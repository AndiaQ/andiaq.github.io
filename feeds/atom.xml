<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Andia</title><link href="https://andiaq.github.io/" rel="alternate"></link><link href="https://andiaq.github.io/feeds/atom.xml" rel="self"></link><id>https://andiaq.github.io/</id><updated>2018-10-24T13:51:00+08:00</updated><subtitle>拒绝熊猫眼。</subtitle><entry><title>博文推荐</title><link href="https://andiaq.github.io/posts/2018/10/24/article-links.html" rel="alternate"></link><published>2018-10-24T13:51:00+08:00</published><updated>2018-10-24T13:51:00+08:00</updated><author><name>Yuwei Wang</name></author><id>tag:andiaq.github.io,2018-10-24:/posts/2018/10/24/article-links.html</id><summary type="html">&lt;ol&gt;
&lt;li&gt;https://forum.huawei.com/enterprise/zh/thread-334207.html&lt;/li&gt;
&lt;li&gt;https://wenku.baidu.com/view/39a6d8c1844769eae109ed46.html&lt;/li&gt;
&lt;li&gt;https://wenku.baidu.com/view/5faaed31941ea76e59fa0419.html&lt;/li&gt;
&lt;li&gt;https://wenku.baidu.com/view/743542d3650e52ea54189846.html&lt;/li&gt;
&lt;li&gt;https://wenku.baidu.com/view/17b2a438f61fb7360a4c6546.html&lt;/li&gt;
&lt;li&gt;https://zhuanlan.zhihu.com/p/29881248&lt;/li&gt;
&lt;li&gt;https://zhuanlan.zhihu.com/p/29975418&lt;/li&gt;
&lt;li&gt;https://zhuanlan …&lt;/li&gt;&lt;/ol&gt;</summary><content type="html">&lt;ol&gt;
&lt;li&gt;https://forum.huawei.com/enterprise/zh/thread-334207.html&lt;/li&gt;
&lt;li&gt;https://wenku.baidu.com/view/39a6d8c1844769eae109ed46.html&lt;/li&gt;
&lt;li&gt;https://wenku.baidu.com/view/5faaed31941ea76e59fa0419.html&lt;/li&gt;
&lt;li&gt;https://wenku.baidu.com/view/743542d3650e52ea54189846.html&lt;/li&gt;
&lt;li&gt;https://wenku.baidu.com/view/17b2a438f61fb7360a4c6546.html&lt;/li&gt;
&lt;li&gt;https://zhuanlan.zhihu.com/p/29881248&lt;/li&gt;
&lt;li&gt;https://zhuanlan.zhihu.com/p/29975418&lt;/li&gt;
&lt;li&gt;https://zhuanlan.zhihu.com/p/30119950&lt;/li&gt;
&lt;/ol&gt;</content></entry><entry><title>OVS 和 Openflow</title><link href="https://andiaq.github.io/posts/2018/09/29/ovs-openflow.html" rel="alternate"></link><published>2018-09-29T18:27:00+08:00</published><updated>2018-09-29T18:27:00+08:00</updated><author><name>Yuwei Wang</name></author><id>tag:andiaq.github.io,2018-09-29:/posts/2018/09/29/ovs-openflow.html</id><summary type="html">&lt;p&gt;本篇文章主要介绍 OVS 以及 Openflow 在 OVS 中的应用。在理解 OVS 原理的基础上，再去学习 Openflow 能更好的掌握二者的实现机制和使用方法。&lt;/p&gt;
&lt;h3&gt;一、介绍 OpenvSwitch&lt;/h3&gt;
&lt;p&gt;在介绍 ovs 之前先说一下另外一个虚拟交换机，即 linux kernel 中的 linux bridge。linux bridge 是一个工作在内核的二层虚拟交换机，添加到 linuxbridge 上的设备 (比如虚拟机的 tap 设备) 被设置为只接受二层数据帧并且转发所有收到的数据包到 linuxbridge 的内核模块中，在 linuxbridge 内核模块中会进行一个类似物理交换机的查 MAC 端口映射表，转发，更新 MAC 端口映射表这样的处理逻辑，从而数据包可以被转发到另一个接口或者被丢弃/广播/发往上层协议栈，由此 …&lt;/p&gt;</summary><content type="html">&lt;p&gt;本篇文章主要介绍 OVS 以及 Openflow 在 OVS 中的应用。在理解 OVS 原理的基础上，再去学习 Openflow 能更好的掌握二者的实现机制和使用方法。&lt;/p&gt;
&lt;h3&gt;一、介绍 OpenvSwitch&lt;/h3&gt;
&lt;p&gt;在介绍 ovs 之前先说一下另外一个虚拟交换机，即 linux kernel 中的 linux bridge。linux bridge 是一个工作在内核的二层虚拟交换机，添加到 linuxbridge 上的设备 (比如虚拟机的 tap 设备) 被设置为只接受二层数据帧并且转发所有收到的数据包到 linuxbridge 的内核模块中，在 linuxbridge 内核模块中会进行一个类似物理交换机的查 MAC 端口映射表，转发，更新 MAC 端口映射表这样的处理逻辑，从而数据包可以被转发到另一个接口或者被丢弃/广播/发往上层协议栈，由此 linuxbridge 实现了数据转发的功能。&lt;/p&gt;
&lt;p&gt;与 linuxbridge 不同的是，ovs 能支持一些高级特性比如 OpenFlow 协议, VLAN tag, QOS, ACL ,Flow 等，是一个高质量的多层虚拟交换机，具备三层交换功能，相比来说更适合 SDN，但是也因此不如 linuxbridge 简单高效易理解。&lt;/p&gt;
&lt;p&gt;OVS 支持 OpenFlow 协议，我们就可以使用任何支持 OpenFlow 协议的控制器来对 OVS 进行远程管理，但这并不意味着 OVS 必须要有一个控制器才能工作。在不连接外部控制器情况下，OVS 作为一个二层虚拟交换机，自身也可以依靠 MAC 地址学习实现二层数据包转发功能，就像 Linuxbridge。&lt;/p&gt;
&lt;h4&gt;1.1 OVS 核心组件及其关联关系&lt;/h4&gt;
&lt;p&gt;&lt;img alt="image" src="/images/network/ovs-openflow.png"&gt;&lt;/p&gt;
&lt;p&gt;ovs 在实现中分为用户空间和内核空间两部分，用户空间主要负责实现数据交换和 Openflow 流表功能，以及一些管理工具。内核空间主要负责流表查找的快速通道。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;ovs-vswitchd: 实现 OpenFlow 交换机的核心功能，通过 Netlink 协议直接和 OVS 内部模块进行通信。另外，通过 UNIX socket 通信机制和 ovs-server 进行通信，将虚拟交换机的配置、流表、统计信息等保存在数据库 ovsdb 中，当 ovsdb 中的配置信息改变时 (例如使用 ovs-vsctl 工具) ，ovs-vswitchd 也会自动更新其配置以保持与数据库同步。也可以直接使用 ovsdb-tool 直接对 ovsdb 数据库进行操作。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;openvswitch.ko：内核空间的快速通路，主要包括 datapath 模块，datapath 负责执行报文的快速转发，把从接受端口接收到的数据包在流表中进行匹配，并执行匹配到的动作，实现快速转发能力。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;OVS 数据流的大致转发流程如下：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;OVS 的 datapath 收到来自物理网卡或者虚拟网卡发来的数据包，获取其中的 IP/MAC/Port 等相关信息&lt;/li&gt;
&lt;li&gt;在内核态查看流表（ datapath flows ），如果有匹配 flow 则按照 action 执行相应的操作进行快速转发，否则将数据包送到用户空间由 ovs-vswitchd 处理。&lt;/li&gt;
&lt;li&gt;ovs-vswitchd 查找用户态流表，如果还找不到，在有 sdn 控制器接入情况下，通过 openflow 协议告知控制器，由控制器处理。&lt;/li&gt;
&lt;li&gt;如果 ovs-vswitchd 找到匹配的 flow，则将匹配的 actions 返回给 datapath 并设置一条 datapath flows 到 datapath 中，这样后续进入的同类型的数据包因为缓存匹配会被 datapath 直接处理，不用再次进入用户空间。&lt;/li&gt;
&lt;li&gt;datapath 重新发起选路，查询其流表，匹配然后进行数据转发。&lt;/li&gt;
&lt;/ol&gt;
&lt;h4&gt;1.2 原生 OVS 源码安装配置&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;下载 ovs 源码，安装 2.9.0 版本。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# git clone https://github.com/openvswitch/ovs.git
# git checkout -b v2.9.0 v2.9.0
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;进行源码安装配置。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# mkdir /usr/local/ovs
# cd ovs
# ./boot.sh
# ./configure --prefix=/usr/local/ovs --with-linux=/lib/modules/`uname -r`/build
# make &amp;amp;&amp;amp; make install
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;验证。可以看到 ovs 2.9.0 版本原生支持 openflow 1.5 版本。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;[root@POD23-CLU02-H006 ~]# ovs-ofctl --version
ovs-ofctl (Open vSwitch) 2.9.0
OpenFlow versions 0x1:0x5
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;二、介绍 OpenFlow&lt;/h3&gt;
&lt;p&gt;Openflow 核心思想很简单，就是将原本完全由交换机/路由器控制的数据包转发过程，转化为由 OpenFlow 交换机 ( OpenFlow Switch ) 和 OpenFlow 控制器 (Controller) 分别完成的独立过程。转变背后进行的实际上是控制权的更迭：传统网络中数据包的流向是人为指定的，虽然交换机、路由器拥有控制权，却没有数据流的概念，只进行数据包级别的交换；而在 OpenFlow 网络中，统一的控制器取代路由，决定了所有数据包在网络中传输路径。&lt;/p&gt;
&lt;p&gt;OpenFlow 交换机会在本地维护一份从控制器获取的流表 (Flow Table) ,如果要转发的数据包在本地流表中有对应项，则直接进行快速转发，若流表中没有此项，数据包就会被发送到控制器进行传输路径的确认，再根据下发结果进行转发。&lt;/p&gt;
&lt;p&gt;现在应该能明白网上关于 OpenFlow 资料经常提到的一句话 OpenFlow 协议实现了控制层面和转发层面的分离，控制层面就是指 OpenFlow 控制器，分离就是说控制器负责控制转发规则，交换机只负责执行转发工作，他们可以通过 IP 网络使用 OpenFlow 协议连接，不需要位于同一台主机上。&lt;/p&gt;
&lt;h4&gt;2.1 OVS 中的 Openflow&lt;/h4&gt;
&lt;p&gt;OVS 是 Openflow 的一个具体实现，ovs-ofctl 是 ovs 原生支持的配置 openflow 流表的工具，在没有 Controller 的接入下，依然可以使用 ovs-ofctl 命令通过 Openflow 协议去连接 OVS，并对 OVS 流表进行操作。本篇文章目的是进行学习测试，通过将 OVS 作为普通 MAC 地址学习交换机并手动添加流表的方式，掌握相关内容。&lt;/p&gt;
&lt;p&gt;在没有连接控制器时，使用 OVS 创建的网桥默认是一个二层虚拟交换机，和 linuxbridge 一样使用简单的 MAC 地址学习方式转发数据包。当流表项指定 action 为 normal，表示匹配此条流表项的数据包脱离 OpenFlow 的控制，由 OVS 根据 MAC 地址学习方式完成后续转发，后面数据包如何被处理就跟 flow 没关系了。如下所示：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;[root@POD23-CLU02-H006 ~]# ovs-vsctl add-br br2
[root@POD23-CLU02-H006 ~]# ovs-ofctl dump-flows br2
 cookie=0x0, duration=19.727s, table=0, n_packets=0, n_bytes=0, priority=0 actions=NORMAL
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;若 OVS 连接有 OpenFlow 控制器或 OVS 中配置有流表，则此时 OVS 数据转发策略就完全由流表来决定。&lt;/p&gt;
&lt;p&gt;下面介绍 openflow 中 flow 的基本语法。&lt;/p&gt;
&lt;h4&gt;2.2 flow 语法&lt;/h4&gt;
&lt;p&gt;在 OVS 中，流表项作为 ovs-ofctl 的参数，采用如下的格式：字段=值。如果有多个字段，可以用逗号或者空格分开。一些常用的字段列举如下：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;匹配字段&lt;/th&gt;
&lt;th&gt;作用&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;in_port=port&lt;/td&gt;
&lt;td&gt;int 类型，数据包进入的 openflow 端口号，&lt;code&gt;ovs-ofctl show br0&lt;/code&gt;可以查看 port number&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;dl_vlan=vlan&lt;/td&gt;
&lt;td&gt;0-4095, 或0xffff，数据包的 VLAN Tag，0xffff 表示此数据包不带 VLAN Tag&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;dl_src=xx:xx:xx:xx:xx:xx&lt;/td&gt;
&lt;td&gt;数据包源 MAC (eg. 00:0A:E4:25:6B:B0)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;dl_dst=xx:xx:xx:xx:xx:xx&lt;/td&gt;
&lt;td&gt;数据包目的 MAC (eg. 00:0A:E4:25:6B:B0)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;01:00:00:00:00:00/01:00:00:00:00:00&lt;/td&gt;
&lt;td&gt;匹配所有多播或广播数据包&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;00:00:00:00:00:00/01:00:00:00:00:00&lt;/td&gt;
&lt;td&gt;匹配所有单播数据包&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;dl_type=ethertype&lt;/td&gt;
&lt;td&gt;0 到 65535 的长整数或者 16 进制表示，匹配以太网数据包类型，EX：0x0800 ( IPv4 数据包) 0x0806 ( arp 数据包)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;nw_src=ip[/netmask] nw_dst=ip[/netmask]&lt;/td&gt;
&lt;td&gt;dl_type 字段为 0x0800 时就匹配源或目的 ip 地址，为 0x0806 就匹配 ar_spa 或 ar_tpa ，若 dl_type 字段为通配符，这两个参数会被忽略&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;tcp_src=port tcp_dst=port udp_src=port udp_dst=port&lt;/td&gt;
&lt;td&gt;匹配 TCP 或 UDP 的源或目的端口，当然，若 dl_type 字段为通配符或者未明确协议类型时，这些字段会忽略&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;关于当前 OVS 版本支持的更多匹配字段以及详细说明和用法，可以通过 &lt;code&gt;man ovs-ofctl&lt;/code&gt; 查看。&lt;/p&gt;
&lt;p&gt;上面提到 flow 支持通配符，添加流表项时只能指定有限的几个字段，对于未指定的字段则默认为通配符，因此若某条添加 flow 命令中所有匹配字段都为通配符，那么这条 flow 将匹配所有数据包，下面新建一个网桥 br-test 测试一下。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;[root@POD23-CLU02-H006 ~]# ovs-vsctl add-br br-test
[root@POD23-CLU02-H006 ~]# ovs-ofctl dump-flows br-test
 cookie=0x0, duration=4.866s, table=0, n_packets=0, n_bytes=0, priority=0 actions=NORMAL
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;可以看到新创建的br-test中默认只有一条flow，也未连接任何控制器，而且此flow中没有匹配字段(priority不是)，因此这条默认添加的flow将匹配所有进入br-test的数据包，而其动作NORMAL表明数据包完全按照MAC地址学习方式完成转发。&lt;/p&gt;
&lt;h4&gt;2.3 flow action 语法&lt;/h4&gt;
&lt;p&gt;action 字段语法为 actions=[action][,action...]，多个 action 用逗号隔开，指定匹配某条流表项的数据包要执行的指令集，要注意的是，若未指定任何 action，数据包会被 DROP。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;action 指令&lt;/th&gt;
&lt;th&gt;作用&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;output:PORT&lt;/td&gt;
&lt;td&gt;数据包从端口 PORT 发出，PORT 为 openflow 端口号，若 PORT 为数据包进入端口，则不执行此 action&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;normal&lt;/td&gt;
&lt;td&gt;数据包交由 OVS 自身的转发规则完成转发，不再匹配任何 openflow flow&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;all&lt;/td&gt;
&lt;td&gt;数据包从网桥上所有端口发出，除了其进入端口&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;drop&lt;/td&gt;
&lt;td&gt;丢弃数据包，当然，drop 之后不能再跟其它 action&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;mod_vlan_vid:vlan_vid&lt;/td&gt;
&lt;td&gt;添加或修改数据包中的 VLAN tag 为此处指定的 tag&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;strip_vlan&lt;/td&gt;
&lt;td&gt;移除数据包中的VLAN tag，如果有的话&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;mod_dl_src:mac /mod_dl_dst:mac&lt;/td&gt;
&lt;td&gt;修改源或目的 MAC 地址&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;mod_nw_src:ip / mod_nw_dst:ip&lt;/td&gt;
&lt;td&gt;修改源或者目的 ip 地址&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;mod_tp_src:port / mod_tp_dst:port&lt;/td&gt;
&lt;td&gt;修改 TCP 或 UDP 数据包的源或目的端口号(注意不是 openflow 端口号)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;resubmit([port],[table])&lt;/td&gt;
&lt;td&gt;若 port 指定,替换数据包 in_port 字段,并重新匹配；若 table 指定，提交数据包到指定 table，并匹配&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h4&gt;2.4 实践操作 OpenFlow 命令&lt;/h4&gt;
&lt;p&gt;在本例中, 我们会创建一个不连接到任何控制器的 OVS 交换机，并演示如何使用 ovs-ofctl 命令操作 OpenFlow 流表。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;创建一个新的 OVS 交换机&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# ovs-vsctl add-br br1
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;创建三台虚拟机，指定 bridge 为 br1，当虚拟机启动时会自动按照 xml 中配置的 tap 设备名称创建一个 port 并挂载到 ovs 网桥上。OVS 会为 interface 自动生成一个 OpenFlow 端口编号。这个端口编号也可以自己配置。配置 openflow 端口编号如下：&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# ovs-vsctl set interface tap-vm1 ofport_request=100
# ovs-vsctl set interface tap-vm2 ofport_request=101
# ovs-vsctl set interface tap-vm3 ofport_request=102
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;配置完成后，两台虚拟机信息：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;虚拟机&lt;/th&gt;
&lt;th&gt;interface&lt;/th&gt;
&lt;th&gt;OpenFlow 端口号&lt;/th&gt;
&lt;th&gt;vlan tag&lt;/th&gt;
&lt;th&gt;IP 地址&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;wangyuwei-1&lt;/td&gt;
&lt;td&gt;tap-vm1&lt;/td&gt;
&lt;td&gt;100&lt;/td&gt;
&lt;td&gt;100&lt;/td&gt;
&lt;td&gt;11.11.11.12&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;wangyuwei-2&lt;/td&gt;
&lt;td&gt;tap-vm2&lt;/td&gt;
&lt;td&gt;101&lt;/td&gt;
&lt;td&gt;100&lt;/td&gt;
&lt;td&gt;11.11.11.13&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;wangyuwei-3&lt;/td&gt;
&lt;td&gt;tap-vm3&lt;/td&gt;
&lt;td&gt;102&lt;/td&gt;
&lt;td&gt;100&lt;/td&gt;
&lt;td&gt;11.11.11.14&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;ol&gt;
&lt;li&gt;屏蔽数据包&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;屏蔽所有进入 OVS 网桥 br1 的以太网数据包&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# ovs-ofctl add-flow br1 &amp;quot;table=0, dl_src=01:00:00:00:00:00/01:00:00:00:00:00, actions=drop&amp;quot;
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;修改数据包&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;添加新的 OpenFlow 条目，修改从端口 tap-vm1 收到的数据包的源地址为 12.12.12.12&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# ovs-ofctl add-flow br1 &amp;quot;priority=1 idle_timeout=0,in_port=100,actions=mod_nw_src:12.12.12.12,normal&amp;quot;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;从 wangyuwei-1 (11.11.11.12) ping wangyuwei-2 (11.11.11.13)，并对 tap-vm2 进行抓包，可以看到地址成功被替换成 12.12.12.12，符合预期。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;[root@POD23-CLU02-H006 ~]# tcpdump -i tap-vm2 icmp
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on tap-vm2, link-type EN10MB (Ethernet), capture size 262144 bytes
18:04:03.382171 IP 12.12.12.12 &amp;gt; 11.11.11.13: ICMP echo request, id 15694, seq 28, length 64
18:04:04.382254 IP 12.12.12.12 &amp;gt; 11.11.11.13: ICMP echo request, id 15694, seq 29, length 64
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;重定向数据包&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;添加新的 OpenFlow 条目，重定向来自 tap-vm1 的所有 ICMP 数据包到端口 tap-vm3。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# ovs-ofctl add-flow br1 idle_timeout=0,dl_type=0x0800,nw_proto=1,nw_src=&amp;quot;11.11.11.12&amp;quot;,actions=output:102
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;分别从 wangyuwei-1 (11.11.11.12) ping wangyuwei-2 (11.11.11.13)，wangyuwei-3 (11.11.11.14) 并对 tap-vm3 进行抓包，可以看到对 tap-vm2 的访问也由 tap-vm3 接收到了，符合预期。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;[root@POD23-CLU02-H006 ~]# tcpdump -i tap-vm3 icmp
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on tap-vm3, link-type EN10MB (Ethernet), capture size 262144 bytes
18:16:09.137650 IP 11.11.11.12 &amp;gt; 11.11.11.13: ICMP echo request, id 15705, seq 5, length 64
18:16:10.137738 IP 11.11.11.12 &amp;gt; 11.11.11.13: ICMP echo request, id 15705, seq 6, length 64
18:16:14.571260 IP 11.11.11.12 &amp;gt; 11.11.11.14: ICMP echo request, id 15706, seq 1, length 64
18:16:14.571433 IP 11.11.11.14 &amp;gt; 11.11.11.12: ICMP echo reply, id 15706, seq 1, length 64
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;修改数据包的 VLAN Tag&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;除了使用 &lt;code&gt;ping&lt;/code&gt;、&lt;code&gt;tcpdump&lt;/code&gt; 和 &lt;code&gt;iperf&lt;/code&gt; 等 Linux 命令以外，我们也可以使用 OVS 提供的 &lt;code&gt;ovs-appctl ofproto/trace&lt;/code&gt; 工具来测试 OVS 对数据包的转发状况。&lt;code&gt;ovs-appctl ofproto/trace&lt;/code&gt; 可以用来生成测试用的模拟数据包，并一步步的展示 OVS 对数据包的流处理过程。在以下的例子中，我们演示一下如何使用这个命令：&lt;/p&gt;
&lt;p&gt;修改端口 tap-vm1 的 VLAN tag 为 101:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# ovs-vsctl set port tap-vm1 tag=101
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;现在由于端口 tap-vm1 和 tap-vm2 属于不同的 VLAN，它们之间无法进行数据交换。我们使用tap-vm1 ping tap-vm2，我们使用 ovs-appctl ofproto/trace 生成一个从端口 t 发送到端口 p1 的数据包，这个数据包不包含任何 VLAN tag，并观察 OVS 的处理过程&lt;/p&gt;
&lt;h3&gt;三、参考文档&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;https://opengers.github.io/openstack/openstack-base-openflow-in-openvswitch/&lt;/li&gt;
&lt;li&gt;https://opengers.github.io/openstack/openstack-base-use-openvswitch/&lt;/li&gt;
&lt;li&gt;https://opengers.github.io/openstack/openstack-base-virtual-network-devices-bridge-and-vlan/&lt;/li&gt;
&lt;li&gt;https://www.ibm.com/developerworks/cn/cloud/library/1401_zhaoyi_openswitch/index.html&lt;/li&gt;
&lt;/ol&gt;</content></entry><entry><title>OpenvSwitch + VxLAN 实现</title><link href="https://andiaq.github.io/posts/2018/09/25/openvswitch-vxlan.html" rel="alternate"></link><published>2018-09-25T10:12:00+08:00</published><updated>2018-09-25T10:12:00+08:00</updated><author><name>Yuwei Wang</name></author><id>tag:andiaq.github.io,2018-09-25:/posts/2018/09/25/openvswitch-vxlan.html</id><summary type="html">&lt;p&gt;本实验基于 OVS 构建 Overlay 的 VxLAN 网络。在实验过程中，建立对 VXLAN 的基本认识，以及了解如何建立并进行配置 VxLAN 隧道网络，从而实现相同网段和不同网段之间的通信。&lt;/p&gt;
&lt;h3&gt;一、对  VxLAN 的认识&lt;/h3&gt;
&lt;p&gt;VXLAN ( Virtual eXtensible Local Area Network ) 一种网络虚拟化技术，通过将 VM 或物理服务器发出的数据包封装在 UDP 中，并使用物理网络的 IP/MAC 作为报文头进行封装，然后在 IP 网络上传输，到达目的地后由隧道终结点解封装并将数据发送给目标虚拟机或物理服务器。&lt;/p&gt;
&lt;h4&gt;1.1 VxLAN 封装和包格式&lt;/h4&gt;
&lt;p&gt;VxLAN 是将二层建立在三层上的网络。通过将二层数据封装到 UDP 的方式来扩展数据中心的二层网段数量。传输协议是 IP …&lt;/p&gt;</summary><content type="html">&lt;p&gt;本实验基于 OVS 构建 Overlay 的 VxLAN 网络。在实验过程中，建立对 VXLAN 的基本认识，以及了解如何建立并进行配置 VxLAN 隧道网络，从而实现相同网段和不同网段之间的通信。&lt;/p&gt;
&lt;h3&gt;一、对  VxLAN 的认识&lt;/h3&gt;
&lt;p&gt;VXLAN ( Virtual eXtensible Local Area Network ) 一种网络虚拟化技术，通过将 VM 或物理服务器发出的数据包封装在 UDP 中，并使用物理网络的 IP/MAC 作为报文头进行封装，然后在 IP 网络上传输，到达目的地后由隧道终结点解封装并将数据发送给目标虚拟机或物理服务器。&lt;/p&gt;
&lt;h4&gt;1.1 VxLAN 封装和包格式&lt;/h4&gt;
&lt;p&gt;VxLAN 是将二层建立在三层上的网络。通过将二层数据封装到 UDP 的方式来扩展数据中心的二层网段数量。传输协议是 IP + UDP。
VxLAN 是一种在现有物理网络设施中支持大规模多租户网络环境的解决方案。&lt;/p&gt;
&lt;p&gt;VxLAN 定义了一个 MAC-in-UDP 的封装格式。
在原始的 Layer 2 网络包前加上 VxLAN header，然后放到 UDP 和 IP 包中。
通过 MAC-in-UDP 封装，VxLAN 能够在 Layer 3 网络上建立起了一条 Layer 2 的隧道。&lt;/p&gt;
&lt;p&gt;VxLAN 包的格式如下：&lt;/p&gt;
&lt;p&gt;&lt;img alt="image" src="/images/network/ovs-vxlan-1.png"&gt;&lt;/p&gt;
&lt;p&gt;如上图所示，VxLAN 引入了 8-byte VxLAN header，其中 VNI 占 24-bit。
VxLAN 和原始的 L2 frame 被封装到 UDP 包中。&lt;/p&gt;
&lt;p&gt;这 24-bit 的 VNI 用于标示不同的二层网段，能够支持 16777216 个 LAN。不同 VxLAN 段的虚拟机不能直接二层相互通信。&lt;/p&gt;
&lt;h4&gt;1.2 VxLAN Tunnel Endpoint&lt;/h4&gt;
&lt;p&gt;VxLAN 使用 VxLAN tunnel endpoint (VTEP) 设备处理 VxLAN 的封装和解封。
每个 VTEP 有一个 IP interface，并配置了一个 IP 地址作为该服务器上的 VxLAN 隧道端点。VTEP 使用该 IP 封装 Layer 2 frame，
并通过该 IP interface 传输和接收封装后的 VxLAN 数据包。&lt;/p&gt;
&lt;p&gt;VxLAN 独立于底层的网络拓扑；
反过来，两个 VTEP 之间的底层 IP 网络也独立于 VxLAN。
VxLAN 数据包是根据外层的 IP header 路由的，该 header 将两端的 VTEP IP 作为源和目标 IP。&lt;/p&gt;
&lt;p&gt;后面通过详细的实验进行说明。&lt;/p&gt;
&lt;h3&gt;二、数据报文转发&lt;/h3&gt;
&lt;p&gt;VM 之间的通信模式主要有3种：同 VNI 下的不同 VM（分布在同一实体和不同实体两种），不同 VNI 下的跨网访问，VxLAN 和非 VxLAN 之间的访问。&lt;/p&gt;
&lt;p&gt;VxLAN 网关分为：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;二层网关&lt;/strong&gt;：位于同一网段的终端用户通信，L2 网关收到用户报文后，根据报文中包含的目的 MAC 类型，报文转发流程分为：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;MAC 地址为 BUM（broadcast&amp;amp;unknown-unicast&amp;amp;multicast）地址，按照 BUM 报文转发流程进行处理&lt;/li&gt;
&lt;li&gt;MAC 地址为已知单播地址，按照已知单播报文转发流程进行处理&lt;/li&gt;
&lt;/ol&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;三层网关&lt;/strong&gt;：用于非同一网段的终端用户通信或 VxLAN 和非 VxLAN 用户间的通信。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;2.1 相同 VNI VM 之间的通信&lt;/h4&gt;
&lt;p&gt;对于相同 VNI 的 VxLAN，属于同一个二层网络段。对于同网段主机的通信而言，报文通过查询 MAC 表进行二层转发。
以下实验的二层网关即 tep0。&lt;/p&gt;
&lt;p&gt;相同 VNI vm 之间互访拓扑图如下：&lt;/p&gt;
&lt;p&gt;&lt;img alt="image" src="/images/network/ovs-vxlan-2.png"&gt;&lt;/p&gt;
&lt;p&gt;在两个物理机上分别配置 VNI 为1000，配置如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;host1 配置:
&lt;span class="c1"&gt;# ovs-vsctl add-br br0&lt;/span&gt;
&lt;span class="c1"&gt;# ovs-vsctl add-port br0 ens10f1&lt;/span&gt;
&lt;span class="c1"&gt;# ovs-vsctl add-port br0 tep0 -- set interface tep0 type=internal&lt;/span&gt;
&lt;span class="c1"&gt;# ip addr add 192.168.0.10/24 dev tep0&lt;/span&gt;
&lt;span class="c1"&gt;# ovs-vsctl add-br br1&lt;/span&gt;
&lt;span class="c1"&gt;# ovs-vsctl add-port br1 vx1 -- set interface vx1 type=vxlan options:remote_ip=192.168.0.20 options:key=1000 options:dst_port=4789&lt;/span&gt;

host2 配置：
&lt;span class="c1"&gt;# ovs-vsctl add-br br0&lt;/span&gt;
&lt;span class="c1"&gt;# ovs-vsctl add-port br0 ens10f1&lt;/span&gt;
&lt;span class="c1"&gt;# ovs-vsctl add-port br0 tep0 -- set interface tep0 type=internal&lt;/span&gt;
&lt;span class="c1"&gt;# ip addr add 192.168.0.20/24 dev tep0&lt;/span&gt;
&lt;span class="c1"&gt;# ip link set tep0 up&lt;/span&gt;
&lt;span class="c1"&gt;# ovs-vsctl add-br br1&lt;/span&gt;
&lt;span class="c1"&gt;# ovs-vsctl add-port br1 vx1 -- set interface vx1 type=vxlan options:remote_ip=192.168.0.10 options:key=1000 options:dst_port=4789&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;vm 网卡配置信息如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;    &lt;span class="nt"&gt;&amp;lt;interface&lt;/span&gt; &lt;span class="na"&gt;type=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;bridge&amp;#39;&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;mac&lt;/span&gt; &lt;span class="na"&gt;address=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;e2:2e:54:67:c3:22&amp;#39;&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;source&lt;/span&gt; &lt;span class="na"&gt;bridge=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;br1&amp;#39;&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;virtualport&lt;/span&gt; &lt;span class="na"&gt;type=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;openvswitch&amp;#39;&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;lt;parameters&lt;/span&gt; &lt;span class="na"&gt;interfaceid=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;d3cc9fef-ff8d-4432-a1b9-87e231f9dc1e&amp;#39;&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;/virtualport&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;target&lt;/span&gt; &lt;span class="na"&gt;dev=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;tap-vm1&amp;#39;&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;model&lt;/span&gt; &lt;span class="na"&gt;type=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;virtio&amp;#39;&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;address&lt;/span&gt; &lt;span class="na"&gt;type=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;pci&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;domain=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;0x0000&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;bus=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;0x00&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;slot=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;0x03&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;function=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;0x0&amp;#39;&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;/interface&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;按照以上配置，在 host1 上创建 vm1, 且配置 vm1 ip 地址为 12.12.12.14/24；host1 上创建 vm2, 且配置 vm2 ip 地址为 12.12.12.12/24.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;root@POD23-CLU02-H006 ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# ovs-vsctl show&lt;/span&gt;
0611578f-a3e2-4df1-927c-d8ec139084a1
    Bridge &lt;span class="s2"&gt;&amp;quot;br0&amp;quot;&lt;/span&gt;
        Port &lt;span class="s2"&gt;&amp;quot;tep0&amp;quot;&lt;/span&gt;
            Interface &lt;span class="s2"&gt;&amp;quot;tep0&amp;quot;&lt;/span&gt;
                type: internal
        Port &lt;span class="s2"&gt;&amp;quot;br0&amp;quot;&lt;/span&gt;
            Interface &lt;span class="s2"&gt;&amp;quot;br0&amp;quot;&lt;/span&gt;
                type: internal
        Port &lt;span class="s2"&gt;&amp;quot;ens10f1&amp;quot;&lt;/span&gt;
            Interface &lt;span class="s2"&gt;&amp;quot;ens10f1&amp;quot;&lt;/span&gt;
    Bridge &lt;span class="s2"&gt;&amp;quot;br1&amp;quot;&lt;/span&gt;
        Port &lt;span class="s2"&gt;&amp;quot;br1&amp;quot;&lt;/span&gt;
            Interface &lt;span class="s2"&gt;&amp;quot;br1&amp;quot;&lt;/span&gt;
                type: internal
        Port &lt;span class="s2"&gt;&amp;quot;tap-vm1&amp;quot;&lt;/span&gt;
            Interface &lt;span class="s2"&gt;&amp;quot;tap-vm1&amp;quot;&lt;/span&gt;
        Port &lt;span class="s2"&gt;&amp;quot;vx1&amp;quot;&lt;/span&gt;
            Interface &lt;span class="s2"&gt;&amp;quot;vx1&amp;quot;&lt;/span&gt;
                type: vxlan
                options: &lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="nv"&gt;dst_port&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;4789&amp;quot;&lt;/span&gt;, &lt;span class="nv"&gt;key&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;1000&amp;quot;&lt;/span&gt;, &lt;span class="nv"&gt;remote_ip&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;192.168.0.10&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;对 vm1 (12.12.12.14) ping vm2 (12.12.12.12) 进行抓包分析，结果如下。可以清楚的看到配置的 VNI 值，以及 overlay 和 underlay ip 地址信息。&lt;/p&gt;
&lt;p&gt;&lt;img alt="image" src="/images/network/ovs-vxlan-3.png"&gt;&lt;/p&gt;
&lt;p&gt;选择使用 VxLAN 网络模式时，每个租户网络使用一个 VNI，处于一个租户下的 vm 之间可以二层互访。不同租户之间即不同 VxLAN 段不能直接二层通信，也就是说通过 VNI ID 实现租户隔离。VNI 数量和 VLAN ID 数量远远不能相比，所以使用 VxLAN 大大解决了租户 vlan 的数量限制。&lt;/p&gt;
&lt;p&gt;实现租户隔离之后，如果再想实现租户内网络二层隔离，这时候可以再结合使用 VLAN tag，从而实现本地隔离。&lt;/p&gt;
&lt;h4&gt;2.2 不同 VNI VM 之间的通信&lt;/h4&gt;
&lt;p&gt;实现不同 VNI 下的跨网访问，需要配置三层网关。以下实验通过增加路由虚拟机，将配置子网网关地址到路由虚拟机上，从而实现跨网访问。&lt;/p&gt;
&lt;p&gt;不同子网拓扑图实现如下：&lt;/p&gt;
&lt;p&gt;&lt;img alt="image" src="/images/network/ovs-vxlan-4.png"&gt;&lt;/p&gt;
&lt;p&gt;如图所示，vm1 和 vm2 分别属于 10.10.10.0/24 网段和 12.12.12.0/24 网段，且分别属于 VNI 1000 和 VNI 2000。vm1 和 vm2 对应的三层网关分别是 vrouter 上 NIC_0 和 NIC_1 的 IP 地址。vrouter上存在到 10.10.10.0/24 网段和 12.12.12.0/24 网段的路由。此时，vm1 想与 vm2 进行通信。&lt;/p&gt;
&lt;p&gt;host1 配置如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# ovs-vsctl add-port br1 vx1 -- set interface vx1 type=vxlan options:remote_ip=192.168.0.20 options:key=1000 options:dst_port=4789&lt;/span&gt;
&lt;span class="c1"&gt;# ovs-vsctl add-port br2 vx2 -- set interface vx2 type=vxlan options:remote_ip=192.168.0.30 options:key=2000 options:dst_port=4789&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;host2 配置如下:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# ovs-vsctl add-port br1 vx1 -- set interface vx1 type=vxlan options:remote_ip=192.168.0.10 options:key=1000 options:dst_port=4789&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;host3 配置如下:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# ovs-vsctl add-port br1 vx1 -- set interface vx1 type=vxlan options:remote_ip=192.168.0.10 options:key=2000 options:dst_port=4789&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;由于是首次进行通信，且 vm1 和 vm2 处于不同网段，vm1 需要先发送 ARP 广播报文请求网关 vrouter（NIC_0）的MAC，获得网关的 MAC 后，vm1 先将数据报文发送给网关；之后网关也将发送 ARP 广播报文请求 vm2 的 MAC，获得 vm2 的 MAC 后，网关再将数据报文发送给 vm2。&lt;/p&gt;
&lt;h4&gt;2.3 VM 和外部服务器的通信&lt;/h4&gt;
&lt;h5&gt;2.3.1 绑定 floating ip 到虚拟机&lt;/h5&gt;
&lt;p&gt;若要直接将 floating ip 绑定到虚拟机，首先我们需要一个 floating ip 段，并且该子网段中有一个 ip 地址作为子网的网关。然后从以上 floating ip 子网段中分配一个 ip 地址给虚拟机。&lt;/p&gt;
&lt;p&gt;在本实验中，由于没有公网 ip 可用，我们可以在计算节点配置一个 11.11.11.1/24 子网段作为 floating ip 段。并将网关地址 11.11.11.1 配置到计算节点上。通过计算节点上 ip 转发以及路由功能，将 floating ip 映射到公网。&lt;/p&gt;
&lt;p&gt;以 host2 为例，配置之前 ovs 信息如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;root@POD23-CLU02-H006 ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# ovs-vsctl show&lt;/span&gt;
0611578f-a3e2-4df1-927c-d8ec139084a1
    Bridge &lt;span class="s2"&gt;&amp;quot;br0&amp;quot;&lt;/span&gt;
        Port &lt;span class="s2"&gt;&amp;quot;tep0&amp;quot;&lt;/span&gt;
            Interface &lt;span class="s2"&gt;&amp;quot;tep0&amp;quot;&lt;/span&gt;
                type: internal
        Port &lt;span class="s2"&gt;&amp;quot;br0&amp;quot;&lt;/span&gt;
            Interface &lt;span class="s2"&gt;&amp;quot;br0&amp;quot;&lt;/span&gt;
                type: internal
        Port &lt;span class="s2"&gt;&amp;quot;ens10f1&amp;quot;&lt;/span&gt;
            Interface &lt;span class="s2"&gt;&amp;quot;ens10f1&amp;quot;&lt;/span&gt;
    Bridge &lt;span class="s2"&gt;&amp;quot;br1&amp;quot;&lt;/span&gt;
        Port &lt;span class="s2"&gt;&amp;quot;br1&amp;quot;&lt;/span&gt;
            Interface &lt;span class="s2"&gt;&amp;quot;br1&amp;quot;&lt;/span&gt;
                type: internal
        Port &lt;span class="s2"&gt;&amp;quot;tap-vm1&amp;quot;&lt;/span&gt;
            tag: &lt;span class="m"&gt;100&lt;/span&gt;
            Interface &lt;span class="s2"&gt;&amp;quot;tap-vm1&amp;quot;&lt;/span&gt;
        Port &lt;span class="s2"&gt;&amp;quot;vx1&amp;quot;&lt;/span&gt;
            Interface &lt;span class="s2"&gt;&amp;quot;vx1&amp;quot;&lt;/span&gt;
                type: vxlan
                options: &lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="nv"&gt;dst_port&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;4789&amp;quot;&lt;/span&gt;, &lt;span class="nv"&gt;key&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;1000&amp;quot;&lt;/span&gt;, &lt;span class="nv"&gt;remote_ip&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;192.168.0.10&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;我们对虚拟机的网卡 tap-vm1 设备打上了 tag=100, 用来模拟 vlan 模型的外部网络。接着做如下配置：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# ovs-vsctl add-port br1 tap-gateway -- set interface tap-gateway type=internal&lt;/span&gt;
&lt;span class="c1"&gt;# ovs-vsctl set port tap-gateway tag=100&lt;/span&gt;
&lt;span class="c1"&gt;# ip link set tap-gateway up&lt;/span&gt;
&lt;span class="c1"&gt;# ip addr add 11.11.11.1/24 dev tap-gateway&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;以上步骤完成 floating ip 子网段和网关地址的配置，我们还需要在计算节点开启 ip 转发和路由转发。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# cat /etc/sysctl.d/99-sysctl.conf &lt;/span&gt;
net.ipv4.ip_forward &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="m"&gt;1&lt;/span&gt;
&lt;span class="c1"&gt;# sysctl -p&lt;/span&gt;

&lt;span class="c1"&gt;# iptables -t nat -A POSTROUTING -s 11.11.11.0/24 -j SNAT --to-source 18.23.120.66&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;以下配置是开启计算节点 dns 服务端口：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# iptables -A OUTPUT -p udp --dport 53 -j ACCEPT&lt;/span&gt;
&lt;span class="c1"&gt;# iptables -A OUTPUT -p udp --sport 53 -j ACCEPT&lt;/span&gt;
&lt;span class="c1"&gt;# iptables -A INPUT -p udp --sport 53 -j ACCEPT&lt;/span&gt;
&lt;span class="c1"&gt;# iptables -A INPUT -p udp --dport 53 -j ACCEPT&lt;/span&gt;
&lt;span class="c1"&gt;# iptables -D INPUT -j REJECT --reject-with icmp-host-prohibited&lt;/span&gt;
&lt;span class="c1"&gt;# iptables -D FORWARD -j REJECT --reject-with icmp-host-prohibited&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;结果如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;root@wangyuwei-1 ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# ip a&lt;/span&gt;
&lt;span class="m"&gt;1&lt;/span&gt;: lo: &amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt; mtu &lt;span class="m"&gt;65536&lt;/span&gt; qdisc noqueue state UNKNOWN 
    link/loopback &lt;span class="m"&gt;00&lt;/span&gt;:00:00:00:00:00 brd &lt;span class="m"&gt;00&lt;/span&gt;:00:00:00:00:00
    inet &lt;span class="m"&gt;127&lt;/span&gt;.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
&lt;span class="m"&gt;2&lt;/span&gt;: eth0: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu &lt;span class="m"&gt;1500&lt;/span&gt; qdisc pfifo_fast state UP qlen &lt;span class="m"&gt;1000&lt;/span&gt;
    link/ether &lt;span class="m"&gt;52&lt;/span&gt;:54:00:7d:e8:37 brd ff:ff:ff:ff:ff:ff
    inet &lt;span class="m"&gt;11&lt;/span&gt;.11.11.12/24 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::5054:ff:fe7d:e837/64 scope link 
       valid_lft forever preferred_lft forever
&lt;span class="o"&gt;[&lt;/span&gt;root@wangyuwei-1 ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# ping -c 2 baidu.com&lt;/span&gt;
PING baidu.com &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;123&lt;/span&gt;.125.115.110&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="m"&gt;56&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;84&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; bytes of data.
&lt;span class="m"&gt;64&lt;/span&gt; bytes from &lt;span class="m"&gt;123&lt;/span&gt;.125.115.110: &lt;span class="nv"&gt;icmp_seq&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt; &lt;span class="nv"&gt;ttl&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;52&lt;/span&gt; &lt;span class="nv"&gt;time&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;.40 ms
&lt;span class="m"&gt;64&lt;/span&gt; bytes from &lt;span class="m"&gt;123&lt;/span&gt;.125.115.110: &lt;span class="nv"&gt;icmp_seq&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt; &lt;span class="nv"&gt;ttl&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;52&lt;/span&gt; &lt;span class="nv"&gt;time&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;.37 ms

--- baidu.com ping statistics ---
&lt;span class="m"&gt;2&lt;/span&gt; packets transmitted, &lt;span class="m"&gt;2&lt;/span&gt; received, &lt;span class="m"&gt;0&lt;/span&gt;% packet loss, &lt;span class="nb"&gt;time&lt;/span&gt; 1001ms
rtt min/avg/max/mdev &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="m"&gt;2&lt;/span&gt;.376/2.391/2.407/0.051 ms
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;以上测试只能作为基础功能实验，理解访问外网的过程，但是并没有做隔离。
如果环境中事先已经准备了一个 floating ip 池，则不需要该 floating ip 池开启 DHCP 功能，只需要按需分配并挂载到虚拟机上。&lt;/p&gt;
&lt;p&gt;如果仅从分配 ip 地址角度来说，在没有路由器参与时，若是分配内网 ip 地址，以上场景可以将虚拟机 ip 地址配置成 dhcp，且可以使用 namespace 实现隔离。&lt;/p&gt;
&lt;h5&gt;2.3.2 绑定 floating ip 到路由器&lt;/h5&gt;
&lt;p&gt;这里路由器有两种实现方式：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;使用 namespace 实现&lt;/li&gt;
&lt;li&gt;使用虚拟机，比如 vyos 或者 6wind 等自带路由，DHCP 等功能的 vrouter&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;这里如果使用虚拟机实现 vrouter, 那么绑定 floating ip 到路由器也意味着绑定 floating ip 到虚拟机。过程及原理和上述绑定 floating ip 到虚拟机类似。&lt;/p&gt;</content></entry><entry><title>OVS-DPDK QoS 实现</title><link href="https://andiaq.github.io/posts/2018/09/04/ovs-dpdk-qos.html" rel="alternate"></link><published>2018-09-04T15:16:00+08:00</published><updated>2018-09-04T15:16:00+08:00</updated><author><name>Yuwei Wang</name></author><id>tag:andiaq.github.io,2018-09-04:/posts/2018/09/04/ovs-dpdk-qos.html</id><summary type="html">&lt;p&gt;在使用 DPDK datapath 时，可以同时设置入口流量限制和出口流量限制。这些分别称为 QoS 和速率限制。&lt;/p&gt;
&lt;h3&gt;一、QoS (Egress Policing)&lt;/h3&gt;
&lt;p&gt;在 OVS-DPDK 环境中配置 QoS，仅在从 vSwitch 上的端口发送的出口流量上进行限制。&lt;/p&gt;
&lt;p&gt;使用如下命令查看 OVS port 支持的 QoS 类型。目前 ovs-dpdk 只支持 egress-policer，随着版本更新可能会支持其他的 QoS 类型。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# ovs-appctl -t ovs-vswitchd qos/show-types dpdkvhostuserclient0
QoS type: egress-policer
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;code&gt;egress-policer&lt;/code&gt; 是 OVS-DPDK 支持的 QoS 类型。&lt;/p&gt;
&lt;p&gt;一旦在接口上超过指定的传输速率（由 token …&lt;/p&gt;</summary><content type="html">&lt;p&gt;在使用 DPDK datapath 时，可以同时设置入口流量限制和出口流量限制。这些分别称为 QoS 和速率限制。&lt;/p&gt;
&lt;h3&gt;一、QoS (Egress Policing)&lt;/h3&gt;
&lt;p&gt;在 OVS-DPDK 环境中配置 QoS，仅在从 vSwitch 上的端口发送的出口流量上进行限制。&lt;/p&gt;
&lt;p&gt;使用如下命令查看 OVS port 支持的 QoS 类型。目前 ovs-dpdk 只支持 egress-policer，随着版本更新可能会支持其他的 QoS 类型。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# ovs-appctl -t ovs-vswitchd qos/show-types dpdkvhostuserclient0
QoS type: egress-policer
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;code&gt;egress-policer&lt;/code&gt; 是 OVS-DPDK 支持的 QoS 类型。&lt;/p&gt;
&lt;p&gt;一旦在接口上超过指定的传输速率（由 token bucket 实现），&lt;code&gt;egress policer&lt;/code&gt; 就会丢弃数据包。 对于物理设备来说，它将丢弃通过 NIC 从主机传输的流量。 对于虚拟接口来说，即 DPDK vhost-user，它将丢弃从 vSwitch 传输到 guest 虚拟机的流量，也就是限制了该端口上 guest 虚拟机的流量接收速率。 &lt;/p&gt;
&lt;p&gt;使用如下命令对 dpdkvhostuserclient1 进行配置，将发送速率限制为 10Mbps。10Mbps = 10,000,000bps = 1250000Bps，即 cir 的值大小。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# ovs-vsctl set port dpdkvhostuserclient1 qos=@newqos -- --id=@newqos create qos type=egress-policer other-config:cir=1250000 other-config:cbs=2048
&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;cir：（Committed Information Rate，承诺信息速率）, 端口允许发送的最大速率，单位为Bytes/s.&lt;/li&gt;
&lt;li&gt;cbs：（Committed Burst Size，承诺突发尺寸），以 bytes 为单位，为令牌桶的容量，即每次突发所允许的最大的流量尺寸。设置的突发尺寸必须大于最大报文长度，即至少要比 MTU 的值大。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;使用如下命令查看端口上的 QoS 信息：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# ovs-appctl -t ovs-vswitchd qos/show dpdkvhostuserclient1
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;使用如下命令从 ovsdb 和 port 上清除 QoS 配置：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# ovs-vsctl destroy QoS dpdkvhostuserclient1 -- clear Port dpdkvhostuserclient1 qos
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;二、Rate Limiting (Ingress Policing)&lt;/h3&gt;
&lt;p&gt;与 QoS 功能作用链路相反，Rate limiting 对 vSwitch 上的端口接收的入口流量进行限制。&lt;/p&gt;
&lt;p&gt;使用如下命令对 dpdkvhostuserclient0 进行配置，将接收速率限制为 10Mbps.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# ovs-vsctl set interface dpdkvhostuserclient0 ingress_policing_rate=10000 ingress_policing_burst=1000
&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;ingress_policing_rate: 允许 VM 可发送的最大速率（以Kbps为单位）。对于创建入口流量策略限制，此值是必需的。 如果未指定任何值，则不会修改现有的速率限制配置。&lt;/li&gt;
&lt;li&gt;ingress_policing_burst: 以kb为单位，表示令牌桶的容量。 这个参数最小值应不小于接口的MTU值。 如果未指定任何值，则默认值为 1000 kb。通常设置为 ingress_policing_rate 的 10% 更有利于 tcp 实现全速率。 这是因为 TCP 在丢弃数据包时如果传输交互不好，这会导致数据包重新传输出现问题。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;使用如下命令查看端口上的速率限制配置信息：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# ovs-vsctl list interface dpdkvhostuserclient0
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;使用如下命令清除端口上的速率限制：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# ovs-vsctl set interface dpdkvhostuserclient0 ingress_policing_rate=0
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;2.1 实验结果&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;未限速之前：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img alt="image" src="/images/network/ovs-dpdk-qos-1.png"&gt;&lt;/p&gt;
&lt;p&gt;设置限速到 4Mbps，即 rate 设置为 4000kbps.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ovs-vsctl set interface dpdkvhostuserclient2 ingress_policing_rate=4000 ingress_policing_burst=1000
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;img alt="image" src="/images/network/ovs-dpdk-qos-2.png"&gt;&lt;/p&gt;</content></entry><entry><title>OpenvSwitch + DPDK 实现</title><link href="https://andiaq.github.io/posts/2018/08/29/openvswitch-dpdk.html" rel="alternate"></link><published>2018-08-29T09:36:00+08:00</published><updated>2018-08-29T09:36:00+08:00</updated><author><name>Yuwei Wang</name></author><id>tag:andiaq.github.io,2018-08-29:/posts/2018/08/29/openvswitch-dpdk.html</id><summary type="html">&lt;p&gt;本文主要介绍如何使用 DPDK datapath 编译并安装 Open vSwitch，以及在 OVS-DPDK 基础上，进行 6wind 包转发性能测试实验。&lt;/p&gt;
&lt;p&gt;使用了 DPDK 库的 OVS 运行在用户空间，可以直接将用户态的数据，不经过内核直接转发到网卡，从而实现加速目的。&lt;/p&gt;
&lt;h3&gt;一、OVS + DPDK 编译部署&lt;/h3&gt;
&lt;p&gt;在部署过程中，各个组件版本之间有一些依赖，版本不对很有可能会出现安装失败或者虚拟机无法开机，推荐使用以下版本。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;root@pod23-clu02-h005 ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# ovs-vswitchd --version&lt;/span&gt;
ovs-vswitchd &lt;span class="o"&gt;(&lt;/span&gt;Open vSwitch&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="m"&gt;2&lt;/span&gt;.9.0
DPDK &lt;span class="m"&gt;17&lt;/span&gt;.11.3

&lt;span class="o"&gt;[&lt;/span&gt;root@pod23-clu02-h005 ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# libvirtd --version&lt;/span&gt;
libvirtd &lt;span class="o"&gt;(&lt;/span&gt;libvirt&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="m"&gt;4&lt;/span&gt;.0 …&lt;/pre&gt;&lt;/div&gt;</summary><content type="html">&lt;p&gt;本文主要介绍如何使用 DPDK datapath 编译并安装 Open vSwitch，以及在 OVS-DPDK 基础上，进行 6wind 包转发性能测试实验。&lt;/p&gt;
&lt;p&gt;使用了 DPDK 库的 OVS 运行在用户空间，可以直接将用户态的数据，不经过内核直接转发到网卡，从而实现加速目的。&lt;/p&gt;
&lt;h3&gt;一、OVS + DPDK 编译部署&lt;/h3&gt;
&lt;p&gt;在部署过程中，各个组件版本之间有一些依赖，版本不对很有可能会出现安装失败或者虚拟机无法开机，推荐使用以下版本。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;root@pod23-clu02-h005 ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# ovs-vswitchd --version&lt;/span&gt;
ovs-vswitchd &lt;span class="o"&gt;(&lt;/span&gt;Open vSwitch&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="m"&gt;2&lt;/span&gt;.9.0
DPDK &lt;span class="m"&gt;17&lt;/span&gt;.11.3

&lt;span class="o"&gt;[&lt;/span&gt;root@pod23-clu02-h005 ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# libvirtd --version&lt;/span&gt;
libvirtd &lt;span class="o"&gt;(&lt;/span&gt;libvirt&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="m"&gt;4&lt;/span&gt;.0.0
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;下载 DPDK&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# wget http://fast.dpdk.org/rel/dpdk-17.11.3.tar.xz&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;添加相关环境变量并安装依赖组件&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;export DPDK_DIR=&amp;lt;DPDK_DIR&amp;gt;        # dpdk-17.11.3安装目录
export DPDK_TARGET=x86_64-native-linuxapp-gcc
export DPDK_BUILD=$DPDK_DIR/$DPDK_TARGET
export LD_LIBRARY_PATH=$DPDK_DIR/x86_64-native-linuxapp-gcc/lib
export PATH=$PATH:/usr/local/ovs/share/openvswitch/scripts
export DB_SOCK=/usr/local/ovs/var/run/openvswitch/db.sock

# yum install autoconf automake libtool numactl numactl-devel
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;编译 DPDK &lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# cd dpdk-17.11.3
# make install T=$DPDK_TARGET DESTDIR=install
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;下载 ovs，这里使用的版本是2.9.0&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# git clone https://github.com/openvswitch/ovs.git
# git checkout -b v2.9.0 v2.9.0
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;编译 ovs-dpdk&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# cd ovs
# ./boot.sh
# ./configure --prefix=/usr/local/ovs --with-dpdk=$DPDK_BUILD
# make &amp;amp;&amp;amp; make install
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;配置 hugepages&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# cat /etc/sysctl.d/hugepages.conf
# vm.nr_hugepages=8192
# sysctl -p /etc/sysctl.d/hugepages.conf
# mount -t hugetlbfs none /dev/hugepages
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;加载驱动模块，配置 dpdk 网卡&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;modprobe vfio-pci
lsmod | grep vfio
/usr/bin/chmod a+x /dev/vfio
/usr/bin/chmod 0666 /dev/vfio/*
dpdk-devbind.py -b vfio-pci ens10f1
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;启动 ovsdb-server&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# mkdir -p /usr/local/ovs/var/run/openvswitch&lt;/span&gt;
&lt;span class="c1"&gt;# /usr/local/ovs/bin/ovsdb-tool create /usr/local/ovs/etc/openvswitch/conf.db /usr/local/ovs/share/openvswitch/vswitch.ovsschema&lt;/span&gt;
&lt;span class="c1"&gt;# /usr/local/ovs/sbin/ovsdb-server --remote=punix:/usr/local/ovs/var/run/openvswitch/db.sock --remote=db:Open_vSwitch,Open_vSwitch,manager_options --pidfile --detach --monitor&lt;/span&gt;

&lt;span class="c1"&gt;# 增加 dpdk 相关配置参数&lt;/span&gt;
&lt;span class="c1"&gt;# ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-init=true&lt;/span&gt;
&lt;span class="c1"&gt;# ovs-vsctl --no-wait set Open_vSwitch . other_config:vhost-iommu-support=true&lt;/span&gt;
&lt;span class="c1"&gt;# ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-socket-mem=&amp;quot;1024,1024&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;ovs 进程核绑定，提升性能。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;查看cpu_layout:
[root@pod23-clu02-h005 ~]# ./dpdk-stable-17.11.3/usertools/cpu_layout.py 
======================================================================
Core and Socket Information (as reported by &amp;#39;/sys/devices/system/cpu&amp;#39;)
======================================================================

cores =  [0, 1, 2, 3, 4, 8, 9, 10, 11, 16, 17, 18, 19, 20, 24, 25, 26, 27]
sockets =  [0, 1]

        Socket 0        Socket 1       
        --------        --------       
Core 0  [0, 36]         [18, 54]       
Core 1  [1, 37]         [19, 55]       
Core 2  [2, 38]         [20, 56]        =&amp;gt; OVS 主进程
Core 3  [3, 39]         [21, 57]        =&amp;gt; OVS-PMD 收发包线程
Core 4  [4, 40]         [22, 58]        
Core 8  [5, 41]         [23, 59]       
Core 9  [6, 42]         [24, 60]       
Core 10 [7, 43]         [25, 61]       
Core 11 [8, 44]         [26, 62]       
Core 16 [9, 45]         [27, 63]       
Core 17 [10, 46]        [28, 64]       
Core 18 [11, 47]        [29, 65]       
Core 19 [12, 48]        [30, 66]       
Core 20 [13, 49]        [31, 67]       
Core 24 [14, 50]        [32, 68]       
Core 25 [15, 51]        [33, 69]       
Core 26 [16, 52]        [34, 70]       
Core 27 [17, 53]        [35, 71]      

# ovs-vswitchd 绑定 2号物理核
# python -c &amp;quot;print &amp;#39;%x&amp;#39; %((1&amp;lt;&amp;lt;2)|(1&amp;lt;&amp;lt;38)|(1&amp;lt;&amp;lt;20)|(1&amp;lt;&amp;lt;56))&amp;quot;
100004000100004
# ovs-vsctl --no-wait set Open_vSwitch . other_config:dpdk-lcore-mask=0x100004000100004

# OVS-PMD 绑定 3号物理核
# python -c &amp;quot;print &amp;#39;%x&amp;#39; %((1&amp;lt;&amp;lt;3)|(1&amp;lt;&amp;lt;39)|(1&amp;lt;&amp;lt;21)|(1&amp;lt;&amp;lt;57))&amp;quot;
200008000200008
# ovs-vsctl --no-wait set Open_vSwitch . other_config:pmd-cpu-mask=0x200008000200008

# 查看 ovs 配置
# ovs-vsctl list open_vswitch
_uuid               : f4bb4728-d9d6-43e9-be9a-cc8b2cdb10b1
bridges             : [7acc5f7b-3e73-4cb8-81c4-37b2a11bc0bf, e3a74062-4b05-44be-b248-09e26e5c1f24]
cur_cfg             : 65
datapath_types      : [netdev, system]
db_version          : []
external_ids        : {}
iface_types         : [dpdk, dpdkr, dpdkvhostuser, dpdkvhostuserclient, geneve, gre, internal, lisp, patch, stt, system, tap, vxlan]
manager_options     : []
next_cfg            : 65
other_config        : {dpdk-init=&amp;quot;true&amp;quot;, dpdk-lcore-mask=&amp;quot;0x100004000100004&amp;quot;, dpdk-socket-mem=&amp;quot;1024,1024&amp;quot;, pmd-cpu-mask=&amp;quot;0x200008000200008&amp;quot;, vhost-iommu-support=&amp;quot;true&amp;quot;}
ovs_version         : []
ssl                 : []
statistics          : {}
system_type         : []
system_version      : []
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;启动 ovs-vswitchd&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ovs-vswitchd unix:/usr/local/ovs/var/run/openvswitch/db.sock --pidfile --detach --log-file&lt;span class="o"&gt;=&lt;/span&gt;/var/log/openvswitch/ovs-vswitchd.log
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;二、搭建实验环境&lt;/h3&gt;
&lt;p&gt;Open vSwitch 提供了两种类型的 vhostuser 端口：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;vhost-user (dpdkvhostuser)&lt;/li&gt;
&lt;li&gt;vhost-user-client (dpdkvhostuserclient)&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;vhostuser 使用 C/S 模型。其中服务端负责创建/管理/销毁 vhostuser socket. 客户端和服务端相连接。ovs 通过配置 dpdkvhostuser 或者 dpdkvhostuserclient 来确定使用的模型。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;使用 vhostuser，OVS 作为服务端，qemu 作为客户端。这意味着如果 OVS 进程发生重启或者挂掉，则 guest vm 必须重启；&lt;/li&gt;
&lt;li&gt;使用 vhostuserclient，OVS 作为客户端，qemu 作为服务端，这就意味着 OVS 可以毫无问题地挂掉或者重启。该功能需要满足 QEMU&amp;gt;=2.7.0。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;推荐使用 vhostuserclient。以下实践也会以 vhostuserclient 为例。使用该功能 ovs 需要做如下配置才会支持：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# ovs-vsctl set Open_vSwitch . other_config:vhost-iommu-support=true&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;2.1. 创建 OVS 网桥和端口&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ovs-vsctl add-br br0 -- &lt;span class="nb"&gt;set&lt;/span&gt; bridge br0 &lt;span class="nv"&gt;datapath_type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;netdev    &lt;span class="c1"&gt;# 使用 ovs-dpdk 必须指定datapath_type类型为netdev&lt;/span&gt;
ovs-vsctl add-br br1 -- &lt;span class="nb"&gt;set&lt;/span&gt; bridge br1 &lt;span class="nv"&gt;datapath_type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;netdev
ovs-vsctl add-port br0 dpdkvhostuserclient0  -- &lt;span class="nb"&gt;set&lt;/span&gt; Interface dpdkvhostuserclient0 &lt;span class="nv"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;dpdkvhostuserclient options:vhost-server-path&lt;span class="o"&gt;=&lt;/span&gt;/tmp/vhostuserclient0.sock
ovs-vsctl add-port br0 dpdkvhostuserclient1  -- &lt;span class="nb"&gt;set&lt;/span&gt; Interface dpdkvhostuserclient1 &lt;span class="nv"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;dpdkvhostuserclient options:vhost-server-path&lt;span class="o"&gt;=&lt;/span&gt;/tmp/vhostuserclient1.sock
ovs-vsctl add-port br0 dpdk0 -- &lt;span class="nb"&gt;set&lt;/span&gt; interface dpdk0 &lt;span class="nv"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;dpdk options:dpdk-devargs&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;0000&lt;/span&gt;:03:00.0
ovs-vsctl add-port br1 dpdk1 -- &lt;span class="nb"&gt;set&lt;/span&gt; interface dpdk1 &lt;span class="nv"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;dpdk options:dpdk-devargs&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;0000&lt;/span&gt;:03:00.1
ovs-vsctl &lt;span class="nb"&gt;set&lt;/span&gt; Interface dpdkvhostuserclient0 options:n_rxq&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;
ovs-vsctl &lt;span class="nb"&gt;set&lt;/span&gt; Interface dpdkvhostuserclient1 options:n_rxq&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;
vs-vsctl &lt;span class="nb"&gt;set&lt;/span&gt; Interface dpdk0 options:n_rxq&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;
vs-vsctl &lt;span class="nb"&gt;set&lt;/span&gt; Interface dpdk1 options:n_rxq&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;查看以上配置：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;root@pod23-clu02-h005 ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# ovs-vsctl show&lt;/span&gt;
f4bb4728-d9d6-43e9-be9a-cc8b2cdb10b1
    Bridge &lt;span class="s2"&gt;&amp;quot;br0&amp;quot;&lt;/span&gt;
        Port &lt;span class="s2"&gt;&amp;quot;br0&amp;quot;&lt;/span&gt;
            Interface &lt;span class="s2"&gt;&amp;quot;br0&amp;quot;&lt;/span&gt;
                type: internal
        Port &lt;span class="s2"&gt;&amp;quot;dpdkvhostuserclient0&amp;quot;&lt;/span&gt;
            Interface &lt;span class="s2"&gt;&amp;quot;dpdkvhostuserclient0&amp;quot;&lt;/span&gt;
                type: dpdkvhostuserclient
                options: &lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="nv"&gt;n_rxq&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;2&amp;quot;&lt;/span&gt;, vhost-server-path&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;/tmp/vhostuserclient0.sock&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;
        Port &lt;span class="s2"&gt;&amp;quot;dpdk0&amp;quot;&lt;/span&gt;
            Interface &lt;span class="s2"&gt;&amp;quot;dpdk0&amp;quot;&lt;/span&gt;
                type: dpdk
                options: &lt;span class="o"&gt;{&lt;/span&gt;dpdk-devargs&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;0000:03:00.0&amp;quot;&lt;/span&gt;, &lt;span class="nv"&gt;n_rxq&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;2&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;
    Bridge &lt;span class="s2"&gt;&amp;quot;br1&amp;quot;&lt;/span&gt;
        Port &lt;span class="s2"&gt;&amp;quot;br1&amp;quot;&lt;/span&gt;
            Interface &lt;span class="s2"&gt;&amp;quot;br1&amp;quot;&lt;/span&gt;
                type: internal
        Port &lt;span class="s2"&gt;&amp;quot;dpdk1&amp;quot;&lt;/span&gt;
            Interface &lt;span class="s2"&gt;&amp;quot;dpdk1&amp;quot;&lt;/span&gt;
                type: dpdk
                options: &lt;span class="o"&gt;{&lt;/span&gt;dpdk-devargs&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;0000:03:00.1&amp;quot;&lt;/span&gt;, &lt;span class="nv"&gt;n_rxq&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;2&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;
        Port &lt;span class="s2"&gt;&amp;quot;dpdkvhostuserclient1&amp;quot;&lt;/span&gt;
            Interface &lt;span class="s2"&gt;&amp;quot;dpdkvhostuserclient1&amp;quot;&lt;/span&gt;
                type: dpdkvhostuserclient
                options: &lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="nv"&gt;n_rxq&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;2&amp;quot;&lt;/span&gt;, vhost-server-path&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;/tmp/vhostuserclient1.sock&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;2.2 创建虚拟机&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;1. 配置共享内存&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;vhost-user 基于 vring 这套通用的共享内存通信方案，通过共享的虚拟队列来完成报文的传输和控制，因此大大降低了 vhost 和 virtio-net 之间的数据传输成本。使用该机制 QEMU 必须将 vm 的部分内存分配给 hugetlbfs， vhost-user 端口在访问 virtio-net 设备的 vring 和数据包缓冲区，会将 vm 的物理内存映射到 hugetlbfs 上。 要使 vhost-user 端口能够将 VM 的内存映射到其进程地址空间，我们需要配置共享内存和大页内存。否则会造成网络不通，流量出不去也进不来。&lt;/p&gt;
&lt;p&gt;以上配置在 libvirt xml 中体现如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;  &lt;span class="nt"&gt;&amp;lt;memoryBacking&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;hugepages&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;page&lt;/span&gt; &lt;span class="na"&gt;size=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;2048&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;unit=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;KiB&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;nodeset=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;0&amp;#39;&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;/hugepages&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;/memoryBacking&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;cpu&lt;/span&gt; &lt;span class="na"&gt;mode=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;host-passthrough&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;check=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;none&amp;#39;&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;topology&lt;/span&gt; &lt;span class="na"&gt;sockets=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;1&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;cores=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;2&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;threads=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;2&amp;#39;&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;numa&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;cell&lt;/span&gt; &lt;span class="na"&gt;id=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;0&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;cpus=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;0-3&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;memory=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;6291456&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;unit=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;KiB&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;memAccess=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;shared&amp;#39;&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt; 
    &lt;span class="nt"&gt;&amp;lt;/numa&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;/cpu&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;在 qemu 进程中体现在 &lt;code&gt;mem-path=/dev/hugepages,share=on&lt;/code&gt;， 如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# /usr/libexec/qemu-kvm -name guest=wangyuwei-test -enable-kvm -m 4096 -smp 8,sockets=2,cores=2,threads=2 -chardev socket,id=char0,path=/usr/local/ovs/var/run/openvswitch/dpdkvhostuser0 -netdev type=vhost-user,id=mynet1,chardev=char0,vhostforce -device virtio-net-pci,netdev=mynet1,mac=52:54:00:02:d9:05 -object memory-backend-file,id=mem,size=4096M,mem-path=/dev/hugepages,share=on -numa node,memdev=mem
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;指定 &lt;code&gt;hugepages&lt;/code&gt; 意味着 qemu 会在 guest OS 的内存中创建一个文件，&lt;code&gt;memAccess='shared'&lt;/code&gt; 选项允许其他进程访问这个文件，也就意味着能访问 guest OS 内存，达到共享内存的目的。&lt;/p&gt;
&lt;p&gt;当 qemu 启动之后，首先会进行 vring 的初始化，并通过 socket 建立 C/S 的共享内存区域和事件机制，然后 client 通过 eventfd 将 virtio kick 事件通知到 server 端，server 端同样通过 eventfd 进行响应，完成整个数据交互。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2. 配置 vhostuser 通信接口&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;在上面提到过，使用 vhostuserclient 时将 qemu 作为服务端，所以 xml 中配置 mode 时必须指定为&lt;code&gt;server&lt;/code&gt;，否则无法建立连接。&lt;/p&gt;
&lt;p&gt;libvirt interface xml 体现如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;    &lt;span class="nt"&gt;&amp;lt;interface&lt;/span&gt; &lt;span class="na"&gt;type=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;vhostuser&amp;#39;&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;mac&lt;/span&gt; &lt;span class="na"&gt;address=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;52:54:00:1f:9f:66&amp;#39;&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;source&lt;/span&gt; &lt;span class="na"&gt;type=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;unix&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;path=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;/tmp/vhostuserclient0.sock&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;mode=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;server&amp;#39;&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;model&lt;/span&gt; &lt;span class="na"&gt;type=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;virtio&amp;#39;&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;driver&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;vhost&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;queues=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;2&amp;#39;&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;lt;host&lt;/span&gt; &lt;span class="na"&gt;mrg_rxbuf=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;off&amp;#39;&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;/driver&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;address&lt;/span&gt; &lt;span class="na"&gt;type=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;pci&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;domain=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;0x0000&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;bus=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;0x00&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;slot=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;0x03&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;function=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;0x0&amp;#39;&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;/interface&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;interface&lt;/span&gt; &lt;span class="na"&gt;type=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;vhostuser&amp;#39;&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;mac&lt;/span&gt; &lt;span class="na"&gt;address=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;52:54:00:1f:9f:67&amp;#39;&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;source&lt;/span&gt; &lt;span class="na"&gt;type=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;unix&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;path=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;/tmp/vhostuserclient1.sock&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;mode=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;server&amp;#39;&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;model&lt;/span&gt; &lt;span class="na"&gt;type=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;virtio&amp;#39;&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;driver&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;vhost&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;queues=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;2&amp;#39;&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
        &lt;span class="nt"&gt;&amp;lt;host&lt;/span&gt; &lt;span class="na"&gt;mrg_rxbuf=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;off&amp;#39;&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;/driver&amp;gt;&lt;/span&gt;
      &lt;span class="nt"&gt;&amp;lt;address&lt;/span&gt; &lt;span class="na"&gt;type=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;pci&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;domain=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;0x0000&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;bus=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;0x00&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;slot=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;0x07&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;function=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;0x0&amp;#39;&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;/interface&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;三、测试过程&lt;/h3&gt;
&lt;h4&gt;3.1 测试拓扑&lt;/h4&gt;
&lt;p&gt;测试使用的拓扑图如下：&lt;/p&gt;
&lt;p&gt;&lt;img alt="image" src="/images/network/ovs-dpdk-1.png"&gt;&lt;/p&gt;
&lt;p&gt;使用 dpdkgen 的 p0 作为发包端口，p1 作为收包端口。&lt;/p&gt;
&lt;p&gt;配置 6wind:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;eth0&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mf"&gt;10.0&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="mf"&gt;0.1&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;24&lt;/span&gt;
&lt;span class="n"&gt;eth1&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mf"&gt;20.0&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="mf"&gt;0.1&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;24&lt;/span&gt;
&lt;span class="kd"&gt;static&lt;/span&gt; &lt;span class="n"&gt;neighbor&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mf"&gt;20.0&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="mf"&gt;0.2&lt;/span&gt; &lt;span class="o"&gt;-&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;p1&lt;/span&gt; &lt;span class="n"&gt;mac&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;发包端口配置如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;Pktgen&amp;gt; &lt;span class="nb"&gt;set&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; src ip &lt;span class="m"&gt;10&lt;/span&gt;.0.0.2/24            &lt;span class="c1"&gt;# 配置 p0 源 ip 地址为 10.0.0.2/24 &lt;/span&gt;
Pktgen&amp;gt; &lt;span class="nb"&gt;set&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; src mac &lt;span class="m"&gt;90&lt;/span&gt;:e2:ba:f7:58:58     &lt;span class="c1"&gt;# 配置 p0 源 mac 地址为 90:e2:ba:f7:58:58&lt;/span&gt;
Pktgen&amp;gt; &lt;span class="nb"&gt;set&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; dst ip &lt;span class="m"&gt;20&lt;/span&gt;.0.0.2               &lt;span class="c1"&gt;# 配置 p0 目的 ip 地址为 20.0.0.2&lt;/span&gt;
Pktgen&amp;gt; &lt;span class="nb"&gt;set&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; dst mac &lt;span class="m"&gt;52&lt;/span&gt;:54:00:1f:9f:66     &lt;span class="c1"&gt;# 配置 p0 目的 mac 地址为 6wind 的 eth0 的 mac 地址&lt;/span&gt;
Pktgen&amp;gt; &lt;span class="nb"&gt;set&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; size &lt;span class="m"&gt;64&lt;/span&gt;
Pktgen&amp;gt; &lt;span class="nb"&gt;enable&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; range
Pktgen&amp;gt; range &lt;span class="m"&gt;0&lt;/span&gt; size max &lt;span class="m"&gt;64&lt;/span&gt;
Pktgen&amp;gt; &lt;span class="nb"&gt;set&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; proto udp
Pktgen&amp;gt; &lt;span class="nb"&gt;set&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; rate &lt;span class="m"&gt;10&lt;/span&gt;%
Pktgen&amp;gt; start &lt;span class="m"&gt;0&lt;/span&gt; 
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;3.2 测试结果&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;将发包字节设置为64字节，发包速率设置10%时，几乎不存在丢包现象。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img alt="image" src="/images/network/ovs-dpdk-2.png"&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;将p0发包速率设置20%时，存在丢包现象。将p1发包速率设置为15%，收发数据差不多。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img alt="image" src="/images/network/ovs-dpdk-3.png"&gt;&lt;/p&gt;</content></entry><entry><title>Pktgen-DPDK 网络性能测试</title><link href="https://andiaq.github.io/posts/2018/08/20/pktgen-dpdk.html" rel="alternate"></link><published>2018-08-20T09:51:00+08:00</published><updated>2018-08-20T09:51:00+08:00</updated><author><name>Yuwei Wang</name></author><id>tag:andiaq.github.io,2018-08-20:/posts/2018/08/20/pktgen-dpdk.html</id><summary type="html">&lt;p&gt;在未使用该工具之前，一直使用的是 iperf 在 10G 网卡场景下进行 64 字节小包性能测试。若要将 64 字节小包流量发到限速，要么一直增加 iperf 客户端，或者在一个高配 iperf 客户端虚拟机中不断的增加 iperf 进程。即使是这样，将发包达到网卡上限，却依然无法利用好 6wind 的性能。所以考虑使用 DPDK-pktgen 发包工具。该工具基于 DPDK 快速报文处里框架开发，以内核模块的形式存在于系统。&lt;/p&gt;
&lt;h2&gt;一、环境部署&lt;/h2&gt;
&lt;h3&gt;1.1 安装DPDK&lt;/h3&gt;
&lt;p&gt;DPDK 可以将用户态的数据不经过内核直接转发到网卡，同样网卡数据也不经过内核直接映射到用户态内存实现加速目的。&lt;/p&gt;
&lt;p&gt;使用 pktgen-dpdk 工具，需要先安装 DPDK 环境。下面内容以 18.05 版本的 DPDK …&lt;/p&gt;</summary><content type="html">&lt;p&gt;在未使用该工具之前，一直使用的是 iperf 在 10G 网卡场景下进行 64 字节小包性能测试。若要将 64 字节小包流量发到限速，要么一直增加 iperf 客户端，或者在一个高配 iperf 客户端虚拟机中不断的增加 iperf 进程。即使是这样，将发包达到网卡上限，却依然无法利用好 6wind 的性能。所以考虑使用 DPDK-pktgen 发包工具。该工具基于 DPDK 快速报文处里框架开发，以内核模块的形式存在于系统。&lt;/p&gt;
&lt;h2&gt;一、环境部署&lt;/h2&gt;
&lt;h3&gt;1.1 安装DPDK&lt;/h3&gt;
&lt;p&gt;DPDK 可以将用户态的数据不经过内核直接转发到网卡，同样网卡数据也不经过内核直接映射到用户态内存实现加速目的。&lt;/p&gt;
&lt;p&gt;使用 pktgen-dpdk 工具，需要先安装 DPDK 环境。下面内容以 18.05 版本的 DPDK 为例进行简要介绍。获取安装包地址请移步：&lt;a href="http://core.dpdk.org/download/"&gt;DPDK Download&lt;/a&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;添加环境变量。这里把环境变量添加到 &lt;code&gt;/root/.bashrc&lt;/code&gt;，使环境变量永久生效。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nb"&gt;export&lt;/span&gt; &lt;span class="nv"&gt;RTE_SDK&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&amp;lt;DPDKInstallDir&amp;gt;
&lt;span class="nb"&gt;export&lt;/span&gt; &lt;span class="nv"&gt;RTE_TARGET&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;x86_64-native-linuxapp-gcc
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;安装所需依赖包。需要注意 kernel 相关安装包版本必须要和操作系统内核版本一致，否则会出现安装失败。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# yum install gcc-c++ gcc glib-devel numactl-devel numactl-libs &lt;/span&gt;
&lt;span class="c1"&gt;# yum install kernel-headers kernel-devel&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;使用脚本安装 DPDK 环境。具体每一步这里不详细描述，可参考其他资料。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;root@vm1 ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# cd dpdk-18.05&lt;/span&gt;
&lt;span class="o"&gt;[&lt;/span&gt;root@vm1 dpdk-18.05&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# ./usertools/dpdk-setup.sh&lt;/span&gt;

&lt;span class="c1"&gt;# 需执行的步骤如下&lt;/span&gt;
&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;15&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; x86_64-native-linuxapp-gcc                     &lt;span class="c1"&gt;# 下载环境&lt;/span&gt;
&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;18&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; Insert IGB UIO module                          &lt;span class="c1"&gt;# 加载igb_uio驱动&lt;/span&gt;
&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;21&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; Setup hugepage mappings &lt;span class="k"&gt;for&lt;/span&gt; non-NUMA systems   &lt;span class="c1"&gt;# 配置大页内存&lt;/span&gt;
&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;24&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; Bind Ethernet/Crypto device to IGB UIO module  &lt;span class="c1"&gt;# 绑定要使用DPDK的网卡&lt;/span&gt;

&lt;span class="c1"&gt;# 查看配置信息&lt;/span&gt;
&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;23&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; Display current Ethernet/Crypto device settings
&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;29&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; List hugepage info from /proc/meminfo
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;1.2 安装 pktgen-dpdk&lt;/h3&gt;
&lt;p&gt;下面简单介绍该工具的安装步骤。获取安装包请移步：&lt;a href="http://git.dpdk.org/apps/pktgen-dpdk"&gt;pktgen-dpdk&lt;/a&gt;
1. 环境编译。在编译结束之后，目录&lt;code&gt;app/build/pktgen&lt;/code&gt;就是编译出来的程序。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;[root@vm1 ~]# cd pktgen-dpdk
[root@vm1 pktgen-dpdk]# make
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;在安装过程中若出现如下错误，需要给 lua 源码打 patch。
错误信息如下：&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;No rule to make target `/root/pktgen-dpdk-pktgen-3.5.1/app/../lib/lua/src/x86_64-native-linuxapp-gcc/lib/librte_lua.a&amp;#39;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;解决办法：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;[root@vm1 lua]# pwd
/root/pktgen-dpdk/lib/lua
[root@wangyuwei-1 lua]# patch -p0 &amp;lt; lua-5.3.4.patch   安装补丁
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;二、测试过程&lt;/h2&gt;
&lt;p&gt;学会使用一个工具最好的方式就是通过 help 查看帮助文档。这里不对使用方式进行详细说明，将只介绍在之后测试中我使用到的参数。&lt;/p&gt;
&lt;h3&gt;2.1  网卡之间互打流量&lt;/h3&gt;
&lt;p&gt;以该测试为例，对使用 pktgen-dpdk 工具先产生感性认识，比较容易理解该工具的主要功能和基本的使用方式。然后再通过编写 lua 脚本构造数据包，实现自己真正需要测试的内容和获取的信息结果。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;环境说明：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;使用 SRIOV 配置多个 VF 网卡，将其中的三个 VF 网卡配置给虚拟机，一个 VF 绑定可访问的 ip 地址，将另外两个 VF 绑定为使用 igb_uio 驱动。&lt;/p&gt;
&lt;p&gt;另外，使用 pktgen-dpdk 管理的网卡内核是看不到的，所以无法使用 ip command 对其进行查看或者操作。事实上，作为 traffic gen 也没有必要配置接口 ip 地址。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;测试脚本&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# ./app/build/pktgen -l 2-10 -n 4 --proc-type auto --socket-mem 1024 -- -P -m &amp;quot;[3-4:5-6].0,[7-8:9-10].1&amp;quot; -f themes/black-yellow.theme
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;执行结果&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img alt="image" src="/images/network/pktgen-dpdk-1.png"&gt;&lt;/p&gt;
&lt;p&gt;以上结果符合预期，Port 0 进行发包，Port 1 进行收包。这两个网卡属于同一块物理网卡的 VF ，所以万兆网卡带宽进行了均分。&lt;/p&gt;
&lt;h4&gt;2.2. 虚拟机与 NAT 网关互打流量&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;环境说明：&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;在物理机 Host01 上，使用 PCI passthrough 将两个物理网卡透传给虚拟机 DPDKGEN vm1 。进入虚拟机，将两个物理网卡配置成 DPDK 驱动。&lt;/li&gt;
&lt;li&gt;在物理机 Host02 上，使用 PCI passthrough 将两个物理网卡透传给虚拟机 6wind，进行如下配置。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# 1. 配置ip地址
6wind:
    ens3: 10.0.0.1
    ens7: 20.0.0.1

# 2. 配置arp，将发包机指定的目的ip地址与dpdkgen p1 mac地址进行绑定
root@router:~# arp -n
Address                  HWtype  HWaddress           Flags Mask            Iface
20.0.0.2                 ether   90:e2:ba:f7:58:59   CM                    eth1
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;测试拓扑图：&lt;/p&gt;
&lt;p&gt;&lt;img alt="image" src="/images/network/pktgen-dpdk-2.png"&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;测试脚本&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# ./app/build/pktgen -l 2-10 -n 4 --proc-type auto --socket-mem 1024 -- -P -m &amp;quot;[3-4:5-6].0,[7-8,9-10].1&amp;quot;

Pktgen:/&amp;gt; set 0 src ip 10.0.0.2/24              # 虚拟一个与6wind ens3 同网段的ip地址
Pktgen:/&amp;gt; set 0 src mac 90:e2:ba:f7:58:58       # dpdkgen p0 mac 地址
Pktgen:/&amp;gt; set 0 dst ip 20.0.0.2                 # 虚拟一个与6wind ens7 同网段的ip地址，注意做arp配置
Pktgen:/&amp;gt; set 0 dst mac 90:e2:ba:f7:53:10       # 6wind ens3 mac 地址
Pktgen:/&amp;gt; set 0 proto udp                       # 配置64字节udp数据包
Pktgen:/&amp;gt; set 0 size 64
Pktgen:/&amp;gt; start 0
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;执行结果&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;6wind cpu 利用率：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;root@router:~# fp-cpu-usage 
Fast path CPU usage:
cpu: %busy     cycles   cycles/packet   cycles/ic pkt
  1:   &amp;lt;1%     156790            8537               0
  2:  100%  458889164             209               0
  3:   &amp;lt;1%      75228            5761               0
average cycles/packets received from NIC: 209 (458989044/2186254)
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;dpdkgen结果如下：&lt;/p&gt;
&lt;p&gt;&lt;img alt="image" src="/images/network/pktgen-dpdk-2.png"&gt;&lt;/p&gt;
&lt;p&gt;从以上结果可以看到，在使用 6wind 一个 core 情况下，64 字节线速发包能力为 9914Mbps ，包转发性能为 14Mpps，接近物理网卡极限。&lt;/p&gt;</content></entry><entry><title>6wind 配置 SRIOV</title><link href="https://andiaq.github.io/posts/2018/08/14/6wind-sriov.html" rel="alternate"></link><published>2018-08-14T09:34:00+08:00</published><updated>2018-08-14T09:34:00+08:00</updated><author><name>Yuwei Wang</name></author><id>tag:andiaq.github.io,2018-08-14:/posts/2018/08/14/6wind-sriov.html</id><summary type="html">&lt;p&gt;本文主要是介绍 6wind 配置 SRIOV 相关过程，在测试过程中进行学习，先产生感性认识，后期更深入了解原理后补充。&lt;/p&gt;
&lt;h3&gt;一、前置条件&lt;/h3&gt;
&lt;p&gt;SRIOV 功能需宿主机开启 VT-d 和 IOMMU 功能。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;VT-d 验证。判断 CPU 是否支持 vt 功能，对于 intel CPU，验证方式如下，如果有结果，则支持。判断 VT 功能是否开启，可以执行 kvm-ok 命令或者查看 /dev/kvm 是否存在。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# grep &amp;quot;vmx&amp;quot; /proc/cpuinfo
# kvm-ok
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;开启 IOMMU，配置验证如下：&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# vim /etc/default/grub …&lt;/pre&gt;&lt;/div&gt;</summary><content type="html">&lt;p&gt;本文主要是介绍 6wind 配置 SRIOV 相关过程，在测试过程中进行学习，先产生感性认识，后期更深入了解原理后补充。&lt;/p&gt;
&lt;h3&gt;一、前置条件&lt;/h3&gt;
&lt;p&gt;SRIOV 功能需宿主机开启 VT-d 和 IOMMU 功能。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;VT-d 验证。判断 CPU 是否支持 vt 功能，对于 intel CPU，验证方式如下，如果有结果，则支持。判断 VT 功能是否开启，可以执行 kvm-ok 命令或者查看 /dev/kvm 是否存在。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# grep &amp;quot;vmx&amp;quot; /proc/cpuinfo
# kvm-ok
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;开启 IOMMU，配置验证如下：&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# vim /etc/default/grub 
...
GRUB_CMDLINE_LINUX=&amp;quot;crashkernel=auto rhgb quiet intel_iommu=on&amp;quot;    # 添加intel_iommu=on
...
# grub2-mkconfig -o /boot/grub2/grub.cfg 更新内核参数
# reboot 重启使更改的参数生效
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;二、SRIOV 配置&lt;/h3&gt;
&lt;p&gt;以下是 SRIOV 配置过程，如果需要以下配置参数永久生效，需要将设置命令行加入开启启动脚本。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;root@localhost ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# modprobe ixgbe max_vfs=2&lt;/span&gt;
&lt;span class="c1"&gt;# 查看网卡可支持的最大VF数&lt;/span&gt;
&lt;span class="o"&gt;[&lt;/span&gt;root@localhost ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# cat /sys/class/net/ens10f0/device/sriov_totalvfs&lt;/span&gt;
&lt;span class="m"&gt;63&lt;/span&gt;
&lt;span class="c1"&gt;# 查看网卡当前的VF数&lt;/span&gt;
&lt;span class="o"&gt;[&lt;/span&gt;root@localhost ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# cat /sys/class/net/ens10f0/device/sriov_numvfs&lt;/span&gt;
&lt;span class="m"&gt;0&lt;/span&gt;
&lt;span class="c1"&gt;# 配置ens10f0网卡VF数为2&lt;/span&gt;
&lt;span class="o"&gt;[&lt;/span&gt;root@localhost ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# echo 2 &amp;gt; /sys/class/net/ens10f0/device/sriov_numvfs&lt;/span&gt;

&lt;span class="c1"&gt;# 查看当前的物理网卡和VF设备， 可以看到VF为03:10.0，03:10.2&lt;/span&gt;
&lt;span class="o"&gt;[&lt;/span&gt;root@localhost ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# lspci  | grep Eth&lt;/span&gt;
&lt;span class="m"&gt;01&lt;/span&gt;:00.0 Ethernet controller: Intel Corporation 82599ES &lt;span class="m"&gt;10&lt;/span&gt;-Gigabit SFI/SFP+ Network Connection &lt;span class="o"&gt;(&lt;/span&gt;rev &lt;span class="m"&gt;01&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;01&lt;/span&gt;:00.1 Ethernet controller: Intel Corporation 82599ES &lt;span class="m"&gt;10&lt;/span&gt;-Gigabit SFI/SFP+ Network Connection &lt;span class="o"&gt;(&lt;/span&gt;rev &lt;span class="m"&gt;01&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;03&lt;/span&gt;:00.0 Ethernet controller: Intel Corporation 82599ES &lt;span class="m"&gt;10&lt;/span&gt;-Gigabit SFI/SFP+ Network Connection &lt;span class="o"&gt;(&lt;/span&gt;rev &lt;span class="m"&gt;01&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;03&lt;/span&gt;:00.1 Ethernet controller: Intel Corporation 82599ES &lt;span class="m"&gt;10&lt;/span&gt;-Gigabit SFI/SFP+ Network Connection &lt;span class="o"&gt;(&lt;/span&gt;rev &lt;span class="m"&gt;01&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;03&lt;/span&gt;:10.0 Ethernet controller: Intel Corporation &lt;span class="m"&gt;82599&lt;/span&gt; Ethernet Controller Virtual Function &lt;span class="o"&gt;(&lt;/span&gt;rev &lt;span class="m"&gt;01&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;03&lt;/span&gt;:10.2 Ethernet controller: Intel Corporation &lt;span class="m"&gt;82599&lt;/span&gt; Ethernet Controller Virtual Function &lt;span class="o"&gt;(&lt;/span&gt;rev &lt;span class="m"&gt;01&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;三、6wind 配置&lt;/h3&gt;
&lt;p&gt;若要获取最佳性能，需要将 6wind 的 vcpu 与物理机的 cpu 进行绑定，且绑定的物理 cpu 需要在同一个物理 socket 上。另外，6wind 使用的物理网卡也需要在与其使用的 cpu 所在的 socket 相同。&lt;/p&gt;
&lt;h4&gt;3.1. 6wind vcpu 绑定&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;查看物理机 cpu 信息，这里我们使用 numa node0 上的物理 cpu，将其分配给 6wind 虚拟机。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;[root@localhost ~]# lscpu
Architecture:          x86_64
CPU op-mode(s):        32-bit, 64-bit
Byte Order:            Little Endian
CPU(s):                72
On-line CPU(s) list:   0-71
Thread(s) per core:    2
Core(s) per socket:    18
Socket(s):             2
NUMA node(s):          2
Vendor ID:             GenuineIntel
CPU family:            6
Model:                 79
Model name:            Intel(R) Xeon(R) CPU E5-2697 v4 @ 2.30GHz
Stepping:              1
CPU MHz:               3599.949
BogoMIPS:              4595.21
Virtualization:        VT-x
L1d cache:             32K
L1i cache:             32K
L2 cache:              256K
L3 cache:              46080K
NUMA node0 CPU(s):     0-17,36-53
NUMA node1 CPU(s):     18-35,54-71
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;配置 6wind cpu 绑定，xml 添加如下配置：&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;  &lt;span class="nt"&gt;&amp;lt;cputune&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;vcpupin&lt;/span&gt; &lt;span class="na"&gt;vcpu=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;0&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;cpuset=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;36&amp;#39;&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;vcpupin&lt;/span&gt; &lt;span class="na"&gt;vcpu=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;1&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;cpuset=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;37&amp;#39;&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;/cputune&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;3.2. 6wind 网卡中断绑定&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;我们将物理网卡 ens10f1 进行 SRIOV 配置，将生成的 PCI 设备给 6wind 使用，网卡信息如下：&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;root@localhost ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# ip link show&lt;/span&gt;
&lt;span class="m"&gt;1&lt;/span&gt;: lo: &amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt; mtu &lt;span class="m"&gt;65536&lt;/span&gt; qdisc noqueue state UNKNOWN mode DEFAULT qlen &lt;span class="m"&gt;1&lt;/span&gt;
    link/loopback &lt;span class="m"&gt;00&lt;/span&gt;:00:00:00:00:00 brd &lt;span class="m"&gt;00&lt;/span&gt;:00:00:00:00:00
&lt;span class="m"&gt;2&lt;/span&gt;: ens20f0: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu &lt;span class="m"&gt;1500&lt;/span&gt; qdisc mq state UP mode DEFAULT qlen &lt;span class="m"&gt;1000&lt;/span&gt;
    link/ether d8:c4:97:0a:39:57 brd ff:ff:ff:ff:ff:ff
&lt;span class="m"&gt;3&lt;/span&gt;: ens20f1: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu &lt;span class="m"&gt;1500&lt;/span&gt; qdisc mq state UP mode DEFAULT qlen &lt;span class="m"&gt;1000&lt;/span&gt;
    link/ether d8:c4:97:0a:39:58 brd ff:ff:ff:ff:ff:ff
&lt;span class="m"&gt;4&lt;/span&gt;: ens10f0: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu &lt;span class="m"&gt;1500&lt;/span&gt; qdisc mq state UP mode DEFAULT qlen &lt;span class="m"&gt;1000&lt;/span&gt;
    link/ether &lt;span class="m"&gt;90&lt;/span&gt;:e2:ba:f7:53:10 brd ff:ff:ff:ff:ff:ff
&lt;span class="m"&gt;5&lt;/span&gt;: ens10f1: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu &lt;span class="m"&gt;1500&lt;/span&gt; qdisc mq state UP mode DEFAULT qlen &lt;span class="m"&gt;1000&lt;/span&gt;
    link/ether &lt;span class="m"&gt;90&lt;/span&gt;:e2:ba:f7:53:11 brd ff:ff:ff:ff:ff:ff
    vf &lt;span class="m"&gt;0&lt;/span&gt; MAC &lt;span class="m"&gt;00&lt;/span&gt;:00:00:00:00:00, spoof checking on, link-state auto, trust off
    vf &lt;span class="m"&gt;1&lt;/span&gt; MAC &lt;span class="m"&gt;00&lt;/span&gt;:00:00:00:00:00, spoof checking on, link-state auto, trust off

&lt;span class="o"&gt;[&lt;/span&gt;root@localhost ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# ip link set ens10f1 vf 0 mac 02:09:c0:cc:0f:8b&lt;/span&gt;
&lt;span class="o"&gt;[&lt;/span&gt;root@localhost ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# ip link set ens10f1 vf 1 mac 02:09:c0:48:95:d2&lt;/span&gt;
&lt;span class="o"&gt;[&lt;/span&gt;root@localhost ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# ip link show ens10f1&lt;/span&gt;
&lt;span class="m"&gt;5&lt;/span&gt;: ens10f1: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu &lt;span class="m"&gt;1500&lt;/span&gt; qdisc mq state UP mode DEFAULT qlen &lt;span class="m"&gt;1000&lt;/span&gt;
    link/ether &lt;span class="m"&gt;90&lt;/span&gt;:e2:ba:f7:53:11 brd ff:ff:ff:ff:ff:ff
    vf &lt;span class="m"&gt;0&lt;/span&gt; MAC &lt;span class="m"&gt;02&lt;/span&gt;:09:c0:cc:0f:8b, spoof checking on, link-state auto, trust off
    vf &lt;span class="m"&gt;1&lt;/span&gt; MAC &lt;span class="m"&gt;02&lt;/span&gt;:09:c0:48:95:d2, spoof checking on, link-state auto, trust off
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;查看 ens10f1 网卡中断绑定信息：&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;[root@localhost ~]# cat /proc/interrupts | grep ens10f1
 239:          0     117768          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0    2527729          0          0          0      76586          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      ens10f1-TxRx-0
 240:          0       2071          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0      41424          0          0          0       1445          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      ens10f1-TxRx-1
 241:          0       2473          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0      45597          0          0          0       1599          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      ens10f1-TxRx-2
 242:          0       2722          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0      51584          0          0          0       1858          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      ens10f1-TxRx-3
 243:          0        106          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0        325          0          0          0         64          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      ens10f1
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;第一列为中断号，查看中断绑定的 cpu 信息如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;[root@localhost ~]# cat /proc/irq/239/smp_affinity_list 
36
[root@localhost ~]# cat /proc/irq/240/smp_affinity_list 
37
[root@localhost ~]# cat /proc/irq/241/smp_affinity_list 
38
[root@localhost ~]# cat /proc/irq/242/smp_affinity_list 
39
[root@localhost ~]# cat /proc/irq/243/smp_affinity_list 
40
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;3.2. 配置 hugepages&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;根据分配给虚拟机的内存大小配置满足需要的 hugepages，这里我们给 6wind 分配了 6G 内存。
则HugePages_Free * Hugepagesize &amp;gt;= 6wind内存 KB 大小。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;mount -t hugetlbfs hugetlbfs /dev/hugepages
sysctl vm.nr_hugepages=4096
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;6wind hugepages 配置：&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;  &amp;lt;memoryBacking&amp;gt;
    &amp;lt;hugepages/&amp;gt;
  &amp;lt;/memoryBacking&amp;gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;开启虚拟机，查看当前 hugepages:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;root@localhost ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# cat /proc/meminfo | grep Huge&lt;/span&gt;
AnonHugePages:     &lt;span class="m"&gt;75776&lt;/span&gt; kB
HugePages_Total:    &lt;span class="m"&gt;4096&lt;/span&gt;
HugePages_Free:     &lt;span class="m"&gt;1024&lt;/span&gt;
HugePages_Rsvd:        &lt;span class="m"&gt;0&lt;/span&gt;
HugePages_Surp:        &lt;span class="m"&gt;0&lt;/span&gt;
Hugepagesize:       &lt;span class="m"&gt;2048&lt;/span&gt; kB
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;四、测试&lt;/h3&gt;
&lt;p&gt;测试过程见：Pktgen-DPDK 网络性能测试&lt;/p&gt;</content></entry><entry><title>6wind NFV 实现</title><link href="https://andiaq.github.io/posts/2018/08/06/6wind-nfv.html" rel="alternate"></link><published>2018-08-06T11:29:00+08:00</published><updated>2018-08-06T11:29:00+08:00</updated><author><name>Yuwei Wang</name></author><id>tag:andiaq.github.io,2018-08-06:/posts/2018/08/06/6wind-nfv.html</id><summary type="html">&lt;h3&gt;一、简介&lt;/h3&gt;
&lt;p&gt;NFV，即网络功能虚拟化，Network Function Virtualization。即通过使用 x86 的服务器作为物理设备，进而实现基于软件的网络功能。NFV 的实现有效地降低了网络组网中昂贵的路由器和交换机成本。通过分离硬件和软件的功能和抽象的方式，网络设备功能不再依赖于专用硬件资源，可成为新的云中的网络服务部署模式，虚拟网络元件之间的网络，基于实际业务需求自动部署，提供了灵活扩展性，故障隔离和自我愈合。&lt;/p&gt;
&lt;p&gt;NFV 的网络功能虚拟化就是将原本是物理设备的路由器，交换机，测试仪器，变成软件的形式，作为一个镜像启动，而其功能不变。在云计算的基础设施平台上，部署基于 NFV 可编程网元，这些网元不受物理设备兼容性的限制，在云计算的基础上部署虚拟网元，使得云平台的资源利用率更加充分，但同时也对组网技术提出了更高的要求。&lt;/p&gt;
&lt;p&gt;本文以 6wind 作为 NFV 虚拟网元设备，将其与基于 linuxbridge 和 vlan 实现的现有网络云平台进行结合，使用 NFV 网元实现云环境中 NAT 和安全组功能 …&lt;/p&gt;</summary><content type="html">&lt;h3&gt;一、简介&lt;/h3&gt;
&lt;p&gt;NFV，即网络功能虚拟化，Network Function Virtualization。即通过使用 x86 的服务器作为物理设备，进而实现基于软件的网络功能。NFV 的实现有效地降低了网络组网中昂贵的路由器和交换机成本。通过分离硬件和软件的功能和抽象的方式，网络设备功能不再依赖于专用硬件资源，可成为新的云中的网络服务部署模式，虚拟网络元件之间的网络，基于实际业务需求自动部署，提供了灵活扩展性，故障隔离和自我愈合。&lt;/p&gt;
&lt;p&gt;NFV 的网络功能虚拟化就是将原本是物理设备的路由器，交换机，测试仪器，变成软件的形式，作为一个镜像启动，而其功能不变。在云计算的基础设施平台上，部署基于 NFV 可编程网元，这些网元不受物理设备兼容性的限制，在云计算的基础上部署虚拟网元，使得云平台的资源利用率更加充分，但同时也对组网技术提出了更高的要求。&lt;/p&gt;
&lt;p&gt;本文以 6wind 作为 NFV 虚拟网元设备，将其与基于 linuxbridge 和 vlan 实现的现有网络云平台进行结合，使用 NFV 网元实现云环境中 NAT 和安全组功能。以及进行网络性能测试。&lt;/p&gt;
&lt;h3&gt;二、NFV 连接不同网络之间通信&lt;/h3&gt;
&lt;p&gt;在我们现有网络环境中，不同网络之间通过 vlan 进行隔离，是无法互通的。我们知道在传统网络中，如果要和一个网络通信，只要和其网关相通就可以了。假设现在有两个不同 vlan 的网络 private1 和 private2，若要使两个网络中的虚拟主机进行通信，我们使 NFV 网元作为 Instance 启动，将 NFV 虚拟路由器连接这两个子网，并将分配给它的两个网络接口的 IP 地址配置成两个网络的网关，从而使流量通过 NFV 虚拟网元，实现子网之间的流量通过这个 NFV 虚拟路由器进行转发。&lt;/p&gt;
&lt;p&gt;&lt;img alt="image" src="/images/network/6wind-nfv-1.png"&gt;&lt;/p&gt;
&lt;p&gt;下面在测试环境进行配置，以实际例子进行说明。首先配置以下三个网络，一个作为外网，两个作为内网。&lt;/p&gt;
&lt;p&gt;外网：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;vlan&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;3967&lt;/span&gt;
&lt;span class="kd"&gt;public&lt;/span&gt;&lt;span class="err"&gt;：&lt;/span&gt;&lt;span class="mf"&gt;172.32&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="mf"&gt;0.0&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;24&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;内网：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;vlan&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;3965&lt;/span&gt;
&lt;span class="n"&gt;private1&lt;/span&gt;&lt;span class="err"&gt;：&lt;/span&gt;&lt;span class="mf"&gt;12.12&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="mf"&gt;12.0&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;24&lt;/span&gt;
&lt;span class="n"&gt;vlan&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;3966&lt;/span&gt;
&lt;span class="n"&gt;private2&lt;/span&gt;&lt;span class="err"&gt;：&lt;/span&gt;&lt;span class="mf"&gt;172.16&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="mf"&gt;10.0&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;24&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;2.1 配置不同子网互通&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;使用 6wind 作为镜像创建虚拟机，添加 public, private1, private2 子网，通过 vnc 进入虚拟机，进行 ip 地址，dhcp 服务配置，具体配置在后面介绍。ip 地址配置如下：&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="mi"&gt;6&lt;/span&gt;&lt;span class="n"&gt;wind&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;ens3&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mf"&gt;172.32&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="mf"&gt;0.5&lt;/span&gt;
    &lt;span class="n"&gt;ens4&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mf"&gt;12.12&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="mf"&gt;12.1&lt;/span&gt;
    &lt;span class="n"&gt;ens5&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mf"&gt;172.16&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="mf"&gt;10.1&lt;/span&gt;
    &lt;span class="n"&gt;gateway&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mf"&gt;172.32&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="mf"&gt;0.1&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;这里为方便从外部访问 vrouter，在宿主机 br-3967 网桥上配置了 ip 地址 172.32.0.1，实现从外部宿主机访问虚拟机。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;创建 vm1，添加 private1 子网。创建 vm2，添加 private2 子网。并将两个虚拟机分别创建到不同宿主机上。虚拟机创建成功之后，通过 vnc 进入虚拟机，修改网卡配置文件通过 DHCP 获取 ip 地址。重启 network 服务，查看当前网络信息。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;vm1&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; 
    &lt;span class="n"&gt;eth0&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mf"&gt;12.12&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="mf"&gt;12.120&lt;/span&gt;
    &lt;span class="n"&gt;gateway&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mf"&gt;12.12&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="mf"&gt;12.1&lt;/span&gt;

&lt;span class="n"&gt;vm2&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;eth0&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mf"&gt;172.16&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="mf"&gt;10.100&lt;/span&gt;
    &lt;span class="n"&gt;gateway&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mf"&gt;172.16&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="mf"&gt;10.1&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;到这里为止，在 6wind 没有开启 nat 且禁用 filter 功能情况下，从 vm1 ping vm2，从vm2 ping vm1, 都能够 ping 通，结果符合预期。下面开启 filter 功能，配置 filter 规则满足以上需求。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;整体网络流量走向图如下所示：&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img alt="image" src="/images/network/6wind-nfv-1.png"&gt;&lt;/p&gt;
&lt;h4&gt;2.2 开启 filter 功能&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;打开 vrouter filter 功能，不配置任何规则，则从任何地方都无法访问路由器中所有的 ip 地址，故而虚拟机无法 ping 通自己的网关地址， 虚拟机之间也不能互通。验证结果如下，符合预期。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="cp"&gt;# 无法从宿主机ping及ssh访问vrouter&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="p"&gt;@&lt;/span&gt;&lt;span class="n"&gt;POD23&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;CLU01&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;H028&lt;/span&gt; &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="err"&gt;#&lt;/span&gt; &lt;span class="n"&gt;ping&lt;/span&gt; &lt;span class="mf"&gt;172.32.0.5&lt;/span&gt;
&lt;span class="n"&gt;PING&lt;/span&gt; &lt;span class="mf"&gt;172.32.0.5&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mf"&gt;172.32.0.5&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="mi"&gt;56&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;84&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="n"&gt;bytes&lt;/span&gt; &lt;span class="n"&gt;of&lt;/span&gt; &lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;
&lt;span class="o"&gt;^&lt;/span&gt;&lt;span class="n"&gt;C&lt;/span&gt;
&lt;span class="o"&gt;---&lt;/span&gt; &lt;span class="mf"&gt;172.32.0.5&lt;/span&gt; &lt;span class="n"&gt;ping&lt;/span&gt; &lt;span class="n"&gt;statistics&lt;/span&gt; &lt;span class="o"&gt;---&lt;/span&gt;
&lt;span class="mi"&gt;3&lt;/span&gt; &lt;span class="n"&gt;packets&lt;/span&gt; &lt;span class="n"&gt;transmitted&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="n"&gt;received&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;100&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="n"&gt;packet&lt;/span&gt; &lt;span class="n"&gt;loss&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;time&lt;/span&gt; &lt;span class="mi"&gt;1999&lt;/span&gt;&lt;span class="n"&gt;ms&lt;/span&gt;

&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="p"&gt;@&lt;/span&gt;&lt;span class="n"&gt;POD23&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;CLU01&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;H028&lt;/span&gt; &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="err"&gt;#&lt;/span&gt; &lt;span class="n"&gt;ssh&lt;/span&gt; &lt;span class="n"&gt;admin&lt;/span&gt;&lt;span class="mf"&gt;@172.32.0.5&lt;/span&gt;
&lt;span class="o"&gt;^&lt;/span&gt;&lt;span class="n"&gt;C&lt;/span&gt;

&lt;span class="cp"&gt;# 无法从 vm1 ping 通其默认网关 12.12.12.1,无法 ping 通 vm2&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;配置允许外部流量 ping 及 ssh 访问 vrouter 网关地址。使用此功能实现云环境安全组，不应开放 vrouter ssh 功能。这里配置是为了实验操作方便。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="cp"&gt;# FILTER RULES&lt;/span&gt;
&lt;span class="n"&gt;rule&lt;/span&gt; &lt;span class="mi"&gt;20000&lt;/span&gt; &lt;span class="n"&gt;processing&lt;/span&gt; &lt;span class="n"&gt;input&lt;/span&gt; &lt;span class="n"&gt;ipv4&lt;/span&gt; &lt;span class="n"&gt;protocol&lt;/span&gt; &lt;span class="n"&gt;tcp&lt;/span&gt; &lt;span class="n"&gt;from&lt;/span&gt; &lt;span class="n"&gt;any&lt;/span&gt; &lt;span class="n"&gt;to&lt;/span&gt; &lt;span class="mf"&gt;172.32.0.5&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;22&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="n"&gt;state&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;established&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="n"&gt;allow&lt;/span&gt;
&lt;span class="n"&gt;rule&lt;/span&gt; &lt;span class="mi"&gt;20010&lt;/span&gt; &lt;span class="n"&gt;processing&lt;/span&gt; &lt;span class="n"&gt;output&lt;/span&gt; &lt;span class="n"&gt;ipv4&lt;/span&gt; &lt;span class="n"&gt;protocol&lt;/span&gt; &lt;span class="n"&gt;tcp&lt;/span&gt; &lt;span class="n"&gt;from&lt;/span&gt; &lt;span class="mf"&gt;172.32.0.5&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;22&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="n"&gt;to&lt;/span&gt; &lt;span class="n"&gt;any&lt;/span&gt; &lt;span class="n"&gt;state&lt;/span&gt; &lt;span class="n"&gt;new&lt;/span&gt; &lt;span class="n"&gt;established&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="n"&gt;allow&lt;/span&gt;
&lt;span class="n"&gt;rule&lt;/span&gt; &lt;span class="mi"&gt;20020&lt;/span&gt; &lt;span class="n"&gt;ipv4&lt;/span&gt; &lt;span class="n"&gt;protocol&lt;/span&gt; &lt;span class="n"&gt;icmp&lt;/span&gt; &lt;span class="n"&gt;echo&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;request&lt;/span&gt; &lt;span class="n"&gt;from&lt;/span&gt; &lt;span class="n"&gt;any&lt;/span&gt; &lt;span class="n"&gt;to&lt;/span&gt; &lt;span class="mf"&gt;172.32.0.5&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="n"&gt;allow&lt;/span&gt;
&lt;span class="n"&gt;rule&lt;/span&gt; &lt;span class="mi"&gt;20030&lt;/span&gt; &lt;span class="n"&gt;ipv4&lt;/span&gt; &lt;span class="n"&gt;protocol&lt;/span&gt; &lt;span class="n"&gt;icmp&lt;/span&gt; &lt;span class="n"&gt;echo&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;reply&lt;/span&gt; &lt;span class="n"&gt;from&lt;/span&gt; &lt;span class="mf"&gt;172.32.0.5&lt;/span&gt; &lt;span class="n"&gt;to&lt;/span&gt; &lt;span class="n"&gt;any&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; &lt;span class="n"&gt;allow&lt;/span&gt;

&lt;span class="cp"&gt;# 验证如下&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="p"&gt;@&lt;/span&gt;&lt;span class="n"&gt;POD23&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;CLU01&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;H028&lt;/span&gt; &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="err"&gt;#&lt;/span&gt; &lt;span class="n"&gt;ping&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;c&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt; &lt;span class="mf"&gt;172.32.0.5&lt;/span&gt;
&lt;span class="n"&gt;PING&lt;/span&gt; &lt;span class="mf"&gt;172.32.0.5&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mf"&gt;172.32.0.5&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="mi"&gt;56&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;84&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="n"&gt;bytes&lt;/span&gt; &lt;span class="n"&gt;of&lt;/span&gt; &lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;
&lt;span class="mi"&gt;64&lt;/span&gt; &lt;span class="n"&gt;bytes&lt;/span&gt; &lt;span class="n"&gt;from&lt;/span&gt; &lt;span class="mf"&gt;172.32.0.5&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;icmp_seq&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="n"&gt;ttl&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;64&lt;/span&gt; &lt;span class="n"&gt;time&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mf"&gt;0.164&lt;/span&gt; &lt;span class="n"&gt;ms&lt;/span&gt;
&lt;span class="mi"&gt;64&lt;/span&gt; &lt;span class="n"&gt;bytes&lt;/span&gt; &lt;span class="n"&gt;from&lt;/span&gt; &lt;span class="mf"&gt;172.32.0.5&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;icmp_seq&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt; &lt;span class="n"&gt;ttl&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;64&lt;/span&gt; &lt;span class="n"&gt;time&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mf"&gt;0.162&lt;/span&gt; &lt;span class="n"&gt;ms&lt;/span&gt;

&lt;span class="o"&gt;---&lt;/span&gt; &lt;span class="mf"&gt;172.32.0.5&lt;/span&gt; &lt;span class="n"&gt;ping&lt;/span&gt; &lt;span class="n"&gt;statistics&lt;/span&gt; &lt;span class="o"&gt;---&lt;/span&gt;
&lt;span class="mi"&gt;2&lt;/span&gt; &lt;span class="n"&gt;packets&lt;/span&gt; &lt;span class="n"&gt;transmitted&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt; &lt;span class="n"&gt;received&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="n"&gt;packet&lt;/span&gt; &lt;span class="n"&gt;loss&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;time&lt;/span&gt; &lt;span class="mi"&gt;999&lt;/span&gt;&lt;span class="n"&gt;ms&lt;/span&gt;
&lt;span class="n"&gt;rtt&lt;/span&gt; &lt;span class="n"&gt;min&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;avg&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;max&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;mdev&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mf"&gt;0.162&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mf"&gt;0.163&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mf"&gt;0.164&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mf"&gt;0.001&lt;/span&gt; &lt;span class="n"&gt;ms&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="p"&gt;@&lt;/span&gt;&lt;span class="n"&gt;POD23&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;CLU01&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;H028&lt;/span&gt; &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="err"&gt;#&lt;/span&gt; &lt;span class="n"&gt;ssh&lt;/span&gt; &lt;span class="n"&gt;admin&lt;/span&gt;&lt;span class="mf"&gt;@172.32.0.5&lt;/span&gt;
&lt;span class="n"&gt;admin&lt;/span&gt;&lt;span class="mf"&gt;@172.32.0.5&lt;/span&gt;&lt;span class="err"&gt;&amp;#39;&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="nl"&gt;password&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; 
&lt;span class="n"&gt;Welcome&lt;/span&gt; &lt;span class="n"&gt;to&lt;/span&gt; &lt;span class="n"&gt;Turbo&lt;/span&gt; &lt;span class="n"&gt;Router&lt;/span&gt; &lt;span class="n"&gt;Embedded&lt;/span&gt; &lt;span class="n"&gt;Edition&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;EE&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="mf"&gt;1.6.4&lt;/span&gt;

&lt;span class="n"&gt;Last&lt;/span&gt; &lt;span class="nl"&gt;login&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Sun&lt;/span&gt; &lt;span class="n"&gt;Aug&lt;/span&gt;  &lt;span class="mi"&gt;5&lt;/span&gt; &lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mo"&gt;05&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;51&lt;/span&gt; &lt;span class="mi"&gt;2018&lt;/span&gt; &lt;span class="n"&gt;from&lt;/span&gt; &lt;span class="mf"&gt;172.32.0.1&lt;/span&gt;
&lt;span class="n"&gt;router&lt;/span&gt;&lt;span class="p"&gt;{}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;配置 filter 规则，允许外部访问 subnet1: 12.12.12.0/24，subnet2: 172.16.10.0/24，为 vm 开启 allow ping &amp;amp; ssh 规则。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# 开启 ping&lt;/span&gt;
rule &lt;span class="m"&gt;20080&lt;/span&gt; ipv4 protocol icmp echo-request from any to &lt;span class="m"&gt;12&lt;/span&gt;.12.12.0/24 &lt;span class="k"&gt;do&lt;/span&gt; allow
rule &lt;span class="m"&gt;20090&lt;/span&gt; ipv4 protocol icmp echo-reply from &lt;span class="m"&gt;12&lt;/span&gt;.12.12.0/24 to any &lt;span class="k"&gt;do&lt;/span&gt; allow
rule &lt;span class="m"&gt;20100&lt;/span&gt; ipv4 protocol icmp echo-request from any to &lt;span class="m"&gt;172&lt;/span&gt;.16.10.0/24 &lt;span class="k"&gt;do&lt;/span&gt; allow
rule &lt;span class="m"&gt;20110&lt;/span&gt; ipv4 protocol icmp echo-reply from &lt;span class="m"&gt;172&lt;/span&gt;.16.10.0/24 to any &lt;span class="k"&gt;do&lt;/span&gt; allow

&lt;span class="c1"&gt;# 开启 ssh &lt;/span&gt;
rule &lt;span class="m"&gt;20120&lt;/span&gt; processing forward ipv4 protocol tcp from any to &lt;span class="m"&gt;12&lt;/span&gt;.12.12.120&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;22&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; allow
rule &lt;span class="m"&gt;20130&lt;/span&gt; processing forward ipv4 protocol tcp from &lt;span class="m"&gt;12&lt;/span&gt;.12.12.120&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;22&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; to any &lt;span class="k"&gt;do&lt;/span&gt; allow
rule &lt;span class="m"&gt;20140&lt;/span&gt; processing forward ipv4 protocol tcp from any to &lt;span class="m"&gt;172&lt;/span&gt;.16.10.100&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;22&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; allow
rule &lt;span class="m"&gt;20150&lt;/span&gt; processing forward ipv4 protocol tcp from &lt;span class="m"&gt;172&lt;/span&gt;.16.10.100&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;22&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; to any &lt;span class="k"&gt;do&lt;/span&gt; allow
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;配置 filter 规则，开启子网段路由转发功能。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# 开放subnet1：12.12.12.0/24 子网段路由转发功能&lt;/span&gt;
rule &lt;span class="m"&gt;20180&lt;/span&gt; processing forward ipv4 from any to &lt;span class="m"&gt;12&lt;/span&gt;.12.12.0/24 &lt;span class="k"&gt;do&lt;/span&gt; allow
rule &lt;span class="m"&gt;20190&lt;/span&gt; processing forward ipv4 from &lt;span class="m"&gt;12&lt;/span&gt;.12.12.0/24 to any &lt;span class="k"&gt;do&lt;/span&gt; allow
rule &lt;span class="m"&gt;20200&lt;/span&gt; processing output ipv4 from &lt;span class="m"&gt;12&lt;/span&gt;.12.12.0/24 to any &lt;span class="k"&gt;do&lt;/span&gt; allow
rule &lt;span class="m"&gt;20210&lt;/span&gt; processing input ipv4 from any to &lt;span class="m"&gt;12&lt;/span&gt;.12.12.0/24 &lt;span class="k"&gt;do&lt;/span&gt; allow
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;三、配置内外网互相访问&lt;/h3&gt;
&lt;h4&gt;2.3 开启 NAT 功能&lt;/h4&gt;
&lt;p&gt;在云网络环境，使用 NAT 功能实现内网访问外网，使内部网络中所有主机均可共享一个合法公网 ip 地址，大大减少公网 ip 的浪费。NAT 分为静态 NAT、动态 NAT 以及网络地址端口转换 NAPT。配置静态 NAT 将私网转换为公网地址，进行一对一映射，实现外网访问内网中某一特定服务，目的地址是固定不变的。配置动态 NAT ，将私网 ip 地址转换为公网 ip 地址，但公网 IP 地址是不确定的，而是随机的，即目的 IP 地址可以配置多个，ip 地址是动态变化的。网络地址端口转换 NAPT 分为 SNAT 源地址转换以及 DNAT 目的地址转换。&lt;/p&gt;
&lt;h5&gt;2.3.1 绑定 floating ip 到路由器&lt;/h5&gt;
&lt;ol&gt;
&lt;li&gt;开启外网地址 NAT 功能，使内网能够访问外网。该功能的实现还需要 filter 开启指定子网段的路由转发功能才能起作用。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# 配置filter规则
# 开放subnet1：12.12.12.0/24 子网段路由转发功能
rule 20180 processing forward ipv4 from any to 12.12.12.0/24 do allow
rule 20190 processing forward ipv4 from 12.12.12.0/24 to any do allow
rule 20200 processing output ipv4 from 12.12.12.0/24 to any do allow
rule 20210 processing input ipv4 from any to 12.12.12.0/24 do allow

# 开启nat功能
router{conf:init_turo-nat}public interface ens3
router{conf:init_turo-nat-ens3}nat enable
router{conf:init_turo-nat-ens3}save
router{}apply init_turo
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;验证内网访问外网，如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;[root@vm1 ~]# ping -c 2 baidu.com
PING baidu.com (220.181.57.216) 56(84) bytes of data.
64 bytes from 220.181.57.216: icmp_seq=1 ttl=55 time=1.94 ms
64 bytes from 220.181.57.216: icmp_seq=2 ttl=55 time=1.99 ms

--- baidu.com ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1001ms
rtt min/avg/max/mdev = 1.949/1.970/1.992/0.049 ms
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;配置静态 NAT 规则， 将私网地址转换为公网地址，通过一对一映射，实现外网访问内网中某一特定服务。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# STATIC MAPPINGS
static 100 protocol tcp public 172.32.0.5:2222 private 12.12.12.120:22
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;验证静态 NAT ssh 端口转发功能，实现外网访问内网，如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="p"&gt;@&lt;/span&gt;&lt;span class="n"&gt;POD23&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;CLU01&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;H028&lt;/span&gt; &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="err"&gt;#&lt;/span&gt; &lt;span class="n"&gt;ssh&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;p&lt;/span&gt; &lt;span class="mi"&gt;2222&lt;/span&gt; &lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="mf"&gt;@172.32.0.5&lt;/span&gt;
&lt;span class="n"&gt;The&lt;/span&gt; &lt;span class="n"&gt;authenticity&lt;/span&gt; &lt;span class="n"&gt;of&lt;/span&gt; &lt;span class="n"&gt;host&lt;/span&gt; &lt;span class="err"&gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mf"&gt;172.32.0.5&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;2222&lt;/span&gt; &lt;span class="p"&gt;([&lt;/span&gt;&lt;span class="mf"&gt;172.32.0.5&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;2222&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="err"&gt;&amp;#39;&lt;/span&gt; &lt;span class="n"&gt;can&lt;/span&gt;&lt;span class="err"&gt;&amp;#39;&lt;/span&gt;&lt;span class="n"&gt;t&lt;/span&gt; &lt;span class="n"&gt;be&lt;/span&gt; &lt;span class="n"&gt;established&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;
&lt;span class="n"&gt;ECDSA&lt;/span&gt; &lt;span class="n"&gt;key&lt;/span&gt; &lt;span class="n"&gt;fingerprint&lt;/span&gt; &lt;span class="n"&gt;is&lt;/span&gt; &lt;span class="nl"&gt;b0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="nl"&gt;b&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;6&lt;/span&gt;&lt;span class="nl"&gt;c&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="nl"&gt;a&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nl"&gt;a4&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;92&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="nl"&gt;c&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nl"&gt;a8&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;65&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;31&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;76&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mf"&gt;6f&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="nl"&gt;b5&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;61&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="nl"&gt;d3&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;
&lt;span class="n"&gt;Are&lt;/span&gt; &lt;span class="n"&gt;you&lt;/span&gt; &lt;span class="n"&gt;sure&lt;/span&gt; &lt;span class="n"&gt;you&lt;/span&gt; &lt;span class="n"&gt;want&lt;/span&gt; &lt;span class="n"&gt;to&lt;/span&gt; &lt;span class="k"&gt;continue&lt;/span&gt; &lt;span class="n"&gt;connecting&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;yes&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;no&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;?&lt;/span&gt; &lt;span class="n"&gt;yes&lt;/span&gt;
&lt;span class="nl"&gt;Warning&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Permanently&lt;/span&gt; &lt;span class="n"&gt;added&lt;/span&gt; &lt;span class="err"&gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mf"&gt;172.32.0.5&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;2222&lt;/span&gt;&lt;span class="err"&gt;&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ECDSA&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="n"&gt;to&lt;/span&gt; &lt;span class="n"&gt;the&lt;/span&gt; &lt;span class="n"&gt;list&lt;/span&gt; &lt;span class="n"&gt;of&lt;/span&gt; &lt;span class="n"&gt;known&lt;/span&gt; &lt;span class="n"&gt;hosts&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;
&lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="mf"&gt;@172.32.0.5&lt;/span&gt;&lt;span class="err"&gt;&amp;#39;&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="nl"&gt;password&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; 
&lt;span class="n"&gt;Last&lt;/span&gt; &lt;span class="nl"&gt;login&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Sat&lt;/span&gt; &lt;span class="n"&gt;Aug&lt;/span&gt;  &lt;span class="mi"&gt;4&lt;/span&gt; &lt;span class="mi"&gt;21&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;46&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mo"&gt;02&lt;/span&gt; &lt;span class="mi"&gt;2018&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="p"&gt;@&lt;/span&gt;&lt;span class="n"&gt;client1&lt;/span&gt; &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="err"&gt;#&lt;/span&gt; &lt;span class="n"&gt;ip&lt;/span&gt; &lt;span class="n"&gt;a&lt;/span&gt;
&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="nl"&gt;lo&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;LOOPBACK&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;UP&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;LOWER_UP&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;mtu&lt;/span&gt; &lt;span class="mi"&gt;65536&lt;/span&gt; &lt;span class="n"&gt;qdisc&lt;/span&gt; &lt;span class="n"&gt;noqueue&lt;/span&gt; &lt;span class="n"&gt;state&lt;/span&gt; &lt;span class="n"&gt;UNKNOWN&lt;/span&gt; 
    &lt;span class="n"&gt;link&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;loopback&lt;/span&gt; &lt;span class="mo"&gt;00&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mo"&gt;00&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mo"&gt;00&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mo"&gt;00&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mo"&gt;00&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mo"&gt;00&lt;/span&gt; &lt;span class="n"&gt;brd&lt;/span&gt; &lt;span class="mo"&gt;00&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mo"&gt;00&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mo"&gt;00&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mo"&gt;00&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mo"&gt;00&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mo"&gt;00&lt;/span&gt;
    &lt;span class="n"&gt;inet&lt;/span&gt; &lt;span class="mf"&gt;127.0.0.1&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;8&lt;/span&gt; &lt;span class="n"&gt;scope&lt;/span&gt; &lt;span class="n"&gt;host&lt;/span&gt; &lt;span class="n"&gt;lo&lt;/span&gt;
       &lt;span class="n"&gt;valid_lft&lt;/span&gt; &lt;span class="n"&gt;forever&lt;/span&gt; &lt;span class="n"&gt;preferred_lft&lt;/span&gt; &lt;span class="n"&gt;forever&lt;/span&gt;
    &lt;span class="n"&gt;inet6&lt;/span&gt; &lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;128&lt;/span&gt; &lt;span class="n"&gt;scope&lt;/span&gt; &lt;span class="n"&gt;host&lt;/span&gt; 
       &lt;span class="n"&gt;valid_lft&lt;/span&gt; &lt;span class="n"&gt;forever&lt;/span&gt; &lt;span class="n"&gt;preferred_lft&lt;/span&gt; &lt;span class="n"&gt;forever&lt;/span&gt;
&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="nl"&gt;eth0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;BROADCAST&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;MULTICAST&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;UP&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;LOWER_UP&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;mtu&lt;/span&gt; &lt;span class="mi"&gt;1500&lt;/span&gt; &lt;span class="n"&gt;qdisc&lt;/span&gt; &lt;span class="n"&gt;pfifo_fast&lt;/span&gt; &lt;span class="n"&gt;state&lt;/span&gt; &lt;span class="n"&gt;UP&lt;/span&gt; &lt;span class="n"&gt;qlen&lt;/span&gt; &lt;span class="mi"&gt;1000&lt;/span&gt;
    &lt;span class="n"&gt;link&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;ether&lt;/span&gt; &lt;span class="mo"&gt;00&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;12&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;25&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;66&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="nl"&gt;d7&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;77&lt;/span&gt; &lt;span class="n"&gt;brd&lt;/span&gt; &lt;span class="nl"&gt;ff&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nl"&gt;ff&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nl"&gt;ff&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nl"&gt;ff&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="nl"&gt;ff&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="n"&gt;ff&lt;/span&gt;
    &lt;span class="n"&gt;inet&lt;/span&gt; &lt;span class="mf"&gt;12.12.12.120&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;24&lt;/span&gt; &lt;span class="n"&gt;brd&lt;/span&gt; &lt;span class="mf"&gt;12.12.12.255&lt;/span&gt; &lt;span class="n"&gt;scope&lt;/span&gt; &lt;span class="n"&gt;global&lt;/span&gt; &lt;span class="n"&gt;dynamic&lt;/span&gt; &lt;span class="n"&gt;eth0&lt;/span&gt;
       &lt;span class="n"&gt;valid_lft&lt;/span&gt; &lt;span class="mi"&gt;3170&lt;/span&gt;&lt;span class="n"&gt;sec&lt;/span&gt; &lt;span class="n"&gt;preferred_lft&lt;/span&gt; &lt;span class="mi"&gt;3170&lt;/span&gt;&lt;span class="n"&gt;sec&lt;/span&gt;
    &lt;span class="n"&gt;inet6&lt;/span&gt; &lt;span class="n"&gt;fe80&lt;/span&gt;&lt;span class="o"&gt;::&lt;/span&gt;&lt;span class="mi"&gt;212&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mf"&gt;25ff&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="nl"&gt;fe66&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="n"&gt;d777&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;64&lt;/span&gt; &lt;span class="n"&gt;scope&lt;/span&gt; &lt;span class="n"&gt;link&lt;/span&gt; 
       &lt;span class="n"&gt;valid_lft&lt;/span&gt; &lt;span class="n"&gt;forever&lt;/span&gt; &lt;span class="n"&gt;preferred_lft&lt;/span&gt; &lt;span class="n"&gt;forever&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h5&gt;2.3.2 绑定 floating ip 到虚拟机&lt;/h5&gt;
&lt;p&gt;为虚拟机添加 floating ip，配置 ip 地址为 172.32.0.3，网关地址为 172.32.0.1。可从外网宿主机通过 ssh 访问该机器，该机器也能访问外网，如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="p"&gt;@&lt;/span&gt;&lt;span class="n"&gt;POD23&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;CLU01&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;H028&lt;/span&gt; &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="err"&gt;#&lt;/span&gt; &lt;span class="n"&gt;ssh&lt;/span&gt; &lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="mf"&gt;@172.32.0.3&lt;/span&gt;
&lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="mf"&gt;@172.32.0.3&lt;/span&gt;&lt;span class="err"&gt;&amp;#39;&lt;/span&gt;&lt;span class="n"&gt;s&lt;/span&gt; &lt;span class="nl"&gt;password&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; 
&lt;span class="n"&gt;Last&lt;/span&gt; &lt;span class="nl"&gt;login&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Mon&lt;/span&gt; &lt;span class="n"&gt;Aug&lt;/span&gt;  &lt;span class="mi"&gt;6&lt;/span&gt; &lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;57&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;27&lt;/span&gt; &lt;span class="mi"&gt;2018&lt;/span&gt; &lt;span class="n"&gt;from&lt;/span&gt; &lt;span class="mf"&gt;172.32.0.1&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="p"&gt;@&lt;/span&gt;&lt;span class="n"&gt;vm1&lt;/span&gt; &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="err"&gt;#&lt;/span&gt; &lt;span class="n"&gt;ip&lt;/span&gt; &lt;span class="n"&gt;route&lt;/span&gt;
&lt;span class="k"&gt;default&lt;/span&gt; &lt;span class="n"&gt;via&lt;/span&gt; &lt;span class="mf"&gt;172.32.0.1&lt;/span&gt; &lt;span class="n"&gt;dev&lt;/span&gt; &lt;span class="n"&gt;eth1&lt;/span&gt; 
&lt;span class="mf"&gt;12.12.12.0&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;24&lt;/span&gt; &lt;span class="n"&gt;dev&lt;/span&gt; &lt;span class="n"&gt;eth0&lt;/span&gt;  &lt;span class="n"&gt;proto&lt;/span&gt; &lt;span class="n"&gt;kernel&lt;/span&gt;  &lt;span class="n"&gt;scope&lt;/span&gt; &lt;span class="n"&gt;link&lt;/span&gt;  &lt;span class="n"&gt;src&lt;/span&gt; &lt;span class="mf"&gt;12.12.12.120&lt;/span&gt; 
&lt;span class="mf"&gt;169.254.0.0&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;16&lt;/span&gt; &lt;span class="n"&gt;dev&lt;/span&gt; &lt;span class="n"&gt;eth0&lt;/span&gt;  &lt;span class="n"&gt;scope&lt;/span&gt; &lt;span class="n"&gt;link&lt;/span&gt;  &lt;span class="n"&gt;metric&lt;/span&gt; &lt;span class="mi"&gt;1002&lt;/span&gt; 
&lt;span class="mf"&gt;169.254.0.0&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;16&lt;/span&gt; &lt;span class="n"&gt;dev&lt;/span&gt; &lt;span class="n"&gt;eth1&lt;/span&gt;  &lt;span class="n"&gt;scope&lt;/span&gt; &lt;span class="n"&gt;link&lt;/span&gt;  &lt;span class="n"&gt;metric&lt;/span&gt; &lt;span class="mi"&gt;1003&lt;/span&gt; 
&lt;span class="mf"&gt;172.32.0.0&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mi"&gt;24&lt;/span&gt; &lt;span class="n"&gt;dev&lt;/span&gt; &lt;span class="n"&gt;eth1&lt;/span&gt;  &lt;span class="n"&gt;proto&lt;/span&gt; &lt;span class="n"&gt;kernel&lt;/span&gt;  &lt;span class="n"&gt;scope&lt;/span&gt; &lt;span class="n"&gt;link&lt;/span&gt;  &lt;span class="n"&gt;src&lt;/span&gt; &lt;span class="mf"&gt;172.32.0.3&lt;/span&gt; 
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="p"&gt;@&lt;/span&gt;&lt;span class="n"&gt;vm1&lt;/span&gt; &lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="err"&gt;#&lt;/span&gt; &lt;span class="n"&gt;ping&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;c&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt; &lt;span class="n"&gt;baidu&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;com&lt;/span&gt;
&lt;span class="n"&gt;PING&lt;/span&gt; &lt;span class="n"&gt;baidu&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;com&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mf"&gt;220.181.57.216&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="mi"&gt;56&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;84&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="n"&gt;bytes&lt;/span&gt; &lt;span class="n"&gt;of&lt;/span&gt; &lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;
&lt;span class="mi"&gt;64&lt;/span&gt; &lt;span class="n"&gt;bytes&lt;/span&gt; &lt;span class="n"&gt;from&lt;/span&gt; &lt;span class="mf"&gt;220.181.57.216&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;icmp_seq&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="n"&gt;ttl&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;56&lt;/span&gt; &lt;span class="n"&gt;time&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mf"&gt;1.46&lt;/span&gt; &lt;span class="n"&gt;ms&lt;/span&gt;
&lt;span class="mi"&gt;64&lt;/span&gt; &lt;span class="n"&gt;bytes&lt;/span&gt; &lt;span class="n"&gt;from&lt;/span&gt; &lt;span class="mf"&gt;220.181.57.216&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="n"&gt;icmp_seq&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt; &lt;span class="n"&gt;ttl&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;56&lt;/span&gt; &lt;span class="n"&gt;time&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mf"&gt;1.66&lt;/span&gt; &lt;span class="n"&gt;ms&lt;/span&gt;

&lt;span class="o"&gt;---&lt;/span&gt; &lt;span class="n"&gt;baidu&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;com&lt;/span&gt; &lt;span class="n"&gt;ping&lt;/span&gt; &lt;span class="n"&gt;statistics&lt;/span&gt; &lt;span class="o"&gt;---&lt;/span&gt;
&lt;span class="mi"&gt;2&lt;/span&gt; &lt;span class="n"&gt;packets&lt;/span&gt; &lt;span class="n"&gt;transmitted&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt; &lt;span class="n"&gt;received&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="n"&gt;packet&lt;/span&gt; &lt;span class="n"&gt;loss&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;time&lt;/span&gt; &lt;span class="mi"&gt;1001&lt;/span&gt;&lt;span class="n"&gt;ms&lt;/span&gt;
&lt;span class="n"&gt;rtt&lt;/span&gt; &lt;span class="n"&gt;min&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;avg&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;max&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;mdev&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mf"&gt;1.466&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mf"&gt;1.566&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mf"&gt;1.666&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="mf"&gt;0.100&lt;/span&gt; &lt;span class="n"&gt;ms&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;这里可能会出现如下问题：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;公网 ip 地址的网关与通过 dhcp 功能分配的子网默认网关配置冲突，网关地址出现抢占。&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;四、路由器配置&lt;/h3&gt;
&lt;h4&gt;4.1 配置 DHCP&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;创建 6wind 虚拟机，加入 public, private1 和 private2 子网，启动虚拟机，可以看到三个网卡。创建 vm1, 加入 private1 子网。创建 vm2, 加入 private2 子网。&lt;/li&gt;
&lt;li&gt;配置 dhcp 功能，以配置 private2 子网段为例。其中租约时间单位为秒。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;router&lt;span class="o"&gt;{&lt;/span&gt;conf:init_turo-dhcpv4server&lt;span class="o"&gt;}&lt;/span&gt;dhcpv4server &lt;span class="nb"&gt;enable&lt;/span&gt;                      &lt;span class="c1"&gt;# 开启dhcp功能&lt;/span&gt;
router&lt;span class="o"&gt;{&lt;/span&gt;conf:init_turo-dhcpv4server&lt;span class="o"&gt;}&lt;/span&gt;subnet &lt;span class="m"&gt;172&lt;/span&gt;.16.10.0/24                    &lt;span class="c1"&gt;# 添加子网段&lt;/span&gt;
router&lt;span class="o"&gt;{&lt;/span&gt;conf:init_turo-dhcpv4server-172.16.10.0/24&lt;span class="o"&gt;}&lt;/span&gt;minlease &lt;span class="m"&gt;600&lt;/span&gt;              &lt;span class="c1"&gt;# 设置最小租约&lt;/span&gt;
router&lt;span class="o"&gt;{&lt;/span&gt;conf:init_turo-dhcpv4server-172.16.10.0/24&lt;span class="o"&gt;}&lt;/span&gt;maxlease &lt;span class="m"&gt;99000&lt;/span&gt;            &lt;span class="c1"&gt;# 设置最大租约&lt;/span&gt;
router&lt;span class="o"&gt;{&lt;/span&gt;conf:init_turo-dhcpv4server-172.16.10.0/24&lt;span class="o"&gt;}&lt;/span&gt;defaultlease &lt;span class="m"&gt;3600&lt;/span&gt;         &lt;span class="c1"&gt;# 设置默认租约&lt;/span&gt;
router&lt;span class="o"&gt;{&lt;/span&gt;conf:init_turo-dhcpv4server-172.16.10.0/24&lt;span class="o"&gt;}&lt;/span&gt;domainname auto
router&lt;span class="o"&gt;{&lt;/span&gt;conf:init_turo-dhcpv4server-172.16.10.0/24&lt;span class="o"&gt;}&lt;/span&gt;default-ipv4 &lt;span class="m"&gt;172&lt;/span&gt;.16.10.1              &lt;span class="c1"&gt;# 配置子网默认网关，推送给在此网段的虚拟机&lt;/span&gt;
router&lt;span class="o"&gt;{&lt;/span&gt;conf:init_turo-dhcpv4server-172.16.10.0/24&lt;span class="o"&gt;}&lt;/span&gt;range &lt;span class="m"&gt;172&lt;/span&gt;.16.10.100 &lt;span class="m"&gt;172&lt;/span&gt;.16.10.200     &lt;span class="c1"&gt;# 配置子网段范围&lt;/span&gt;
router&lt;span class="o"&gt;{&lt;/span&gt;conf:init_turo-dhcpv4server-172.16.10.0/24&lt;span class="o"&gt;}&lt;/span&gt;nameserver &lt;span class="m"&gt;114&lt;/span&gt;.114.114.114 primary    &lt;span class="c1"&gt;# 配置dns&lt;/span&gt;
router&lt;span class="o"&gt;{&lt;/span&gt;conf:init_turo-dhcpv4server-172.16.10.0/24&lt;span class="o"&gt;}&lt;/span&gt;nameserver &lt;span class="m"&gt;8&lt;/span&gt;.8.8.8 secondary
router&lt;span class="o"&gt;{&lt;/span&gt;conf:init_turo-dhcpv4server-172.16.10.0/24&lt;span class="o"&gt;}&lt;/span&gt;display 
    &lt;span class="c1"&gt;# SUBNET&lt;/span&gt;
      subnet &lt;span class="m"&gt;172&lt;/span&gt;.16.10.0/24
          minlease &lt;span class="m"&gt;600&lt;/span&gt;
          maxlease &lt;span class="m"&gt;99000&lt;/span&gt;
          defaultlease &lt;span class="m"&gt;3600&lt;/span&gt;
          default-ipv4 &lt;span class="m"&gt;172&lt;/span&gt;.16.10.1
        &lt;span class="c1"&gt;# RANGES&lt;/span&gt;
          range &lt;span class="m"&gt;172&lt;/span&gt;.16.10.100 &lt;span class="m"&gt;172&lt;/span&gt;.16.10.200
        &lt;span class="c1"&gt;# EXCLUDES&lt;/span&gt;
        &lt;span class="c1"&gt;# HOSTS&lt;/span&gt;
        &lt;span class="c1"&gt;# NAMESERVERS&lt;/span&gt;
          nameserver &lt;span class="m"&gt;114&lt;/span&gt;.114.114.114 primary
          nameserver &lt;span class="m"&gt;8&lt;/span&gt;.8.8.8 secondary
        &lt;span class="c1"&gt;# NTP SERVERS&lt;/span&gt;
        &lt;span class="c1"&gt;# NETBIOS NAME SERVERS&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;再以同样的方式配置 private1，在添加完以上两个私网后，查看 dhcp 的所有配置。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;router&lt;span class="o"&gt;{&lt;/span&gt;conf:init_turo-dhcpv4server&lt;span class="o"&gt;}&lt;/span&gt;display
    &lt;span class="c1"&gt;# DHCPSERVER STATEMENTS&lt;/span&gt;
      dhcpv4server &lt;span class="nb"&gt;enable&lt;/span&gt;
    &lt;span class="c1"&gt;# SUBNET&lt;/span&gt;
      subnet &lt;span class="m"&gt;12&lt;/span&gt;.12.12.0/24
          minlease &lt;span class="m"&gt;600&lt;/span&gt;
          maxlease &lt;span class="m"&gt;99000&lt;/span&gt;
          defaultlease &lt;span class="m"&gt;3600&lt;/span&gt;
          domainname auto
          default-ipv4 &lt;span class="m"&gt;12&lt;/span&gt;.12.12.1
        &lt;span class="c1"&gt;# RANGES&lt;/span&gt;
          range &lt;span class="m"&gt;12&lt;/span&gt;.12.12.100 &lt;span class="m"&gt;12&lt;/span&gt;.12.12.200
        &lt;span class="c1"&gt;# EXCLUDES&lt;/span&gt;
        &lt;span class="c1"&gt;# HOSTS&lt;/span&gt;
          host client1 &lt;span class="m"&gt;00&lt;/span&gt;:12:25:66:d7:77 &lt;span class="m"&gt;12&lt;/span&gt;.12.12.120       &lt;span class="c1"&gt;# 将vm1网卡mac地址与指定ip进行绑定&lt;/span&gt;
        &lt;span class="c1"&gt;# NAMESERVERS&lt;/span&gt;
          nameserver &lt;span class="m"&gt;114&lt;/span&gt;.114.114.114 primary
          nameserver &lt;span class="m"&gt;114&lt;/span&gt;.114.115.115 secondary
        &lt;span class="c1"&gt;# NTP SERVERS&lt;/span&gt;
        &lt;span class="c1"&gt;# NETBIOS NAME SERVERS&lt;/span&gt;

      subnet &lt;span class="m"&gt;172&lt;/span&gt;.16.10.0/24
          minlease &lt;span class="m"&gt;600&lt;/span&gt;
          maxlease &lt;span class="m"&gt;99000&lt;/span&gt;
          defaultlease &lt;span class="m"&gt;3600&lt;/span&gt;
          default-ipv4 &lt;span class="m"&gt;172&lt;/span&gt;.16.10.1
        &lt;span class="c1"&gt;# RANGES&lt;/span&gt;
          range &lt;span class="m"&gt;172&lt;/span&gt;.16.10.100 &lt;span class="m"&gt;172&lt;/span&gt;.16.10.200
        &lt;span class="c1"&gt;# EXCLUDES&lt;/span&gt;
        &lt;span class="c1"&gt;# HOSTS&lt;/span&gt;
        &lt;span class="c1"&gt;# NAMESERVERS&lt;/span&gt;
          nameserver &lt;span class="m"&gt;114&lt;/span&gt;.114.114.114 primary
          nameserver &lt;span class="m"&gt;8&lt;/span&gt;.8.8.8 secondary
        &lt;span class="c1"&gt;# NTP SERVERS&lt;/span&gt;
        &lt;span class="c1"&gt;# NETBIOS NAME SERVERS&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;通过 vnc 进入 vm1 虚拟机，修改网卡配置文件通过 DHCP 获取 ip 地址。重启 network 服务，查看当前网络信息。可以看到在 DHCP 子网段中配置的 DNS、默认网关以及绑定的 ip 地址都已经被分配到 ip 地址上。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;root@vm1 ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# cat /etc/resolv.conf       &lt;/span&gt;
&lt;span class="p"&gt;;&lt;/span&gt; generated by /usr/sbin/dhclient-script
search centos
nameserver &lt;span class="m"&gt;114&lt;/span&gt;.114.114.114
nameserver &lt;span class="m"&gt;114&lt;/span&gt;.114.115.115
&lt;span class="o"&gt;[&lt;/span&gt;root@vm1 ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# ip route&lt;/span&gt;
default via &lt;span class="m"&gt;12&lt;/span&gt;.12.12.1 dev eth0 
&lt;span class="m"&gt;12&lt;/span&gt;.12.12.0/24 dev eth0  proto kernel  scope link  src &lt;span class="m"&gt;12&lt;/span&gt;.12.12.120 
&lt;span class="m"&gt;169&lt;/span&gt;.254.0.0/16 dev eth0  scope link  metric &lt;span class="m"&gt;1002&lt;/span&gt; 
&lt;span class="o"&gt;[&lt;/span&gt;root@vm1 ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# cat /etc/resolv.conf &lt;/span&gt;
&lt;span class="p"&gt;;&lt;/span&gt; generated by /usr/sbin/dhclient-script
search centos
nameserver &lt;span class="m"&gt;114&lt;/span&gt;.114.114.114
nameserver &lt;span class="m"&gt;114&lt;/span&gt;.114.115.115
&lt;span class="o"&gt;[&lt;/span&gt;root@client1 ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# ping -c 4 baidu.com&lt;/span&gt;
PING baidu.com &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;220&lt;/span&gt;.181.57.216&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="m"&gt;56&lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;84&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; bytes of data.
&lt;span class="m"&gt;64&lt;/span&gt; bytes from &lt;span class="m"&gt;220&lt;/span&gt;.181.57.216: &lt;span class="nv"&gt;icmp_seq&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt; &lt;span class="nv"&gt;ttl&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;55&lt;/span&gt; &lt;span class="nv"&gt;time&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;.12 ms
&lt;span class="m"&gt;64&lt;/span&gt; bytes from &lt;span class="m"&gt;220&lt;/span&gt;.181.57.216: &lt;span class="nv"&gt;icmp_seq&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt; &lt;span class="nv"&gt;ttl&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;55&lt;/span&gt; &lt;span class="nv"&gt;time&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;.12 ms
&lt;span class="m"&gt;64&lt;/span&gt; bytes from &lt;span class="m"&gt;220&lt;/span&gt;.181.57.216: &lt;span class="nv"&gt;icmp_seq&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;3&lt;/span&gt; &lt;span class="nv"&gt;ttl&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;55&lt;/span&gt; &lt;span class="nv"&gt;time&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;.98 ms
&lt;span class="m"&gt;64&lt;/span&gt; bytes from &lt;span class="m"&gt;220&lt;/span&gt;.181.57.216: &lt;span class="nv"&gt;icmp_seq&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;4&lt;/span&gt; &lt;span class="nv"&gt;ttl&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;55&lt;/span&gt; &lt;span class="nv"&gt;time&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;.63 ms

--- baidu.com ping statistics ---
&lt;span class="m"&gt;4&lt;/span&gt; packets transmitted, &lt;span class="m"&gt;4&lt;/span&gt; received, &lt;span class="m"&gt;0&lt;/span&gt;% packet loss, &lt;span class="nb"&gt;time&lt;/span&gt; 3004ms
rtt min/avg/max/mdev &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="m"&gt;1&lt;/span&gt;.981/2.215/2.633/0.254 ms
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;到这里 DHCP 服务生效。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;DHCP 租约问题&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;从 DHCP Client 开看，整个租约流程如下：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;第一次获取 DHCP 租约以及租约失效情况下，需要走 DHCP 获取租约的完整流程，即从发送 DHCPDISCOVER 开始&lt;/li&gt;
&lt;li&gt;若已经获取到租约之后，每次机器开机会直接发送 DHCPREQUEST，请求使用原来的 IP 地址&lt;/li&gt;
&lt;li&gt;租约期限到一半时，Client 发送 DHCPREQUEST, 若没有得到 DHCP 服务器的 ACK,仍然会继续使用&lt;/li&gt;
&lt;li&gt;租约期限到87.5%，Client 继续发送 DHCPREQUEST ，能获取来自 DHCP 服务器的 ACK 则继续使用（ ACK中包含新的租约时间以及其他配置参数 ），如果得不到 ACK 响应或者联系不上，则 Client 会与其他 DHCP 服务器通信（获取新的地址）。如果网络上没有其他 DHCP 服务器，当达到租约期限时，则该 Client 必须停止使用该 IP 地址。然后走 DHCP 获取租约的完整流程，从 DHCPDISCOVER 开始，获取新的 ip 地址。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;综上，当租约期达到一半时，若 client 能联系上之前的 DHCP 服务器（两者均在线），则会获取 ACK 然后进行续约。在租约期内，若有一方不在线，IP 虽然不会被释放，但是没有续约，如果直到达到租约期限依然没有续约上的话，IP 会被释放。&lt;/p&gt;
&lt;p&gt;如何保证在 vm 未被删除之前，ip 始终保持不变？&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;确保网络中至少有一个 DHCP 服务器&lt;/li&gt;
&lt;li&gt;当将 MAC 地址与 ip 地址进行绑定&lt;/li&gt;
&lt;/ol&gt;
&lt;h4&gt;4.2、配置 NAT&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;开启 6wind nat 功能，添加静态 nat 规则，将 vrouter 的公网地址 2222 端口映射 client1 的 22 端口，2223 端口映射为 client2 的 22 端口，使外网通过 ssh 访问内网。配置信息如下：&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;router&lt;span class="o"&gt;{&lt;/span&gt;conf:init_turo-nat&lt;span class="o"&gt;}&lt;/span&gt;public interface ens3
router&lt;span class="o"&gt;{&lt;/span&gt;conf:init_turo-nat-ens3&lt;span class="o"&gt;}&lt;/span&gt;nat &lt;span class="nb"&gt;enable&lt;/span&gt;
router&lt;span class="o"&gt;{&lt;/span&gt;conf:init_turo-nat-ens3&lt;span class="o"&gt;}&lt;/span&gt;static &lt;span class="m"&gt;100&lt;/span&gt; protocol tcp public &lt;span class="m"&gt;172&lt;/span&gt;.32.0.5:2222 private &lt;span class="m"&gt;12&lt;/span&gt;.12.12.120:22
router&lt;span class="o"&gt;{&lt;/span&gt;conf:init_turo-nat-ens3&lt;span class="o"&gt;}&lt;/span&gt;static &lt;span class="m"&gt;200&lt;/span&gt; protocol tcp public &lt;span class="m"&gt;172&lt;/span&gt;.32.0.5:2223 private &lt;span class="m"&gt;172&lt;/span&gt;.16.10.100:22
router&lt;span class="o"&gt;{&lt;/span&gt;conf:init_turo-nat-ens3&lt;span class="o"&gt;}&lt;/span&gt;display 
      nat &lt;span class="nb"&gt;enable&lt;/span&gt;

    &lt;span class="c1"&gt;# DYNAMIC MAPPINGS&lt;/span&gt;

    &lt;span class="c1"&gt;# STATIC MAPPINGS&lt;/span&gt;
      static &lt;span class="m"&gt;100&lt;/span&gt; protocol tcp public &lt;span class="m"&gt;172&lt;/span&gt;.32.0.5:2222 private &lt;span class="m"&gt;12&lt;/span&gt;.12.12.120:22
      static &lt;span class="m"&gt;200&lt;/span&gt; protocol tcp public &lt;span class="m"&gt;172&lt;/span&gt;.32.0.5:2223 private &lt;span class="m"&gt;172&lt;/span&gt;.16.10.100:22

router&lt;span class="o"&gt;{&lt;/span&gt;conf:init_turo-nat-ens3&lt;span class="o"&gt;}&lt;/span&gt;save 
router&lt;span class="o"&gt;{}&lt;/span&gt;apply init_turo
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;以 100 rule 为例，验证静态 nat 功能，如下：&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;root@POD23-CLU01-H028 ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# ssh -p 2222 root@172.32.0.5&lt;/span&gt;
The authenticity of host &lt;span class="s1"&gt;&amp;#39;[172.32.0.5]:2222 ([172.32.0.5]:2222)&amp;#39;&lt;/span&gt; can&lt;span class="s1"&gt;&amp;#39;t be established.&lt;/span&gt;
&lt;span class="s1"&gt;ECDSA key fingerprint is b0:4b:6c:4a:a4:92:9c:a8:65:31:76:6f:b5:61:d3:5e.&lt;/span&gt;
&lt;span class="s1"&gt;Are you sure you want to continue connecting (yes/no)? yes&lt;/span&gt;
&lt;span class="s1"&gt;Warning: Permanently added &amp;#39;&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;172&lt;/span&gt;.32.0.5&lt;span class="o"&gt;]&lt;/span&gt;:2222&lt;span class="s1"&gt;&amp;#39; (ECDSA) to the list of known hosts.&lt;/span&gt;
&lt;span class="s1"&gt;root@172.32.0.5&amp;#39;&lt;/span&gt;s password: 
Last login: Sat Aug  &lt;span class="m"&gt;4&lt;/span&gt; &lt;span class="m"&gt;21&lt;/span&gt;:46:02 &lt;span class="m"&gt;2018&lt;/span&gt;
&lt;span class="o"&gt;[&lt;/span&gt;root@client1 ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# ip a&lt;/span&gt;
&lt;span class="m"&gt;1&lt;/span&gt;: lo: &amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt; mtu &lt;span class="m"&gt;65536&lt;/span&gt; qdisc noqueue state UNKNOWN 
    link/loopback &lt;span class="m"&gt;00&lt;/span&gt;:00:00:00:00:00 brd &lt;span class="m"&gt;00&lt;/span&gt;:00:00:00:00:00
    inet &lt;span class="m"&gt;127&lt;/span&gt;.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
&lt;span class="m"&gt;2&lt;/span&gt;: eth0: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu &lt;span class="m"&gt;1500&lt;/span&gt; qdisc pfifo_fast state UP qlen &lt;span class="m"&gt;1000&lt;/span&gt;
    link/ether &lt;span class="m"&gt;00&lt;/span&gt;:12:25:66:d7:77 brd ff:ff:ff:ff:ff:ff
    inet &lt;span class="m"&gt;12&lt;/span&gt;.12.12.120/24 brd &lt;span class="m"&gt;12&lt;/span&gt;.12.12.255 scope global dynamic eth0
       valid_lft 3170sec preferred_lft 3170sec
    inet6 fe80::212:25ff:fe66:d777/64 scope link 
       valid_lft forever preferred_lft forever
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;4.3、配置 Filter&lt;/h4&gt;
&lt;p&gt;配置 iptables filter 规则，实现云环境中安全组功能。6wind 提供的安全组规则，是通过在在路由器上进行配置，实现对整个子网段或者单个虚拟网卡进行配置。6wind 开启 filter 功能之后，会拒绝所有进入进出流量。以下为整个测试过程中配置的 filter 规则。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;router&lt;span class="o"&gt;{&lt;/span&gt;conf:init_turo&lt;span class="o"&gt;}&lt;/span&gt;fil
router&lt;span class="o"&gt;{&lt;/span&gt;conf:init_turo-fil&lt;span class="o"&gt;}&lt;/span&gt;display 
    &lt;span class="c1"&gt;# FILTER RULES&lt;/span&gt;
      &lt;span class="c1"&gt;# 开放路由器 22 端口&lt;/span&gt;
      rule &lt;span class="m"&gt;20000&lt;/span&gt; processing input ipv4 protocol tcp from any to &lt;span class="m"&gt;172&lt;/span&gt;.32.0.5&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;22&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; state new established &lt;span class="k"&gt;do&lt;/span&gt; allow
      rule &lt;span class="m"&gt;20010&lt;/span&gt; processing output ipv4 protocol tcp from &lt;span class="m"&gt;172&lt;/span&gt;.32.0.5&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;22&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; to any state new established &lt;span class="k"&gt;do&lt;/span&gt; allow
      &lt;span class="c1"&gt;# 允许外部 ping 路由器网关&lt;/span&gt;
      rule &lt;span class="m"&gt;20020&lt;/span&gt; ipv4 protocol icmp echo-request from any to &lt;span class="m"&gt;172&lt;/span&gt;.32.0.5 &lt;span class="k"&gt;do&lt;/span&gt; allow
      rule &lt;span class="m"&gt;20030&lt;/span&gt; ipv4 protocol icmp echo-reply from &lt;span class="m"&gt;172&lt;/span&gt;.32.0.5 to any &lt;span class="k"&gt;do&lt;/span&gt; allow

      &lt;span class="c1"&gt;# 允许 ping subnet1:12.12.12.0/24, subnet2: 172.16.10.0/24  (针对整个子网段配置filter规则)&lt;/span&gt;
      rule &lt;span class="m"&gt;20080&lt;/span&gt; ipv4 protocol icmp echo-request from any to &lt;span class="m"&gt;12&lt;/span&gt;.12.12.0/24 &lt;span class="k"&gt;do&lt;/span&gt; allow
      rule &lt;span class="m"&gt;20090&lt;/span&gt; ipv4 protocol icmp echo-reply from &lt;span class="m"&gt;12&lt;/span&gt;.12.12.0/24 to any &lt;span class="k"&gt;do&lt;/span&gt; allow
      rule &lt;span class="m"&gt;20100&lt;/span&gt; ipv4 protocol icmp echo-request from any to &lt;span class="m"&gt;172&lt;/span&gt;.16.10.0/24 &lt;span class="k"&gt;do&lt;/span&gt; allow
      rule &lt;span class="m"&gt;20110&lt;/span&gt; ipv4 protocol icmp echo-reply from &lt;span class="m"&gt;172&lt;/span&gt;.16.10.0/24 to any &lt;span class="k"&gt;do&lt;/span&gt; allow

      &lt;span class="c1"&gt;# 开放 vm1 eth0的22端口，vm2 eth0的22端口 （针对单个虚拟网卡配置filter规则）&lt;/span&gt;
      rule &lt;span class="m"&gt;20120&lt;/span&gt; processing forward ipv4 protocol tcp from any to &lt;span class="m"&gt;12&lt;/span&gt;.12.12.120&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;22&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; allow
      rule &lt;span class="m"&gt;20130&lt;/span&gt; processing forward ipv4 protocol tcp from &lt;span class="m"&gt;12&lt;/span&gt;.12.12.120&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;22&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; to any &lt;span class="k"&gt;do&lt;/span&gt; allow
      rule &lt;span class="m"&gt;20140&lt;/span&gt; processing forward ipv4 protocol tcp from any to &lt;span class="m"&gt;172&lt;/span&gt;.16.10.100&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;22&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="k"&gt;do&lt;/span&gt; allow
      rule &lt;span class="m"&gt;20150&lt;/span&gt; processing forward ipv4 protocol tcp from &lt;span class="m"&gt;172&lt;/span&gt;.16.10.100&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;22&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; to any &lt;span class="k"&gt;do&lt;/span&gt; allow

      &lt;span class="c1"&gt;# 开放subnet1：12.12.12.0/24 子网段路由转发功能&lt;/span&gt;
      rule &lt;span class="m"&gt;20180&lt;/span&gt; processing forward ipv4 from any to &lt;span class="m"&gt;12&lt;/span&gt;.12.12.0/24 &lt;span class="k"&gt;do&lt;/span&gt; allow
      rule &lt;span class="m"&gt;20190&lt;/span&gt; processing forward ipv4 from &lt;span class="m"&gt;12&lt;/span&gt;.12.12.0/24 to any &lt;span class="k"&gt;do&lt;/span&gt; allow
      rule &lt;span class="m"&gt;20200&lt;/span&gt; processing output ipv4 from &lt;span class="m"&gt;12&lt;/span&gt;.12.12.0/24 to any &lt;span class="k"&gt;do&lt;/span&gt; allow
      rule &lt;span class="m"&gt;20210&lt;/span&gt; processing input ipv4 from any to &lt;span class="m"&gt;12&lt;/span&gt;.12.12.0/24 &lt;span class="k"&gt;do&lt;/span&gt; allow
    &lt;span class="c1"&gt;# RPF RULES&lt;/span&gt;
    &lt;span class="c1"&gt;# FILTER STATEMENT&lt;/span&gt;
      filter &lt;span class="nb"&gt;enable&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;</content></entry><entry><title>6wind 配置 PCI Passthrough</title><link href="https://andiaq.github.io/posts/2018/07/25/6wind-pci-passthrough.html" rel="alternate"></link><published>2018-07-25T15:14:00+08:00</published><updated>2018-07-25T15:14:00+08:00</updated><author><name>Yuwei Wang</name></author><id>tag:andiaq.github.io,2018-07-25:/posts/2018/07/25/6wind-pci-passthrough.html</id><summary type="html">&lt;h3&gt;一、前置条件&lt;/h3&gt;
&lt;p&gt;libvirt pci passthrough 功能需宿主机开启 VT-d 和 IOMMU 功能。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;VT-d 验证。判断 CPU 是否支持 vt 功能，对于 intel CPU，验证方式如下，如果有结果，则支持。判断 VT 功能是否开启，可以执行 kvm-ok 命令或者查看 /dev/kvm 是否存在。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# grep &amp;quot;vmx&amp;quot; /proc/cpuinfo&lt;/span&gt;
&lt;span class="c1"&gt;# kvm-ok&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;开启 IOMMU，配置验证如下：&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# vim /etc/default/grub &lt;/span&gt;
...
&lt;span class="nv"&gt;GRUB_CMDLINE_LINUX&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;crashkernel=auto rhgb quiet intel_iommu …&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;</summary><content type="html">&lt;h3&gt;一、前置条件&lt;/h3&gt;
&lt;p&gt;libvirt pci passthrough 功能需宿主机开启 VT-d 和 IOMMU 功能。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;VT-d 验证。判断 CPU 是否支持 vt 功能，对于 intel CPU，验证方式如下，如果有结果，则支持。判断 VT 功能是否开启，可以执行 kvm-ok 命令或者查看 /dev/kvm 是否存在。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# grep &amp;quot;vmx&amp;quot; /proc/cpuinfo&lt;/span&gt;
&lt;span class="c1"&gt;# kvm-ok&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;开启 IOMMU，配置验证如下：&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# vim /etc/default/grub &lt;/span&gt;
...
&lt;span class="nv"&gt;GRUB_CMDLINE_LINUX&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;crashkernel=auto rhgb quiet intel_iommu=on&amp;quot;&lt;/span&gt;    &lt;span class="c1"&gt;# 添加intel_iommu=on&lt;/span&gt;
...
&lt;span class="c1"&gt;# grub2-mkconfig -o /boot/grub2/grub.cfg 更新内核参数&lt;/span&gt;
&lt;span class="c1"&gt;# reboot 重启使更改的参数生效&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;二、宿主机配置&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;在物理机上选择需要直通的网卡，使用如下命令查看与网卡相关的 pci 设备及详细信息。这里我们选择使用直通 01:00.0 pci 设备。后续均以此 pci 设备为例进行介绍。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;[root@localhost ~]# lspci | grep Eth
01:00.0 Ethernet controller: Intel Corporation 82599ES 10-Gigabit SFI/SFP+ Network Connection (rev 01)
01:00.1 Ethernet controller: Intel Corporation 82599ES 10-Gigabit SFI/SFP+ Network Connection (rev 01)
03:00.0 Ethernet controller: Intel Corporation 82599ES 10-Gigabit SFI/SFP+ Network Connection (rev 01)
03:00.1 Ethernet controller: Intel Corporation 82599ES 10-Gigabit SFI/SFP+ Network Connection (rev 01)
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;使用 virsh 查看详细信息，同样我们选取 &lt;code&gt;pci_0000_03_00_0&lt;/code&gt; ,查看 bus, slot,和 function 值。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# virsh nodedev-list --tree&lt;/span&gt;
&lt;span class="o"&gt;[&lt;/span&gt;root@localhost ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# virsh nodedev-list --tree &lt;/span&gt;
computer
  &lt;span class="p"&gt;|&lt;/span&gt;
  +- net_lo_00_00_00_00_00_00
  +- pci_0000_00_00_0
  +- pci_0000_00_01_0
  &lt;span class="p"&gt;|&lt;/span&gt;   &lt;span class="p"&gt;|&lt;/span&gt;
  &lt;span class="p"&gt;|&lt;/span&gt;   +- pci_0000_01_00_0
  &lt;span class="p"&gt;|&lt;/span&gt;   &lt;span class="p"&gt;|&lt;/span&gt;   &lt;span class="p"&gt;|&lt;/span&gt;
  &lt;span class="p"&gt;|&lt;/span&gt;   &lt;span class="p"&gt;|&lt;/span&gt;   +- net_ens20f0_d8_c4_97_0a_39_57
  &lt;span class="p"&gt;|&lt;/span&gt;   &lt;span class="p"&gt;|&lt;/span&gt;     
  &lt;span class="p"&gt;|&lt;/span&gt;   +- pci_0000_01_00_1
  &lt;span class="p"&gt;|&lt;/span&gt;       &lt;span class="p"&gt;|&lt;/span&gt;
  &lt;span class="p"&gt;|&lt;/span&gt;       +- net_ens20f1_d8_c4_97_0a_39_58
  &lt;span class="p"&gt;|&lt;/span&gt;         
  +- pci_0000_00_02_0
  &lt;span class="p"&gt;|&lt;/span&gt;   &lt;span class="p"&gt;|&lt;/span&gt;
  &lt;span class="p"&gt;|&lt;/span&gt;   +- pci_0000_03_00_0
  &lt;span class="p"&gt;|&lt;/span&gt;   &lt;span class="p"&gt;|&lt;/span&gt;   &lt;span class="p"&gt;|&lt;/span&gt;
  &lt;span class="p"&gt;|&lt;/span&gt;   &lt;span class="p"&gt;|&lt;/span&gt;   +- net_ens10f0_90_e2_ba_f7_53_10
  &lt;span class="p"&gt;|&lt;/span&gt;   &lt;span class="p"&gt;|&lt;/span&gt;     
  &lt;span class="p"&gt;|&lt;/span&gt;   +- pci_0000_03_00_1
  &lt;span class="p"&gt;|&lt;/span&gt;       &lt;span class="p"&gt;|&lt;/span&gt;
  &lt;span class="p"&gt;|&lt;/span&gt;       +- net_ens10f1_90_e2_ba_f7_53_11

...
&lt;span class="o"&gt;[&lt;/span&gt;root@localhost ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# virsh nodedev-dumpxml pci_0000_03_00_0&lt;/span&gt;
&amp;lt;device&amp;gt;
  &amp;lt;name&amp;gt;pci_0000_03_00_0&amp;lt;/name&amp;gt;
  &amp;lt;path&amp;gt;/sys/devices/pci0000:00/0000:00:02.0/0000:03:00.0&amp;lt;/path&amp;gt;
  &amp;lt;parent&amp;gt;pci_0000_00_02_0&amp;lt;/parent&amp;gt;
  &amp;lt;driver&amp;gt;
    &amp;lt;name&amp;gt;ixgbe&amp;lt;/name&amp;gt;
  &amp;lt;/driver&amp;gt;
  &amp;lt;capability &lt;span class="nv"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;pci&amp;#39;&lt;/span&gt;&amp;gt;
    &amp;lt;domain&amp;gt;0&amp;lt;/domain&amp;gt;
    &amp;lt;bus&amp;gt;3&amp;lt;/bus&amp;gt;
    &amp;lt;slot&amp;gt;0&amp;lt;/slot&amp;gt;
    &amp;lt;&lt;span class="k"&gt;function&lt;/span&gt;&amp;gt;0&amp;lt;/function&amp;gt;
    &amp;lt;product &lt;span class="nv"&gt;id&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;0x10fb&amp;#39;&lt;/span&gt;&amp;gt;82599ES &lt;span class="m"&gt;10&lt;/span&gt;-Gigabit SFI/SFP+ Network Connection&amp;lt;/product&amp;gt;
    &amp;lt;vendor &lt;span class="nv"&gt;id&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;0x8086&amp;#39;&lt;/span&gt;&amp;gt;Intel Corporation&amp;lt;/vendor&amp;gt;
    &amp;lt;capability &lt;span class="nv"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;virt_functions&amp;#39;&lt;/span&gt; &lt;span class="nv"&gt;maxCount&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;63&amp;#39;&lt;/span&gt;/&amp;gt;
    &amp;lt;iommuGroup &lt;span class="nv"&gt;number&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;44&amp;#39;&lt;/span&gt;&amp;gt;
      &amp;lt;address &lt;span class="nv"&gt;domain&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;0x0000&amp;#39;&lt;/span&gt; &lt;span class="nv"&gt;bus&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;0x03&amp;#39;&lt;/span&gt; &lt;span class="nv"&gt;slot&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;0x00&amp;#39;&lt;/span&gt; &lt;span class="k"&gt;function&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;0x0&amp;#39;&lt;/span&gt;/&amp;gt;
    &amp;lt;/iommuGroup&amp;gt;
    &amp;lt;numa &lt;span class="nv"&gt;node&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;0&amp;#39;&lt;/span&gt;/&amp;gt;
    &amp;lt;pci-express&amp;gt;
      &amp;lt;link &lt;span class="nv"&gt;validity&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;cap&amp;#39;&lt;/span&gt; &lt;span class="nv"&gt;port&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;0&amp;#39;&lt;/span&gt; &lt;span class="nv"&gt;speed&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;5&amp;#39;&lt;/span&gt; &lt;span class="nv"&gt;width&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;8&amp;#39;&lt;/span&gt;/&amp;gt;
      &amp;lt;link &lt;span class="nv"&gt;validity&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;sta&amp;#39;&lt;/span&gt; &lt;span class="nv"&gt;speed&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;5&amp;#39;&lt;/span&gt; &lt;span class="nv"&gt;width&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;8&amp;#39;&lt;/span&gt;/&amp;gt;
    &amp;lt;/pci-express&amp;gt;
  &amp;lt;/capability&amp;gt;
&amp;lt;/device&amp;gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;将以上选取的enp6s0网卡从物理机上解除绑定，并更换驱动为pci-stub。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;#lspci -nn | grep 06:00.0，查看vendor_id以及product_id，这里分别是 1137 和 0043&lt;/span&gt;
&lt;span class="m"&gt;06&lt;/span&gt;:00.0 Ethernet controller &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;0200&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;: Cisco Systems Inc VIC Ethernet NIC &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;1137&lt;/span&gt;:0043&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;rev a2&lt;span class="o"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;# 将vendor_id以及product_id写入到driver中&lt;/span&gt;
&lt;span class="c1"&gt;# echo &amp;quot;1137 0043&amp;quot; &amp;gt; /sys/bus/pci/drivers/pci-stub/new_id&lt;/span&gt;
&lt;span class="c1"&gt;# echo 0000:03:00.0 &amp;gt; /sys/bus/pci/devices/0000\:03\:00.0/driver/unbind&lt;/span&gt;
&lt;span class="c1"&gt;# echo 0000:03:00.0 &amp;gt; /sys/bus/pci/drivers/pci-stub/bind&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;配置完可以看到网卡驱动已经换成pci-stub.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;root@localhost ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# lspci -v -s 03:00.0&lt;/span&gt;
&lt;span class="m"&gt;03&lt;/span&gt;:00.0 Ethernet controller: Intel Corporation 82599ES &lt;span class="m"&gt;10&lt;/span&gt;-Gigabit SFI/SFP+ Network Connection &lt;span class="o"&gt;(&lt;/span&gt;rev &lt;span class="m"&gt;01&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
    Subsystem: Intel Corporation Ethernet Server Adapter X520-2
    Physical Slot: &lt;span class="m"&gt;10&lt;/span&gt;
    Flags: fast devsel, IRQ &lt;span class="m"&gt;26&lt;/span&gt;, NUMA node &lt;span class="m"&gt;0&lt;/span&gt;
    Memory at c7180000 &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;64&lt;/span&gt;-bit, non-prefetchable&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;size&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;512K&lt;span class="o"&gt;]&lt;/span&gt;
    I/O ports at &lt;span class="m"&gt;5020&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;size&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;32&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;
    Memory at c7604000 &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;64&lt;/span&gt;-bit, non-prefetchable&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="nv"&gt;size&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;16K&lt;span class="o"&gt;]&lt;/span&gt;
    Capabilities: &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;40&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; Power Management version &lt;span class="m"&gt;3&lt;/span&gt;
    Capabilities: &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;50&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; MSI: Enable- &lt;span class="nv"&gt;Count&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;/1 Maskable+ 64bit+
    Capabilities: &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;70&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; MSI-X: Enable- &lt;span class="nv"&gt;Count&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;64&lt;/span&gt; Masked-
    Capabilities: &lt;span class="o"&gt;[&lt;/span&gt;a0&lt;span class="o"&gt;]&lt;/span&gt; Express Endpoint, MSI &lt;span class="m"&gt;00&lt;/span&gt;
    Capabilities: &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;100&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; Advanced Error Reporting
    Capabilities: &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;140&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; Device Serial Number &lt;span class="m"&gt;90&lt;/span&gt;-e2-ba-ff-ff-f7-53-10
    Capabilities: &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;150&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; Alternative Routing-ID Interpretation &lt;span class="o"&gt;(&lt;/span&gt;ARI&lt;span class="o"&gt;)&lt;/span&gt;
    Capabilities: &lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;160&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt; Single Root I/O Virtualization &lt;span class="o"&gt;(&lt;/span&gt;SR-IOV&lt;span class="o"&gt;)&lt;/span&gt;
    Kernel driver in use: pci-stub
    Kernel modules: ixgbe
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;将 &lt;code&gt;0000:06:00.0&lt;/code&gt; 设备直通给虚拟机，虚拟机 xml 配置添加信息如下，其中 bus, slot, function 值为从上面查看到的值的 16 进制：&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nt"&gt;&amp;lt;hostdev&lt;/span&gt; &lt;span class="na"&gt;mode=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;subsystem&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;type=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;pci&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;managed=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;yes&amp;#39;&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;source&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;address&lt;/span&gt; &lt;span class="na"&gt;domain=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;0x0000&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;bus=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;0x03&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;slot=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;0x00&amp;#39;&lt;/span&gt; &lt;span class="na"&gt;function=&lt;/span&gt;&lt;span class="s"&gt;&amp;#39;0x0&amp;#39;&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;/source&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/hostdev&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;开启虚拟机。&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;三、直通功能验证&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;进入虚拟机后，查看 pci 设备信息，可以看到所直通的物理网卡设备，如下 00:03:0：&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;root@localhost:~# lspci
&lt;span class="m"&gt;00&lt;/span&gt;:00.0 Host bridge: Intel Corporation 440FX - 82441FX PMC &lt;span class="o"&gt;[&lt;/span&gt;Natoma&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;rev &lt;span class="m"&gt;02&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00&lt;/span&gt;:01.0 ISA bridge: Intel Corporation 82371SB PIIX3 ISA &lt;span class="o"&gt;[&lt;/span&gt;Natoma/Triton II&lt;span class="o"&gt;]&lt;/span&gt;
&lt;span class="m"&gt;00&lt;/span&gt;:01.1 IDE interface: Intel Corporation 82371SB PIIX3 IDE &lt;span class="o"&gt;[&lt;/span&gt;Natoma/Triton II&lt;span class="o"&gt;]&lt;/span&gt;
&lt;span class="m"&gt;00&lt;/span&gt;:01.2 USB controller: Intel Corporation 82371SB PIIX3 USB &lt;span class="o"&gt;[&lt;/span&gt;Natoma/Triton II&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;rev &lt;span class="m"&gt;01&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00&lt;/span&gt;:01.3 Bridge: Intel Corporation 82371AB/EB/MB PIIX4 ACPI &lt;span class="o"&gt;(&lt;/span&gt;rev &lt;span class="m"&gt;03&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00&lt;/span&gt;:02.0 VGA compatible controller: Cirrus Logic GD &lt;span class="m"&gt;5446&lt;/span&gt;
&lt;span class="m"&gt;00&lt;/span&gt;:03.0 Ethernet controller: Intel Corporation 82599ES &lt;span class="m"&gt;10&lt;/span&gt;-Gigabit SFI/SFP+ Network Connection &lt;span class="o"&gt;(&lt;/span&gt;rev &lt;span class="m"&gt;01&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00&lt;/span&gt;:04.0 SCSI storage controller: Red Hat, Inc Virtio SCSI
&lt;span class="m"&gt;00&lt;/span&gt;:05.0 Communication controller: Red Hat, Inc Virtio console
&lt;span class="m"&gt;00&lt;/span&gt;:06.0 Unclassified device &lt;span class="o"&gt;[&lt;/span&gt;00ff&lt;span class="o"&gt;]&lt;/span&gt;: Red Hat, Inc Virtio memory balloon

root@localhost:~# lspci -mm &lt;span class="p"&gt;|&lt;/span&gt; grep &lt;span class="m"&gt;00&lt;/span&gt;:03.0
&lt;span class="m"&gt;00&lt;/span&gt;:03.0 &lt;span class="s2"&gt;&amp;quot;Ethernet controller&amp;quot;&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Intel Corporation&amp;quot;&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;82599ES 10-Gigabit SFI/SFP+ Network Connection&amp;quot;&lt;/span&gt; -r01 &lt;span class="s2"&gt;&amp;quot;Intel Corporation&amp;quot;&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Ethernet Server Adapter X520-2&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;脚本请移步：https://github.com/DPDK/dpdk/blob/v1.8.0/tools/dpdk_nic_bind.py&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="nd"&gt;@router&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="o"&gt;~&lt;/span&gt;&lt;span class="c1"&gt;# python dpdk_nic_bind.py --status&lt;/span&gt;

&lt;span class="n"&gt;Network&lt;/span&gt; &lt;span class="n"&gt;devices&lt;/span&gt; &lt;span class="n"&gt;using&lt;/span&gt; &lt;span class="n"&gt;DPDK&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;compatible&lt;/span&gt; &lt;span class="n"&gt;driver&lt;/span&gt;
&lt;span class="o"&gt;============================================&lt;/span&gt;
&lt;span class="mo"&gt;0000&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mo"&gt;00&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mf"&gt;03.0&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;82599ES 10-Gigabit SFI/SFP+ Network Connection&amp;#39;&lt;/span&gt; &lt;span class="n"&gt;drv&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;igb_uio&lt;/span&gt; &lt;span class="n"&gt;unused&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;ixgbe&lt;/span&gt;
&lt;span class="mo"&gt;0000&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mo"&gt;00&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mf"&gt;07.0&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;82599ES 10-Gigabit SFI/SFP+ Network Connection&amp;#39;&lt;/span&gt; &lt;span class="n"&gt;drv&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;igb_uio&lt;/span&gt; &lt;span class="n"&gt;unused&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;ixgbe&lt;/span&gt;

&lt;span class="n"&gt;Network&lt;/span&gt; &lt;span class="n"&gt;devices&lt;/span&gt; &lt;span class="n"&gt;using&lt;/span&gt; &lt;span class="n"&gt;kernel&lt;/span&gt; &lt;span class="n"&gt;driver&lt;/span&gt;
&lt;span class="o"&gt;===================================&lt;/span&gt;
&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;none&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;

&lt;span class="n"&gt;Other&lt;/span&gt; &lt;span class="n"&gt;network&lt;/span&gt; &lt;span class="n"&gt;devices&lt;/span&gt;
&lt;span class="o"&gt;=====================&lt;/span&gt;
&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;none&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;另外补充内容，查看网卡是否支持DPDK，可以进行如下验证：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# 查看网卡的设备id&lt;/span&gt;
&lt;span class="c1"&gt;# cat /sys/bus/pci/devices/0000\:03\:00.0/device &lt;/span&gt;
0x0043
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;使用以上输出内容进入&lt;a href="http://doc.dpdk.org/api-2.2/rte__pci__dev__ids_8h_source.html"&gt;rte_pci_dev_ids.h&lt;/a&gt;文章中找。如果能找到，说明网卡支持 DPDK。&lt;/p&gt;
&lt;h3&gt;四、6wind 配置及 nat 验证&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;ip 配置&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;这里测试使用了两张网卡进行直通。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;root@router:~# lspci &lt;span class="p"&gt;|&lt;/span&gt; grep Eth
&lt;span class="m"&gt;00&lt;/span&gt;:03.0 Ethernet controller: Intel Corporation 82599ES &lt;span class="m"&gt;10&lt;/span&gt;-Gigabit SFI/SFP+ Network Connection &lt;span class="o"&gt;(&lt;/span&gt;rev &lt;span class="m"&gt;01&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
&lt;span class="m"&gt;00&lt;/span&gt;:07.0 Ethernet controller: Intel Corporation 82599ES &lt;span class="m"&gt;10&lt;/span&gt;-Gigabit SFI/SFP+ Network Connection &lt;span class="o"&gt;(&lt;/span&gt;rev &lt;span class="m"&gt;01&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;创建vlan接口，并配置ip地址：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;root@router:~# ip a
&lt;span class="m"&gt;1&lt;/span&gt;: lo: &amp;lt;LOOPBACK,UP,LOWER_UP&amp;gt; mtu &lt;span class="m"&gt;65536&lt;/span&gt; qdisc noqueue state UNKNOWN group default qlen &lt;span class="m"&gt;1&lt;/span&gt;
    link/loopback &lt;span class="m"&gt;00&lt;/span&gt;:00:00:00:00:00 brd &lt;span class="m"&gt;00&lt;/span&gt;:00:00:00:00:00
    inet &lt;span class="m"&gt;127&lt;/span&gt;.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
&lt;span class="m"&gt;4&lt;/span&gt;: fpn0: &amp;lt;BROADCAST,MULTICAST,NOARP,UP,LOWER_UP&amp;gt; mtu &lt;span class="m"&gt;65536&lt;/span&gt; qdisc noqueue state UNKNOWN group default qlen &lt;span class="m"&gt;1&lt;/span&gt;
    link/ether &lt;span class="m"&gt;00&lt;/span&gt;:00:46:50:4e:00 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::200:46ff:fe50:4e00/64 scope link 
       valid_lft forever preferred_lft forever
&lt;span class="m"&gt;5&lt;/span&gt;: ens3: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu &lt;span class="m"&gt;1500&lt;/span&gt; qdisc mq state UP group default qlen &lt;span class="m"&gt;1000&lt;/span&gt;
    link/ether &lt;span class="m"&gt;90&lt;/span&gt;:e2:ba:f7:53:10 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::92e2:baff:fef7:5310/64 scope link 
       valid_lft forever preferred_lft forever
&lt;span class="m"&gt;6&lt;/span&gt;: ens7: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu &lt;span class="m"&gt;1500&lt;/span&gt; qdisc mq state UP group default qlen &lt;span class="m"&gt;1000&lt;/span&gt;
    link/ether &lt;span class="m"&gt;90&lt;/span&gt;:e2:ba:f7:53:11 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::92e2:baff:fef7:5311/64 scope link 
       valid_lft forever preferred_lft forever
&lt;span class="m"&gt;7&lt;/span&gt;: vlan401@ens3: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu &lt;span class="m"&gt;1500&lt;/span&gt; qdisc noqueue state UP group default qlen &lt;span class="m"&gt;1000&lt;/span&gt;
    link/ether &lt;span class="m"&gt;02&lt;/span&gt;:09:c0:9e:47:f8 brd ff:ff:ff:ff:ff:ff
    inet &lt;span class="m"&gt;10&lt;/span&gt;.128.120.65/22 brd &lt;span class="m"&gt;10&lt;/span&gt;.128.123.255 scope global vlan401
       valid_lft forever preferred_lft forever
    inet6 fe80::9:c0ff:fe9e:47f8/64 scope link 
       valid_lft forever preferred_lft forever
&lt;span class="m"&gt;8&lt;/span&gt;: vlan2388@ens7: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu &lt;span class="m"&gt;1500&lt;/span&gt; qdisc noqueue state UP group default qlen &lt;span class="m"&gt;1000&lt;/span&gt;
    link/ether &lt;span class="m"&gt;02&lt;/span&gt;:09:c0:8b:ec:90 brd ff:ff:ff:ff:ff:ff
    inet &lt;span class="m"&gt;18&lt;/span&gt;.23.120.65/8 brd &lt;span class="m"&gt;18&lt;/span&gt;.255.255.255 scope global vlan2388
       valid_lft forever preferred_lft forever
    inet6 fe80::9:c0ff:fe8b:ec90/64 scope link 
       valid_lft forever preferred_lft forever
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;ip 信息配置如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;router&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;ens3&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mf"&gt;18.23&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="mf"&gt;120.65&lt;/span&gt;
    &lt;span class="n"&gt;ens4&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mf"&gt;10.128&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="mf"&gt;120.65&lt;/span&gt;
    &lt;span class="n"&gt;gateway&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mf"&gt;18.23&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="mf"&gt;120.10&lt;/span&gt;

&lt;span class="n"&gt;client1&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; 
    &lt;span class="n"&gt;eth0&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mf"&gt;10.128&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="mf"&gt;120.77&lt;/span&gt;
    &lt;span class="n"&gt;gateway&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mf"&gt;10.128&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="mf"&gt;120.65&lt;/span&gt;

&lt;span class="n"&gt;client2&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;eth0&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mf"&gt;18.23&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="mf"&gt;120.88&lt;/span&gt;
    &lt;span class="n"&gt;gateway&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt; &lt;span class="mf"&gt;18.23&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="mf"&gt;120.10&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;nat 配置&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;router&lt;span class="o"&gt;{&lt;/span&gt;conf:init_turbo-nat&lt;span class="o"&gt;}&lt;/span&gt;display 
    &lt;span class="c1"&gt;# NAT STATEMENTS&lt;/span&gt;

    &lt;span class="c1"&gt;# NAT PUBLIC INTERFACES&lt;/span&gt;
      public interface vlan2388
        nat &lt;span class="nb"&gt;enable&lt;/span&gt;

      &lt;span class="c1"&gt;# DYNAMIC MAPPINGS&lt;/span&gt;
        dynamic &lt;span class="m"&gt;100&lt;/span&gt; &lt;span class="m"&gt;10&lt;/span&gt;.128.120.77/8 to &lt;span class="m"&gt;18&lt;/span&gt;.23.120.65

      &lt;span class="c1"&gt;# STATIC MAPPINGS&lt;/span&gt;
        static &lt;span class="m"&gt;100&lt;/span&gt; protocol tcp public &lt;span class="m"&gt;18&lt;/span&gt;.23.120.65:2222 private &lt;span class="m"&gt;10&lt;/span&gt;.128.120.77:22
        static &lt;span class="m"&gt;200&lt;/span&gt; protocol tcp public &lt;span class="m"&gt;18&lt;/span&gt;.23.120.65:5201 private &lt;span class="m"&gt;10&lt;/span&gt;.128.120.77:5201

       &lt;span class="nb"&gt;exit&lt;/span&gt;

    &lt;span class="c1"&gt;# NAT timeouts&lt;/span&gt;

    &lt;span class="c1"&gt;# LOG&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;测试验证&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;wan to lan:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;client1 &lt;span class="c1"&gt;# iperf3 -s&lt;/span&gt;
client2 &lt;span class="c1"&gt;# iperf3 -c 18.23.120.65 -l 1518 -t 20 -P 10 -i 20 -f m&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;lan to wan:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;client1# iperf3 -c &lt;span class="m"&gt;18&lt;/span&gt;.23.120.88 -l &lt;span class="m"&gt;1518&lt;/span&gt; -t &lt;span class="m"&gt;20&lt;/span&gt; -P &lt;span class="m"&gt;10&lt;/span&gt; -i &lt;span class="m"&gt;20&lt;/span&gt; -f m
client2# iperf3 -s
&lt;/pre&gt;&lt;/div&gt;</content></entry><entry><title>OpenStack环境虚拟机打快照分析</title><link href="https://andiaq.github.io/posts/2017/03/17/create-snapshots.html" rel="alternate"></link><published>2017-03-17T10:29:00+08:00</published><updated>2017-03-17T10:29:00+08:00</updated><author><name>Yuwei Wang</name></author><id>tag:andiaq.github.io,2017-03-17:/posts/2017/03/17/create-snapshots.html</id><summary type="html">&lt;p&gt;本文主要分析OpenStack N版本中给虚拟机打快照的具体实现方式。&lt;/p&gt;
&lt;p&gt;用法：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;usage: nova image-create &lt;span class="o"&gt;[&lt;/span&gt;--metadata &amp;lt;&lt;span class="nv"&gt;key&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;value&amp;gt;&lt;span class="o"&gt;]&lt;/span&gt;
                         &lt;span class="o"&gt;[&lt;/span&gt;--show&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;--poll&lt;span class="o"&gt;]&lt;/span&gt;
                         &amp;lt;server&amp;gt; &amp;lt;name&amp;gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;strong&gt;从volume启动的虚拟机，可以对[ACTIVE, STOPPED, SUSPEND]虚拟机进行快照操作。&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;nova-api接收到请求之后，首先会从nova数据库中获取instance_system_metadata表中image metadata properties.删除不能被继承的properties(通过&lt;code&gt;non_inheritable_image_properties&lt;/code&gt;参数配置)。在获取虚拟机的image properties之后，nova-api只会先生成一个类似只有image properties（比如block device mapping, kernel and ramdisk IDs)）的bucket,实际大小设置为0。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;如果虚拟机处于ACTIVE状态，会通过发送异步RPC调用nova-compute，然后调用libvirt对虚拟机执行quiesce操作来静默文件系统，禁止磁盘继续读写，从而保证磁盘快照的一致性（执行该操作需要安装qemu-guest-agent）。在quiesce之后，获取虚拟机上挂载的所有磁盘，包括根磁盘，调用cinder-api依次对这些volume卷进行打快照 …&lt;/p&gt;&lt;/li&gt;&lt;/ol&gt;</summary><content type="html">&lt;p&gt;本文主要分析OpenStack N版本中给虚拟机打快照的具体实现方式。&lt;/p&gt;
&lt;p&gt;用法：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;usage: nova image-create &lt;span class="o"&gt;[&lt;/span&gt;--metadata &amp;lt;&lt;span class="nv"&gt;key&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;value&amp;gt;&lt;span class="o"&gt;]&lt;/span&gt;
                         &lt;span class="o"&gt;[&lt;/span&gt;--show&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="o"&gt;[&lt;/span&gt;--poll&lt;span class="o"&gt;]&lt;/span&gt;
                         &amp;lt;server&amp;gt; &amp;lt;name&amp;gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;strong&gt;从volume启动的虚拟机，可以对[ACTIVE, STOPPED, SUSPEND]虚拟机进行快照操作。&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;nova-api接收到请求之后，首先会从nova数据库中获取instance_system_metadata表中image metadata properties.删除不能被继承的properties(通过&lt;code&gt;non_inheritable_image_properties&lt;/code&gt;参数配置)。在获取虚拟机的image properties之后，nova-api只会先生成一个类似只有image properties（比如block device mapping, kernel and ramdisk IDs)）的bucket,实际大小设置为0。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;如果虚拟机处于ACTIVE状态，会通过发送异步RPC调用nova-compute，然后调用libvirt对虚拟机执行quiesce操作来静默文件系统，禁止磁盘继续读写，从而保证磁盘快照的一致性（执行该操作需要安装qemu-guest-agent）。在quiesce之后，获取虚拟机上挂载的所有磁盘，包括根磁盘，调用cinder-api依次对这些volume卷进行打快照（但是nova-api只会获取这些volume snapshot的id信息，然后更新到meta）。对磁盘打完快照之后，执行unquiesce进行解冻。并将卷快照的信息更新保存到instance_system_metadata表的&lt;code&gt;block_device_mapping&lt;/code&gt;参数中。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;总的来说，nova-api所做的操作都是为了最后能获取虚拟机更新后的新image-meta数据，并没有执行创建工作。&lt;/p&gt;
&lt;p&gt;对虚拟机执行quiesce操作的测试如下：&lt;/p&gt;
&lt;p&gt;1）对虚拟机注入循环执行程序，该程序实现向另外一个文件持续写入时间戳。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;root@jenkins test&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# tailf quiesce.log&lt;/span&gt;
&lt;span class="m"&gt;1489632992&lt;/span&gt;.9
&lt;span class="m"&gt;1489632993&lt;/span&gt;.91
&lt;span class="m"&gt;1489632994&lt;/span&gt;.91
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;2）在虚拟机所在的宿主机上执行以下命令：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ virsh qemu-agent-command instance-0003abaf &lt;span class="s1"&gt;&amp;#39;{&amp;quot;execute&amp;quot;:&amp;quot;guest-fsfreeze-freeze&amp;quot;}&amp;#39;&lt;/span&gt;
&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;return&amp;quot;&lt;/span&gt;:2&lt;span class="o"&gt;}&lt;/span&gt;
查看quiesce状态：
$ virsh qemu-agent-command instance-0003abaf &lt;span class="s1"&gt;&amp;#39;{&amp;quot;execute&amp;quot;:&amp;quot;guest-fsfreeze-status&amp;quot;}&amp;#39;&lt;/span&gt;
&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;return&amp;quot;&lt;/span&gt;:&lt;span class="s2"&gt;&amp;quot;frozen&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;3）等待一会儿之后，将虚拟机解冻，查看日志。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ virsh qemu-agent-command instance-0003abaf &lt;span class="s1"&gt;&amp;#39;{&amp;quot;execute&amp;quot;:&amp;quot;guest-fsfreeze-thaw&amp;quot;}&amp;#39;&lt;/span&gt;
&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;return&amp;quot;&lt;/span&gt;:2&lt;span class="o"&gt;}&lt;/span&gt;
$ virsh qemu-agent-command instance-0003abaf &lt;span class="s1"&gt;&amp;#39;{&amp;quot;execute&amp;quot;:&amp;quot;guest-fsfreeze-status&amp;quot;}&amp;#39;&lt;/span&gt;
&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;return&amp;quot;&lt;/span&gt;:&lt;span class="s2"&gt;&amp;quot;thawed&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;
&lt;span class="o"&gt;[&lt;/span&gt;root@jenkins test&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# tailf quiesce.log&lt;/span&gt;
&lt;span class="m"&gt;1489632991&lt;/span&gt;.9
&lt;span class="m"&gt;1489632992&lt;/span&gt;.9
&lt;span class="m"&gt;1489632993&lt;/span&gt;.91
&lt;span class="m"&gt;1489632994&lt;/span&gt;.91
&lt;span class="m"&gt;1489633427&lt;/span&gt;.07
&lt;span class="m"&gt;1489633428&lt;/span&gt;.07
&lt;span class="m"&gt;1489633429&lt;/span&gt;.07
&lt;span class="m"&gt;1489633430&lt;/span&gt;.07
&lt;span class="m"&gt;1489633431&lt;/span&gt;.07
&lt;span class="m"&gt;1489633432&lt;/span&gt;.07
&lt;span class="m"&gt;1489633433&lt;/span&gt;.08
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;通过以上结果可以发现，在对虚拟机执行quiesce之后，虚拟机确实不再写入文件，thaw之后，虚拟机继续写入文件。达到预期结果。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;nova-api在获取新image-meta元数据之后，会向glance-api发送create信息。glance-api根据传过来的instance和image-meta信息创建快照镜像。所以glance创建的快照镜像中只会保存volume snapshot信息到&lt;code&gt;block_device_mapping&lt;/code&gt;，镜像中不会存在磁盘数据。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;root@controller ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# nova image-create f0d1455f-5079-4ffd-b954-0762159e9793 wei-v1-snap&lt;/span&gt;
&lt;span class="o"&gt;[&lt;/span&gt;root@controller ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# cinder snapshot-list&lt;/span&gt;
+--------------------------------------+--------------------------------------+-----------+--------------------------+------+
&lt;span class="p"&gt;|&lt;/span&gt; ID                                   &lt;span class="p"&gt;|&lt;/span&gt; Volume ID                            &lt;span class="p"&gt;|&lt;/span&gt; Status    &lt;span class="p"&gt;|&lt;/span&gt; Name                     &lt;span class="p"&gt;|&lt;/span&gt; Size &lt;span class="p"&gt;|&lt;/span&gt;
+--------------------------------------+--------------------------------------+-----------+--------------------------+------+
&lt;span class="p"&gt;|&lt;/span&gt; 5e33cc09-01d8-423f-be26-ad1f44b6689e &lt;span class="p"&gt;|&lt;/span&gt; 2495add5-969b-4b4c-97c2-f7a2c378431e &lt;span class="p"&gt;|&lt;/span&gt; available &lt;span class="p"&gt;|&lt;/span&gt; snapshot &lt;span class="k"&gt;for&lt;/span&gt; wei-v1-snap &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1&lt;/span&gt;    &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; fd284012-7771-42af-92a0-949569ad527b &lt;span class="p"&gt;|&lt;/span&gt; 174495f0-bf09-49c9-ba8a-b1603f75db68 &lt;span class="p"&gt;|&lt;/span&gt; available &lt;span class="p"&gt;|&lt;/span&gt; snapshot &lt;span class="k"&gt;for&lt;/span&gt; wei-v1-snap &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;20&lt;/span&gt;   &lt;span class="p"&gt;|&lt;/span&gt;
+--------------------------------------+--------------------------------------+-----------+--------------------------+------+

&lt;span class="o"&gt;[&lt;/span&gt;root@controller ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# glance image-show 9d1c6596-4b5c-49a9-87a6-51603460aeed&lt;/span&gt;
+----------------------+----------------------------------------------------------------------------------+
&lt;span class="p"&gt;|&lt;/span&gt; Property             &lt;span class="p"&gt;|&lt;/span&gt; Value                                                                            &lt;span class="p"&gt;|&lt;/span&gt;
+----------------------+----------------------------------------------------------------------------------+
&lt;span class="p"&gt;|&lt;/span&gt; base_image_ref       &lt;span class="p"&gt;|&lt;/span&gt;                                                                                  &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; bdm_v2               &lt;span class="p"&gt;|&lt;/span&gt; True                                                                             &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; block_device_mapping &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="o"&gt;[{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;guest_format&amp;quot;&lt;/span&gt;: null, &lt;span class="s2"&gt;&amp;quot;boot_index&amp;quot;&lt;/span&gt;: &lt;span class="m"&gt;0&lt;/span&gt;, &lt;span class="s2"&gt;&amp;quot;delete_on_termination&amp;quot;&lt;/span&gt;: false,         &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt;                      &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;no_device&amp;quot;&lt;/span&gt;: null, &lt;span class="s2"&gt;&amp;quot;snapshot_id&amp;quot;&lt;/span&gt;: &lt;span class="s2"&gt;&amp;quot;fd284012-7771-42af-92a0-949569ad527b&amp;quot;&lt;/span&gt;,        &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt;                      &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;device_name&amp;quot;&lt;/span&gt;: &lt;span class="s2"&gt;&amp;quot;/dev/vda&amp;quot;&lt;/span&gt;, &lt;span class="s2"&gt;&amp;quot;disk_bus&amp;quot;&lt;/span&gt;: &lt;span class="s2"&gt;&amp;quot;virtio&amp;quot;&lt;/span&gt;, &lt;span class="s2"&gt;&amp;quot;image_id&amp;quot;&lt;/span&gt;: null,               &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt;                      &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;source_type&amp;quot;&lt;/span&gt;: &lt;span class="s2"&gt;&amp;quot;snapshot&amp;quot;&lt;/span&gt;, &lt;span class="s2"&gt;&amp;quot;tag&amp;quot;&lt;/span&gt;: null, &lt;span class="s2"&gt;&amp;quot;device_type&amp;quot;&lt;/span&gt;: &lt;span class="s2"&gt;&amp;quot;disk&amp;quot;&lt;/span&gt;, &lt;span class="s2"&gt;&amp;quot;volume_id&amp;quot;&lt;/span&gt;:      &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt;                      &lt;span class="p"&gt;|&lt;/span&gt; null, &lt;span class="s2"&gt;&amp;quot;destination_type&amp;quot;&lt;/span&gt;: &lt;span class="s2"&gt;&amp;quot;volume&amp;quot;&lt;/span&gt;, &lt;span class="s2"&gt;&amp;quot;volume_size&amp;quot;&lt;/span&gt;: &lt;span class="m"&gt;20&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;, &lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;guest_format&amp;quot;&lt;/span&gt;: null,   &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt;                      &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;boot_index&amp;quot;&lt;/span&gt;: null, &lt;span class="s2"&gt;&amp;quot;delete_on_termination&amp;quot;&lt;/span&gt;: false, &lt;span class="s2"&gt;&amp;quot;no_device&amp;quot;&lt;/span&gt;: null,           &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt;                      &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;snapshot_id&amp;quot;&lt;/span&gt;: &lt;span class="s2"&gt;&amp;quot;5e33cc09-01d8-423f-be26-ad1f44b6689e&amp;quot;&lt;/span&gt;, &lt;span class="s2"&gt;&amp;quot;device_name&amp;quot;&lt;/span&gt;:            &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt;                      &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;/dev/vdb&amp;quot;&lt;/span&gt;, &lt;span class="s2"&gt;&amp;quot;disk_bus&amp;quot;&lt;/span&gt;: null, &lt;span class="s2"&gt;&amp;quot;image_id&amp;quot;&lt;/span&gt;: null, &lt;span class="s2"&gt;&amp;quot;source_type&amp;quot;&lt;/span&gt;: &lt;span class="s2"&gt;&amp;quot;snapshot&amp;quot;&lt;/span&gt;,       &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt;                      &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;tag&amp;quot;&lt;/span&gt;: null, &lt;span class="s2"&gt;&amp;quot;device_type&amp;quot;&lt;/span&gt;: null, &lt;span class="s2"&gt;&amp;quot;volume_id&amp;quot;&lt;/span&gt;: null, &lt;span class="s2"&gt;&amp;quot;destination_type&amp;quot;&lt;/span&gt;:         &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt;                      &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;volume&amp;quot;&lt;/span&gt;, &lt;span class="s2"&gt;&amp;quot;volume_size&amp;quot;&lt;/span&gt;: &lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="o"&gt;}]&lt;/span&gt;                                                     &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; checksum             &lt;span class="p"&gt;|&lt;/span&gt; d41d8cd98f00b204e9800998ecf8427e                                                 &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; container_format     &lt;span class="p"&gt;|&lt;/span&gt; bare                                                                             &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; created_at           &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;2017&lt;/span&gt;-03-12T12:04:57Z                                                             &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; disk_format          &lt;span class="p"&gt;|&lt;/span&gt; qcow2                                                                            &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; id                   &lt;span class="p"&gt;|&lt;/span&gt; 9d1c6596-4b5c-49a9-87a6-51603460aeed                                             &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; locations            &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="o"&gt;[{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;url&amp;quot;&lt;/span&gt;: &lt;span class="s2"&gt;&amp;quot;rbd://cdd3749c-df0d-40f6-a178-78ae91517dfa/openstack-00/9d1c6596-4b5c- |&lt;/span&gt;
&lt;span class="s2"&gt;|                      | 49a9-87a6-51603460aeed/snap&amp;quot;&lt;/span&gt;, &lt;span class="s2"&gt;&amp;quot;metadata&amp;quot;&lt;/span&gt;: &lt;span class="o"&gt;{}}]&lt;/span&gt;                                   &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; min_disk             &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;20&lt;/span&gt;                                                                               &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; min_ram              &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;256&lt;/span&gt;                                                                              &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; name                 &lt;span class="p"&gt;|&lt;/span&gt; wei-v1-snap                                                                      &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; owner                &lt;span class="p"&gt;|&lt;/span&gt; 08c8707bb8134e6d8eff730fac326b87                                                 &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; protected            &lt;span class="p"&gt;|&lt;/span&gt; False                                                                            &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; root_device_name     &lt;span class="p"&gt;|&lt;/span&gt; /dev/vda                                                                         &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; size                 &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt;                                                                                &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; status               &lt;span class="p"&gt;|&lt;/span&gt; active                                                                           &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; tags                 &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="o"&gt;[]&lt;/span&gt;                                                                               &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; updated_at           &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;2017&lt;/span&gt;-03-12T12:04:57Z                                                             &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; virtual_size         &lt;span class="p"&gt;|&lt;/span&gt; None                                                                             &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; visibility           &lt;span class="p"&gt;|&lt;/span&gt; private                                                                          &lt;span class="p"&gt;|&lt;/span&gt;
+----------------------+----------------------------------------------------------------------------------+
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;strong&gt;从镜像启动的虚拟机，可以对[ACTIVE, STOPPED, PAUSED, SUSPEND]状态的虚拟机进行快照操作。&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;对于从镜像启动的虚拟机，同样会在创建快照之前，清除&lt;code&gt;instance_system_metadata&lt;/code&gt;数据表中的&lt;code&gt;disk_format&lt;/code&gt;和&lt;code&gt;container_format&lt;/code&gt;参数，因为新创建的镜像可能会变成其他的格式，待镜像上传之后会给这些参数填充正确的值。其次删除不能被继承的properties。但依然可以通过在执行&lt;code&gt;nova image-create $INSTANCE_ID&lt;/code&gt;时添加&lt;code&gt;--metadata &amp;lt;key=value&amp;gt;&lt;/code&gt;参数来添加新的metadata。最终获取虚拟机最新的image-meta。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;nova-api在获取新image-meta元数据之后，会向glance-api发送create信息。glance-api根据传过来的instance和image-meta信息创建快照镜像。并返回镜像对象的image_meta给nova-api。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;nova-api在拿到镜像对象的image-meta之后，然后发送异步RPC调用虚拟机所在宿主机上的nova-compute服务，再由libvirt调用snapshot接口（要求qemu版本在0.14及以上）。&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; &lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;1. 具有LVM encrypted 临时存储的虚拟机需要冷快照。但目前检查加密是多余的，因为LVM仅支持冷快照。
2. 关机状态的虚拟机只能进行冷快照。
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;live_snapshot需满足的条件：
1. hypervisor type一致。
2. image source type不是lvm;
3. nova.conf中&lt;code&gt;ephemeral_storage_encryption&lt;/code&gt;中enabled=False;
4. nova.conf中&lt;code&gt;workarounds&lt;/code&gt;中disable_libvirt_livesnapshot=False;&lt;/p&gt;
&lt;p&gt;如果满足以上条件，还需要对虚拟机的磁盘guest.get_block_device(disk_path).abort_job()&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;&lt;code&gt;live_snapshot&lt;/code&gt;和&lt;code&gt;cold_snapshot&lt;/code&gt;的区别与联系：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;区别：&lt;/strong&gt;
1. live_snapshot需满足一系列条件。
2. 对cold_snapshot来说，如果virt_type不为lxc，电源状态处于[RUNNING, PAUSED]的虚拟机会被suspend，将虚拟机内存中的信息保存到磁盘上。待虚拟机快照创建完成并上传到glance之后，再根据其xml文件开启虚拟机。
3. live_snapshot不会对虚拟机执行suspend。但在创建在线快照之前会终止根磁盘上所有任务（同时确认虚拟机处于RUNNING状态）。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;联系：&lt;/strong&gt;
1. live_snapshot与cold_snapshot创建快照的流程相同。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;live_snapshot/cold_snapshot (rbd-backend)的创建流程：&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;由于nova并不知glance是如何配置来存储image的，所以会获取虚拟机镜像所在的pool；&lt;/li&gt;
&lt;li&gt;对虚拟机根磁盘进行打快照(即创建rbd快照)并设置该快照为保护状态；&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;root@compute-bj-2-withlvm ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# rbd info openstack-00/6a1e1b85-eacb-401b-9b5c-93f59c12c8d0_disk@47e07a6c6f4d42b3817cae614493992d&lt;/span&gt;
rbd image &lt;span class="s1"&gt;&amp;#39;6a1e1b85-eacb-401b-9b5c-93f59c12c8d0_disk&amp;#39;&lt;/span&gt;:
    size &lt;span class="m"&gt;20480&lt;/span&gt; MB in &lt;span class="m"&gt;5120&lt;/span&gt; objects
    order &lt;span class="m"&gt;22&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;4096&lt;/span&gt; kB objects&lt;span class="o"&gt;)&lt;/span&gt;
    block_name_prefix: rbd_data.12ea72ae8944a
    format: &lt;span class="m"&gt;2&lt;/span&gt;
    features: layering, exclusive-lock, object-map, fast-diff, deep-flatten
    flags: 
    protected: True
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;将上面创建的快照clone到虚拟机镜像所在的pool；&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;root@compute-bj-2-withlvm ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# rbd info openstack-00/3c4b3058-0f58-483c-b7e2-20274df984d9&lt;/span&gt;
rbd image &lt;span class="s1"&gt;&amp;#39;3c4b3058-0f58-483c-b7e2-20274df984d9&amp;#39;&lt;/span&gt;:
    size &lt;span class="m"&gt;20480&lt;/span&gt; MB in &lt;span class="m"&gt;5120&lt;/span&gt; objects
    order &lt;span class="m"&gt;22&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;4096&lt;/span&gt; kB objects&lt;span class="o"&gt;)&lt;/span&gt;
    block_name_prefix: rbd_data.953d4e89a492
    format: &lt;span class="m"&gt;2&lt;/span&gt;
    features: layering, exclusive-lock, object-map, fast-diff, deep-flatten
    flags: 
    parent: openstack-00/6a1e1b85-eacb-401b-9b5c-93f59c12c8d0_disk@47e07a6c6f4d42b3817cae614493992d
    overlap: &lt;span class="m"&gt;20480&lt;/span&gt; MB
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;对快照进行flatten操作，让其与它的parent解除关联；&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;root@compute-bj-2-withlvm ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# rbd info openstack-00/3c4b3058-0f58-483c-b7e2-20274df984d9&lt;/span&gt;
rbd image &lt;span class="s1"&gt;&amp;#39;3c4b3058-0f58-483c-b7e2-20274df984d9&amp;#39;&lt;/span&gt;:
    size &lt;span class="m"&gt;20480&lt;/span&gt; MB in &lt;span class="m"&gt;5120&lt;/span&gt; objects
    order &lt;span class="m"&gt;22&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;4096&lt;/span&gt; kB objects&lt;span class="o"&gt;)&lt;/span&gt;
    block_name_prefix: rbd_data.953d4e89a492
    format: &lt;span class="m"&gt;2&lt;/span&gt;
    features: layering, exclusive-lock, object-map, fast-diff, deep-flatten
    flags: 
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;将快照（此时已经成为image）的parent删除(即删除&lt;code&gt;openstack-00/6a1e1b85-eacb-401b-9b5c-93f59c12c8d0_disk@47e07a6c6f4d42b3817cae614493992d&lt;/code&gt;)&lt;/li&gt;
&lt;li&gt;对以上生成的image创建受保护的快照&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;root@compute-bj-2-withlvm ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# rbd info openstack-00/3c4b3058-0f58-483c-b7e2-20274df984d9@snap&lt;/span&gt;
rbd image &lt;span class="s1"&gt;&amp;#39;3c4b3058-0f58-483c-b7e2-20274df984d9&amp;#39;&lt;/span&gt;:
    size &lt;span class="m"&gt;20480&lt;/span&gt; MB in &lt;span class="m"&gt;5120&lt;/span&gt; objects
    order &lt;span class="m"&gt;22&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;4096&lt;/span&gt; kB objects&lt;span class="o"&gt;)&lt;/span&gt;
    block_name_prefix: rbd_data.953d4e89a492
    format: &lt;span class="m"&gt;2&lt;/span&gt;
    features: layering, exclusive-lock, object-map, fast-diff, deep-flatten
    flags: 
    protected: True
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;更新image信息，上传到glance成功。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;{&amp;#39;status&amp;#39;: &amp;#39;active&amp;#39;, &amp;#39;name&amp;#39;: u&amp;#39;wei-image-snap&amp;#39;, &amp;#39;container_format&amp;#39;: u&amp;#39;bare&amp;#39;, &amp;#39;disk_format&amp;#39;: &amp;#39;raw&amp;#39;, &amp;#39;location&amp;#39;: u&amp;#39;rbd://cdd3749c-df0d-40f6-a178-78ae91517dfa/openstack-00/3c4b3058-0f58-483c-b7e2-20274df984d9/snap&amp;#39;, &amp;#39;is_public&amp;#39;: False&amp;#39;}
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;总结&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;从image创建的虚拟机&lt;/p&gt;
&lt;p&gt;只会对根磁盘打快照。如果要基于该快照做rebuild操作时，需要先将源虚拟机上挂载的volume卷卸载掉，再重新挂载到rebuild之后的虚拟机上。
根据以上分析，快照之后生成的image已经与其parent解除关联，所以源虚拟机是可以删除的。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;从volume创建的虚拟机&lt;/p&gt;
&lt;p&gt;会调用cinder对所有的volume卷（根磁盘和所有数据盘）打快照。
源虚拟机也是可以删除的。rebuild操作会获取快照中的block_device_mapping信息，重新创建虚拟机并挂载数据盘。&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</content></entry><entry><title>Availability Zones 及 Host Aggregate</title><link href="https://andiaq.github.io/posts/2017/03/13/ha-az.html" rel="alternate"></link><published>2017-03-13T18:30:00+08:00</published><updated>2017-03-13T18:30:00+08:00</updated><author><name>Yuwei Wang</name></author><id>tag:andiaq.github.io,2017-03-13:/posts/2017/03/13/ha-az.html</id><summary type="html">&lt;h2&gt;Availability zones&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;Availability zones&lt;/code&gt;和&lt;code&gt;host aggregates&lt;/code&gt;是在region和cell基础上提出的进一步的划分（segregation）概念。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Availability zone&lt;/code&gt;致力于通过逻辑划分提供某种形式上的物理隔离。也就是说，通过位置可用性来将服务器进行逻辑上的分组。用户可以某些可用性上的区别来指定az，从而选择所起虚拟机的“位置”。&lt;/p&gt;
&lt;p&gt;一般对于规模较大的集群比如跨数据中心，可以根据地理位置来定义az。比如：bj，sh。或是同一数据中心的不同机房，或是在同一机房的几个相邻的机架，同样可以通过位置来定义，从而保证不同az之间具有某些特性上的冗余性，比如供电系统、网络设备等。而不影响其他的 Availability Zones 上节点运行的虚拟机，通过这种划分来提高 OpenStack 的可用性。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Host Aggregates&lt;/code&gt; 是在 &lt;code&gt;Availability Zones&lt;/code&gt; 的基础上更进一步地进行逻辑的分组和隔离。例如我们可以根据不同的 computes 节点的物理硬件配置将具有相同共性的物理资源规划在同一 &lt;code&gt;Host Aggregate&lt;/code&gt; 之下，或者根据用户的具体需求将几个 computes …&lt;/p&gt;</summary><content type="html">&lt;h2&gt;Availability zones&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;Availability zones&lt;/code&gt;和&lt;code&gt;host aggregates&lt;/code&gt;是在region和cell基础上提出的进一步的划分（segregation）概念。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Availability zone&lt;/code&gt;致力于通过逻辑划分提供某种形式上的物理隔离。也就是说，通过位置可用性来将服务器进行逻辑上的分组。用户可以某些可用性上的区别来指定az，从而选择所起虚拟机的“位置”。&lt;/p&gt;
&lt;p&gt;一般对于规模较大的集群比如跨数据中心，可以根据地理位置来定义az。比如：bj，sh。或是同一数据中心的不同机房，或是在同一机房的几个相邻的机架，同样可以通过位置来定义，从而保证不同az之间具有某些特性上的冗余性，比如供电系统、网络设备等。而不影响其他的 Availability Zones 上节点运行的虚拟机，通过这种划分来提高 OpenStack 的可用性。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Host Aggregates&lt;/code&gt; 是在 &lt;code&gt;Availability Zones&lt;/code&gt; 的基础上更进一步地进行逻辑的分组和隔离。例如我们可以根据不同的 computes 节点的物理硬件配置将具有相同共性的物理资源规划在同一 &lt;code&gt;Host Aggregate&lt;/code&gt; 之下，或者根据用户的具体需求将几个 computes 节点规划在具有相同用途的同一 &lt;code&gt;Host Aggregate&lt;/code&gt; 之下，通过这样的划分有利于提高 OpenStack 资源的使用效率。&lt;code&gt;Host Aggregates&lt;/code&gt; 可以通过 nova client 或 API 来创建和配置。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;图 1.Availability Zones 与 Host Aggregates 的关系&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img alt="image" src="/images/hz_az.png"&gt;&lt;/p&gt;
&lt;h2&gt;配置&lt;/h2&gt;
&lt;p&gt;我们可以通过对 nova.conf 文件的配置来定义不同的 Availability zones。相关配置项为：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;internal_service_availability_zone&lt;/code&gt;（定义services的az，默认为internal）&lt;/li&gt;
&lt;li&gt;&lt;code&gt;default_availability_zone&lt;/code&gt; (定义计算节点的az，默认为nova)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;以上配置在nova-api节点设置，且未配置主机聚合时，可以作为默认&lt;code&gt;availability_zone&lt;/code&gt;。计算节点都将会在这个默认&lt;code&gt;availability_zone&lt;/code&gt;下。&lt;/p&gt;
&lt;h2&gt;用法&lt;/h2&gt;
&lt;p&gt;与availability_zone相关的filter：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Filter名&lt;/th&gt;
&lt;th&gt;功能描述&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;AvailabilityZoneFilter&lt;/td&gt;
&lt;td&gt;筛选出指定availability_zone中的宿主机&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;基于&lt;code&gt;availability_zone&lt;/code&gt;筛选宿主机需要在&lt;code&gt;nova-scheduler&lt;/code&gt;节点的&lt;code&gt;nova.conf&lt;/code&gt;文件配置项&lt;code&gt;scheduler_default_filters&lt;/code&gt;后面添加&lt;code&gt;AvailabilityZoneFilter&lt;/code&gt;，然后重启&lt;code&gt;openstack-nova-scheduler&lt;/code&gt;服务才能生效。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;命令行方式：&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;nova boot --flavor 1 --image e875ac34-2031-4265-890d-f6ed1968dfc7 --nic net-id=38bf1bcf-8119-49bd-ae6f-76995cb13d1f --availability-zone bj test-wei
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;strong&gt;面板方式：&lt;/strong&gt;
&lt;img alt="image" src="/images/az2.png"&gt;&lt;/p&gt;
&lt;h2&gt;Host Aggregate&lt;/h2&gt;
&lt;p&gt;从具体实现上来看，&lt;code&gt;Host aggregate&lt;/code&gt;指一组拥有关联metadata的计算节点，metadata中描述了该组计算节点所拥有的特性，比如高速网卡、GPU、SSD存储、属于特定租户、Qos等。也就是说，Host Aggregate被设计用于按能力对服务器进行分组。这些能力，通过metadata自定义。&lt;code&gt;nova-scheduler&lt;/code&gt;能够过滤不满足某些特性的主机，从而只选择只具备某些特性的主机，比如只选择配置ssd的主机或者只选择具有GPU加速的主机等。&lt;/p&gt;
&lt;p&gt;所有的&lt;code&gt;nova availability zones&lt;/code&gt;的部署都是基于&lt;code&gt;host aggregate&lt;/code&gt;实现的（尽管不是所有的宿主机聚合都叫可用区域）。&lt;/p&gt;
&lt;p&gt;Nova没有提供创建&lt;code&gt;availability_zone&lt;/code&gt;的CLI，只能通过创建&lt;code&gt;host-aggregate&lt;/code&gt;时同时创建&lt;code&gt;availability_zone&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;usage: &lt;code&gt;nova aggregate-create &amp;lt;name&amp;gt; [&amp;lt;availability-zone&amp;gt;]&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;root@controller ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# nova aggregate-create hz3 AZ3&lt;/span&gt;
+----+------+-------------------+-------+-------------------------+
&lt;span class="p"&gt;|&lt;/span&gt; Id &lt;span class="p"&gt;|&lt;/span&gt; Name &lt;span class="p"&gt;|&lt;/span&gt; Availability Zone &lt;span class="p"&gt;|&lt;/span&gt; Hosts &lt;span class="p"&gt;|&lt;/span&gt; Metadata                &lt;span class="p"&gt;|&lt;/span&gt;
+----+------+-------------------+-------+-------------------------+
&lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;4&lt;/span&gt;  &lt;span class="p"&gt;|&lt;/span&gt; hz3  &lt;span class="p"&gt;|&lt;/span&gt; AZ3               &lt;span class="p"&gt;|&lt;/span&gt;       &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;availability_zone=AZ3&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt;
+----+------+-------------------+-------+-------------------------+
&lt;span class="s1"&gt;&amp;#39;nova aggregate-create hz3 AZ3&amp;#39;&lt;/span&gt;命令等效于创建host aggregate，然后设置元数据：
&lt;span class="o"&gt;[&lt;/span&gt;root@controller ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# nova aggregate-create hz4&lt;/span&gt;
+----+------+-------------------+-------+----------+
&lt;span class="p"&gt;|&lt;/span&gt; Id &lt;span class="p"&gt;|&lt;/span&gt; Name &lt;span class="p"&gt;|&lt;/span&gt; Availability Zone &lt;span class="p"&gt;|&lt;/span&gt; Hosts &lt;span class="p"&gt;|&lt;/span&gt; Metadata &lt;span class="p"&gt;|&lt;/span&gt;
+----+------+-------------------+-------+----------+
&lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;5&lt;/span&gt;  &lt;span class="p"&gt;|&lt;/span&gt; hz4  &lt;span class="p"&gt;|&lt;/span&gt; -                 &lt;span class="p"&gt;|&lt;/span&gt;       &lt;span class="p"&gt;|&lt;/span&gt;          &lt;span class="p"&gt;|&lt;/span&gt;
+----+------+-------------------+-------+----------+
&lt;span class="o"&gt;[&lt;/span&gt;root@controller ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# nova aggregate-set-metadata hz4 availability_zone=AZ4&lt;/span&gt;
Metadata has been successfully updated &lt;span class="k"&gt;for&lt;/span&gt; aggregate &lt;span class="m"&gt;5&lt;/span&gt;.
+----+------+-------------------+-------+-------------------------+
&lt;span class="p"&gt;|&lt;/span&gt; Id &lt;span class="p"&gt;|&lt;/span&gt; Name &lt;span class="p"&gt;|&lt;/span&gt; Availability Zone &lt;span class="p"&gt;|&lt;/span&gt; Hosts &lt;span class="p"&gt;|&lt;/span&gt; Metadata                &lt;span class="p"&gt;|&lt;/span&gt;
+----+------+-------------------+-------+-------------------------+
&lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;5&lt;/span&gt;  &lt;span class="p"&gt;|&lt;/span&gt; hz4  &lt;span class="p"&gt;|&lt;/span&gt; AZ4               &lt;span class="p"&gt;|&lt;/span&gt;       &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;availability_zone=AZ4&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt;
+----+------+-------------------+-------+-------------------------+
当我们添加新节点到这个host aggregate的时，计算节点会自动被划分到该availability_zone或者具体相同特性的组。但是Nova不允许将计算节点添加到有冲突的availbility_zone。
&lt;span class="o"&gt;[&lt;/span&gt;root@controller ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# nova aggregate-show hz1&lt;/span&gt;
+----+------+-------------------+--------------------------------------------------------------------+------------------------+
&lt;span class="p"&gt;|&lt;/span&gt; Id &lt;span class="p"&gt;|&lt;/span&gt; Name &lt;span class="p"&gt;|&lt;/span&gt; Availability Zone &lt;span class="p"&gt;|&lt;/span&gt; Hosts                                                              &lt;span class="p"&gt;|&lt;/span&gt; Metadata               &lt;span class="p"&gt;|&lt;/span&gt;
+----+------+-------------------+--------------------------------------------------------------------+------------------------+
&lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1&lt;/span&gt;  &lt;span class="p"&gt;|&lt;/span&gt; hz1  &lt;span class="p"&gt;|&lt;/span&gt; bj                &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;compute-bj-1-withlvm.novalocal&amp;#39;&lt;/span&gt;, &lt;span class="s1"&gt;&amp;#39;compute-bj-2-withlvm.novalocal&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;availability_zone=bj&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt;
+----+------+-------------------+--------------------------------------------------------------------+------------------------+
&lt;span class="o"&gt;[&lt;/span&gt;root@controller ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# nova aggregate-show hz4&lt;/span&gt;
+----+------+-------------------+-------+-------------------------+
&lt;span class="p"&gt;|&lt;/span&gt; Id &lt;span class="p"&gt;|&lt;/span&gt; Name &lt;span class="p"&gt;|&lt;/span&gt; Availability Zone &lt;span class="p"&gt;|&lt;/span&gt; Hosts &lt;span class="p"&gt;|&lt;/span&gt; Metadata                &lt;span class="p"&gt;|&lt;/span&gt;
+----+------+-------------------+-------+-------------------------+
&lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;5&lt;/span&gt;  &lt;span class="p"&gt;|&lt;/span&gt; hz4  &lt;span class="p"&gt;|&lt;/span&gt; AZ4               &lt;span class="p"&gt;|&lt;/span&gt;       &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;availability_zone=AZ4&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt;
+----+------+-------------------+-------+-------------------------+
&lt;span class="o"&gt;[&lt;/span&gt;root@controller ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# nova aggregate-add-host hz1 compute-bj-1-withlvm.novalocal&lt;/span&gt;
ERROR &lt;span class="o"&gt;(&lt;/span&gt;Conflict&lt;span class="o"&gt;)&lt;/span&gt;: Aggregate &lt;span class="m"&gt;1&lt;/span&gt; already has host compute-bj-1-withlvm.novalocal. &lt;span class="o"&gt;(&lt;/span&gt;HTTP &lt;span class="m"&gt;409&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt; &lt;span class="o"&gt;(&lt;/span&gt;Request-ID: req-ec05903d-5db6-4b50-bb25-0dba2eb9b7d5&lt;span class="o"&gt;)&lt;/span&gt;
一个host可以属于多个host aggregates，但只能属于一个az。实际部署中，只要availability_zone不冲突，Nova允许将计算节点分配给具有不同metadata的不同host aggregate。如下：
&lt;span class="o"&gt;[&lt;/span&gt;root@controller ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# nova aggregate-show hz1&lt;/span&gt;
+----+------+-------------------+--------------------------------------------------------------------+------------------------+
&lt;span class="p"&gt;|&lt;/span&gt; Id &lt;span class="p"&gt;|&lt;/span&gt; Name &lt;span class="p"&gt;|&lt;/span&gt; Availability Zone &lt;span class="p"&gt;|&lt;/span&gt; Hosts                                                              &lt;span class="p"&gt;|&lt;/span&gt; Metadata               &lt;span class="p"&gt;|&lt;/span&gt;
+----+------+-------------------+--------------------------------------------------------------------+------------------------+
&lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1&lt;/span&gt;  &lt;span class="p"&gt;|&lt;/span&gt; hz1  &lt;span class="p"&gt;|&lt;/span&gt; bj                &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;compute-bj-1-withlvm.novalocal&amp;#39;&lt;/span&gt;, &lt;span class="s1"&gt;&amp;#39;compute-bj-2-withlvm.novalocal&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;availability_zone=bj&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt;
+----+------+-------------------+--------------------------------------------------------------------+------------------------+
&lt;span class="o"&gt;[&lt;/span&gt;root@controller ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# nova aggregate-add-host hz3 compute-bj-1-withlvm.novalocal&lt;/span&gt;
Host compute-bj-1-withlvm.novalocal has been successfully added &lt;span class="k"&gt;for&lt;/span&gt; aggregate &lt;span class="m"&gt;6&lt;/span&gt;
+----+------+-------------------+----------------------------------+------------+
&lt;span class="p"&gt;|&lt;/span&gt; Id &lt;span class="p"&gt;|&lt;/span&gt; Name &lt;span class="p"&gt;|&lt;/span&gt; Availability Zone &lt;span class="p"&gt;|&lt;/span&gt; Hosts                            &lt;span class="p"&gt;|&lt;/span&gt; Metadata   &lt;span class="p"&gt;|&lt;/span&gt;
+----+------+-------------------+----------------------------------+------------+
&lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;6&lt;/span&gt;  &lt;span class="p"&gt;|&lt;/span&gt; hz3  &lt;span class="p"&gt;|&lt;/span&gt; -                 &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;compute-bj-1-withlvm.novalocal&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;ssd=true&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt;
+----+------+-------------------+----------------------------------+------------+
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;另外，AZ对于用户可见，而&lt;code&gt;Host aggregate&lt;/code&gt;对于用户并不可见；用户通过选择具有某种特性的flavor，从而间接选择具有该特性的&lt;code&gt;host aggregate&lt;/code&gt;。&lt;code&gt;nova-scheduler&lt;/code&gt;调度时会读取Flavor的extra specs，并与主机集合的metadata匹配，不匹配的将被过滤掉，不会被最终选择作为候选主机。&lt;/p&gt;
&lt;p&gt;Flavor内置支持很多extra specs，通过extra specs，可以指定虚拟机的CPU拓扑、QoS限制、CPU pinning策略、NUMA拓扑，甚至设置PCI passthrough，详细介绍参考官方文档。比如设置CPU topology，可以设置CPU的socket数量、core数量以及超线程数量等 。当然也可以给flavor自定义extra specs，只要与host aggregate的metadata相同即可。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ nova flavor-key FLAVOR-NAME &lt;span class="nb"&gt;set&lt;/span&gt; &lt;span class="se"&gt;\&lt;/span&gt;
    hw:cpu_sockets&lt;span class="o"&gt;=&lt;/span&gt;FLAVOR-SOCKETS &lt;span class="se"&gt;\&lt;/span&gt;
    hw:cpu_cores&lt;span class="o"&gt;=&lt;/span&gt;FLAVOR-CORES &lt;span class="se"&gt;\&lt;/span&gt;
    hw:cpu_threads&lt;span class="o"&gt;=&lt;/span&gt;FLAVOR-THREADS &lt;span class="se"&gt;\&lt;/span&gt;
    hw:cpu_max_sockets&lt;span class="o"&gt;=&lt;/span&gt;FLAVOR-SOCKETS &lt;span class="se"&gt;\&lt;/span&gt;
    hw:cpu_max_cores&lt;span class="o"&gt;=&lt;/span&gt;FLAVOR-CORES &lt;span class="se"&gt;\&lt;/span&gt;
    hw:cpu_max_threads&lt;span class="o"&gt;=&lt;/span&gt;FLAVOR-THREADS
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;根据实际的物理资源在 OpenStack 环境中创建 &lt;code&gt;Host Aggregates&lt;/code&gt;
我们需要设置tiny flavor的key与aggregate的metadata相同，然后选择该flavor创建虚拟机，测试是否会调度该&lt;code&gt;host aggregate&lt;/code&gt;下面的计算节点。&lt;/p&gt;
&lt;p&gt;要注意的是，这种方式筛选宿主机需要在&lt;code&gt;nova-scheduler&lt;/code&gt;节点的nova.conf文件配置项&lt;code&gt;scheduler_default_filters&lt;/code&gt;后面添加&lt;code&gt;AggregateInstanceExtraSpecsFilter&lt;/code&gt;，然后重启&lt;code&gt;openstack-nova-scheduler&lt;/code&gt;服务才能生效。&lt;/p&gt;
&lt;p&gt;测试如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;root@controller ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# nova aggregate-create high-memory-agg high-memory-az&lt;/span&gt;
+----+-----------------+-------------------+-------+------------------------------------+
&lt;span class="p"&gt;|&lt;/span&gt; Id &lt;span class="p"&gt;|&lt;/span&gt; Name            &lt;span class="p"&gt;|&lt;/span&gt; Availability Zone &lt;span class="p"&gt;|&lt;/span&gt; Hosts &lt;span class="p"&gt;|&lt;/span&gt; Metadata                           &lt;span class="p"&gt;|&lt;/span&gt;
+----+-----------------+-------------------+-------+------------------------------------+
&lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;7&lt;/span&gt;  &lt;span class="p"&gt;|&lt;/span&gt; high-memory-agg &lt;span class="p"&gt;|&lt;/span&gt; high-memory-az    &lt;span class="p"&gt;|&lt;/span&gt;       &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;availability_zone=high-memory-az&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt;
+----+-----------------+-------------------+-------+------------------------------------+
&lt;span class="o"&gt;[&lt;/span&gt;root@controller ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# nova aggregate-set-metadata high-memory-agg HW=high-memory&lt;/span&gt;
Metadata has been successfully updated &lt;span class="k"&gt;for&lt;/span&gt; aggregate &lt;span class="m"&gt;7&lt;/span&gt;.
+----+-----------------+-------------------+-------+------------------------------------------------------+
&lt;span class="p"&gt;|&lt;/span&gt; Id &lt;span class="p"&gt;|&lt;/span&gt; Name            &lt;span class="p"&gt;|&lt;/span&gt; Availability Zone &lt;span class="p"&gt;|&lt;/span&gt; Hosts &lt;span class="p"&gt;|&lt;/span&gt; Metadata                                             &lt;span class="p"&gt;|&lt;/span&gt;
+----+-----------------+-------------------+-------+------------------------------------------------------+
&lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;7&lt;/span&gt;  &lt;span class="p"&gt;|&lt;/span&gt; high-memory-agg &lt;span class="p"&gt;|&lt;/span&gt; high-memory-az    &lt;span class="p"&gt;|&lt;/span&gt;       &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;HW=high-memory&amp;#39;&lt;/span&gt;, &lt;span class="s1"&gt;&amp;#39;availability_zone=high-memory-az&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt;
+----+-----------------+-------------------+-------+------------------------------------------------------+
&lt;span class="o"&gt;[&lt;/span&gt;root@controller ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# nova flavor-key  1 set HW=high-memory&lt;/span&gt;
&lt;span class="o"&gt;[&lt;/span&gt;root@controller ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# nova flavor-show 1&lt;/span&gt;
+----------------------------+-----------------------+
&lt;span class="p"&gt;|&lt;/span&gt; Property                   &lt;span class="p"&gt;|&lt;/span&gt; Value                 &lt;span class="p"&gt;|&lt;/span&gt;
+----------------------------+-----------------------+
&lt;span class="p"&gt;|&lt;/span&gt; OS-FLV-DISABLED:disabled   &lt;span class="p"&gt;|&lt;/span&gt; False                 &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; OS-FLV-EXT-DATA:ephemeral  &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt;                     &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; disk                       &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;20&lt;/span&gt;                    &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; extra_specs                &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;HW&amp;quot;&lt;/span&gt;: &lt;span class="s2"&gt;&amp;quot;high-memory&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; id                         &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1&lt;/span&gt;                     &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; name                       &lt;span class="p"&gt;|&lt;/span&gt; tiny                  &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; os-flavor-access:is_public &lt;span class="p"&gt;|&lt;/span&gt; True                  &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; ram                        &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;512&lt;/span&gt;                   &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; rxtx_factor                &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1&lt;/span&gt;.0                   &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; swap                       &lt;span class="p"&gt;|&lt;/span&gt;                       &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; vcpus                      &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1&lt;/span&gt;                     &lt;span class="p"&gt;|&lt;/span&gt;
+----------------------------+-----------------------+
&lt;span class="o"&gt;[&lt;/span&gt;root@controller ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# nova aggregate-add-host high-memory-agg  compute-bj-1-withlvm.novalocal&lt;/span&gt;
Host compute-bj-1-withlvm.novalocal has been successfully added &lt;span class="k"&gt;for&lt;/span&gt; aggregate &lt;span class="m"&gt;7&lt;/span&gt;
+----+-----------------+-------------------+----------------------------------+------------------------------------------------------+
&lt;span class="p"&gt;|&lt;/span&gt; Id &lt;span class="p"&gt;|&lt;/span&gt; Name            &lt;span class="p"&gt;|&lt;/span&gt; Availability Zone &lt;span class="p"&gt;|&lt;/span&gt; Hosts                            &lt;span class="p"&gt;|&lt;/span&gt; Metadata                                             &lt;span class="p"&gt;|&lt;/span&gt;
+----+-----------------+-------------------+----------------------------------+------------------------------------------------------+
&lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;7&lt;/span&gt;  &lt;span class="p"&gt;|&lt;/span&gt; high-memory-agg &lt;span class="p"&gt;|&lt;/span&gt; high-memory-az    &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;compute-bj-1-withlvm.novalocal&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;HW=high-memory&amp;#39;&lt;/span&gt;, &lt;span class="s1"&gt;&amp;#39;availability_zone=high-memory-az&amp;#39;&lt;/span&gt; &lt;span class="p"&gt;|&lt;/span&gt;
+----+-----------------+-------------------+----------------------------------+------------------------------------------------------+

&lt;span class="o"&gt;[&lt;/span&gt;root@controller nova&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# nova boot --flavor 1 --image e875ac34-2031-4265-890d-f6ed1968dfc7 --nic net-id=38bf1bcf-8119-49bd-ae6f-76995cb13d1f test-wei&lt;/span&gt;
&lt;span class="o"&gt;[&lt;/span&gt;root@controller ~&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="c1"&gt;# nova show 4869650b-4dd6-48fe-820e-8ac59dbf3c59&lt;/span&gt;
+--------------------------------------+----------------------------------------------------------+
&lt;span class="p"&gt;|&lt;/span&gt; Property                             &lt;span class="p"&gt;|&lt;/span&gt; Value                                                    &lt;span class="p"&gt;|&lt;/span&gt;
+--------------------------------------+----------------------------------------------------------+
&lt;span class="p"&gt;|&lt;/span&gt; OS-DCF:diskConfig                    &lt;span class="p"&gt;|&lt;/span&gt; MANUAL                                                   &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; OS-EXT-AZ:availability_zone          &lt;span class="p"&gt;|&lt;/span&gt; high-memory-az                                           &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; OS-EXT-SRV-ATTR:host                 &lt;span class="p"&gt;|&lt;/span&gt; compute-bj-1-withlvm.novalocal                           &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; OS-EXT-SRV-ATTR:hostname             &lt;span class="p"&gt;|&lt;/span&gt; test-wei                                                 &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; OS-EXT-SRV-ATTR:hypervisor_hostname  &lt;span class="p"&gt;|&lt;/span&gt; compute-bj-1-withlvm.novalocal                           &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; OS-EXT-SRV-ATTR:instance_name        &lt;span class="p"&gt;|&lt;/span&gt; instance-0000002c                                        &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; OS-EXT-SRV-ATTR:kernel_id            &lt;span class="p"&gt;|&lt;/span&gt;                                                          &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; OS-EXT-SRV-ATTR:launch_index         &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt;                                                        &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; OS-EXT-SRV-ATTR:ramdisk_id           &lt;span class="p"&gt;|&lt;/span&gt;                                                          &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; OS-EXT-SRV-ATTR:reservation_id       &lt;span class="p"&gt;|&lt;/span&gt; r-9t3kqglu                                               &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; OS-EXT-SRV-ATTR:root_device_name     &lt;span class="p"&gt;|&lt;/span&gt; /dev/vda                                                 &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; OS-EXT-SRV-ATTR:user_data            &lt;span class="p"&gt;|&lt;/span&gt; -                                                        &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; OS-EXT-STS:power_state               &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1&lt;/span&gt;                                                        &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; OS-EXT-STS:task_state                &lt;span class="p"&gt;|&lt;/span&gt; -                                                        &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; OS-EXT-STS:vm_state                  &lt;span class="p"&gt;|&lt;/span&gt; active                                                   &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; OS-SRV-USG:launched_at               &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;2017&lt;/span&gt;-03-09T02:43:34.000000                               &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; OS-SRV-USG:terminated_at             &lt;span class="p"&gt;|&lt;/span&gt; -                                                        &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; accessIPv4                           &lt;span class="p"&gt;|&lt;/span&gt;                                                          &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; accessIPv6                           &lt;span class="p"&gt;|&lt;/span&gt;                                                          &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; config_drive                         &lt;span class="p"&gt;|&lt;/span&gt;                                                          &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; created                              &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;2017&lt;/span&gt;-03-09T02:43:27Z                                     &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; description                          &lt;span class="p"&gt;|&lt;/span&gt; -                                                        &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; flavor                               &lt;span class="p"&gt;|&lt;/span&gt; tiny &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;                                                 &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; hebin-test network                   &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;172&lt;/span&gt;.16.98.13                                             &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; hostId                               &lt;span class="p"&gt;|&lt;/span&gt; 29624d4fab8a27da27dfc97646bf1ac0080647f48de7e8603d6e9d5b &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; host_status                          &lt;span class="p"&gt;|&lt;/span&gt; UP                                                       &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; id                                   &lt;span class="p"&gt;|&lt;/span&gt; 4869650b-4dd6-48fe-820e-8ac59dbf3c59                     &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; image                                &lt;span class="p"&gt;|&lt;/span&gt; cirros &lt;span class="o"&gt;(&lt;/span&gt;e875ac34-2031-4265-890d-f6ed1968dfc7&lt;span class="o"&gt;)&lt;/span&gt;            &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; key_name                             &lt;span class="p"&gt;|&lt;/span&gt; -                                                        &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; locked                               &lt;span class="p"&gt;|&lt;/span&gt; False                                                    &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; metadata                             &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="o"&gt;{}&lt;/span&gt;                                                       &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; name                                 &lt;span class="p"&gt;|&lt;/span&gt; test-wei                                                 &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; os-extended-volumes:volumes_attached &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="o"&gt;[]&lt;/span&gt;                                                       &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; progress                             &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt;                                                        &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; security_groups                      &lt;span class="p"&gt;|&lt;/span&gt; default                                                  &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; status                               &lt;span class="p"&gt;|&lt;/span&gt; ACTIVE                                                   &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; tags                                 &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="o"&gt;[]&lt;/span&gt;                                                       &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; tenant_id                            &lt;span class="p"&gt;|&lt;/span&gt; 08c8707bb8134e6d8eff730fac326b87                         &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; updated                              &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;2017&lt;/span&gt;-03-09T02:43:35Z                                     &lt;span class="p"&gt;|&lt;/span&gt;
&lt;span class="p"&gt;|&lt;/span&gt; user_id                              &lt;span class="p"&gt;|&lt;/span&gt; 7418921e19a4406caee18bd8ad08bf92                         &lt;span class="p"&gt;|&lt;/span&gt;
+--------------------------------------+----------------------------------------------------------+
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;可以看到虚拟机被成功调度到&lt;code&gt;high-memory-az&lt;/code&gt;可用域中的&lt;code&gt;compute-bj-1-withlvm.novalocal&lt;/code&gt;节点。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;基于主机特性相关的Filter：&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Filter名&lt;/th&gt;
&lt;th&gt;功能描述&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;AggregateImagePropertiesIsolation&lt;/td&gt;
&lt;td&gt;筛选出对应aggregate满足image属性的宿主机&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;AggregateInstanceExtraSpecsFilter&lt;/td&gt;
&lt;td&gt;筛选出对应aggregate满足flavor的附加参数的宿主机，非常灵活的filter，可以用来根据主机的某些物理特性进行筛选&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;AggregateMultiTenancyIsolation&lt;/td&gt;
&lt;td&gt;将特定租户的虚拟机隔离在特定的aggregate中，绑定了aggregate且其aggregate只含有其他租户的宿主机将被过滤掉&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;AggregateCoreFilter&lt;/td&gt;
&lt;td&gt;与CoreFilter类似，但是cpu_allocation_ratio从宿主机所在aggregate的metadata中获取&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;AggregateRamFilter&lt;/td&gt;
&lt;td&gt;与RamFilter类似，ram_allocation_ratio从宿主机所在aggregate的metadata中获取&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;AggregateCoreFilter&lt;/td&gt;
&lt;td&gt;与DiskFilter类似，disk_allocation_ratio从宿主机所在aggregate的metadata中获取&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;AggregateNumInstancesFilter&lt;/td&gt;
&lt;td&gt;与NumInstancesFilter类似，max_instances_per_host从宿主机所在aggregate的metadata中获取&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;AggregateIoOpsFilter&lt;/td&gt;
&lt;td&gt;与IoOpsFilter类似，max_io_ops_per_host从宿主机所在aggregate的metadata中获取&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;根据以上特性的Filter，我们就可以根据实际的用户需求在 OpenStack 环境中创建 &lt;code&gt;Host Aggregates&lt;/code&gt;。
在具体使用 &lt;code&gt;Host Aggregates&lt;/code&gt; 机制来分配 computes 节点资源时，我们可以综合考虑目前 OpenStack 环境里的物理资源和用户需求来灵活地配置 &lt;code&gt;Host Aggregate&lt;/code&gt; 的 metadatas 以及 filters。由于一个 &lt;code&gt;Availability Zone&lt;/code&gt; 可以同时包含多个 &lt;code&gt;Host aggregates&lt;/code&gt;，每个 &lt;code&gt;Host aggregate&lt;/code&gt; 又有可能配置不同的 metadatas，因此我们在创建虚拟机时也应该注意这点，不要将虚拟机创建到错误的 compute 节点上。&lt;/p&gt;
&lt;h2&gt;参考资料&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;https://www.ibm.com/developerworks/cn/cloud/library/1604-openstack-host-aggregate/&lt;/li&gt;
&lt;li&gt;https://www.mirantis.com/blog/the-first-and-final-word-on-openstack-availability-zones/&lt;/li&gt;
&lt;/ol&gt;</content></entry><entry><title>linux 服务器架构</title><link href="https://andiaq.github.io/posts/2017/03/13/linux-cpu-architecture.html" rel="alternate"></link><published>2017-03-13T18:00:00+08:00</published><updated>2017-03-13T18:00:00+08:00</updated><author><name>Yuwei Wang</name></author><id>tag:andiaq.github.io,2017-03-13:/posts/2017/03/13/linux-cpu-architecture.html</id><summary type="html">&lt;p&gt;&lt;strong&gt;商用服务器的系统架构大致可以分为三类：&lt;/strong&gt;
&lt;code&gt;SMP&lt;/code&gt; &lt;code&gt;NUMA&lt;/code&gt; &lt;code&gt;MMP&lt;/code&gt;&lt;/p&gt;
&lt;h2&gt;SMP&lt;/h2&gt;
&lt;p&gt;SMP即&lt;code&gt;Symmetric Multi-Processor&lt;/code&gt;，对称多处理器架构。
所谓对称多处理器架构，是指服务器中的多个CPU对称工作，无主次和从属关系。各CPU共享相同的物理内存，每个CPU访问内存中的任何地址所需的时间都是相同的，因此SMP也被称为一致存储器访问结构。对SMP服务器进行扩展的方式包括：增加内存； 使用更快的CPU；增加CPU数量；扩充I/O(槽口数和总线数)；以及添加更多的外部设备(通常是磁盘存储)。&lt;/p&gt;
&lt;p&gt;SMP服务器的主要特征是共享，系统中的所有资源(CPU、内存、I/O等)都是共享的。也正是由于这种特征，导致了SMP服务器的主要问题，那就是它得扩展能力非常有限。&lt;/p&gt;
&lt;p&gt;对于SMP服务器而言，每一个共享的环节都可能造成SMP服务器扩展时的瓶颈，而最受限制的则是内存。由于每个CPU必须通过相同的内存总线访问相同的内存资源，因此随着CPU数量的增加，内存访问冲突将迅速增加，最终会造成CPU资源的浪费，使 CPU性能的有效性大大降低。实验证明，SMP服务器CPU利用率最好的情况是2至4个CPU。 &lt;/p&gt;
&lt;h2&gt;NUMA&lt;/h2&gt;
&lt;p&gt;NUMA即&lt;code&gt;Non-Uniform Memory Access …&lt;/code&gt;&lt;/p&gt;</summary><content type="html">&lt;p&gt;&lt;strong&gt;商用服务器的系统架构大致可以分为三类：&lt;/strong&gt;
&lt;code&gt;SMP&lt;/code&gt; &lt;code&gt;NUMA&lt;/code&gt; &lt;code&gt;MMP&lt;/code&gt;&lt;/p&gt;
&lt;h2&gt;SMP&lt;/h2&gt;
&lt;p&gt;SMP即&lt;code&gt;Symmetric Multi-Processor&lt;/code&gt;，对称多处理器架构。
所谓对称多处理器架构，是指服务器中的多个CPU对称工作，无主次和从属关系。各CPU共享相同的物理内存，每个CPU访问内存中的任何地址所需的时间都是相同的，因此SMP也被称为一致存储器访问结构。对SMP服务器进行扩展的方式包括：增加内存； 使用更快的CPU；增加CPU数量；扩充I/O(槽口数和总线数)；以及添加更多的外部设备(通常是磁盘存储)。&lt;/p&gt;
&lt;p&gt;SMP服务器的主要特征是共享，系统中的所有资源(CPU、内存、I/O等)都是共享的。也正是由于这种特征，导致了SMP服务器的主要问题，那就是它得扩展能力非常有限。&lt;/p&gt;
&lt;p&gt;对于SMP服务器而言，每一个共享的环节都可能造成SMP服务器扩展时的瓶颈，而最受限制的则是内存。由于每个CPU必须通过相同的内存总线访问相同的内存资源，因此随着CPU数量的增加，内存访问冲突将迅速增加，最终会造成CPU资源的浪费，使 CPU性能的有效性大大降低。实验证明，SMP服务器CPU利用率最好的情况是2至4个CPU。 &lt;/p&gt;
&lt;h2&gt;NUMA&lt;/h2&gt;
&lt;p&gt;NUMA即&lt;code&gt;Non-Uniform Memory Access&lt;/code&gt;，非一致性内存架构。
NUMA架构产生的原因之一，就是为了解决SMP在扩展能力上的限制。利用NUMA技术，可以把几十个CPU(甚至上百个CPU)组合在一个服务器内。其CPU模块结构如下图所示：&lt;/p&gt;
&lt;p&gt;&lt;img alt="image" src="/images/numa_cpu.png"&gt;&lt;/p&gt;
&lt;p&gt;NUMA服务器的基本特征是具有多个CPU模块，每个CPU模块由多个CPU(如4个)组成，并且具有独立的本地内存、I/O槽口等。由于其节点之间可以通过互联模块(如称为Crossbar Switch)进行连接和信息交互，因此每个CPU可以访问整个系统的内存(这是NUMA系统与MPP系统的重要差别)。显然，访问本地内存的速度将远远高于访问远地内存(系统内其它节点的内存)的速度，这也是非一致存储访问NUMA的由来。由于这个特点，为了更好地发挥系统性能，开发应用程序时需要尽量减少不同CPU模块之间的信息交互。利用NUMA技术，可以较好地解决原来SMP系统的扩展问题，在一个物理服务器内可以支持上百个CPU。比较典型的NUMA服务器的例子包括HP的Superdome、SUN15K、IBMp690等。&lt;/p&gt;
&lt;p&gt;但NUMA技术同样有一定缺陷，由于访问远地内存的延时远远超过本地内存，因此当CPU数量增加时，系统性能无法线性增加。如HP公司发布Superdome服务器时，曾公布了它与HP其它UNIX服务器的相对性能值，结果发现，64路CPU的Superdome(NUMA结构)的相对性能值是20，而8路N4000(共享的SMP结构)的相对性能值是6.3。从这个结果可以看到，8倍数量的CPU换来的只是3倍性能的提升。 &lt;/p&gt;
&lt;h2&gt;MPP&lt;/h2&gt;
&lt;p&gt;MPP即&lt;code&gt;Massive Parallel Processing&lt;/code&gt;，海量并行处理架构。
和NUMA不同，MPP提供了另外一种进行系统扩展的方式，它由多个SMP服务器通过一定的节点互联网络进行连接，协同工作，完成相同的任务，从用户的角度来看是一个服务器系统。其基本特征是由多个SMP服务器(每个SMP服务器称节点)通过节点互联网络连接而成，每个节点只访问自己的本地资源(内存、存储等)，是一种完全无共享(Share Nothing)结构，因而扩展能力最好，理论上其扩展无限制，目前的技术可实现512个节点互联，数千个CPU。目前业界对节点互联网络暂无标准，如 NCR的Bynet，IBM的SPSwitch，它们都采用了不同的内部实现机制。但节点互联网仅供MPP服务器内部使用，对用户而言是透明的。&lt;/p&gt;
&lt;p&gt;在MPP系统中，每个SMP节点也可以运行自己的操作系统、数据库等。但和NUMA不同的是，它不存在异地内存访问的问题。换言之，每个节点内的CPU不能访问另一个节点的内存。节点之间的信息交互是通过节点互联网络实现的，这个过程一般称为数据重分配(Data Redistribution)。&lt;/p&gt;
&lt;p&gt;但是MPP服务器需要一种复杂的机制来调度和平衡各个节点的负载和并行处理过程。目前一些基于MPP技术的服务器往往通过系统级软件(如数据库)来屏蔽这种复杂性。举例来说，NCR的Teradata就是基于MPP技术的一个关系数据库软件，基于此数据库来开发应用时，不管后台服务器由多少个节点组成，开发人员所面对的都是同一个数据库系统，而不需要考虑如何调度其中某几个节点的负载。&lt;/p&gt;
&lt;h2&gt;NUMA与MPP的区别&lt;/h2&gt;
&lt;p&gt;从架构来看，NUMA与MPP具有许多相似之处：它们都由多个节点组成，每个节点都具有自己的CPU、内存、I/O，节点之间都可以通过节点互联机制进行信息交互。那么它们的区别在哪里？通过分析下面NUMA和MPP服务器的内部架构和工作原理不难发现其差异所在。&lt;/p&gt;
&lt;p&gt;首先是节点互联机制不同，NUMA的节点互联机制是在同一个物理服务器内部实现的，当某个CPU需要进行远地内存访问时，它必须等待，这也是NUMA服务器无法实现CPU增加时性能线性扩展的主要原因。而MPP的节点互联机制是在不同的SMP服务器外部通过I/O 实现的，每个节点只访问本地内存和存储，节点之间的信息交互与节点本身的处理是并行进行的。因此MPP在增加节点时性能基本上可以实现线性扩展。&lt;/p&gt;
&lt;p&gt;其次是内存访问机制不同。在NUMA服务器内部，任何一个CPU可以访问整个系统的内存，但远地访问的性能远远低于本地内存访问，因此在开发应用程序时应该尽量避免远地内存访问。在MPP服务器中，每个节点只访问本地内存，不存在远地内存访问的问题。&lt;/p&gt;
&lt;h2&gt;数据仓库的选择&lt;/h2&gt;
&lt;p&gt;哪种服务器更加适应数据仓库环境？这需要从数据仓库环境本身的负载特征入手。众所周知，典型的数据仓库环境具有大量复杂的数据处理和综合分析，要求系统具有很高的I/O处理能力，并且存储系统需要提供足够的I/O带宽与之匹配。而一个典型的OLTP系统则以联机事务处理为主，每个交易所涉及的数据不多，要求系统具有很高的事务处理能力，能够在单位时间里处理尽量多的交易。显然这两种应用环境的负载特征完全不同。&lt;/p&gt;
&lt;p&gt;从NUMA架构来看，它可以在一个物理服务器内集成许多CPU，使系统具有较高的事务处理能力，由于远地内存访问时延远长于本地内存访问，因此需要尽量减少不同CPU模块之间的数据交互。显然，NUMA架构更适用于OLTP事务处理环境，当用于数据仓库环境时，由于大量复杂的数据处理必然导致大量的数据交互，将使CPU的利用率大大降低。&lt;/p&gt;
&lt;p&gt;相对而言，MPP服务器架构的并行处理能力更优越，更适合于复杂的数据综合分析与处理环境。当然，它需要借助于支持MPP技术的关系数据库系统来屏蔽节点之间负载平衡与调度的复杂性。另外，这种并行处理能力也与节点互联网络有很大的关系。显然，适应于数据仓库环境的MPP服务器，其节点互联网络的I/O性能应该非常突出，才能充分发挥整个系统的性能。&lt;/p&gt;
&lt;h2&gt;参考资料&lt;/h2&gt;
&lt;p&gt;1.http://blog.csdn.net/chengleisheng/article/details/43454515&lt;/p&gt;</content></entry><entry><title>Git常用操作</title><link href="https://andiaq.github.io/posts/2016/12/11/git-usage.html" rel="alternate"></link><published>2016-12-11T20:24:00+08:00</published><updated>2016-12-11T20:24:00+08:00</updated><author><name>Yuwei Wang</name></author><id>tag:andiaq.github.io,2016-12-11:/posts/2016/12/11/git-usage.html</id><summary type="html">&lt;p&gt;对于开源项目的开发来说，熟练使用git的应该算是必备技能。本篇博客记录了平时工作中较常用的git操作。&lt;/p&gt;
&lt;h2&gt;git log&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;显示所有历史记录&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# git log&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;显示最近N条历史记录&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# git log -N &lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;显示详细历史记录，包括代码改动内容&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# git log -p &lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;只显示一行，哈希值和提交说明&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# git log --pretty=oneline&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;显示提交历史记录的简单图形&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# glog&lt;/span&gt;
&lt;span class="c1"&gt;# git log --pretty=format:&amp;quot;%H %s&amp;quot; --graph&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;自定义格式显示历史记录&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# git log --pretty=format:&amp;quot; &amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;常用的格式占位符写法及其代表的意义如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;选项   说明
%H  提交对象（commit）的完整哈希字串
%h  提交对象的简短哈希字串
%T  树对象（tree）的完整哈希字串 …&lt;/pre&gt;&lt;/div&gt;</summary><content type="html">&lt;p&gt;对于开源项目的开发来说，熟练使用git的应该算是必备技能。本篇博客记录了平时工作中较常用的git操作。&lt;/p&gt;
&lt;h2&gt;git log&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;显示所有历史记录&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# git log&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;显示最近N条历史记录&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# git log -N &lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;显示详细历史记录，包括代码改动内容&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# git log -p &lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;只显示一行，哈希值和提交说明&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# git log --pretty=oneline&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;显示提交历史记录的简单图形&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# glog&lt;/span&gt;
&lt;span class="c1"&gt;# git log --pretty=format:&amp;quot;%H %s&amp;quot; --graph&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;自定义格式显示历史记录&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# git log --pretty=format:&amp;quot; &amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;常用的格式占位符写法及其代表的意义如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;选项   说明
%H  提交对象（commit）的完整哈希字串
%h  提交对象的简短哈希字串
%T  树对象（tree）的完整哈希字串
%t  树对象的简短哈希字串
%P  父对象（parent）的完整哈希字串
%p  父对象的简短哈希字串
%an 作者（author）的名字
%ae 作者的电子邮件地址
%ad 作者修订日期（可以用 -date= 选项定制格式）
%ar 作者修订日期，按多久以前的方式显示
%cn 提交者(committer)的名字
%ce 提交者的电子邮件地址
%cd 提交日期
%cr 提交日期，按多久以前的方式显示
%s  提交说明
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;例如：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# git log --pretty=format:&amp;quot;%H | %an | %s&amp;quot;&lt;/span&gt;
6f74e1e5d83fbfd5fa7d9a079854e168689920b5 &lt;span class="p"&gt;|&lt;/span&gt; AndiaQ &lt;span class="p"&gt;|&lt;/span&gt; Merge branch &lt;span class="s1"&gt;&amp;#39;master&amp;#39;&lt;/span&gt; of git.ustack.com:uos3/nova
486b90b24e9515678166d0b370e4daefe4e9e341 &lt;span class="p"&gt;|&lt;/span&gt; Jenkins &lt;span class="p"&gt;|&lt;/span&gt; Merge &lt;span class="s2"&gt;&amp;quot;Make server_external_events cells-aware&amp;quot;&lt;/span&gt;
6a3b436b09321259d4fe1c5079c65d0241464a3a &lt;span class="p"&gt;|&lt;/span&gt; Jenkins &lt;span class="p"&gt;|&lt;/span&gt; Merge &lt;span class="s2"&gt;&amp;quot;Remove service version check for Ocata/Newton placement decisions&amp;quot;&lt;/span&gt;
8bbc1eeca75f2ebdd57d977ebb9004ac1ade6690 &lt;span class="p"&gt;|&lt;/span&gt; Jenkins &lt;span class="p"&gt;|&lt;/span&gt; Merge &lt;span class="s2"&gt;&amp;quot;Fix novncproxy for python3&amp;quot;&lt;/span&gt;
94f3281a53b0592a8985f7301dd0a62c6b413a90 &lt;span class="p"&gt;|&lt;/span&gt; Dan Smith &lt;span class="p"&gt;|&lt;/span&gt; Make server_external_events cells-aware
c604a6cf16441458df79654cb2cfbb551fa7d0b7 &lt;span class="p"&gt;|&lt;/span&gt; Dan Smith &lt;span class="p"&gt;|&lt;/span&gt; Remove service version check &lt;span class="k"&gt;for&lt;/span&gt; Ocata/Newton placement decisions
384e02217df4aae72340e169d05b9d595f54fb37 &lt;span class="p"&gt;|&lt;/span&gt; Jenkins &lt;span class="p"&gt;|&lt;/span&gt; Merge &lt;span class="s2"&gt;&amp;quot;Tests: improve assertJsonEqual diagnostic message&amp;quot;&lt;/span&gt;
c746974054e1a78032051fef7202a1b98dc9603f &lt;span class="p"&gt;|&lt;/span&gt; Jenkins &lt;span class="p"&gt;|&lt;/span&gt; Merge &lt;span class="s2"&gt;&amp;quot;Raise correct error instead of class exist in Placement API&amp;quot;&lt;/span&gt;
f6885362fe4e08a7019504bc5d7cc4e717d3c9af &lt;span class="p"&gt;|&lt;/span&gt; zhouweiyu &lt;span class="p"&gt;|&lt;/span&gt; Initial empty repository
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;git rebase&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;git rebase&lt;/code&gt;操作简单理解就是“换基”。一般只操作还未push到远程仓库的commit，一旦push到了远程仓库，那么不允许再修改commit，不然会给其他开发带来很多麻烦。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;Assume the following history exists and the current branch is &amp;quot;topic&amp;quot;:

             A---B---C topic
            /
       D---E---F---G master


From this point, the result of either of the following commands:

   git rebase master
   git rebase master topic

would be:

                     A&amp;#39;--B&amp;#39;--C&amp;#39; topic
                    /
       D---E---F---G master
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;如上图所示，topic和master有共同的基E，即topic分支是从master分支的E点切出来的新分支。当topic分支有了自己的私有开发，但master分支仍然在更新时，若操作者需要拉取master分支更新的内容，这时就需要“换基”。也就是说，将topic的HEAD变成master分支最新的G，将自己的私有代码放到master分支的尾巴上。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;git rebase&lt;/code&gt;还有一些高级且很重要的操作。&lt;/p&gt;
&lt;h3&gt;commit合并&lt;/h3&gt;
&lt;p&gt;当需要在一个分支上将两个或者以上的commits合并时，我们可以通过&lt;code&gt;git rebase -i&lt;/code&gt;来完成这件事。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;-i&lt;/code&gt; 是 &lt;code&gt;--interactive&lt;/code&gt; 的简写，在使用 git rebase -i 时，我们要在后面再添加一个参数，这个参数应该是 最新的一个想保留的 Commit。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;如下是一个简单的范例，将e46b345和44e910a两次commits合并成一个。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;➜  nova git:&lt;span class="o"&gt;(&lt;/span&gt;master&lt;span class="o"&gt;)&lt;/span&gt; git log --pretty&lt;span class="o"&gt;=&lt;/span&gt;format:&lt;span class="s2"&gt;&amp;quot;%H| %s&amp;quot;&lt;/span&gt;
e46b345324a8411e8b9b1a085f3df67e48799c48 &lt;span class="p"&gt;|&lt;/span&gt; Fix novncproxy &lt;span class="k"&gt;for&lt;/span&gt; python3
44e910a693b424a2f75fbca76f97eb6d8ed94fc7 &lt;span class="p"&gt;|&lt;/span&gt; Tests: improve assertJsonEqual diagnostic message
e8b7214946fd124e568495cd7cd78ae3e0033d07 &lt;span class="p"&gt;|&lt;/span&gt; Raise correct error instead of class exist in Placement API
...
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;根据上面的解释，那么&lt;code&gt;-i&lt;/code&gt;后面的commit就是&lt;code&gt;e8b7214&lt;/code&gt;。（若想将&lt;code&gt;44e910a&lt;/code&gt;和&lt;code&gt;e8b7214&lt;/code&gt;合并的话，则&lt;code&gt;-i&lt;/code&gt;后面的commit应该是&lt;code&gt;e46b345&lt;/code&gt;）&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;git rebase -i e8b7214
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;进入如下编辑界面：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;pick 44e910a Tests: improve assertJsonEqual diagnostic message                                                                                                                                                                              
pick e46b345 Fix novncproxy &lt;span class="k"&gt;for&lt;/span&gt; python3

&lt;span class="c1"&gt;# Rebase e8b7214..e46b345 onto e8b7214&lt;/span&gt;
&lt;span class="c1"&gt;#&lt;/span&gt;
&lt;span class="c1"&gt;# Commands:&lt;/span&gt;
&lt;span class="c1"&gt;#  p, pick = use commit&lt;/span&gt;
&lt;span class="c1"&gt;#  r, reword = use commit, but edit the commit message&lt;/span&gt;
&lt;span class="c1"&gt;#  e, edit = use commit, but stop for amending&lt;/span&gt;
&lt;span class="c1"&gt;#  s, squash = use commit, but meld into previous commit&lt;/span&gt;
&lt;span class="c1"&gt;#  f, fixup = like &amp;quot;squash&amp;quot;, but discard this commit&amp;#39;s log message&lt;/span&gt;
&lt;span class="c1"&gt;#  x, exec = run command (the rest of the line) using shell&lt;/span&gt;
&lt;span class="c1"&gt;#&lt;/span&gt;
&lt;span class="c1"&gt;# These lines can be re-ordered; they are executed from top to bottom.&lt;/span&gt;
&lt;span class="c1"&gt;#&lt;/span&gt;
&lt;span class="c1"&gt;# If you remove a line here THAT COMMIT WILL BE LOST.&lt;/span&gt;
&lt;span class="c1"&gt;#&lt;/span&gt;
&lt;span class="c1"&gt;# However, if you remove everything, the rebase will be aborted.&lt;/span&gt;
&lt;span class="c1"&gt;#&lt;/span&gt;
&lt;span class="c1"&gt;# Note that empty commits are commented out&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;简单说明一下以上注释中的部分内容：
- &lt;code&gt;squash&lt;/code&gt;:使用该commit，会被合并到上一个commit&lt;/p&gt;
&lt;p&gt;因此我们将用到的就是这个command。下面在编辑框中修改如下内容：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;pick 44e910a Tests: improve assertJsonEqual diagnostic message
squash e46b345 Fix novncproxy for python3
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;修改完后wq保存并退出，出现如下界面：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# This is a combination of 2 commits.                                                                                                                                                                                                       &lt;/span&gt;
&lt;span class="c1"&gt;# The first commit&amp;#39;s message is:&lt;/span&gt;

Tests: improve assertJsonEqual diagnostic message

This change adds a path information in assertJsonEqual output.
Example:
before: Difference: &lt;span class="m"&gt;1&lt;/span&gt; !&lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="m"&gt;2&lt;/span&gt;
arter: Difference: &lt;span class="m"&gt;1&lt;/span&gt; !&lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="m"&gt;2&lt;/span&gt;: path: root.country.state.city&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;.street.building

Change-Id: I4243e48cc7f01b5fa049e0c4aef48a72cc640d0a

&lt;span class="c1"&gt;# This is the 2nd commit message:&lt;/span&gt;

Fix novncproxy &lt;span class="k"&gt;for&lt;/span&gt; python3

The getheader&lt;span class="o"&gt;()&lt;/span&gt; &lt;span class="k"&gt;function&lt;/span&gt; isn&lt;span class="s1"&gt;&amp;#39;t available in python3 [1]. Instead one can &lt;/span&gt;
&lt;span class="s1"&gt;simply use get() similar to what is done in the websockify module that&lt;/span&gt;
&lt;span class="s1"&gt;this code is using.&lt;/span&gt;

&lt;span class="s1"&gt;[1] https://bugs.python.org/issue4773&lt;/span&gt;

&lt;span class="s1"&gt;Change-Id: I349742d80e0abeb7866eeeb647ce18948eff81f8&lt;/span&gt;
&lt;span class="s1"&gt;Partial-Bug: 1663593&lt;/span&gt;

&lt;span class="s1"&gt;# Please enter the commit message for your changes. Lines starting&lt;/span&gt;
&lt;span class="s1"&gt;# with &amp;#39;&lt;/span&gt;&lt;span class="c1"&gt;#&amp;#39; will be ignored, and an empty message aborts the commit.&lt;/span&gt;
&lt;span class="c1"&gt;#&lt;/span&gt;
&lt;span class="c1"&gt;# Author:    Andrey Volkov &amp;lt;avolkov@mirantis.com&amp;gt;&lt;/span&gt;
&lt;span class="c1"&gt;#&lt;/span&gt;
&lt;span class="c1"&gt;# rebase in progress; onto e8b7214&lt;/span&gt;
&lt;span class="c1"&gt;# You are currently editing a commit while rebasing branch &amp;#39;master&amp;#39; on &amp;#39;e8b7214&amp;#39;.&lt;/span&gt;
&lt;span class="c1"&gt;#&lt;/span&gt;
&lt;span class="c1"&gt;# Changes to be committed:&lt;/span&gt;
&lt;span class="c1"&gt;#       modified:   nova/console/websocketproxy.py&lt;/span&gt;
&lt;span class="c1"&gt;#       modified:   nova/test.py&lt;/span&gt;
&lt;span class="c1"&gt;#       modified:   nova/tests/unit/console/test_websocketproxy.py&lt;/span&gt;
&lt;span class="c1"&gt;#       modified:   nova/tests/unit/test_test.py&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;可以看出这是一个输入commit message的界面，修改成你想写的内容即可，如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;Merge commits 44e910a and e46b345                                                   

&lt;span class="c1"&gt;# Please enter the commit message for your changes. Lines starting&lt;/span&gt;
&lt;span class="c1"&gt;# with &amp;#39;#&amp;#39; will be ignored, and an empty message aborts the commit.&lt;/span&gt;
&lt;span class="c1"&gt;#&lt;/span&gt;
&lt;span class="c1"&gt;# Author:    Andrey Volkov &amp;lt;avolkov@mirantis.com&amp;gt;&lt;/span&gt;
&lt;span class="c1"&gt;#&lt;/span&gt;
&lt;span class="c1"&gt;# rebase in progress; onto e8b7214&lt;/span&gt;
&lt;span class="c1"&gt;# You are currently editing a commit while rebasing branch &amp;#39;master&amp;#39; on &amp;#39;e8b7214&amp;#39;.&lt;/span&gt;
&lt;span class="c1"&gt;#&lt;/span&gt;
&lt;span class="c1"&gt;# Changes to be committed:&lt;/span&gt;
&lt;span class="c1"&gt;#       modified:   nova/console/websocketproxy.py&lt;/span&gt;
&lt;span class="c1"&gt;#       modified:   nova/test.py&lt;/span&gt;
&lt;span class="c1"&gt;#       modified:   nova/tests/unit/console/test_websocketproxy.py&lt;/span&gt;
&lt;span class="c1"&gt;#       modified:   nova/tests/unit/test_test.py&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;修改完后wq保存退出，提示已经rebase成功。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;➜  nova git:&lt;span class="o"&gt;(&lt;/span&gt;master&lt;span class="o"&gt;)&lt;/span&gt; git rebase -i e8b7214
&lt;span class="o"&gt;[&lt;/span&gt;detached HEAD d51b317&lt;span class="o"&gt;]&lt;/span&gt; Merge commits 44e910a and e46b345
 Author: Andrey Volkov &amp;lt;avolkov@mirantis.com&amp;gt;
 &lt;span class="m"&gt;4&lt;/span&gt; files changed, &lt;span class="m"&gt;197&lt;/span&gt; insertions&lt;span class="o"&gt;(&lt;/span&gt;+&lt;span class="o"&gt;)&lt;/span&gt;, &lt;span class="m"&gt;139&lt;/span&gt; deletions&lt;span class="o"&gt;(&lt;/span&gt;-&lt;span class="o"&gt;)&lt;/span&gt;
Successfully rebased and updated refs/heads/master.
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;进入历史记录查看。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;➜  nova git:&lt;span class="o"&gt;(&lt;/span&gt;master&lt;span class="o"&gt;)&lt;/span&gt; git log --pretty&lt;span class="o"&gt;=&lt;/span&gt;format:&lt;span class="s2"&gt;&amp;quot;%H | %s&amp;quot;&lt;/span&gt;
d51b31794a628d2e2d21d6089d188ab7ab27b5cb &lt;span class="p"&gt;|&lt;/span&gt; Merge commits 44e910a and e46b345
e8b7214946fd124e568495cd7cd78ae3e0033d07 &lt;span class="p"&gt;|&lt;/span&gt; Raise correct error instead of class exist in Placement API
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;更换commits顺序&lt;/h3&gt;
&lt;p&gt;在本地基于某个分支做开发时，由于总会不断的完善功能，很容易出现一些小功能之间穿插提交代码，造成commits比较混乱。&lt;code&gt;git rebase -i&lt;/code&gt;依然可以很好地解决这个问题。&lt;/p&gt;
&lt;p&gt;以下范例是需要将dev1-2和dev2-1调整顺序。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;➜  tests git:&lt;span class="o"&gt;(&lt;/span&gt;master&lt;span class="o"&gt;)&lt;/span&gt; git log --pretty&lt;span class="o"&gt;=&lt;/span&gt;format:&lt;span class="s2"&gt;&amp;quot;%h | %s&amp;quot;&lt;/span&gt;
12be243 &lt;span class="p"&gt;|&lt;/span&gt; dev2-2
da0a1d4 &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="nb"&gt;test&lt;/span&gt;
22a5a50 &lt;span class="p"&gt;|&lt;/span&gt; dev1-2
14bbd74 &lt;span class="p"&gt;|&lt;/span&gt; dev2-1
98e752f &lt;span class="p"&gt;|&lt;/span&gt; dev1-1
&lt;/pre&gt;&lt;/div&gt;


&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;➜  tests git:(master) git rebase -i 98e752f

pick 14bbd74 dev2-1
pick 22a5a50 dev1-2
pick da0a1d4 test
pick 12be243 dev2-2
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;将以上内容显示的顺序与git log查看的顺序完全相反。只需将&lt;code&gt;dev1-2&lt;/code&gt;和&lt;code&gt;dev2-1&lt;/code&gt;调换顺序即可。调换顺序后保存退出，查看历史记录：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;➜  tests git:(master) git log --pretty=format:&amp;quot;%h | %s&amp;quot;
ff2c926 | dev2-2
f894e78 | test
8482018 | dev2-1
6743e79 | dev1-2
98e752f | dev1-1
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;若想将test这次的commit删除，同样只需在编辑框中删除&lt;code&gt;pick da0a1d4 test&lt;/code&gt;这一行。&lt;/p&gt;
&lt;h2&gt;git fetch&lt;/h2&gt;
&lt;p&gt;当远程仓库有了新的更新，需要将新的commits更新到本地时，可使用&lt;code&gt;git fetch&lt;/code&gt;完成操作。&lt;/p&gt;
&lt;p&gt;Usage:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;获取远程主机所有更新。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;git fetch &amp;lt;远程主机名&amp;gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;获取远程主机特定分支上的所有更新。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;git fetch &amp;lt;远程主机名&amp;gt; &amp;lt;分支名&amp;gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;➜  tests git:(master) git remote -v
trystack    http://git.trystack.cn/openstack/nova.git (fetch)
trystack    http://git.trystack.cn/openstack/nova.git (push)
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;如上，若想获取将远程trystack仓库nova的newton分支上的所有更新，执行：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;git fetch trystack stable/newton
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;结果如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;➜  tests git:(master) git branch -a
* master
  remotes/trystack/stable/newton
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;若想将以上fetch到的远程分支拉取到本地，可基于远程分支切换新的分支，执行：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;➜  tests git:&lt;span class="o"&gt;(&lt;/span&gt;master&lt;span class="o"&gt;)&lt;/span&gt; git checkout -b stable/newton trystack/stable/newton
Branch stable/newton &lt;span class="nb"&gt;set&lt;/span&gt; up to track remote branch stable/newton from trystack.
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;同理，若想获取远程仓库master分支的所有更新，执行：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;获取远程master分支
&lt;span class="c1"&gt;# git fetch trystack master  &lt;/span&gt;
切换到本地master分支
&lt;span class="c1"&gt;# git checkout master       &lt;/span&gt;
rebase本地master到远程master
&lt;span class="c1"&gt;# git rebase trystack/master  &lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;git tag&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;创建tag。&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;git tag -a &amp;lt;tag号&amp;gt; &amp;lt;commit号&amp;gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;删除多个tag。有如下两种方式。使用正则表达式进行过滤即可。&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;➜  nova git:(master) git tag | awk &amp;#39;/2012/&amp;#39; | xargs git tag -d
Deleted tag &amp;#39;2012.1&amp;#39; (was 49934aa)
Deleted tag &amp;#39;2012.1.1&amp;#39; (was 29293ce)
Deleted tag &amp;#39;2012.1.2&amp;#39; (was 7a7c8f8)
...
&lt;/pre&gt;&lt;/div&gt;


&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# git show-ref --tag | awk &amp;#39;/2012/ {print &amp;quot;:&amp;quot;$2}&amp;#39; | xargs git push origin
&lt;/pre&gt;&lt;/div&gt;</content></entry><entry><title>OpenStack Networking Guide</title><link href="https://andiaq.github.io/posts/2016/12/11/networking-guide.html" rel="alternate"></link><published>2016-12-11T20:24:00+08:00</published><updated>2016-12-11T20:24:00+08:00</updated><author><name>Yuwei Wang</name></author><id>tag:andiaq.github.io,2016-12-11:/posts/2016/12/11/networking-guide.html</id><summary type="html">&lt;p&gt;该系列文章基本翻译于社区的Networking Guide，个人理解，原创翻译，仅供学习参考。&lt;/p&gt;
&lt;h3&gt;一、网络绪论&lt;/h3&gt;
&lt;p&gt;OpenStack 网络服务提供了 API 接口，用户可以建立和自定义网络的拓扑结构并且访问云网络。这个网络服务的项目代码是 Neutron，OpenStack 网络服务操作着虚拟网络设施的创建和管理，这些虚拟网络设施包括网络，交换机，子网，以及为 openstack 计算服务（nova）所管理的设备提供的路由，还包括一些高级服务比如防火墙，虚拟专用网络 VPN 等等。&lt;/p&gt;
&lt;p&gt;OpenStack 网络是由 neutron-server 组件，持久化存储的数据库，以及很多 plugin,agent 组成的。这些 agent 提供了一些其他的服务，比如与原生的 linux 网络机制，外部设备，或者 SDN controller 进行交互等等。&lt;/p&gt;
&lt;p&gt;OpenStack 网络是完全独立的服务 …&lt;/p&gt;</summary><content type="html">&lt;p&gt;该系列文章基本翻译于社区的Networking Guide，个人理解，原创翻译，仅供学习参考。&lt;/p&gt;
&lt;h3&gt;一、网络绪论&lt;/h3&gt;
&lt;p&gt;OpenStack 网络服务提供了 API 接口，用户可以建立和自定义网络的拓扑结构并且访问云网络。这个网络服务的项目代码是 Neutron，OpenStack 网络服务操作着虚拟网络设施的创建和管理，这些虚拟网络设施包括网络，交换机，子网，以及为 openstack 计算服务（nova）所管理的设备提供的路由，还包括一些高级服务比如防火墙，虚拟专用网络 VPN 等等。&lt;/p&gt;
&lt;p&gt;OpenStack 网络是由 neutron-server 组件，持久化存储的数据库，以及很多 plugin,agent 组成的。这些 agent 提供了一些其他的服务，比如与原生的 linux 网络机制，外部设备，或者 SDN controller 进行交互等等。&lt;/p&gt;
&lt;p&gt;OpenStack 网络是完全独立的服务，可以部署到一个专用的节点。如果我们的部署使用了一个控制节点来运行核心的计算组件（NOVA），那么我们可以把网络服务部署到另一个专用节点上。&lt;/p&gt;
&lt;p&gt;OpenStack 网络已与多种OpenStack组件整合：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;身份认证服务(Keystone)：进行用户验证和授权API请求。&lt;/li&gt;
&lt;li&gt;计算服务(Nova)：为虚拟机提供虚拟网卡。&lt;/li&gt;
&lt;li&gt;控制面板(horizon)：管理员和租户可以通过一个基于web的图形界面来创建和管理网络。&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;1.1 网络基础&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;以太网&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;以太网是一种具有IEEE802.3标准特性的网络协议。&lt;strong&gt;大多数的物理网卡都是通过以太网来通信。&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;在OSI模型的网络协议中，以太网在第二层，也被称为数据链路层。说到以太网，我们常听到以下几种词语，比如局域网，二层网，L2，链路层和数据链路层等等。&lt;/p&gt;
&lt;p&gt;在以太网中，连接到网络中的主机通过&lt;strong&gt;交换帧&lt;/strong&gt;来通信。以太网中的每一个主机唯一地被MAC地址所标识。在一个 OpenStack 环境中，每个虚拟机实例都有一个独一无二的 MAC 地址，不同于计算节点上的 MAC 地址。一个 MAC 地址有 48bits，是十六进制字符串的典型代表，比如&lt;code&gt;08:00:27:b9:88:74&lt;/code&gt;。MAC地址是由制造商通过硬编码到网卡上，但是现代的网卡允许你通过程序来改变MAC地址。在linux中，你可以使用ip命令来获取网卡的MAC地址。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# ip link show eth0&lt;/span&gt;
&lt;span class="m"&gt;2&lt;/span&gt;: eth0: &amp;lt;BROADCAST,MULTICAST,UP,LOWER_UP&amp;gt; mtu &lt;span class="m"&gt;1500&lt;/span&gt; qdisc pfifo_fast state UP mode DEFAULT qlen &lt;span class="m"&gt;1000&lt;/span&gt;
    link/ether fa:16:3e:5a:34:50 brd ff:ff:ff:ff:ff:ff
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;从概念上讲，你可以把以太网想象成一个每个网络上的主键都可以连接的单总线。在早期实现中，一个以太网包含了一条同轴电缆，主机可以因此连接网络。而现代的以太网络不使用这个方法，取而代之的是，每个网络主机都可以直接连到一个被称为交换机的网络设备。这个概念模型非常的有用。在OpenStack网络拓扑中，以太网通常被描述得类似是一条单总线。你会经常听到一个以太网被称为二层网络段。&lt;/p&gt;
&lt;p&gt;在以太网中，网络中的每个主机都可以向其他主机直接发送帧。以太网也支持广播，因此一个主机可以通过发送一个特殊的MAC地址&lt;code&gt;ff:ff:ff:ff:ff:ff&lt;/code&gt;，通过这个地址发送一个数据帧到网络中的每一台主机。ARP和DHCP是使用以太网广播的两个著名的协议，你可能也会听到一个以太网络被称为一个广播域。&lt;/p&gt;
&lt;p&gt;当一个网卡接收到一个以太网帧，默认情况下网卡会检查目的 MAC 地址是否与网卡（或者广播）的地址相匹配，如果 MAC 地址不匹配，以太网帧就会被丢掉。对计算节点来说，这一行为是不被容忍的，因为这个帧可能会被用于某个实例。NIC可以被配置为混杂模式，在混杂模式中，NIC 会把所有的以太网帧传到操作系统，即使MAC地址并不匹配。计算节点也应该经常为混杂模式配置合适的 NICs。&lt;/p&gt;
&lt;p&gt;正如上面所提到的，现代以太网络使用交换机来使网络中的主机互相连接。交换机是一个拥有很多端口的网络硬件盒，将以太网帧从一个已连接的主机发送到另一台主机。当主机第一次在交换机上发送以太网帧时，交换机并不知道是哪一个MAC地址与这个端口相对应。如果一个以太网帧发往的是一个未知的MAC地址，交换机会将帧广播到所有的端口。端口通过观察流量来知道哪个MAC地址对应于哪个端口。一旦知道端口对应的MAC地址，它就将以太网帧发送到正确的端口而不是采取广播的方式。交换机在一个转发表或者转发信息库中保存了MAC地址到交换机端口的映射关系。多个交换机呈菊链状地连接在一起，交换机和主机的连接后的表现得像是单一的网络。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;VLAN&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;VLAN 是一个可以使单个交换机表现得像是多个独立的交换机的网络技术。主要特点在于，连接到同一个交换机上但不是同一个局域网的两个主机观察不到对方的流量。OpenStack能够充分利用虚拟局域网隔离不同租户网络的优势，即使租户碰巧在同一个宿主机上运行着多个虚拟机实例。每一个虚拟局域网都被在1到4095中分配了一个ID。我们说“VLAN 15”指的就是ID号为15的虚拟局域网。&lt;/p&gt;
&lt;p&gt;为了理解VLANs如何工作，让我们来思考在传统IT环境中VLAN的应用，所谓的传统IT环境，即多台物理主机被连接到一台物理交换机，不涉及到虚拟化技术。设想这样一种方案，即你需要三个独立的网络，但是你只有一个物理交换机。网络管理员可能会选择三个VLAN ID，比如10,11,12，再配置交换机将交换机端口与VLAN ID相连接。比如交换机2号端口可能会与10号的VLAN相连，交换机3号端口可能会与11号的VLAN相连等等。当一个交换机端口为一个特殊的VLAN所配置，则这个端口被称为访问端口。交换机负责的就是确保网络流量在VLANs中被隔离。&lt;/p&gt;
&lt;p&gt;现在来考虑这样一种方案：第一个交换机的所有端口都被占用，因此机构购买了第二个交换机并将其与第一个交换机相连，以扩展可用的端口的数量。第二个交换机同样被配置成支持ID号为10,11,12的VLAN。现在设想与第一个交换机上被配置成10号VLAN的端口相连的主机A，欲打算向与第二个交换机上被配置成10号VLAN的端口相连的主机B发送一个以太网帧，当第一个交换机转发一个以太网帧到第二个交换机时，它必须表明这个帧与10号VLAN相关。&lt;/p&gt;
&lt;p&gt;如果两个交换机被连接到了一起，配置好了VLAN，则被用来连接两个交换机的端口必须被配置成允许来自任何VLAN的以太网帧都可以被转发到其他的交换机。另外，发送方交换机必须用VLAN号来标记每个以太网帧，因此接收方的交换机便可以确保只有VLAN匹配的主机才能接受帧。&lt;/p&gt;
&lt;p&gt;当一个交换机端口被配置成可以传输来自所有VLANs的以太网帧，并将它们用VLAN号做了标记，这种端口被称为传输端口。IEEE802.1Q是一种描述了当使用传输端口时，VLAN标记是如何被编码到以太网帧的网络协议。&lt;/p&gt;
&lt;p&gt;注意，如果你在你的物理交换机上使用VLANs来实现你的OpenStack云中的租户隔离，你就必须保证你所有的交换机端口都被配置成传输端口。&lt;/p&gt;
&lt;p&gt;在你当前网络基础设施中选择一个未被使用的VLAN地址范围是非常重要的。比如，如果你估计你的云必须最大可以支持100个项目，选择一个超出这个最大值的VLAN范围，比如200-299号的VLAN。处理租户网络的OpenStack和所有的物理网络基础设施都必须支持这个VLAN范围。&lt;/p&gt;
&lt;p&gt;传输端口可以被用来连接不同的交换机。每个传输端口使用一个标记来表明哪些VLAN被使用，这便确保了在同一个VLAN的交换机可以相互通信。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Subnets and ARP&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;网卡使用MAC地址找到网络主机，而TCP/IP层使用的是IP地址。地址解析协议ARP通过将IP地址转换成MAC地址在以太网和IP层之间建起了桥。 IP地址被分为两个部分：网络号和主机号。如果两个主机有相同的网络号就说明他们在同一个子网上。回想之前所说如果两个主机在同一个子网上，它们便可以直接在以太网上通信。ARP假定在同一个子网的所有的机器都在同一个本地局域网。网络管理员必须关系给主机分配IP地址和子网掩码，确保在同一个子网上的任何两台主机都在同一个本地局域网，否则ARP不会正常工作。&lt;/p&gt;
&lt;p&gt;为了计算一个IP地址的网络号，你必须知道与这个IP地址相关的子网掩码。子网掩码表明了在一个32位的IP地址中有多少位被用来组成网络号。 表示一个子网掩码有以下两种标记法： - 点分四位 - 无分类域间路由CIDR&lt;/p&gt;
&lt;p&gt;有一个IP地址为192.168.1.5，其前24位为网络号。在点分四位标记法中，这个子网掩码可以被写成255.255.255.0。CIDR标记法包括IP地址和子网掩码，可以被写成192.168.1.5/24。&lt;/p&gt;
&lt;p&gt;【注】：一个包括多播地址或者回环地址的CIDR子网掩码不能在OpenStack环境中被使用。比如，不支持使用224.0.0.0/16或者127.0.1.0/24作为子网。&lt;/p&gt;
&lt;p&gt;有时候我们想使用一个子网，但是在这个子网上没有任何特殊的IP地址，一个常遵循的惯例就是设置主机标识符全0来指向一个子网。比如，如果一个主机的IP地址为10.10.53.24/16，我们可以说其子网为10.10.0.0/16。&lt;/p&gt;
&lt;p&gt;为了理解ARP是如何将IP地址转换成MAC地址，我们可以看以下例子。假设主机A的IP地址是192.168.1.5/24， MAC地址是fc:99:47:49:d4:a0， 想向IP地址为192.168.1.7的主机B发送一个数据包。注意两个的主机有相同的子网号，所以主机A可以直接向主机B发送数据帧。&lt;/p&gt;
&lt;p&gt;主机A第一次试图和主机B通信，但是目的MAC地址未知。主机A便向局域网发出一个ARP请求，这个请求带有如下信息的广播：&lt;/p&gt;
&lt;p&gt;To：所有主机(ff:ff:ff:ff:ff:ff)，我在寻找IP地址为192.168.1.7的主机。我的MAC地址是fc:99:47:49:d4:a0。 主机B回复如下的响应报文： To：fc:99:47:49:d4:a0，我的IP地址是192.168.1.7。我的MAC地址是54:78:1a:86:00:a5。 然后主机A便向主机B发送以太网帧。 你可以使用arping命令手动发起一个ARP请求。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;➜  ~ arping -I eth0 &lt;span class="m"&gt;172&lt;/span&gt;.16.1.6
ARPING &lt;span class="m"&gt;172&lt;/span&gt;.16.1.6 from &lt;span class="m"&gt;172&lt;/span&gt;.16.1.5 eth0
Unicast reply from &lt;span class="m"&gt;172&lt;/span&gt;.16.1.6 &lt;span class="o"&gt;[&lt;/span&gt;FA:16:3E:6B:47:D8&lt;span class="o"&gt;]&lt;/span&gt;  &lt;span class="m"&gt;1&lt;/span&gt;.829ms
Unicast reply from &lt;span class="m"&gt;172&lt;/span&gt;.16.1.6 &lt;span class="o"&gt;[&lt;/span&gt;FA:16:3E:6B:47:D8&lt;span class="o"&gt;]&lt;/span&gt;  &lt;span class="m"&gt;1&lt;/span&gt;.981ms
Unicast reply from &lt;span class="m"&gt;172&lt;/span&gt;.16.1.6 &lt;span class="o"&gt;[&lt;/span&gt;FA:16:3E:6B:47:D8&lt;span class="o"&gt;]&lt;/span&gt;  &lt;span class="m"&gt;0&lt;/span&gt;.903ms
Unicast reply from &lt;span class="m"&gt;172&lt;/span&gt;.16.1.6 &lt;span class="o"&gt;[&lt;/span&gt;FA:16:3E:6B:47:D8&lt;span class="o"&gt;]&lt;/span&gt;  &lt;span class="m"&gt;0&lt;/span&gt;.970ms
Unicast reply from &lt;span class="m"&gt;172&lt;/span&gt;.16.1.6 &lt;span class="o"&gt;[&lt;/span&gt;FA:16:3E:6B:47:D8&lt;span class="o"&gt;]&lt;/span&gt;  &lt;span class="m"&gt;0&lt;/span&gt;.832ms
^CSent &lt;span class="m"&gt;5&lt;/span&gt; probes &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt; broadcast&lt;span class="o"&gt;(&lt;/span&gt;s&lt;span class="o"&gt;))&lt;/span&gt;
Received &lt;span class="m"&gt;5&lt;/span&gt; response&lt;span class="o"&gt;(&lt;/span&gt;s&lt;span class="o"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;为了减少ARP请求的数量，操作系统会保留一个包含IP地址和MAC地址映射的ARP缓存。在linux机器上，你可以使用arp命令来查看ARP缓存的内容。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;➜  ~ arp -n
Address                  HWtype  HWaddress           Flags Mask            Iface
&lt;span class="m"&gt;172&lt;/span&gt;.16.1.1               ether   fa:16:3e:d7:2f:5e   C                     eth0
&lt;span class="m"&gt;172&lt;/span&gt;.16.1.6               ether   fa:16:3e:6b:47:d8   C                     eth0
&lt;span class="m"&gt;172&lt;/span&gt;.16.1.7               ether   fa:16:3e:f9:fa:7c   C                     eth0
&lt;span class="m"&gt;172&lt;/span&gt;.16.1.4               ether   fa:16:3e:f6:1a:64   C                     eth0
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;strong&gt;动态主机控制协议DHCP&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;连接到网络上的主机可以使用动态主机控制协议来自动获取IP地址。由DHCP服务器分发IP地址给网络上的主机，这些主机即DHCP client。 DHCP client通过从68号端口发送UDP数据包到67号端口的255.255.255.255地址来确定DHCP server的位置。255.255.255.255是局域网的广播地址：在本地局域网的所有的主机都可以查看到发往这个地址的UDP数据包。然而，这种数据包不会被转发到其他的网络上。因此，DHCP server和DHCP client必须在一个局域网内，否则DHCP server将接收不到广播包。DHCP server通过从67号端口往client的68号端口发送一个UDP数据包作为回应。交换过程如下：
1. 客户端发送一个discover（“我是MAC地址为08:00:27:b9:88:74的客户端，我需要一个IP地址”
2. 服务端发送一个offer（“好的，我可以提供的IP地址是10.10.0.112”）
3. 客户端发送一个request（“服务器10.10.0.131，我想要10.10.0.112这个IP地址”）
4. 服务端发送一个acknowledgement（“好的，08:00:27:b9:88:74，10.10.0.112这个IP地址就是你的了。”）&lt;/p&gt;
&lt;p&gt;OpenStack需要一个三方程序Dnsmasq来实现DHCP服务器的功能，Dnsmasq写在系统日志，在这个日志里面你可以看到DHCP的请求的回复：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;Apr 23 15:53:46 c100-1 dhcpd: DHCPDISCOVER from 08:00:27:b9:88:74 via eth2
Apr 23 15:53:46 c100-1 dhcpd: DHCPOFFER on 10.10.0.112 to 08:00:27:b9:88:74 via eth2
Apr 23 15:53:48 c100-1 dhcpd: DHCPREQUEST for 10.10.0.112 (10.10.0.131) from 08:00:27:b9:88:74 via eth2
Apr 23 15:53:48 c100-1 dhcpd: DHCPACK on 10.10.0.112 to 08:00:27:b9:88:74 via eth2
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;实际OpenStack环境中，当虚拟机网络不可达时，我们可以通过检查这个日志来查看虚拟机在DHCP协议获取网络地址的哪个步骤有问题。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;IP&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;网际协议IP指定了连接在不同局域网上的主机如何路由数据包。IP依赖的是路由器或者说是网关。一个路由器可以被认为是至少连接了两个局域网的主机，可以将一个局域网中的IP数据包转发到另一个局域网上。路由器有多个IP地址：每个IP地址用于一个网络连接。&lt;/p&gt;
&lt;p&gt;在网络协议的OSI模型中，IP在第三层，也被称为网络层。说到IP，我们也常听到三层，L3和网络层这样的词语。&lt;/p&gt;
&lt;p&gt;主机发送一个数据包给IP地址询问它的路由表来决定这个数据包应该被发送到局域网的哪个主机，路由表中保存了与主机直接相连的局域网之间的映射。&lt;/p&gt;
&lt;p&gt;在linux机器上，下面的任何一个命令都可以显示路由表：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# ip route show&lt;/span&gt;
&lt;span class="c1"&gt;# route -n&lt;/span&gt;
&lt;span class="c1"&gt;# netstat -rn &lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;strong&gt;TCP/UDP/ICMP&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;对于在IP层网络通信的网络软件应用程序来说，他们必须使用在IP层之上的协议，这些协议占据OSI模型的第四层，也被称为传输层或者L4。协议编号的web页面由互联网号码分配局（IANA）为IP层之上的层和与它们相关的编号在维护。&lt;/p&gt;
&lt;p&gt;传输控制协议TCP是在网络应用中最常被使用的四层协议，TCP是一个面向连接的协议：它使用客户端-服务器模型（即C/S模型），在这个模型中，客户端与服务器相连接，服务器指的是可以接收连接的应用。典型基于TCP协议的应用的交互过程如下：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;客户端与服务器相连接&lt;/li&gt;
&lt;li&gt;客户端与服务器交换数据&lt;/li&gt;
&lt;li&gt;客户端或者服务器释放连接&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;因为一个网络主机可能有多个基于TCP协议的应用在运行，所以TCP协议使用端口来唯一的标识这些基于TCP的应用程序。一个TCP端口与1-65535范围内的一个数字相对应，在同一时刻，一个TCP端口只能与一个主机上的一个应用程序相关联，这一规则由操作系统在严格控制。 
TCP服务器在端口上被监听，比如，SSH服务器在22号端口被监听。对一个想与使用TCP协议的服务器连接的客户端来说，客户端必须知道服务器的IP地址和TCP端口号。&lt;/p&gt;
&lt;p&gt;TCP客户端应用程序所在的操作系统会自动的为其分配一个端口号，客户端在TCP连接释放前会一直拥有这个端口号，之后操作系统会对这个被释放的端口号进行回收，这些端口号被认为是临时端口号。&lt;/p&gt;
&lt;p&gt;互联网号码分配局（IANA）保存了大多数基于TCP服务和在端口上应用其他四层协议服务的注册端口号。注册一个端口号并不是硬性要求，但是这对避免与其他服务冲突非常的有用。欲知在OpenStack部署中被各种服务所使用的默认TCP端口号请阅读OpenStack配置参考书之Appendix B. Firewalls and default ports。&lt;/p&gt;
&lt;p&gt;编写基于TCP应用的API被称为伯克利套接字，也被称为BSD套接字，或者简称为套接字。套接字API公开面向流接口来编写TCP应用：从一个程序员的角度来看，在建立的TCP连接之上发送数据与写字节流到文件情况类似。操作系统的TCP/IP协议负责将数据流分解成IP包，操作系统同时还负责转播被丢弃的数据包，分发控制流来确保发出的数据不会超过发送方的数据缓冲区，接收方的数据缓冲区以及网络容量。最后，它还负责以正确的顺序重组数据包到接收方的数据流。因为TCP可以侦查和重发丢失的数据包，所以被称为可靠地协议。&lt;/p&gt;
&lt;p&gt;用户数据包协议（UDP）是另一种四层协议，是其他著名网络协议的基础。UDP是无连接的协议：两个基于UDP通信的应用程序在交换信息之前不用建立连接。UDP也是一种不可靠的协议，操作系统不会试图去重发或者去侦查丢失的UDP数据包，也不会保证接收端的应用程序接收UDP数据的顺序和发送的顺序相同。&lt;/p&gt;
&lt;p&gt;UDP和TCP一样，使用端口来区分在同一个系统上的不同应用程序。但是请注意，操作系统对UDP端口和TCP端口是分开处理的。比如，有一个与16543号TCP端口相关联的应用程序和有另一个独立的与16543号的UDP端口相关联的应用程序是可以实现的。&lt;/p&gt;
&lt;p&gt;和TCP一样，套接字API是编写基于UDP应用最常用的API。套接字API提供了编写UDP应用程序的面向信息的接口：程序员通过发送固定大小的消息在UDP上发送数据。如果应用程序需要重发丢失的数据包或者重新定义接收数据包的顺序，程序员就要负责在应用程序的代码中实现这个功能。&lt;/p&gt;
&lt;p&gt;动态主机控制协议（DHCP），域名解析系统（DNS），网络同步协议（NTP）和VXLAN都是在OpenStack环境中被使用的基于UDP的协议。&lt;/p&gt;
&lt;p&gt;UDP也支持一对多的通信：发送一个数据包到多个主机。应用程序可以通过设置接收端IP为广播地址255:255:255:255来广播一个UDP数据包到同一网络上的所有主机，还可以使用IP多播来发送一个UDP数据报到多个接收端。只要欲接收数据包的应用程序通过绑定一个UDP套接字到一个特殊的IP地址来加入一个多播组，而这个IP地址是合法多播组地址的其中一个。接收信息的主机可以不用在同一个局域网上作为发送方，但是介于中间的路由必须被配置成支持IP多播路由。VXLAN就是一个基于UDP协议使用IP多播的例子。&lt;/p&gt;
&lt;p&gt;网络控制报文协议（ICMP）是在IP层网络之上被用来发送控制信息的协议。比如，如果路由器的路由表中没有与目的地址相关的路由（1号ICMP，目的主机不可达），或者说如果IP数据包对路由器处理来说太（4号ICMP，需要分片但是被设置成了不分片），接收IP数据包的路由器就会发回一个ICMP差错报告报文。&lt;/p&gt;
&lt;p&gt;ping和mtr是使用ICMP的两个很实用的Linux命令行工具。&lt;/p&gt;</content></entry><entry><title>python eventlet及其在OpenStack中的应用</title><link href="https://andiaq.github.io/posts/2016/11/16/python-eventlet.html" rel="alternate"></link><published>2016-11-16T17:34:00+08:00</published><updated>2016-11-16T17:34:00+08:00</updated><author><name>Yuwei Wang</name></author><id>tag:andiaq.github.io,2016-11-16:/posts/2016/11/16/python-eventlet.html</id><summary type="html">&lt;p&gt;一直迷糊于操作系统的进程线程协程等概念及其切换，本文从基础开始梳理，旨在学习python的eventlet,及其在OpenStack中的应用。&lt;/p&gt;
&lt;h3&gt;一、简介&lt;/h3&gt;
&lt;p&gt;eventlet是一个python的并发网络库，采用&lt;code&gt;epoll/pool/select&lt;/code&gt;等异步 IO，并结合 greenlet 协程库实现并发。简单来说，eventlet是帮助实现并发的python库，不一定并行，但是也可以并行；在讲究高并发与分布式的今天，同步和阻塞就慢，异步和非阻塞就快。&lt;/p&gt;
&lt;p&gt;协程是一种运行在线程中的执行单位，同一个线程中可以同时运行多个协程，注意：该同时运行并不是真正意义上的并行，同时拥有CPU时间片的只有一个当前协程，其它的协程处于挂起状态。不要觉得这样”协程”就没有意义，因为有另一类协程，当前需要的不是CPU而是IO。众所周知，CPU是很快的，而IO很慢，所以当一些协程都在挂起等待IO的时候，一些协程则在用CPU，在同一个线程中跑多个协程的就可以更充分地利用硬件资源，极大的提高服务的响应能力。不同于线程和进程由内核来调度并分配时间片，协程需要在代码层显式地控制与转换。&lt;/p&gt;
&lt;p&gt;eventlet又将协程称为绿色线程(GreenThread)。所谓的并发，就是创建多个greenthread,并对其进行管理，以实现非阻塞式的I/O …&lt;/p&gt;</summary><content type="html">&lt;p&gt;一直迷糊于操作系统的进程线程协程等概念及其切换，本文从基础开始梳理，旨在学习python的eventlet,及其在OpenStack中的应用。&lt;/p&gt;
&lt;h3&gt;一、简介&lt;/h3&gt;
&lt;p&gt;eventlet是一个python的并发网络库，采用&lt;code&gt;epoll/pool/select&lt;/code&gt;等异步 IO，并结合 greenlet 协程库实现并发。简单来说，eventlet是帮助实现并发的python库，不一定并行，但是也可以并行；在讲究高并发与分布式的今天，同步和阻塞就慢，异步和非阻塞就快。&lt;/p&gt;
&lt;p&gt;协程是一种运行在线程中的执行单位，同一个线程中可以同时运行多个协程，注意：该同时运行并不是真正意义上的并行，同时拥有CPU时间片的只有一个当前协程，其它的协程处于挂起状态。不要觉得这样”协程”就没有意义，因为有另一类协程，当前需要的不是CPU而是IO。众所周知，CPU是很快的，而IO很慢，所以当一些协程都在挂起等待IO的时候，一些协程则在用CPU，在同一个线程中跑多个协程的就可以更充分地利用硬件资源，极大的提高服务的响应能力。不同于线程和进程由内核来调度并分配时间片，协程需要在代码层显式地控制与转换。&lt;/p&gt;
&lt;p&gt;eventlet又将协程称为绿色线程(GreenThread)。所谓的并发，就是创建多个greenthread,并对其进行管理，以实现非阻塞式的I/O。&lt;/p&gt;
&lt;h3&gt;二、与操作系统相关的概念&lt;/h3&gt;
&lt;p&gt;理解eventlet前，需知道的操作系统相关基础，请移步：https://segmentfault.com/a/1190000003063859&lt;/p&gt;
&lt;h4&gt;协程与线程的区别&lt;/h4&gt;
&lt;p&gt;类似线程，协程也是一个执行序列，拥有自己独立的栈和局部变量，同时又与其他协程共享局部变量。他们的主要区别在于，一个具有多线程的程序可以同时运行几个线程，而同一时间内只能有一个协程在运行，无需考虑很多锁的问题。&lt;/p&gt;
&lt;p&gt;使用线程时，线程的执行完全由操作系统控制，进程调度会决定什么时候哪个线程应该占用CPU。而使用协程时，协程的执行顺序与时间完全由程序自己决定。协程可以自己主动让出CPU,因此任务的执行顺序可控，从而能最大可能的利用CPU的性能。&lt;/p&gt;
&lt;p&gt;协程的实现方式&lt;/p&gt;
&lt;p&gt;协程的实现主要是在协程休息时把当前的寄存器保存起来，然后重新工作时将其恢复。我们可以简单地将协程理解成一个线程内的伪并发方式。&lt;/p&gt;
&lt;h3&gt;三、GreenThread&lt;/h3&gt;
&lt;p&gt;eventlet通过实现了GreenThread类对greenlet进行了简单的封装。下面看官网上关于greenlet的一个例子：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;greenlet&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;greenlet&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;test1&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="mi"&gt;12&lt;/span&gt;
    &lt;span class="n"&gt;gr2&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;switch&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="mi"&gt;34&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;test2&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="mi"&gt;56&lt;/span&gt;
    &lt;span class="n"&gt;gr1&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;switch&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="mi"&gt;78&lt;/span&gt;

&lt;span class="n"&gt;gr1&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;greenlet&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;test1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;gr2&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;greenlet&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;test2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;gr1&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;switch&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;该示例创建了两个协程 gr1 和 gr2 ,分别运行 test1 与 test2 两个函数，协程之间的切换使用 switch 方法。创建两个协程的主协程之后，切换到test1(),打印出12，然后又切换到test2()，打印出56，又切换回test1()，打印出34，然后执行权限重回主协程，由于之后主协程没有再切换给gr2执行，所以78没有被打印。这个过程始终只有一个协程在运行，函数的执行流由程序自己来控制，这很好的验证了协程运行顺序的可控性。&lt;/p&gt;
&lt;p&gt;但同样也验证了上述中已提到的，协程需要在代码层显式地控制与转换，是由应用程序来控制的，操作系统感知不到。而对于OpenStack这样的大项目来说，直接通过编写控制代码来切换的话可想而知不太可能。且python 2.x原生不支持协程，eventlet需要通过对标准库打patch实现协程。OpenStack对eventlet的使用同样如此。以Nova项目为例，在操作系统看来，nova-api只有一个线程，即主线程，该线程中又运行了很多协程，如果某一个协程被阻塞，应用程序也没有进行协程切换的话，便会阻塞该线程中的其他协程，大大影响并发效率。所以应用程序必须能够感知切换的时机，对于阻塞的场景，需要一种机制来触发切换该协程，运行其它的协程。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;EventletMonkey Patch&lt;/code&gt;可以动态地修改某些标准库，使得库里的阻塞函数被调用时触发切换，把CPU片段留给其它的协程。相关函数如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;eventlet.patcher.monkey_patch(os=None, select=None, socket=None, thread=None, time=None, psycopg=None)
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;它可以修改如下8种module：&lt;/p&gt;
&lt;p&gt;os / select / socket / thread / time / psycopg / MySQLdb / builtins&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;usage：&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;以&lt;code&gt;time module&lt;/code&gt;为例，传入&lt;code&gt;time=True&lt;/code&gt;表示&lt;code&gt;time module&lt;/code&gt;被打补丁[time.sleep is patched by eventlet.sleep]&lt;/p&gt;
&lt;p&gt;检查某个module是否已被monkey patch:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;eventlet&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;patcher&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;is_monkey_patched&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;module&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Eventlet 遇到如下场景时，会触发上下文切换：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;eventlet.sleep()&lt;/li&gt;
&lt;li&gt;上述被 monkey patch 的 module 的某些函数&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;在Nova中，eventlet被调用的入口在cmd/init.py:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;eventlet&lt;/span&gt;

&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;nova&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;debugger&lt;/span&gt;

&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;debugger&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;enabled&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
    &lt;span class="c1"&gt;# 禁用thread以开启远程调试&lt;/span&gt;
    &lt;span class="n"&gt;eventlet&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;monkey_patch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;False&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;thread&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;False&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;eventlet&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;monkey_patch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;os&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;False&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;下文继续分析eventlet常用的API，已经nova对eventlet的具体调用。&lt;/p&gt;
&lt;h3&gt;四、参考文档&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;http://greenlet.readthedocs.io/en/latest/&lt;/li&gt;
&lt;li&gt;http://eventlet.net/doc/basic_usage.html&lt;/li&gt;
&lt;li&gt;http://wsfdl.com/openstack/2014/09/29/Nova%E4%B8%AD%E7%9A%84%E5%8D%8F%E7%A8%8Bmonkey_patch.html&lt;/li&gt;
&lt;li&gt;https://specs.openstack.org/openstack/openstack-specs/specs/eventlet-best-practices.html&lt;/li&gt;
&lt;li&gt;http://eventlet.net/doc/patching.html#monkeypatching-the-standard-library&lt;/li&gt;
&lt;/ol&gt;</content></entry><entry><title>Nova中定时任务解析</title><link href="https://andiaq.github.io/posts/2016/11/02/periodic-task.html" rel="alternate"></link><published>2016-11-02T23:00:00+08:00</published><updated>2016-11-02T23:00:00+08:00</updated><author><name>Yuwei Wang</name></author><id>tag:andiaq.github.io,2016-11-02:/posts/2016/11/02/periodic-task.html</id><summary type="html">&lt;h3&gt;一、periodic_task&lt;/h3&gt;
&lt;h4&gt;1.1 what is periodic_task&lt;/h4&gt;
&lt;p&gt;在Nova中，nova-compute, nova-scheduler, nova-cell, network都有自己的周期性任务，通过nova的代码结构可以发现，它们都统一由各自模块下的manager.py中periodic_task管理。其中，periodic_task首先实现了一个装饰器，所有的周期性任务都是通过添加该装饰器实现，而周期性任务的启动伴随着每个服务的start也同步开始。&lt;/p&gt;
&lt;p&gt;首先装饰器实现如下(&lt;code&gt;oslo_service/periodic_task.py&lt;/code&gt;)，我们阅读后会发现，该方法主要定义了周期性任务（为True），以及周期性任务的名称，间隔时间（默认间隔时间是60s），运行方式等。实际上，此方法也只是定义了上述内容，添加了几个属性，并没有做其他的什么操作。由这些参数作为周期性任务的标记，保存到kwargs。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;periodic_task&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;decorator&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;          &lt;span class="c1"&gt;# f为被装饰的函数&lt;/span&gt;
        &lt;span class="c1"&gt;# Test for old style invocation&lt;/span&gt;
        &lt;span class="k"&gt;if …&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;</summary><content type="html">&lt;h3&gt;一、periodic_task&lt;/h3&gt;
&lt;h4&gt;1.1 what is periodic_task&lt;/h4&gt;
&lt;p&gt;在Nova中，nova-compute, nova-scheduler, nova-cell, network都有自己的周期性任务，通过nova的代码结构可以发现，它们都统一由各自模块下的manager.py中periodic_task管理。其中，periodic_task首先实现了一个装饰器，所有的周期性任务都是通过添加该装饰器实现，而周期性任务的启动伴随着每个服务的start也同步开始。&lt;/p&gt;
&lt;p&gt;首先装饰器实现如下(&lt;code&gt;oslo_service/periodic_task.py&lt;/code&gt;)，我们阅读后会发现，该方法主要定义了周期性任务（为True），以及周期性任务的名称，间隔时间（默认间隔时间是60s），运行方式等。实际上，此方法也只是定义了上述内容，添加了几个属性，并没有做其他的什么操作。由这些参数作为周期性任务的标记，保存到kwargs。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;periodic_task&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;decorator&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;          &lt;span class="c1"&gt;# f为被装饰的函数&lt;/span&gt;
        &lt;span class="c1"&gt;# Test for old style invocation&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;ticks_between_runs&amp;#39;&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;raise&lt;/span&gt; &lt;span class="n"&gt;InvalidPeriodicTaskArg&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;arg&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;ticks_between_runs&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

        &lt;span class="c1"&gt;# Control if run at all&lt;/span&gt;
        &lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_periodic_task&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;True&lt;/span&gt;     
        &lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_periodic_external_ok&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;pop&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;external_process_ok&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;False&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_periodic_enabled&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;pop&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;enabled&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_periodic_name&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;pop&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;name&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="vm"&gt;__name__&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

        &lt;span class="c1"&gt;# Control frequency&lt;/span&gt;
        &lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_periodic_spacing&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;pop&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;spacing&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;# 定义间隔时间&lt;/span&gt;
        &lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_periodic_immediate&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;pop&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;run_immediately&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;False&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="c1"&gt;# 定义运行方式&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_periodic_immediate&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_periodic_last_run&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;None&lt;/span&gt;
        &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;f&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_periodic_last_run&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;now&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;f&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;decorator&lt;/span&gt;
    &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;decorator&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;1.2 why use periodic_task&lt;/h4&gt;
&lt;p&gt;在创建虚拟机时，时常会出现虚拟机一直处于创建过程中的某一个状态，比如在rebuild状态时，通过设置定时机制，可以设置超时时间，不至于一直处于某一个状态。另外，合理利用定时机制还可以实现资源在周期时间内被回收，同步电源状态，循环更新宿主机可用资源，循环删除迁移失败的虚机等等。在Nova中，周期性任务的实现大大增强了openstack虚拟机生命周期管理的可用性。&lt;/p&gt;
&lt;h4&gt;1.3 how to use periodic_task&lt;/h4&gt;
&lt;p&gt;周期性任务的真正实现首先由nova/service.py的start方法中被触发：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;start&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="o"&gt;......&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;tg&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add_dynamic_timer&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;periodic_tasks&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                                  &lt;span class="n"&gt;initial_delay&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;initial_delay&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;     
                                  &lt;span class="n"&gt;periodic_interval_max&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;           
                                     &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;periodic_interval_max&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;其中，self.periodic_tasks调用了nova/manager.py的periodic_tasks方法:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;periodic_tasks&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;raise_on_error&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;False&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Tasks to be run at a periodic interval.&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;run_periodic_tasks&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;raise_on_error&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;raise_on_error&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; 
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;code&gt;run_periodic_tasks()&lt;/code&gt;来自&lt;code&gt;oslo_service/periodic_task.py&lt;/code&gt;中的&lt;code&gt;PeriodicTasks&lt;/code&gt;类，该类的实现方式比较复杂，由&lt;code&gt;@six.add_metaclass(_PeriodicTasksMeta)&lt;/code&gt;装饰，即使用了 Python 中的 metaclass，即元类。这里简要说明下，我们可以把元类想象成一个类中类，或者是一个类，而它的实例也是一个类。也可以理解成，metaclass 的实例是类，而 class 的实例是一个类对象。metaclass 详解移步&lt;a href="http://jianpx.iteye.com/blog/908121"&gt;这里&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;下面分析该元类:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;_PeriodicTasksMeta&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;cls&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;names&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;bases&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;dict_&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="c1"&gt;# cls为将要被创建的类，names为类名，bases为基类，dict_为类的属性，是一个字典，保存类的方法&lt;/span&gt;
        &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Metaclass that allows us to collect decorated periodic tasks.&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
        &lt;span class="nb"&gt;super&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;_PeriodicTasksMeta&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;cls&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;names&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;bases&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;dict_&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

        &lt;span class="c1"&gt;# 为类添加_periodic_tasks和_periodic_spacing两个类变量&lt;/span&gt;
        &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="bp"&gt;cls&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_periodic_tasks&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;cls&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_periodic_tasks&lt;/span&gt;&lt;span class="p"&gt;[:]&lt;/span&gt;
        &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="ne"&gt;AttributeError&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="bp"&gt;cls&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_periodic_tasks&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[]&lt;/span&gt;

        &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="bp"&gt;cls&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_periodic_spacing&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;cls&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_periodic_spacing&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;copy&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="ne"&gt;AttributeError&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="bp"&gt;cls&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_periodic_spacing&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{}&lt;/span&gt;

        &lt;span class="c1"&gt;# 访问类的各个函数成员，如果成员中_periodic_task变量并且等于true，&lt;/span&gt;
        &lt;span class="c1"&gt;# 则将该函数成员收集到类的_periodic_tasks列表中，在for循环结束后，&lt;/span&gt;
        &lt;span class="c1"&gt;# 所有的周期性任务都会在该列表里面&lt;/span&gt;
        &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;value&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="bp"&gt;cls&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="vm"&gt;__dict__&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;values&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nb"&gt;getattr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;value&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;_periodic_task&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;False&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
                &lt;span class="bp"&gt;cls&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_add_periodic_task&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;value&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;添加周期性任务到_periodic_tasks中的方法实现如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;_add_periodic_task&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;cls&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;task&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Add a periodic task to the list of periodic tasks.&lt;/span&gt;

&lt;span class="sd"&gt;    The task should already be decorated by @periodic_task.&lt;/span&gt;

&lt;span class="sd"&gt;    :return: whether task was actually enabled&lt;/span&gt;
&lt;span class="sd"&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="n"&gt;name&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;task&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_periodic_name&lt;/span&gt;

    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;task&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_periodic_spacing&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;LOG&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;_LI&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Skipping periodic task &lt;/span&gt;&lt;span class="si"&gt;%(task)s&lt;/span&gt;&lt;span class="s1"&gt; because &amp;#39;&lt;/span&gt;
                     &lt;span class="s1"&gt;&amp;#39;its interval is negative&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
                 &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;task&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="bp"&gt;False&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;task&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_periodic_enabled&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;LOG&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;info&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;_LI&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Skipping periodic task &lt;/span&gt;&lt;span class="si"&gt;%(task)s&lt;/span&gt;&lt;span class="s1"&gt; because &amp;#39;&lt;/span&gt;
                     &lt;span class="s1"&gt;&amp;#39;it is disabled&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
                 &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;task&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="bp"&gt;False&lt;/span&gt;

    &lt;span class="c1"&gt;# A periodic spacing of zero indicates that this task should&lt;/span&gt;
    &lt;span class="c1"&gt;# be run on the default interval to avoid running too&lt;/span&gt;
    &lt;span class="c1"&gt;# frequently.&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;task&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_periodic_spacing&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;task&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_periodic_spacing&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;DEFAULT_INTERVAL&lt;/span&gt;

    &lt;span class="bp"&gt;cls&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_periodic_tasks&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;task&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
    &lt;span class="bp"&gt;cls&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_periodic_spacing&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;task&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_periodic_spacing&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="bp"&gt;True&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;由以上程序，便完成了所有周期性任务的收集，接着等待任务被调度。现在我们继续说&lt;code&gt;add_dynamic_timer&lt;/code&gt;方法(&lt;code&gt;oslo_service/loopingcall.py&lt;/code&gt;)。 其中&lt;code&gt;tg&lt;/code&gt;是线程组&lt;code&gt;threadgroup.ThreadGroup(threads)&lt;/code&gt; 的实例，主要用来管理定时器&lt;code&gt;Timer&lt;/code&gt;和&lt;code&gt;greenthreads&lt;/code&gt;。然后实例化了一个&lt;code&gt;DynamicLoopingCall&lt;/code&gt;对象&lt;code&gt;timer&lt;/code&gt;,循环调用&lt;code&gt;callback&lt;/code&gt;,此处的传入的&lt;code&gt;callback&lt;/code&gt;为&lt;code&gt;periodic_tasks.DynamicLoopingCall&lt;/code&gt;与普通的&lt;code&gt;LoopingCall&lt;/code&gt;不同之处在于，它在循环调用&lt;code&gt;callback&lt;/code&gt;时，两次调用之间的等待时间是动态决定的。 接着timer调用start方法，该方法会创建一个绿色线程，定时触发周期性任务被调度。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;add_dynamic_timer&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;initial_delay&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;None&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                      &lt;span class="n"&gt;periodic_interval_max&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;None&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;timer&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;loopingcall&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;DynamicLoopingCall&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;timer&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;initial_delay&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;initial_delay&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                &lt;span class="n"&gt;periodic_interval_max&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;periodic_interval_max&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;timers&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;timer&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;timer&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;现在我们回到manager.py,执行run_periodic_tasks方法：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;run_periodic_tasks&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;raise_on_error&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;False&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;Tasks to be run at a periodic interval.&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
    &lt;span class="n"&gt;idle_for&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;DEFAULT_INTERVAL&lt;/span&gt;
    &lt;span class="c1"&gt;# 这里开始循环执行在上述元类_PeriodicTasksMeta中收集到的&lt;/span&gt;
    &lt;span class="c1"&gt;# 所有被deriodic_task装饰过的函数&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;task_name&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;task&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_periodic_tasks&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;task&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_periodic_external_ok&lt;/span&gt; &lt;span class="ow"&gt;and&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; 
           &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;conf&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;run_external_periodic_tasks&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
            &lt;span class="k"&gt;continue&lt;/span&gt;
        &lt;span class="n"&gt;cls_name&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;reflection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get_class_name&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;fully_qualified&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;False&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;full_task_name&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;.&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;([&lt;/span&gt;&lt;span class="n"&gt;cls_name&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;task_name&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;

        &lt;span class="n"&gt;spacing&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_periodic_spacing&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;task_name&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
        &lt;span class="n"&gt;last_run&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_periodic_last_run&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;task_name&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;

        &lt;span class="c1"&gt;# Check if due, if not skip&lt;/span&gt;
        &lt;span class="n"&gt;idle_for&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;min&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;idle_for&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;spacing&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;last_run&lt;/span&gt; &lt;span class="ow"&gt;is&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="bp"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;delta&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;last_run&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;spacing&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;now&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;delta&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                &lt;span class="n"&gt;idle_for&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;min&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;idle_for&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;delta&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
                &lt;span class="k"&gt;continue&lt;/span&gt;

        &lt;span class="n"&gt;LOG&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;debug&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Running periodic task &lt;/span&gt;&lt;span class="si"&gt;%(full_task_name)s&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                  &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;full_task_name&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;full_task_name&lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_periodic_last_run&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;task_name&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;_nearest_boundary&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
            &lt;span class="n"&gt;last_run&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;spacing&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

        &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;task&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;       &lt;span class="c1"&gt;# 执行被装饰的函数&lt;/span&gt;
        &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="ne"&gt;Exception&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;raise_on_error&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                &lt;span class="k"&gt;raise&lt;/span&gt;
            &lt;span class="n"&gt;LOG&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exception&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;_LE&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Error during &lt;/span&gt;&lt;span class="si"&gt;%(full_task_name)s&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
                          &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;full_task_name&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;full_task_name&lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;
        &lt;span class="n"&gt;time&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sleep&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;idle_for&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;</content></entry><entry><title>rabbitmq code snippets</title><link href="https://andiaq.github.io/posts/2016/10/11/rabbitmq-code-snippets.html" rel="alternate"></link><published>2016-10-11T12:00:00+08:00</published><updated>2016-10-11T12:00:00+08:00</updated><author><name>Yuwei Wang</name></author><id>tag:andiaq.github.io,2016-10-11:/posts/2016/10/11/rabbitmq-code-snippets.html</id><summary type="html">&lt;p&gt;RabbitMQ是一个支持多种通信协议的消息通信中间件，其核心原理即：接收和发送消息，是AMQP的典型应用。以下分模块列出与之相关的demo。&lt;/p&gt;
&lt;h3&gt;一、Hello World&lt;/h3&gt;
&lt;p&gt;以下实例实现了发送消息到一个已知队列中，并从该队列中接收消息。 send.py会发送一个消息到队列中，但是首先需要建立到RabbitMQ服务器的连接。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="ch"&gt;#!/usr/bin/env python&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pika&lt;/span&gt;

&lt;span class="n"&gt;connection&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pika&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;BlockingConnection&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pika&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ConnectionParameters&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="n"&gt;host&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;localhost&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;5672&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="n"&gt;channel&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;                       &lt;span class="c1"&gt;#建立一个到RabbitMQ服务器的连接&lt;/span&gt;

&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;queue_declare&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;queue&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;hello&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;                 &lt;span class="c1"&gt;#申明一个队列，消息将被发送到这个队列中&lt;/span&gt;

&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;basic_publish&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;exchange&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;                   &lt;span class="c1"&gt;#exchange=&amp;#39;&amp;#39;表示使用默认的交换机，由该默认交换机来指定某条消息需要投递&lt;/span&gt;
&lt;span class="c1"&gt;#到哪个队列，routing_key指定队列的名称&lt;/span&gt;
                      &lt;span class="n"&gt;routing_key&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;hello&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                      &lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Hello …&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;</summary><content type="html">&lt;p&gt;RabbitMQ是一个支持多种通信协议的消息通信中间件，其核心原理即：接收和发送消息，是AMQP的典型应用。以下分模块列出与之相关的demo。&lt;/p&gt;
&lt;h3&gt;一、Hello World&lt;/h3&gt;
&lt;p&gt;以下实例实现了发送消息到一个已知队列中，并从该队列中接收消息。 send.py会发送一个消息到队列中，但是首先需要建立到RabbitMQ服务器的连接。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="ch"&gt;#!/usr/bin/env python&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pika&lt;/span&gt;

&lt;span class="n"&gt;connection&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pika&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;BlockingConnection&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pika&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ConnectionParameters&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="n"&gt;host&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;localhost&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;5672&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="n"&gt;channel&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;                       &lt;span class="c1"&gt;#建立一个到RabbitMQ服务器的连接&lt;/span&gt;

&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;queue_declare&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;queue&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;hello&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;                 &lt;span class="c1"&gt;#申明一个队列，消息将被发送到这个队列中&lt;/span&gt;

&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;basic_publish&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;exchange&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;                   &lt;span class="c1"&gt;#exchange=&amp;#39;&amp;#39;表示使用默认的交换机，由该默认交换机来指定某条消息需要投递&lt;/span&gt;
&lt;span class="c1"&gt;#到哪个队列，routing_key指定队列的名称&lt;/span&gt;
                      &lt;span class="n"&gt;routing_key&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;hello&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                      &lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Hello World!&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot; [x] Sent &amp;#39;Hello World!&amp;#39;&amp;quot;&lt;/span&gt;
&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;                                   &lt;span class="c1"&gt;#在退出程序之前，我们需要确认网络缓冲已经被刷写、消息已经投递到RabbitMQ&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;receive.py将会从队列中获取消息并将消息打印出来，前提仍然是需要先建立到RabbitMQ服务器的连接。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="ch"&gt;#!/usr/bin/env python&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pika&lt;/span&gt;

&lt;span class="n"&gt;connection&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pika&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;BlockingConnection&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pika&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ConnectionParameters&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="n"&gt;host&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;localhost&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;5672&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="n"&gt;channel&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;queue_declare&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;queue&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;hello&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;                 &lt;span class="c1"&gt;#使用queue_declare创建一个队列,即使多次运行这个命令但只有一个队列会被创建。因为我们                              &lt;/span&gt;
                                                     &lt;span class="c1"&gt;#并不确定哪个程序会首先运行。这种情况下，在程序中重复将队列重复声明一下是种值得推荐的做法&lt;/span&gt;
&lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39; [*] Waiting for messages. To exit press CTRL+C&amp;#39;&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ch&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;method&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;properties&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;          &lt;span class="c1"&gt;#该回调函数接收到的消息内容并输出到屏幕上&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot; [x] Received &lt;/span&gt;&lt;span class="si"&gt;%r&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="p"&gt;,)&lt;/span&gt;              
&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;basic_consume&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;                      &lt;span class="c1"&gt;#告诉RabbitMQ callback将从queue中接收消息&lt;/span&gt;
                      &lt;span class="n"&gt;queue&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;hello&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                      &lt;span class="n"&gt;no_ack&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39; [*] Waiting for messages. To exit press CTRL+C&amp;#39;&lt;/span&gt;   &lt;span class="c1"&gt;#等待消息数据&lt;/span&gt;
&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;start_consuming&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;二、工作队列&lt;/h3&gt;
&lt;p&gt;工作队列是为了避免等待一些占用大量资源、时间的操作。后台的工作者worker进程会将任务从队列中取出并处理。若运行多个了工作者，任务会在这些工作者之间共享。默认情况下， RabbitMQ采用的是轮询机制，会按照顺序把消息发送给每一个消费者，使得平均每个消费者接收到同等数量的消息。&lt;/p&gt;
&lt;h4&gt;2.1 轮询调度&lt;/h4&gt;
&lt;p&gt;以下实例通过发送字符串并在字符串之后加点号（.）来表示任务的复杂度，一个点号（.）将会耗时1秒钟。 &lt;/p&gt;
&lt;p&gt;1）new_task.py会按照计划发送任务到工作队列。在以上send.py的基础上，主要是重新定义了消息message，通过此message来模拟。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;sys&lt;/span&gt;

&lt;span class="n"&gt;message&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;:])&lt;/span&gt; &lt;span class="ow"&gt;or&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Hello World!&amp;quot;&lt;/span&gt;
&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;basic_publish&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;exchange&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;routing_key&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;hello&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;message&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot; [x] Sent &lt;/span&gt;&lt;span class="si"&gt;%r&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;message&lt;/span&gt;&lt;span class="p"&gt;,)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;2）worker.py实现了为消息体中每一个点号（.）模拟1秒钟操作。主要在receive.py的基础上添加修改了如下代码。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;time&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ch&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;method&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;properties&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot; [x] Received &lt;/span&gt;&lt;span class="si"&gt;%r&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="p"&gt;,)&lt;/span&gt;
    &lt;span class="n"&gt;time&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sleep&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt; &lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;count&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;.&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot; [x] Done&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;可以通过在多个终端上运行worker.py脚本，同时在一个终端上不断运行new_task.py string，观察结果。&lt;/p&gt;
&lt;h4&gt;2.2 消息确认&lt;/h4&gt;
&lt;p&gt;为了防止消息丢失，RabbitMQ提供了消息确认机制，工作者可以通过ack，通知RabbitMQ已经收到并处理了某条信息；若工作者挂掉，RabbitMQ会将任务发送给其他工作者；若工作者和消息断开连接，RabbitMQ会重新发送信息。该机制通过no_ack=True设置，默认情况下开启。&lt;/p&gt;
&lt;h4&gt;2.3 消息持久化&lt;/h4&gt;
&lt;p&gt;将“队列”和“消息”设为持久化，可以防止当RabbitMQ服务器崩溃时，丢失所有的队列和信息。该机制通过durable=True设置。需要在消息发送端的代码new_task.py中如下代码：&lt;/p&gt;
&lt;p&gt;1）设置队列持久化&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;channel.queue_declare(queue=&amp;#39;task_queue&amp;#39;, durable=True)
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;2）设置消息持久化&lt;/p&gt;
&lt;p&gt;在new_task.py中添加如下代码实现消息&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;channel.basic_publish(exchange=&amp;#39;&amp;#39;,
                      routing_key=&amp;quot;task_queue&amp;quot;,
                      body=message,
                      properties=pika.BasicProperties(
                         delivery_mode = 2,                     # 设置消息持久化
                      ))
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;2.4 公平调度&lt;/h4&gt;
&lt;p&gt;公平调度实现了多个worker进程之间任务的均匀分配。 通过使用basic.qos方法，设置prefetch_count=1，告诉RabbitMQ在同一时刻，不要发送超过1条消息给某一个worker进程，直到该worker进程处理完了上一条消息并作出了响应。 在worker.py中添加如下代码实现公平调度：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;channel.basic_qos(prefetch_count=1)
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;注意：当所有的worker处于繁忙状态时，消息队列会被填满，此时可以添加更多的worker或采用其他方式解决。&lt;/p&gt;
&lt;h3&gt;三、发布/订阅&lt;/h3&gt;
&lt;p&gt;前两部分都是将一个message发送给一个consumer，现在我们尝试将一个message发送给多个consumer（即broadcast）。每个consumer收到消息后都可以做不同的处理。例如接下来我们要做一个简单的logging system，productor发送一个log，一个receiver负责存在硬盘里，一个receiver负责显示在屏幕上。工作模型如下：&lt;/p&gt;
&lt;p&gt;&lt;img alt="image" src="/images/publish.png"&gt;&lt;/p&gt;
&lt;p&gt;send.py:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="ch"&gt;#!/usr/bin/env python&lt;/span&gt;
&lt;span class="c1"&gt;# -*- coding=utf-8 -*-&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pika&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;sys&lt;/span&gt;
&lt;span class="n"&gt;conn&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pika&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;BlockingConnection&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pika&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ConnectionParameters&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;host&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;localhost&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="n"&gt;channel&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;conn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="c1"&gt;# 声明一个exchange,类型为fanout.&lt;/span&gt;
&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exchange_declare&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;exchange&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;logs&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;fanout&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;msg&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39; &amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;:])&lt;/span&gt; &lt;span class="ow"&gt;or&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;info: Hello World!&amp;quot;&lt;/span&gt;
&lt;span class="c1"&gt;# 这里的exchange不再为空，而是指定为‘log’&lt;/span&gt;
&lt;span class="c1"&gt;# 这里的routing_key为空串，因为fanout型的exchange会忽略它&lt;/span&gt;
&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;basic_publish&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;exchange&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;logs&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                      &lt;span class="n"&gt;routing_key&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                      &lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;msg&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;[x] sent &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="n"&gt;msg&lt;/span&gt;
&lt;span class="n"&gt;conn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;receive.py&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="ch"&gt;#!/usr/bin/env python                                                      &lt;/span&gt;
&lt;span class="c1"&gt;# -*- coding=utf-8 -*-&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pika&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;sys&lt;/span&gt;
&lt;span class="n"&gt;conn&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pika&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;BlockingConnection&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pika&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ConnectionParameters&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;localhost&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="n"&gt;channel&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;conn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exchange_declare&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;exchange&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;logs&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;fanout&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="c1"&gt;# 声明一个queue，这里不指明queue的名字，而是由系统随机生成，通常形如amq.xxx。&lt;/span&gt;
&lt;span class="c1"&gt;# 而exclusive设为True的意义是： once we disconnect the consumer the queue should be deleted&lt;/span&gt;
&lt;span class="c1"&gt;# 这样，无论什么时候我们需要一个空queue，都可以这样生成一个有随机名字的queue&lt;/span&gt;
&lt;span class="n"&gt;res&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;queue_declare&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;exclusive&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="c1"&gt;# 获取队列的名字&lt;/span&gt;
&lt;span class="n"&gt;queue_name&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;res&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;method&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;queue&lt;/span&gt;

&lt;span class="c1"&gt;# 绑定queue和exchange，告诉exchange要把message路由到哪个queue&lt;/span&gt;
&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;queue_bind&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;exchange&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;logs&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;queue&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;queue_name&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;[x] wait for logs.To exit press CTRL-c&amp;quot;&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ch&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;method&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;properties&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;[x] receive &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="n"&gt;body&lt;/span&gt;

&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;basic_consume&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;queue&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;queue_name&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;no_ack&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;start_consuming&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;运行多个receiver端，可以看到它们是同时接收到message的。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# 将接收到的消息日志存入文件
python receive.py &amp;gt; log.txt
# 将接收到的消息日志显示在屏幕上
python receive.py
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;四、路由（直接匹配）&lt;/h3&gt;
&lt;p&gt;第三部分实现了exchange给与它绑定的所有queue广播消息，这里实现发送端指定接收的queue。原理很简单,将一个queue和一个exchange绑定时，可以指定一个路由键(binding key)。发送端发送消息时，设定相应的路由键(routing key)，这样，当message到达exchange时，就根据路由键，将message发送给相应的queue。这里继上一篇，发送端指定info、warning、error三种级别的信息，由exchange发送到不同的接收端。工作模型如下:&lt;/p&gt;
&lt;p&gt;&lt;img alt="image" src="/images/direct-exchange.png"&gt;&lt;/p&gt;
&lt;h4&gt;4.1 绑定时指定路由键&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;channel.queue_bind(exchange=exchange_name,
                   queue=queue_name,
                   routing_key=&amp;#39;error&amp;#39;)
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;4.2 直接交换（Direct exchange）&lt;/h4&gt;
&lt;p&gt;exchange有四种类型，分别为direct,fanout,topic,headers。第三部分声明exchange时类型是fanout，fanout exchange会忽略路由键，而将message发送给每一个绑定了的队列，继而实现了广播的功能。为了给特定队列发送message，这里指定exchange的类型设定为direct。这样，exchange会将bind key 与 routing key 进行比较，若相同，则发送给相应的队列。若没有binding key 与routing key相同，则把message丢弃。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# 绑定queue和exchange，指定类型为direct&lt;/span&gt;
&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exchange_declare&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;exchange&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;direct_logs&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                         &lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;direct&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="c1"&gt;# 发送message时，设定routing key&lt;/span&gt;
&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;basic_publish&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;exchange&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;direct_logs&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                      &lt;span class="n"&gt;routing_key&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;severity&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                      &lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;message&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;4.3 多重绑定&lt;/h4&gt;
&lt;p&gt;多个queue与exchange绑定时，可以有相同的binding key，这样，当一个routing key与这个binding key相同时，message会发送给相应的多个queue，实现类似组播的功能。效果如图:&lt;/p&gt;
&lt;p&gt;&lt;img alt="image" src="/images/direct-exchange-multiple.png"&gt;&lt;/p&gt;
&lt;p&gt;具体实现&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="ch"&gt;#!/usr/bin/env python&lt;/span&gt;
&lt;span class="c1"&gt;# -*- coding=utf-8 -*-&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pika&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;sys&lt;/span&gt;
&lt;span class="n"&gt;conn&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pika&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;BlockingConnection&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pika&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ConnectionParameters&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;host&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;localhost&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="n"&gt;channel&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;conn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="c1"&gt;# 设定一个direct exchange&lt;/span&gt;
&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exchange_declare&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;exchange&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;direct_logs&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;direct&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="c1"&gt;# 发送三个不同routing key 的message&lt;/span&gt;
&lt;span class="n"&gt;routing&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;info&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;warning&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;error&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;route&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;routing&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;msg&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;&lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s2"&gt;: hello wordol&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="n"&gt;route&lt;/span&gt;
    &lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;basic_publish&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;exchange&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;direct_logs&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                          &lt;span class="n"&gt;routing_key&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;route&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                          &lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;msg&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;[x] sent &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="n"&gt;msg&lt;/span&gt;
&lt;span class="n"&gt;conn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;相比前一节，改动主要有两点： 
1. 设定exchange的类型为direct 
2. 发送消息时指定routing_key&lt;/p&gt;
&lt;p&gt;receive.py:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="ch"&gt;#!/usr/bin/env python                                                      &lt;/span&gt;
&lt;span class="c1"&gt;# -*- coding=utf-8 -*-&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pika&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;sys&lt;/span&gt;

&lt;span class="n"&gt;conn&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pika&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;BlockingConnection&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pika&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ConnectionParameters&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;host&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;localhost&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="n"&gt;channel&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;conn&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exchange_declare&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;exchange&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;direct_logs&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;direct&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;res&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;queue_declare&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;exclusive&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;queue_name&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;res&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;method&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;queue&lt;/span&gt;
&lt;span class="c1"&gt;# 从命令行接收binding key参数，若没有，则设为error&lt;/span&gt;
&lt;span class="n"&gt;routings&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;:]&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;routings&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;routings&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;error&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;route&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;routings&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="n"&gt;route&lt;/span&gt;
    &lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;queue_bind&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;exchange&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;direct_logs&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                       &lt;span class="n"&gt;queue&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;queue_name&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                       &lt;span class="n"&gt;routing_key&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;route&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;[x] wait for logs.To exit press CTRL-c&amp;quot;&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ch&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;method&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;properties&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;[x] receive &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="n"&gt;body&lt;/span&gt;

&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;basic_consume&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;queue&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;queue_name&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;no_ack&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;start_consuming&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;相比前一节，改动主要有两点： 
1. 设定exchange的类型为direct 
2. 从命令行接收binding key参数，从而在绑定时使用&lt;/p&gt;
&lt;h3&gt;五、主题交换机（模糊匹配）&lt;/h3&gt;
&lt;p&gt;由上可以看出，直连交换机可以有选择性的接收日志，但是无法基于多个标准执行路由操作。主题交换机的作用就是为了该目的来实现，大大提高了灵活性。 主题交换机的路由键是一个由.分隔开的词语列表，比如“a.b.c”, "a.d.e", "e.z.c"。 以下用图来说明： &lt;/p&gt;
&lt;p&gt;&lt;img alt="image" src="/images/topic_exchange.png"&gt;&lt;/p&gt;
&lt;p&gt;这三个绑定键被可以总结为： Q1 对所有的桔黄色动物都感兴趣。 Q2 则是对所有的兔子和所有懒惰的动物感兴趣。 两个通配符： '': 匹配前一个字符一次或多次 '#': 匹配前一个字符0次或多次 例： a. ，匹配的有a., a.b等等 a.#，匹配的有a,a., a.b....&lt;/p&gt;
&lt;p&gt;emit_log_topic.py:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="ch"&gt;#!/usr/bin/env python&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pika&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;sys&lt;/span&gt;
&lt;span class="n"&gt;connection&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pika&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;BlockingConnection&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pika&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ConnectionParameters&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
            &lt;span class="n"&gt;host&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;localhost&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;5672&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="n"&gt;channel&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exchange_declare&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;exchange&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;topic_logs&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;topic&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;routing_key&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nb"&gt;len&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt; &lt;span class="k"&gt;else&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;anonymous.info&amp;#39;&lt;/span&gt;     &lt;span class="c1"&gt;#设置路由键&lt;/span&gt;
&lt;span class="n"&gt;message&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39; &amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;:])&lt;/span&gt; &lt;span class="ow"&gt;or&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;Hello World!&amp;#39;&lt;/span&gt;

&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;basic_publish&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;exchange&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;topic_logs&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                      &lt;span class="n"&gt;routing_key&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;routing_key&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                      &lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;message&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot; [x] Sent &lt;/span&gt;&lt;span class="si"&gt;%r&lt;/span&gt;&lt;span class="s2"&gt;:&lt;/span&gt;&lt;span class="si"&gt;%r&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;routing_key&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;message&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;receive_logs_topic.py:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="ch"&gt;#!/usr/bin/env python&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pika&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;sys&lt;/span&gt;

&lt;span class="n"&gt;connection&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pika&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;BlockingConnection&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pika&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ConnectionParameters&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
            &lt;span class="n"&gt;host&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;localhost&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;5672&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;span class="n"&gt;channel&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exchange_declare&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;exchange&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;topic_logs&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="nb"&gt;type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;topic&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;result&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;queue_declare&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;exclusive&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;                          &lt;span class="c1"&gt;#随机生成队列&lt;/span&gt;
&lt;span class="n"&gt;queue_name&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;result&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;method&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;queue&lt;/span&gt;

&lt;span class="n"&gt;binding_keys&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;:]&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;binding_keys&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stderr&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Usage: &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s2"&gt; [binding_key]...&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
    &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exit&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;binding_key&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;binding_keys&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;                                       &lt;span class="c1"&gt;#获取绑定键，将绑定键和路由键做匹配，进行选择接受的日志类型&lt;/span&gt;
    &lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;queue_bind&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;exchange&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;topic_logs&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;queue&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;queue_name&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;routing_key&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;binding_key&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39; [*] Waiting for logs. To exit press CTRL+C&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ch&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;method&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;properties&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot; [x] &lt;/span&gt;&lt;span class="si"&gt;%r&lt;/span&gt;&lt;span class="s2"&gt;:&lt;/span&gt;&lt;span class="si"&gt;%r&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;method&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;routing_key&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;basic_consume&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;queue&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;queue_name&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;no_ack&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;start_consuming&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;观察到运行结果如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;shell1 $ ./emit_log_topic.py &amp;quot;kern.critical&amp;quot; &amp;quot;A critical kernel error&amp;quot;
 [x] Sent &amp;#39;&amp;#39;:&amp;#39;A critical kernel error&amp;#39;


shell2 $ ./receive_logs_topic.py &amp;quot;#&amp;quot;                             #接收所有日志信息
 [*] Waiting for logs. To exit press CTRL+C
 [x] &amp;#39;kern.critical&amp;#39;:&amp;#39;A critical kernel error&amp;#39;


shell3 $ ./receive_logs_topic.py &amp;quot;kern.*&amp;quot;                        #接收所有来自内核的日志信息
 [*] Waiting for logs. To exit press CTRL+C
 [x] &amp;#39;kern.critical&amp;#39;:&amp;#39;A critical kernel error&amp;#39;

shell4 $ ./receive_logs_topic.py &amp;quot;*.error&amp;quot;                        #接收所有的错误信息
 [*] Waiting for logs. To exit press CTRL+C
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;说明: 
1. binding key 设置为'#'时，topic exchange 和 fanout exchange的效果一样，相应的queue能接收到每一个message。 
2. binding key 里没有'*'或‘#’时， topic exchange 和 direct exchange的效果一样。&lt;/p&gt;
&lt;h3&gt;六、远程过程调用&lt;/h3&gt;
&lt;p&gt;将一个函数运行在远程计算机上并且等待从那儿获得结果，这种模式被称为远程过程调用RPC。 以下实例模拟RPC服务来返回斐波那契数列。 服务器端代码：&lt;/p&gt;
&lt;p&gt;rpc_server.py:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="ch"&gt;#!/usr/bin/env python&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pika&lt;/span&gt;
&lt;span class="n"&gt;connection&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pika&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;BlockingConnection&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pika&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ConnectionParameters&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;host&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;localhost&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;port&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;5672&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;               &lt;span class="c1"&gt;#建立到RabbitMQ服务器的连接&lt;/span&gt;
&lt;span class="n"&gt;channel&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;                                  &lt;span class="c1"&gt;#建立通道&lt;/span&gt;
&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;queue_declare&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;queue&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;rpc_queue&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;                        &lt;span class="c1"&gt;#申明消息队列&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;fib&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;                                                     &lt;span class="c1"&gt;#定义斐波那契函数&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;n&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
    &lt;span class="k"&gt;elif&lt;/span&gt; &lt;span class="n"&gt;n&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;
    &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;fib&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;fib&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;on_request&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ch&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;method&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;props&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;                           &lt;span class="c1"&gt;#为basic_consume声明一个回调函数，执行实际的操作并且做出响应&lt;/span&gt;
    &lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;[.] fib(&lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s2"&gt;)&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;,)&lt;/span&gt;
    &lt;span class="n"&gt;response&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;fib&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;ch&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;basic_publish&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;exchange&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                    &lt;span class="n"&gt;routing_key&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;props&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;reply_to&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;                 &lt;span class="c1"&gt;#reply_to（回复目标）：用来命名回调队列&lt;/span&gt;
                    &lt;span class="n"&gt;properties&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;pika&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;BasicProperties&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;correlation_id&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;props&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;correlation_id&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;                 &lt;span class="c1"&gt;#correlation_id（关联标识）：将RPC的响应和请求关联起来&lt;/span&gt;
                    &lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;response&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;                                               
    &lt;span class="n"&gt;ch&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;basic_ack&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;delivery_tag&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;method&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;delivery_tag&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;            &lt;span class="c1"&gt;#这是上面提到过得消息确认机制&lt;/span&gt;
&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;basic_qos&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;prefetch_count&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;                             &lt;span class="c1"&gt;#实现公平调度机制&lt;/span&gt;
&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;basic_consume&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;on_request&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;queue&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;rpc_queue&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;print&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;[x] Awaiting RPC requests&amp;quot;&lt;/span&gt;
&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;start_consuming&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;客户端代码：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="ch"&gt;#!/usr/bin/env python&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;pika&lt;/span&gt;
&lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;uuid&lt;/span&gt; 

&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;FibonacciRpcClient&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;object&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;pika&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;BlockingConnection&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pika&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ConnectionParameters&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;
                                        &lt;span class="n"&gt;host&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;localhost&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;channel&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;  
        &lt;span class="n"&gt;result&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;queue_declare&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;exclusive&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;                    &lt;span class="c1"&gt;#声明匿名独享的回调队列&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;callback_queue&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;result&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;method&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;queue&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;basic_consume&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;on_response&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;no_ack&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;True&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                                   &lt;span class="n"&gt;queue&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;callback_queue&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;                  &lt;span class="c1"&gt;#订阅上面声明的回调队列，以便接收RPC的响应&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;on_response&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ch&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;method&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;props&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;corr_id&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;props&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;correlation_id&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;                               &lt;span class="c1"&gt;#检查每一个响应消息的correlation_id是否与我们期待的一致&lt;/span&gt;
            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;response&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;body&lt;/span&gt;                                               &lt;span class="c1"&gt;#若correlation_id一致，则将响应结果赋值给self.response&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;call&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;                             &lt;span class="c1"&gt;#执行RPC请求&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;response&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;None&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;corr_id&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;uuid&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;uuid4&lt;/span&gt;&lt;span class="p"&gt;())&lt;/span&gt;           &lt;span class="c1"&gt;#生成一个唯一的correlation_id，并将其保存起来&lt;/span&gt;

        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;channel&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;basic_publish&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;exchange&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;                                &lt;span class="c1"&gt;#将带有reply_to和correlation_id属性的消息发布出去&lt;/span&gt;
                                   &lt;span class="n"&gt;routing_key&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;rpc_queue&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                                   &lt;span class="n"&gt;properties&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;pika&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;BasicProperties&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;reply_to&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;callback_queue&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                                                                   &lt;span class="n"&gt;correlation_id&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;corr_id&lt;/span&gt;&lt;span class="p"&gt;,),&lt;/span&gt;
                                                                   &lt;span class="n"&gt;body&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;str&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;        
        &lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;response&lt;/span&gt; &lt;span class="ow"&gt;is&lt;/span&gt; &lt;span class="bp"&gt;None&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;process_data_events&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="nb"&gt;int&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;response&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;        

&lt;span class="n"&gt;fibonacci_rpc&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;FibonacciRpcClient&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;              &lt;span class="c1"&gt;#发送RPC请求&lt;/span&gt;
&lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot; [x] Requesting fib(30)&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="n"&gt;response&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;fibonacci_rpc&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;call&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;30&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;                
&lt;span class="k"&gt;print&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot; [.] Got &lt;/span&gt;&lt;span class="si"&gt;%r&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="n"&gt;response&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;                   &lt;span class="c1"&gt;#接收响应的结果并打印&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;七、总结&lt;/h3&gt;
&lt;p&gt;&lt;img alt="image" src="/images/rpc.png"&gt;&lt;/p&gt;
&lt;p&gt;RPC的工作机制如下： &lt;/p&gt;
&lt;p&gt;客户端启动时，会创建一个匿名独享的回调队列； 在RPC请求中，客户端通过basic_publish发送带有两个属性的消息：一个是设置回调队列的 reply_to属性，另一个是设置唯一值的 correlation_id 属性； 以上请求会发送到rpc_queue队列中； RPC服务器端会等待请求发送到这个队列中。当请求出现时，服务器端执行他的工作并将带有执行结果的消息发送给reply_to字段指定的队列； 客户端等待回调队列里的数据，当消息出现时，它会检查correlation_id属性，若此属性值与请求匹配，就将其返回给应用。&lt;/p&gt;
&lt;h3&gt;八、参考文档&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;http://www.rabbitmq.com/tutorials/tutorial-one-python.html&lt;/li&gt;
&lt;li&gt;http://rabbitmq.mr-ping.com/&lt;/li&gt;
&lt;/ol&gt;</content></entry><entry><title>qemu-guest-agent</title><link href="https://andiaq.github.io/posts/2016/10/09/qemu-guest-agent.html" rel="alternate"></link><published>2016-10-09T14:14:00+08:00</published><updated>2016-10-09T14:14:00+08:00</updated><author><name>Yuwei Wang</name></author><id>tag:andiaq.github.io,2016-10-09:/posts/2016/10/09/qemu-guest-agent.html</id><summary type="html">&lt;h3&gt;一、背景&lt;/h3&gt;
&lt;p&gt;最近在OpenStack环境中分析给虚拟机打快照的过程。发现OpenStack默认打快照的方式是cold snapshot，在打快照的过程中，要么会把虚拟机关机（save状态），要么会将实例的文件系统静默。具体的情况下次解析。此文主要分析rbd做后端存储时使用qemu-guest-agent来静默文件系统。&lt;/p&gt;
&lt;h3&gt;二、简介&lt;/h3&gt;
&lt;p&gt;在KVM系统中，qemu-guest-agent（即qga）是一个运行在虚拟机内部的常驻进程。其功能类似vmware-tools，即实现宿主机和虚拟机的通信，这种方式不依赖于网络，而是依赖于virtio-serial（默认首选方式）或者isa-serial。OpenStack中，QEMU则提供了串口设备的模拟及数据交换的channel，最终呈现出来的是一个虚拟机内部的串口设备和宿主机上对应该虚拟机的unix socket文件。qga则通过读写串口设备和socket进行通信，通信协议为QMP（QEMU Machine Protocol）。QMP是一种基于json格式的传输协议，我们能利用它与从外部控制QEMU虚拟机实例，例如查询，更改虚拟机的状态，获取设备信息等等。&lt;/p&gt;
&lt;h3&gt;三、使用方式&lt;/h3&gt;
&lt;h4&gt;3.1 前提条件&lt;/h4&gt;
&lt;p&gt;1） 使用ceph做后端存储时，为了实现Nova、Glance、Cinder统一存储快速创建虚拟机，必须使用raw格式的镜像，如果使用qcow2会导致创建虚拟机过程很慢（Nova会先下载镜像后台转成raw格式再启动 …&lt;/p&gt;</summary><content type="html">&lt;h3&gt;一、背景&lt;/h3&gt;
&lt;p&gt;最近在OpenStack环境中分析给虚拟机打快照的过程。发现OpenStack默认打快照的方式是cold snapshot，在打快照的过程中，要么会把虚拟机关机（save状态），要么会将实例的文件系统静默。具体的情况下次解析。此文主要分析rbd做后端存储时使用qemu-guest-agent来静默文件系统。&lt;/p&gt;
&lt;h3&gt;二、简介&lt;/h3&gt;
&lt;p&gt;在KVM系统中，qemu-guest-agent（即qga）是一个运行在虚拟机内部的常驻进程。其功能类似vmware-tools，即实现宿主机和虚拟机的通信，这种方式不依赖于网络，而是依赖于virtio-serial（默认首选方式）或者isa-serial。OpenStack中，QEMU则提供了串口设备的模拟及数据交换的channel，最终呈现出来的是一个虚拟机内部的串口设备和宿主机上对应该虚拟机的unix socket文件。qga则通过读写串口设备和socket进行通信，通信协议为QMP（QEMU Machine Protocol）。QMP是一种基于json格式的传输协议，我们能利用它与从外部控制QEMU虚拟机实例，例如查询，更改虚拟机的状态，获取设备信息等等。&lt;/p&gt;
&lt;h3&gt;三、使用方式&lt;/h3&gt;
&lt;h4&gt;3.1 前提条件&lt;/h4&gt;
&lt;p&gt;1） 使用ceph做后端存储时，为了实现Nova、Glance、Cinder统一存储快速创建虚拟机，必须使用raw格式的镜像，如果使用qcow2会导致创建虚拟机过程很慢（Nova会先下载镜像后台转成raw格式再启动）&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# qemu-img convert -f qcow2 -O raw cirros-0.3.4-x86_64-disk.img cirros-0.3.4-x86_64-disk.raw&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;2）通过OpenStack创建虚拟机时，首先要满足选择的镜像属性hw_qemu_guest_agent=yes：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# glance image-update --property hw_qemu_guest_agent=yes $image_id&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;3）创建虚拟机。&lt;/p&gt;
&lt;p&gt;3.2 配置过程
1）启动虚拟机，在虚拟机中安装qemu-guest-agent（以CentOS 6.X为例）:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;yum install qemu-agent-agent
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;2）安装qga后，修改/etc/sysdonfig/qemu-ga文件：&lt;/p&gt;
&lt;p&gt;改动部分如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;设置 FSFREEZE_HOOK_ENABLE=1
注释 # BLACKLIST_RPC=&amp;quot;&amp;quot;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;3）查看&lt;code&gt;/var/lib/nova/instances/${instance_uuid}/libvirt.xml&lt;/code&gt;文件的以下设置：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nt"&gt;&amp;lt;channel&lt;/span&gt; &lt;span class="na"&gt;type=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;unix&amp;quot;&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;source&lt;/span&gt; &lt;span class="na"&gt;mode=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;bind&amp;quot;&lt;/span&gt; &lt;span class="na"&gt;path=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;/var/lib/libvirt/qemu/org.qemu.guest_agent.0.instance-0000066a.sock&amp;quot;&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
  &lt;span class="nt"&gt;&amp;lt;target&lt;/span&gt; &lt;span class="na"&gt;type=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;virtio&amp;quot;&lt;/span&gt; &lt;span class="na"&gt;name=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;org.qemu.guest_agent.0&amp;quot;&lt;/span&gt;&lt;span class="nt"&gt;/&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/channel&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;code&gt;org.qemu.guest_agent.0.instance-0000066a.sock&lt;/code&gt;是宿主机中对应该虚拟机的unit socket文件，&lt;code&gt;org.qemu.guest_agent.0&lt;/code&gt;是虚拟机内部的串口设备。由此组成一个通道的两端。qga时刻监听这个unix socket，一旦发现有指令发来，便分析该指令并执行，通过unix socket返回执行结果。&lt;/p&gt;
&lt;h4&gt;3.3 执行操作&lt;/h4&gt;
&lt;p&gt;查看虚拟机：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ virsh list
 Id    Name                           State
 ------------------------------------------------
 &lt;span class="m"&gt;3&lt;/span&gt;     instance-00000662              running
 &lt;span class="m"&gt;5&lt;/span&gt;     instance-0000066a              running
 &lt;span class="sb"&gt;```&lt;/span&gt;
获取虚拟机的信息：
&lt;span class="sb"&gt;```&lt;/span&gt;bash
&lt;span class="o"&gt;[&lt;/span&gt;root@server-68.103.hatest.ustack.in qemu &lt;span class="o"&gt;]&lt;/span&gt;$ virsh qemu-agent-command &lt;span class="m"&gt;5&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;{&amp;quot;execute&amp;quot;:&amp;quot;guest-info&amp;quot;}&amp;#39;&lt;/span&gt;
&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;return&amp;quot;&lt;/span&gt;:&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;version&amp;quot;&lt;/span&gt;:&lt;span class="s2"&gt;&amp;quot;1.2.1&amp;quot;&lt;/span&gt;,&lt;span class="s2"&gt;&amp;quot;supported_commands&amp;quot;&lt;/span&gt;:&lt;span class="o"&gt;[{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;enabled&amp;quot;&lt;/span&gt;:true,&lt;span class="s2"&gt;&amp;quot;name&amp;quot;&lt;/span&gt;:&lt;span class="s2"&gt;&amp;quot;guest-network-get-interfaces&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;,
&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;enabled&amp;quot;&lt;/span&gt;:true,&lt;span class="s2"&gt;&amp;quot;name&amp;quot;&lt;/span&gt;:&lt;span class="s2"&gt;&amp;quot;guest-suspend-hybrid&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;,&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;enabled&amp;quot;&lt;/span&gt;:true,&lt;span class="s2"&gt;&amp;quot;name&amp;quot;&lt;/span&gt;:&lt;span class="s2"&gt;&amp;quot;guest-suspend-ram&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;,
&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;enabled&amp;quot;&lt;/span&gt;:true,&lt;span class="s2"&gt;&amp;quot;name&amp;quot;&lt;/span&gt;:&lt;span class="s2"&gt;&amp;quot;guest-suspend-disk&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;,&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;enabled&amp;quot;&lt;/span&gt;:true,&lt;span class="s2"&gt;&amp;quot;name&amp;quot;&lt;/span&gt;:&lt;span class="s2"&gt;&amp;quot;guest-fstrim&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;,
&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;enabled&amp;quot;&lt;/span&gt;:true,&lt;span class="s2"&gt;&amp;quot;name&amp;quot;&lt;/span&gt;:&lt;span class="s2"&gt;&amp;quot;guest-fsfreeze-thaw&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;,&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;enabled&amp;quot;&lt;/span&gt;:true,&lt;span class="s2"&gt;&amp;quot;name&amp;quot;&lt;/span&gt;:&lt;span class="s2"&gt;&amp;quot;guest-fsfreeze-freeze&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;,
&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;enabled&amp;quot;&lt;/span&gt;:true,&lt;span class="s2"&gt;&amp;quot;name&amp;quot;&lt;/span&gt;:&lt;span class="s2"&gt;&amp;quot;guest-fsfreeze-status&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;,&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;enabled&amp;quot;&lt;/span&gt;:true,&lt;span class="s2"&gt;&amp;quot;name&amp;quot;&lt;/span&gt;:&lt;span class="s2"&gt;&amp;quot;guest-file-flush&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;,
&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;enabled&amp;quot;&lt;/span&gt;:true,&lt;span class="s2"&gt;&amp;quot;name&amp;quot;&lt;/span&gt;:&lt;span class="s2"&gt;&amp;quot;guest-file-seek&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;,&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;enabled&amp;quot;&lt;/span&gt;:true,&lt;span class="s2"&gt;&amp;quot;name&amp;quot;&lt;/span&gt;:&lt;span class="s2"&gt;&amp;quot;guest-file-write&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;,
&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;enabled&amp;quot;&lt;/span&gt;:true,&lt;span class="s2"&gt;&amp;quot;name&amp;quot;&lt;/span&gt;:&lt;span class="s2"&gt;&amp;quot;guest-file-read&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;,&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;enabled&amp;quot;&lt;/span&gt;:true,&lt;span class="s2"&gt;&amp;quot;name&amp;quot;&lt;/span&gt;:&lt;span class="s2"&gt;&amp;quot;guest-file-close&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;,
&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;enabled&amp;quot;&lt;/span&gt;:true,&lt;span class="s2"&gt;&amp;quot;name&amp;quot;&lt;/span&gt;:&lt;span class="s2"&gt;&amp;quot;guest-file-open&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;,&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;enabled&amp;quot;&lt;/span&gt;:true,&lt;span class="s2"&gt;&amp;quot;name&amp;quot;&lt;/span&gt;:&lt;span class="s2"&gt;&amp;quot;guest-shutdown&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;,
&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;enabled&amp;quot;&lt;/span&gt;:true,&lt;span class="s2"&gt;&amp;quot;name&amp;quot;&lt;/span&gt;:&lt;span class="s2"&gt;&amp;quot;guest-info&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;,&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;enabled&amp;quot;&lt;/span&gt;:true,&lt;span class="s2"&gt;&amp;quot;name&amp;quot;&lt;/span&gt;:&lt;span class="s2"&gt;&amp;quot;guest-ping&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;,
&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;enabled&amp;quot;&lt;/span&gt;:true,&lt;span class="s2"&gt;&amp;quot;name&amp;quot;&lt;/span&gt;:&lt;span class="s2"&gt;&amp;quot;guest-sync&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;,&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;enabled&amp;quot;&lt;/span&gt;:true,&lt;span class="s2"&gt;&amp;quot;name&amp;quot;&lt;/span&gt;:&lt;span class="s2"&gt;&amp;quot;guest-sync-delimited&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;}]}}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;以上执行结果显示了该虚拟机支持("enabled":true)的所有功能。&lt;/p&gt;
&lt;p&gt;feeeze文件系统的用法如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# 冻结虚拟机的文件系统，domain可以是domain name, id or uuid&lt;/span&gt;
&lt;span class="o"&gt;[&lt;/span&gt;root@server-68.103.hatest.ustack.in qemu &lt;span class="o"&gt;]&lt;/span&gt;$ virsh qemu-agent-command &lt;span class="m"&gt;5&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;{&amp;quot;execute&amp;quot;:&amp;quot;guest-fsfreeze-freeze&amp;quot;}&amp;#39;&lt;/span&gt;
&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;return&amp;quot;&lt;/span&gt;:1&lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="c1"&gt;# 查看文件系统冻结后的状态为frozen&lt;/span&gt;
&lt;span class="o"&gt;[&lt;/span&gt;root@server-68.103.hatest.ustack.in qemu &lt;span class="o"&gt;]&lt;/span&gt;$ virsh qemu-agent-command &lt;span class="m"&gt;5&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;{&amp;quot;execute&amp;quot;:&amp;quot;guest-fsfreeze-status&amp;quot;}&amp;#39;&lt;/span&gt;
&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;return&amp;quot;&lt;/span&gt;:&lt;span class="s2"&gt;&amp;quot;frozen&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="c1"&gt;# 解冻文件系统&lt;/span&gt;
&lt;span class="o"&gt;[&lt;/span&gt;root@server-68.103.hatest.ustack.in qemu &lt;span class="o"&gt;]&lt;/span&gt;$ virsh qemu-agent-command &lt;span class="m"&gt;5&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;{&amp;quot;execute&amp;quot;:&amp;quot;guest-fsfreeze-thaw&amp;quot;}&amp;#39;&lt;/span&gt;
&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;return&amp;quot;&lt;/span&gt;:1&lt;span class="o"&gt;}&lt;/span&gt;

&lt;span class="c1"&gt;# 查看文件系统解冻后的状态为thawed&lt;/span&gt;
&lt;span class="o"&gt;[&lt;/span&gt;root@server-68.103.hatest.ustack.in qemu &lt;span class="o"&gt;]&lt;/span&gt;$ virsh qemu-agent-command &lt;span class="m"&gt;5&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;{&amp;quot;execute&amp;quot;:&amp;quot;guest-fsfreeze-status&amp;quot;}&amp;#39;&lt;/span&gt;
&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;return&amp;quot;&lt;/span&gt;:&lt;span class="s2"&gt;&amp;quot;thawed&amp;quot;&lt;/span&gt;&lt;span class="o"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;四、OpenStack中打快照&lt;/h4&gt;
&lt;p&gt;OpenStack中静默文件系统时，会进入如下方法：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;_set_quiesced&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;context&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;instance&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;image_meta&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;quiesced&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_can_quiesce&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;instance&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;image_meta&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;guest&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_host&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get_guest&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;instance&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

        &lt;span class="c1"&gt;# TODO(sahid): We are converting all calls from a&lt;/span&gt;
        &lt;span class="c1"&gt;# virDomain object to use nova.virt.libvirt.Guest.&lt;/span&gt;
        &lt;span class="c1"&gt;# We should be able to remove domain at the end.&lt;/span&gt;
        &lt;span class="n"&gt;domain&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;guest&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_domain&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;quiesced&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="c1"&gt;# 调用libvirt库函数，冻结文件系统，类似执行virsh qemu-agent-command 5 &amp;#39;{&amp;quot;execute&amp;quot;:&amp;quot;guest-fsfreeze-freeze&amp;quot;}&amp;#39;&lt;/span&gt;
            &lt;span class="n"&gt;domain&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fsFreeze&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="c1"&gt;# 调用libvirt库函数，解封文件系统，类似执行virsh qemu-agent-command 5 &amp;#39;{&amp;quot;execute&amp;quot;:&amp;quot;guest-fsfreeze-thaw&amp;quot;}&amp;#39;&lt;/span&gt;
            &lt;span class="n"&gt;domain&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fsThaw&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="n"&gt;libvirt&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;libvirtError&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;ex&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;error_code&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ex&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get_error_code&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="n"&gt;msg&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;_&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Error from libvirt while quiescing &lt;/span&gt;&lt;span class="si"&gt;%(instance_name)s&lt;/span&gt;&lt;span class="s1"&gt;: &amp;#39;&lt;/span&gt;
                 &lt;span class="s1"&gt;&amp;#39;[Error Code &lt;/span&gt;&lt;span class="si"&gt;%(error_code)s&lt;/span&gt;&lt;span class="s1"&gt;] &lt;/span&gt;&lt;span class="si"&gt;%(ex)s&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
               &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;instance_name&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;instance&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                  &lt;span class="s1"&gt;&amp;#39;error_code&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;error_code&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;ex&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;ex&lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;
        &lt;span class="k"&gt;raise&lt;/span&gt; &lt;span class="n"&gt;exception&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;NovaException&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;msg&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;五、参考文档&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;http://docs.ceph.org.cn/rbd/rbd-snapshot/&lt;/li&gt;
&lt;li&gt;http://wiki.libvirt.org/page/Qemu_guest_agent&lt;/li&gt;
&lt;li&gt;http://www.wtoutiao.com/p/186Gewv.html&lt;/li&gt;
&lt;/ol&gt;</content></entry><entry><title>make rpm package</title><link href="https://andiaq.github.io/posts/2016/10/07/make-rpm-package.html" rel="alternate"></link><published>2016-10-07T14:48:00+08:00</published><updated>2016-10-07T14:48:00+08:00</updated><author><name>Yuwei Wang</name></author><id>tag:andiaq.github.io,2016-10-07:/posts/2016/10/07/make-rpm-package.html</id><summary type="html">&lt;p&gt;近一个两月和同事们一起开发了一个关于虚拟机HA的项目rock。目前正在着手将该项目由Puppet管理，所以需要将rock打包成rpm格式。以下记录了RPM打包的过程。&lt;/p&gt;
&lt;h3&gt;一、简介&lt;/h3&gt;
&lt;p&gt;RPM(RedHat Package Manager)是RedHat的软件包管理器。通过rpm可以在软件安装的过程中就把相关的依赖一起部署完毕，此外，rpm还有数据库协助软件升级、文件校验等，结合yum升级方式，选择rpm打包是很好的一种方法。&lt;/p&gt;
&lt;h3&gt;二、RPM常用命令&lt;/h3&gt;
&lt;p&gt;常用命令组合：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;-ivh  # 安装显示安装进度 --install--verbose--hash
-Uvh  # 升级软件包 --Update;
-qpl  # 列出RPM软件包内的文件信息 [Query Package list];
-qpi  # 列出RPM软件包的描述信息 [Query Package install package(s)];
-qf   # 查找指定文件属于哪个RPM软件包 [Query File];
-Va   # 校验所有的RPM软件包，查找丢失的文件 [View Lost];
-e    # 删除包  
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;更多命令可以通过 …&lt;/p&gt;</summary><content type="html">&lt;p&gt;近一个两月和同事们一起开发了一个关于虚拟机HA的项目rock。目前正在着手将该项目由Puppet管理，所以需要将rock打包成rpm格式。以下记录了RPM打包的过程。&lt;/p&gt;
&lt;h3&gt;一、简介&lt;/h3&gt;
&lt;p&gt;RPM(RedHat Package Manager)是RedHat的软件包管理器。通过rpm可以在软件安装的过程中就把相关的依赖一起部署完毕，此外，rpm还有数据库协助软件升级、文件校验等，结合yum升级方式，选择rpm打包是很好的一种方法。&lt;/p&gt;
&lt;h3&gt;二、RPM常用命令&lt;/h3&gt;
&lt;p&gt;常用命令组合：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;-ivh  # 安装显示安装进度 --install--verbose--hash
-Uvh  # 升级软件包 --Update;
-qpl  # 列出RPM软件包内的文件信息 [Query Package list];
-qpi  # 列出RPM软件包的描述信息 [Query Package install package(s)];
-qf   # 查找指定文件属于哪个RPM软件包 [Query File];
-Va   # 校验所有的RPM软件包，查找丢失的文件 [View Lost];
-e    # 删除包  
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;更多命令可以通过&lt;code&gt;man rpm&lt;/code&gt;查询。&lt;/p&gt;
&lt;h3&gt;三、打包过程&lt;/h3&gt;
&lt;h4&gt;3.1 准备操作&lt;/h4&gt;
&lt;p&gt;在创建RPM包之前，需要先安装一些必须的开发工具：&lt;/p&gt;
&lt;p&gt;安装打包套件：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ yum install rpmdevtools
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;建议使用临时用户来创建RPM包，若打包发生了错误，构建程序不会破坏系统。&lt;/p&gt;
&lt;p&gt;使用临时用户登陆，在家目录下，创建标准的打包目录结构：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ rpmdev-setuptree
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;该操作会在家目录下生成rpmbuild目录，同时该目录下存在如下目录：
- BUILT
- RPMS
- SOURCES
- SPECS
- SRAMS&lt;/p&gt;
&lt;p&gt;其中，SOURCES目录中存放的是源文件的压缩包（一般是tar.gz格式）以及其所需要的配置文件和patch等。BUILD目录存放build阶段解压的源文件压缩包。SPECS目录存放的是spec文件，打包的关键就是对该spec文件的编写。之后通过对该spec文件执行rpmbuild操作进行打包，最终生成的二进制RPM包存放于RPMS，源文件RPM包存放于SRAMS。&lt;/p&gt;
&lt;p&gt;同时在install阶段，为保证非root用户能打包，引入了BuildRoot，整个安装过程会在该目录发生。再根据spec文件中的%files指定打包需要哪些文件（从BUILDROOT的相应路径找到文件）。&lt;/p&gt;
&lt;p&gt;以上准备工作完成。现在需要编写spec文件。&lt;/p&gt;
&lt;h4&gt;3.2 编写spec文件&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ &lt;span class="nb"&gt;cd&lt;/span&gt; rpmbuild/SPECS
$ vim test.spec
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;也可以通过以下命令快速生成一个模板：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ rpmdev-newspec test.spec
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;以下通过test.spec模板进行解释：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;Name:                                   # 该软件包的名称，如:rock,可通过宏{%name}来引用
Version:                                # 版本信息
Release:    1%{?dist}                   # rpm包的发行号
Summary:                                # 软件包简介
Group:                                  # 软件类型
License:                                # 软件包的版权规则
URL:                                    # 软件地址
Source0:                                # 源文件包，通常为tar.gz
BuildRoot:  %{_tmppath}/%{name}-%{version}-%{release}-root-%(%{__id_u} -n) 

BuildRequires
Requires:

%description                            # 软件包的详细描述信息

%prep                                   # 打包前的准备操作
%setup -q -n %{name}-%{version}         # 解压源码包到BUILD目录下

%build                                  # 构建阶段
%configure
make %{?_smp_mflags}

%install                                # 安装阶段
rm -rf %{buildroot}
make install DESTDIR=%{buildroot}

%clean                                  # 清理临时文件
rm -rf %{buildroot}

%files                                  # 定义放入rpm包中的文件和目录
%defattr(-,root,root,-)
%doc

%changelog                              # 日志变更信息
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;部分具体说明如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;%group&lt;/code&gt;：可在&lt;code&gt;/usr/share/doc/rpm-x.x.x/GROUPS&lt;/code&gt;中查看 Group 的一个列表。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;%BuildRoot&lt;/code&gt;：构建包时的安装目录。BUILD 目录即&lt;code&gt;%{_builddir}&lt;/code&gt;，编译是在 BUILD 目录中进行的，当编译完成后，将打包需要的文件从 BUILD 目录复制到 BuildRoot 目录，然后在 BuildRoot 目录进行安装，若设置 BuildRoot 为 &lt;code&gt;/usr/local&lt;/code&gt;，可用 &lt;code&gt;$RPM_BUILD_ROOT&lt;/code&gt; 或 &lt;code&gt;%{buildroot}&lt;/code&gt; 访问它，值为 &lt;code&gt;rpmbuild/BUILDROOT/usr/local&lt;/code&gt;。除了在 spec 文件中设置 BuildRoot 外，还可以在 rpmrc 文件或在 rpmbuild 命令使用 &lt;code&gt;--buildroot&lt;/code&gt; 来设置 BuildRoot。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;%BuildRequires&lt;/code&gt;：编译该软件包所需的依赖包列表，以逗号分隔。编译依赖不会自动判断，所以需要列出编译所需的所有依赖包。常见的软件包可省略，例如 gcc。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;%Requires&lt;/code&gt;：安装该软件所需的依赖包列表。BuildRequires 标签是编译所需的依赖，而 Requires 标签是安装/运行程序所需的依赖。大多数情况下，rpmbuild 会自动探测依赖，所以可能不需要 Requires 标签。然而，你也可以明确标明需要哪些软件包，或由于未自动探测所需依赖而需要手动标明。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;更多详细信息可以&lt;a href="https://fedoraproject.org/wiki/How_to_create_an_RPM_package/zh-cn#SPEC_.E6.96.87.E4.BB.B6.E7.BB.BC.E8.BF.B0"&gt;这里&lt;/a&gt;查看。&lt;/p&gt;
&lt;h4&gt;3.3 打包时的具体问题&lt;/h4&gt;
&lt;p&gt;一、在编写spec文件时，使用到很多RPM宏命令，这些宏命令的定义可在&lt;code&gt;/usr/lib/rpm/macros&lt;/code&gt;中查看。以下列出我所用到的宏命令：&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;宏命令&lt;/th&gt;
&lt;th&gt;路径&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td _95_95_python="__python"&gt;%&lt;/td&gt;
&lt;td&gt;/usr/bin/python&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td _95_prefix="_prefix"&gt;%&lt;/td&gt;
&lt;td&gt;/usr&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td _95_sysconfdir="_sysconfdir"&gt;%&lt;/td&gt;
&lt;td&gt;/etc/&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td _95_unitdir="_unitdir"&gt;%&lt;/td&gt;
&lt;td&gt;/usr/lib/systemd/system&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td _95_python_95_sitelib="_python_sitelib"&gt;%&lt;/td&gt;
&lt;td&gt;/usr/lib/python2.7/site-packages&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td _95_localstatedir="_localstatedir"&gt;%&lt;/td&gt;
&lt;td&gt;/var&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td _95_bindir="_bindir"&gt;%&lt;/td&gt;
&lt;td&gt;/usr/bin&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;以上宏命令所对应的路径都可以通过&lt;code&gt;rpm --eval %{macro}&lt;/code&gt;查看。&lt;/p&gt;
&lt;p&gt;二、下面以rock.spec为例，分步解释。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;code&gt;%prep&lt;/code&gt;字段，对源文件压缩包解压。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nf"&gt;%prep&lt;/span&gt;
&lt;span class="nf"&gt;%setup&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;q&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;n&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;-%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;version&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;&lt;code&gt;%build&lt;/code&gt;字段，构建压缩包。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nf"&gt;%build&lt;/span&gt;
&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;__python&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="n"&gt;setup&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;py&lt;/span&gt; &lt;span class="n"&gt;build&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;%install字段，安装软件包到BUILDROOT目录。需注意的是，这里rock依赖了keeplived，需修改keepalived.conf文件，但是keepalived同样可能会被其他软件所使用，所以我们只管安装自己项目所需的文件，这里在安装之前，先把编译到BUILDROOT下的keeplived.conf删除后再进行下面的操作的。其次，在安装下面的配置文件时，注意赋予的权限。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nf"&gt;%install&lt;/span&gt;
&lt;span class="n"&gt;rm&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;rf&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;buildroot&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;__python&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="n"&gt;setup&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;py&lt;/span&gt; &lt;span class="n"&gt;install&lt;/span&gt; &lt;span class="o"&gt;--&lt;/span&gt;&lt;span class="n"&gt;skip&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;build&lt;/span&gt; &lt;span class="o"&gt;--&lt;/span&gt;&lt;span class="n"&gt;root&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;buildroot&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="cp"&gt;# Remove keepalived dependency&lt;/span&gt;
&lt;span class="n"&gt;rm&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;buildroot&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;_sysconfdir&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;keepalived&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;keepalived&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;conf&lt;/span&gt;

&lt;span class="cp"&gt;# Setup directories&lt;/span&gt;
&lt;span class="n"&gt;install&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;d&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;m&lt;/span&gt; &lt;span class="mi"&gt;755&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;buildroot&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;_localstatedir&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;rock&lt;/span&gt;

&lt;span class="cp"&gt;# Install config files&lt;/span&gt;

&lt;span class="n"&gt;install&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;p&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;m&lt;/span&gt; &lt;span class="mi"&gt;640&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;SOURCE1&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;buildroot&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;_sysconfdir&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;rock&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;alembic&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ini&lt;/span&gt;
&lt;span class="n"&gt;install&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;p&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;m&lt;/span&gt; &lt;span class="mi"&gt;640&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;SOURCE2&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;buildroot&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;_sysconfdir&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;rock&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;rock&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ini&lt;/span&gt;
&lt;span class="n"&gt;install&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;p&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;m&lt;/span&gt; &lt;span class="mi"&gt;640&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;SOURCE3&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;buildroot&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;_sysconfdir&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;rock&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;target&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;json&lt;/span&gt;
&lt;span class="n"&gt;install&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;p&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;m&lt;/span&gt; &lt;span class="mi"&gt;640&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;SOURCE4&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;buildroot&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;_sysconfdir&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;rock&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;cases&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;host_down&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;json&lt;/span&gt;

&lt;span class="cp"&gt;# Install systemd units&lt;/span&gt;
&lt;span class="n"&gt;install&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;p&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;m&lt;/span&gt; &lt;span class="mi"&gt;644&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;SOURCE5&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;buildroot&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;_unitdir&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;rock&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;engine&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;service&lt;/span&gt;
&lt;span class="n"&gt;install&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;p&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;m&lt;/span&gt; &lt;span class="mi"&gt;644&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;SOURCE6&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;buildroot&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;_unitdir&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;rock&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;mon&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;service&lt;/span&gt;

&lt;span class="cp"&gt;# Install init scripts&lt;/span&gt;
&lt;span class="n"&gt;install&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;p&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;D&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;m&lt;/span&gt; &lt;span class="mi"&gt;544&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;SOURCE7&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;buildroot&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;_prefix&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;local&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;bin&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;backup&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sh&lt;/span&gt;
&lt;span class="p"&gt;...&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;%files字段。起初我不是那么明白该字段该如何填写，所以故意编译让其报错，根据提示的错误在这里一一添加的内容，包括需创建的目录。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nf"&gt;%files&lt;/span&gt;
&lt;span class="nf"&gt;%defattr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;_bindir&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;rock&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;engine&lt;/span&gt;
&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;_bindir&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;rock&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;db&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;manage&lt;/span&gt;
&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;_bindir&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;rock&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;mon&lt;/span&gt;
&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;_prefix&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;local&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;bin&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;backup&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sh&lt;/span&gt;
&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;_prefix&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;local&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;bin&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;clear&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sh&lt;/span&gt;
&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;_prefix&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;local&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;bin&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;ha_status&lt;/span&gt;
&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;_prefix&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;local&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;bin&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;is_normal&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sh&lt;/span&gt;
&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;_prefix&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;local&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;bin&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;kill&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sh&lt;/span&gt;
&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;_prefix&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;local&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;bin&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;kill_engine&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sh&lt;/span&gt;
&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;_prefix&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;local&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;bin&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;kill_mon&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sh&lt;/span&gt;
&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;_prefix&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;local&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;bin&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;notify&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sh&lt;/span&gt;
&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;_prefix&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;local&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;bin&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sh&lt;/span&gt;
&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;_prefix&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;local&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;bin&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;tables&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;sh&lt;/span&gt;

&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;python_sitelib&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;-%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;version&lt;/span&gt;&lt;span class="p"&gt;}.&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;egg&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;info&lt;/span&gt;
&lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;python_sitelib&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;rock&lt;/span&gt;

&lt;span class="nf"&gt;%config&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;noreplace&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="nf"&gt;%attr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;_sysconfdir&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;rock&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;rock&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ini&lt;/span&gt;
&lt;span class="nf"&gt;%config&lt;/span&gt; &lt;span class="nf"&gt;%attr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;_sysconfdir&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;rock&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;target&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;json&lt;/span&gt;
&lt;span class="nf"&gt;%config&lt;/span&gt; &lt;span class="nf"&gt;%attr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;_sysconfdir&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;rock&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;alembic&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ini&lt;/span&gt;
&lt;span class="nf"&gt;%config&lt;/span&gt; &lt;span class="nf"&gt;%attr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;_sysconfdir&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;rock&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;cases&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;host_down&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;json&lt;/span&gt;
&lt;span class="nf"&gt;%config&lt;/span&gt; &lt;span class="nf"&gt;%attr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;_unitdir&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;rock&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;engine&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;service&lt;/span&gt;
&lt;span class="nf"&gt;%config&lt;/span&gt; &lt;span class="nf"&gt;%attr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;_unitdir&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;rock&lt;/span&gt;&lt;span class="o"&gt;-&lt;/span&gt;&lt;span class="n"&gt;mon&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;service&lt;/span&gt;

&lt;span class="nf"&gt;%dir&lt;/span&gt; &lt;span class="nf"&gt;%attr&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mo"&gt;0755&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;root&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="n"&gt;_localstatedir&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="o"&gt;/&lt;/span&gt;&lt;span class="n"&gt;rock&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;ol&gt;
&lt;li&gt;%changelog字段，填写变更的日志信息。&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nf"&gt;%changelog&lt;/span&gt;
&lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="n"&gt;Tue&lt;/span&gt; &lt;span class="n"&gt;Sep&lt;/span&gt; &lt;span class="mi"&gt;27&lt;/span&gt; &lt;span class="mi"&gt;2016&lt;/span&gt; &lt;span class="n"&gt;Yuwei&lt;/span&gt; &lt;span class="n"&gt;Wang&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;wangyuwei&lt;/span&gt;&lt;span class="err"&gt;@&lt;/span&gt;&lt;span class="n"&gt;unitedstack&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;com&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="mf"&gt;0.0.1&lt;/span&gt;
&lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="n"&gt;Package&lt;/span&gt; &lt;span class="n"&gt;rock&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;deployment&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;三、编写完rock.spec后，开始打包。rpm命令可以指定不同的参数，分步进行打包，可以检测在打包过程中遇到的具体问题。以下是从spec文档打包时rpmbuild相关的命令。&lt;/p&gt;
&lt;p&gt;命令格式：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;rpmbuild [options] [spec文档]
命令options:

-bp  #只执行spec的%pre 段(解开源码包并打补丁，即只做准备)
-bc  #执行spec的%pre和%build 段(准备并编译)
-bi  #执行spec中%pre，%build与%install(准备，编译并安装)
-bl  #检查spec中的%file段(查看文件是否齐全)
-ba  #建立源码与二进制包(常用)
-bb  #只建立二进制包(常用)
-bs  #只建立源码包
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;若执行&lt;code&gt;rpmbuild -ba test.spec&lt;/code&gt;没有报错，则大体算是打包成功，具体是否可用还需进行检查，遇到问题再修改其中的小细节。打包完后可去rpmbuild/RPMS目录中查看二进制包。&lt;/p&gt;
&lt;h3&gt;四、创建本地仓库&lt;/h3&gt;
&lt;p&gt;这里将rock所依赖的所有rpm包包括rock本身的rpm包放置一块创建一个本地仓库，就可以直接通过yum install rock命令安装rock包括其所有的依赖，这样通过yum安装起来会更加方便。以下简单说明创建本地仓库的步骤。&lt;/p&gt;
&lt;h4&gt;4.1 创建本地yum仓库&lt;/h4&gt;
&lt;p&gt;依赖的相关软件包可通过yum install *** --downloadonly --downloaddir=/yum/local命令下载到/yum/local下而不安装。也可以通过其他方式比如cp。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ mkdir -p /yum/local &lt;span class="c1"&gt;#可以有N级目录  &lt;/span&gt;
$ cp ... &lt;span class="c1"&gt;#复制RPM包到上述目录&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;4.2 创建repo文件&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ cat&amp;gt;&amp;gt;/etc/yum.repos.d/CentOS-Local.repo&lt;span class="s"&gt;&amp;lt;&amp;lt;-EOF  &lt;/span&gt;
&lt;span class="s"&gt;[Local]  &lt;/span&gt;
&lt;span class="s"&gt;name=Local Yum  &lt;/span&gt;
&lt;span class="s"&gt;baseurl=file:///yum/  &lt;/span&gt;
&lt;span class="s"&gt;gpgcheck=1  &lt;/span&gt;
&lt;span class="s"&gt;gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KE&lt;/span&gt;Y-CentOS-7  
&lt;span class="nv"&gt;enabled&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;4.3 安装createrepo&lt;/h4&gt;
&lt;p&gt;以下是两种安装方式。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ yum install createrepo &lt;span class="c1"&gt;#使用yum安装createrepo  &lt;/span&gt;
$ rpm -ivh http://mirror.centos.org/centos/7/os/x86_64/Packages/createrepo-0.9.9-23.el7.noarch.rpm
&lt;/pre&gt;&lt;/div&gt;


&lt;h4&gt;4.4 创建索引&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ createrepo /yum   
$ yum makecache &lt;span class="c1"&gt;#更新缓存&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;</content></entry></feed>