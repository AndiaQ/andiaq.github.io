
<!DOCTYPE html>
<html lang="zh_cn">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet/less" type="text/css" href="https://andiaq.github.io/theme/stylesheet/style.less">
    <script src="//cdnjs.cloudflare.com/ajax/libs/less.js/2.5.1/less.min.js" type="text/javascript"></script>

  <link rel="stylesheet" type="text/css" href="https://andiaq.github.io/theme/pygments/monokai.min.css">
  <link rel="stylesheet" type="text/css" href="https://andiaq.github.io/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://andiaq.github.io/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://andiaq.github.io/theme/font-awesome/css/solid.css">

    <link href="https://andiaq.github.io/static/custom.css" rel="stylesheet">



    <link rel="shortcut icon" href="/images/fav.ico" type="image/x-icon">
    <link rel="icon" href="/images/fav.ico" type="image/x-icon">


    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#333333">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#333333">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Microsoft EDGE -->
    <meta name="msapplication-TileColor" content="#333333">

<meta name="author" content="Yuwei Wang" />
<meta name="description" content="一、简介 NFV，即网络功能虚拟化，Network Function Virtualization。即通过使用 x86 的服务器作为物理设备，进而实现基于软件的网络功能。NFV 的实现有效地降低了网络组网中昂贵的路由器和交换机成本。通过分离硬件和软件的功能和抽象的方式，网络设备功能不再依赖于专用硬件资源，可成为新的云中的网络服务部署模式，虚拟网络元件之间的网络，基于实际业务需求自动部署，提供了灵活扩展性，故障隔离和自我愈合。 NFV 的网络功能虚拟化就是将原本是物理设备的路由器，交换机，测试仪器，变成软件的形式，作为一个镜像启动，而其功能不变。在云计算的基础设施平台上，部署基于 NFV 可编程网元，这些网元不受物理设备兼容性的限制，在云计算的基础上部署虚拟网元，使得云平台的资源利用率更加充分，但同时也对组网技术提出了更高的要求。 本文以 6wind 作为 NFV 虚拟网元设备，将其与基于 linuxbridge 和 vlan 实现的现有网络云平台进行结合，使用 NFV 网元实现云环境中 NAT 和安全组功能 …" />
<meta name="keywords" content="">

<meta property="og:site_name" content="Andia"/>
<meta property="og:title" content="6wind NFV 实现"/>
<meta property="og:description" content="一、简介 NFV，即网络功能虚拟化，Network Function Virtualization。即通过使用 x86 的服务器作为物理设备，进而实现基于软件的网络功能。NFV 的实现有效地降低了网络组网中昂贵的路由器和交换机成本。通过分离硬件和软件的功能和抽象的方式，网络设备功能不再依赖于专用硬件资源，可成为新的云中的网络服务部署模式，虚拟网络元件之间的网络，基于实际业务需求自动部署，提供了灵活扩展性，故障隔离和自我愈合。 NFV 的网络功能虚拟化就是将原本是物理设备的路由器，交换机，测试仪器，变成软件的形式，作为一个镜像启动，而其功能不变。在云计算的基础设施平台上，部署基于 NFV 可编程网元，这些网元不受物理设备兼容性的限制，在云计算的基础上部署虚拟网元，使得云平台的资源利用率更加充分，但同时也对组网技术提出了更高的要求。 本文以 6wind 作为 NFV 虚拟网元设备，将其与基于 linuxbridge 和 vlan 实现的现有网络云平台进行结合，使用 NFV 网元实现云环境中 NAT 和安全组功能 …"/>
<meta property="og:locale" content="zh_CN"/>
<meta property="og:url" content="https://andiaq.github.io/articles/6wind-nfv.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2018-08-06 11:29:00+08:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://andiaq.github.io/author/yuwei-wang.html">
<meta property="article:section" content="network"/>
<meta property="og:image" content="/images/head.jpg">

  <title>Andia &ndash; 6wind NFV 实现</title>

</head>
<body>
  <aside>
    <div>
      <a href="https://andiaq.github.io">
        <img src="/images/head.jpg" alt="" title="">
      </a>
      <h1><a href="https://andiaq.github.io"></a></h1>

<p>拒绝熊猫眼。</p>
      <nav>
        <ul class="list">
          <li><a href="https://andiaq.github.io/pages/about-me.html#about-me">About Me</a></li>

        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-github" href="https://github.com/AndiaQ" target="_blank">
            <i class="fab fa-github">
            </i>
          </a></li>
          <li>
            <a  class="sc-mail" href="yuweifree@gmail.com" target="_blank">
            <i class="fab fa-mail">
            </i>
          </a></li>
      </ul>
    </div>


  </aside>
  <main>

    <nav>
      <a href="https://andiaq.github.io">    Home
</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>


    </nav>

<article class="single">
  <header>
      
    <h1 id="6wind-nfv">6wind NFV 实现</h1>
    <p>
          Posted on 2018-08-06(星期一) 11:29 in <a href="https://andiaq.github.io/category/network.html">network</a>


    </p>
  </header>


  <div>
    <h3>一、简介</h3>
<p>NFV，即网络功能虚拟化，Network Function Virtualization。即通过使用 x86 的服务器作为物理设备，进而实现基于软件的网络功能。NFV 的实现有效地降低了网络组网中昂贵的路由器和交换机成本。通过分离硬件和软件的功能和抽象的方式，网络设备功能不再依赖于专用硬件资源，可成为新的云中的网络服务部署模式，虚拟网络元件之间的网络，基于实际业务需求自动部署，提供了灵活扩展性，故障隔离和自我愈合。</p>
<p>NFV 的网络功能虚拟化就是将原本是物理设备的路由器，交换机，测试仪器，变成软件的形式，作为一个镜像启动，而其功能不变。在云计算的基础设施平台上，部署基于 NFV 可编程网元，这些网元不受物理设备兼容性的限制，在云计算的基础上部署虚拟网元，使得云平台的资源利用率更加充分，但同时也对组网技术提出了更高的要求。</p>
<p>本文以 6wind 作为 NFV 虚拟网元设备，将其与基于 linuxbridge 和 vlan 实现的现有网络云平台进行结合，使用 NFV 网元实现云环境中 NAT 和安全组功能。以及进行网络性能测试。</p>
<h3>二、NFV 连接不同网络之间通信</h3>
<p>在我们现有网络环境中，不同网络之间通过 vlan 进行隔离，是无法互通的。我们知道在传统网络中，如果要和一个网络通信，只要和其网关相通就可以了。假设现在有两个不同 vlan 的网络 private1 和 private2，若要使两个网络中的虚拟主机进行通信，我们使 NFV 网元作为 Instance 启动，将 NFV 虚拟路由器连接这两个子网，并将分配给它的两个网络接口的 IP 地址配置成两个网络的网关，从而使流量通过 NFV 虚拟网元，实现子网之间的流量通过这个 NFV 虚拟路由器进行转发。</p>
<p><img alt="image" src="../images/network/6wind-nfv-1.png"></p>
<p>下面在测试环境进行配置，以实际例子进行说明。首先配置以下三个网络，一个作为外网，两个作为内网。</p>
<p>外网：</p>
<div class="highlight"><pre><span></span><span class="n">vlan</span><span class="o">:</span><span class="mi">3967</span>
<span class="kd">public</span><span class="err">：</span><span class="mf">172.32</span><span class="o">.</span><span class="mf">0.0</span><span class="o">/</span><span class="mi">24</span>
</pre></div>


<p>内网：</p>
<div class="highlight"><pre><span></span><span class="n">vlan</span><span class="o">:</span><span class="mi">3965</span>
<span class="n">private1</span><span class="err">：</span><span class="mf">12.12</span><span class="o">.</span><span class="mf">12.0</span><span class="o">/</span><span class="mi">24</span>
<span class="n">vlan</span><span class="o">:</span><span class="mi">3966</span>
<span class="n">private2</span><span class="err">：</span><span class="mf">172.16</span><span class="o">.</span><span class="mf">10.0</span><span class="o">/</span><span class="mi">24</span>
</pre></div>


<h4>2.1 配置不同子网互通</h4>
<ol>
<li>使用 6wind 作为镜像创建虚拟机，添加 public, private1, private2 子网，通过 vnc 进入虚拟机，进行 ip 地址，dhcp 服务配置，具体配置在后面介绍。ip 地址配置如下：</li>
</ol>
<div class="highlight"><pre><span></span><span class="mi">6</span><span class="n">wind</span><span class="o">:</span>
    <span class="n">ens3</span><span class="o">:</span> <span class="mf">172.32</span><span class="o">.</span><span class="mf">0.5</span>
    <span class="n">ens4</span><span class="o">:</span> <span class="mf">12.12</span><span class="o">.</span><span class="mf">12.1</span>
    <span class="n">ens5</span><span class="o">:</span> <span class="mf">172.16</span><span class="o">.</span><span class="mf">10.1</span>
    <span class="n">gateway</span><span class="o">:</span> <span class="mf">172.32</span><span class="o">.</span><span class="mf">0.1</span>
</pre></div>


<p>这里为方便从外部访问 vrouter，在宿主机 br-3967 网桥上配置了 ip 地址 172.32.0.1，实现从外部宿主机访问虚拟机。</p>
<ol>
<li>创建 vm1，添加 private1 子网。创建 vm2，添加 private2 子网。并将两个虚拟机分别创建到不同宿主机上。虚拟机创建成功之后，通过 vnc 进入虚拟机，修改网卡配置文件通过 DHCP 获取 ip 地址。重启 network 服务，查看当前网络信息。</li>
</ol>
<div class="highlight"><pre><span></span><span class="n">vm1</span><span class="o">:</span> 
    <span class="n">eth0</span><span class="o">:</span> <span class="mf">12.12</span><span class="o">.</span><span class="mf">12.120</span>
    <span class="n">gateway</span><span class="o">:</span> <span class="mf">12.12</span><span class="o">.</span><span class="mf">12.1</span>

<span class="n">vm2</span><span class="o">:</span>
    <span class="n">eth0</span><span class="o">:</span><span class="mf">172.16</span><span class="o">.</span><span class="mf">10.100</span>
    <span class="n">gateway</span><span class="o">:</span> <span class="mf">172.16</span><span class="o">.</span><span class="mf">10.1</span>
</pre></div>


<p>到这里为止，在 6wind 没有开启 nat 且禁用 filter 功能情况下，从 vm1 ping vm2，从vm2 ping vm1, 都能够 ping 通，结果符合预期。下面开启 filter 功能，配置 filter 规则满足以上需求。</p>
<ol>
<li>整体网络流量走向图如下所示：</li>
</ol>
<p><img alt="image" src="../images/network/6wind-nfv-1.png"></p>
<h4>2.2 开启 filter 功能</h4>
<ol>
<li>打开 vrouter filter 功能，不配置任何规则，则从任何地方都无法访问路由器中所有的 ip 地址，故而虚拟机无法 ping 通自己的网关地址， 虚拟机之间也不能互通。验证结果如下，符合预期。</li>
</ol>
<div class="highlight"><pre><span></span><span class="cp"># 无法从宿主机ping及ssh访问vrouter</span>
<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">POD23</span><span class="o">-</span><span class="n">CLU01</span><span class="o">-</span><span class="n">H028</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">ping</span> <span class="mf">172.32.0.5</span>
<span class="n">PING</span> <span class="mf">172.32.0.5</span> <span class="p">(</span><span class="mf">172.32.0.5</span><span class="p">)</span> <span class="mi">56</span><span class="p">(</span><span class="mi">84</span><span class="p">)</span> <span class="n">bytes</span> <span class="n">of</span> <span class="n">data</span><span class="p">.</span>
<span class="o">^</span><span class="n">C</span>
<span class="o">---</span> <span class="mf">172.32.0.5</span> <span class="n">ping</span> <span class="n">statistics</span> <span class="o">---</span>
<span class="mi">3</span> <span class="n">packets</span> <span class="n">transmitted</span><span class="p">,</span> <span class="mi">0</span> <span class="n">received</span><span class="p">,</span> <span class="mi">100</span><span class="o">%</span> <span class="n">packet</span> <span class="n">loss</span><span class="p">,</span> <span class="n">time</span> <span class="mi">1999</span><span class="n">ms</span>

<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">POD23</span><span class="o">-</span><span class="n">CLU01</span><span class="o">-</span><span class="n">H028</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">ssh</span> <span class="n">admin</span><span class="mf">@172.32.0.5</span>
<span class="o">^</span><span class="n">C</span>

<span class="cp"># 无法从 vm1 ping 通其默认网关 12.12.12.1,无法 ping 通 vm2</span>
</pre></div>


<ol>
<li>配置允许外部流量 ping 及 ssh 访问 vrouter 网关地址。使用此功能实现云环境安全组，不应开放 vrouter ssh 功能。这里配置是为了实验操作方便。</li>
</ol>
<div class="highlight"><pre><span></span><span class="cp"># FILTER RULES</span>
<span class="n">rule</span> <span class="mi">20000</span> <span class="n">processing</span> <span class="n">input</span> <span class="n">ipv4</span> <span class="n">protocol</span> <span class="n">tcp</span> <span class="n">from</span> <span class="n">any</span> <span class="n">to</span> <span class="mf">172.32.0.5</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="n">state</span> <span class="n">new</span> <span class="n">established</span> <span class="k">do</span> <span class="n">allow</span>
<span class="n">rule</span> <span class="mi">20010</span> <span class="n">processing</span> <span class="n">output</span> <span class="n">ipv4</span> <span class="n">protocol</span> <span class="n">tcp</span> <span class="n">from</span> <span class="mf">172.32.0.5</span><span class="p">[</span><span class="mi">22</span><span class="p">]</span> <span class="n">to</span> <span class="n">any</span> <span class="n">state</span> <span class="n">new</span> <span class="n">established</span> <span class="k">do</span> <span class="n">allow</span>
<span class="n">rule</span> <span class="mi">20020</span> <span class="n">ipv4</span> <span class="n">protocol</span> <span class="n">icmp</span> <span class="n">echo</span><span class="o">-</span><span class="n">request</span> <span class="n">from</span> <span class="n">any</span> <span class="n">to</span> <span class="mf">172.32.0.5</span> <span class="k">do</span> <span class="n">allow</span>
<span class="n">rule</span> <span class="mi">20030</span> <span class="n">ipv4</span> <span class="n">protocol</span> <span class="n">icmp</span> <span class="n">echo</span><span class="o">-</span><span class="n">reply</span> <span class="n">from</span> <span class="mf">172.32.0.5</span> <span class="n">to</span> <span class="n">any</span> <span class="k">do</span> <span class="n">allow</span>

<span class="cp"># 验证如下</span>
<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">POD23</span><span class="o">-</span><span class="n">CLU01</span><span class="o">-</span><span class="n">H028</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">ping</span> <span class="o">-</span><span class="n">c</span> <span class="mi">2</span> <span class="mf">172.32.0.5</span>
<span class="n">PING</span> <span class="mf">172.32.0.5</span> <span class="p">(</span><span class="mf">172.32.0.5</span><span class="p">)</span> <span class="mi">56</span><span class="p">(</span><span class="mi">84</span><span class="p">)</span> <span class="n">bytes</span> <span class="n">of</span> <span class="n">data</span><span class="p">.</span>
<span class="mi">64</span> <span class="n">bytes</span> <span class="n">from</span> <span class="mf">172.32.0.5</span><span class="o">:</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">1</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">64</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.164</span> <span class="n">ms</span>
<span class="mi">64</span> <span class="n">bytes</span> <span class="n">from</span> <span class="mf">172.32.0.5</span><span class="o">:</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">2</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">64</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.162</span> <span class="n">ms</span>

<span class="o">---</span> <span class="mf">172.32.0.5</span> <span class="n">ping</span> <span class="n">statistics</span> <span class="o">---</span>
<span class="mi">2</span> <span class="n">packets</span> <span class="n">transmitted</span><span class="p">,</span> <span class="mi">2</span> <span class="n">received</span><span class="p">,</span> <span class="mi">0</span><span class="o">%</span> <span class="n">packet</span> <span class="n">loss</span><span class="p">,</span> <span class="n">time</span> <span class="mi">999</span><span class="n">ms</span>
<span class="n">rtt</span> <span class="n">min</span><span class="o">/</span><span class="n">avg</span><span class="o">/</span><span class="n">max</span><span class="o">/</span><span class="n">mdev</span> <span class="o">=</span> <span class="mf">0.162</span><span class="o">/</span><span class="mf">0.163</span><span class="o">/</span><span class="mf">0.164</span><span class="o">/</span><span class="mf">0.001</span> <span class="n">ms</span>
<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">POD23</span><span class="o">-</span><span class="n">CLU01</span><span class="o">-</span><span class="n">H028</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">ssh</span> <span class="n">admin</span><span class="mf">@172.32.0.5</span>
<span class="n">admin</span><span class="mf">@172.32.0.5</span><span class="err">&#39;</span><span class="n">s</span> <span class="nl">password</span><span class="p">:</span> 
<span class="n">Welcome</span> <span class="n">to</span> <span class="n">Turbo</span> <span class="n">Router</span> <span class="n">Embedded</span> <span class="n">Edition</span> <span class="p">(</span><span class="n">EE</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.6.4</span>

<span class="n">Last</span> <span class="nl">login</span><span class="p">:</span> <span class="n">Sun</span> <span class="n">Aug</span>  <span class="mi">5</span> <span class="mi">10</span><span class="o">:</span><span class="mo">05</span><span class="o">:</span><span class="mi">51</span> <span class="mi">2018</span> <span class="n">from</span> <span class="mf">172.32.0.1</span>
<span class="n">router</span><span class="p">{}</span>
</pre></div>


<ol>
<li>配置 filter 规则，允许外部访问 subnet1: 12.12.12.0/24，subnet2: 172.16.10.0/24，为 vm 开启 allow ping &amp; ssh 规则。</li>
</ol>
<div class="highlight"><pre><span></span><span class="c1"># 开启 ping</span>
rule <span class="m">20080</span> ipv4 protocol icmp echo-request from any to <span class="m">12</span>.12.12.0/24 <span class="k">do</span> allow
rule <span class="m">20090</span> ipv4 protocol icmp echo-reply from <span class="m">12</span>.12.12.0/24 to any <span class="k">do</span> allow
rule <span class="m">20100</span> ipv4 protocol icmp echo-request from any to <span class="m">172</span>.16.10.0/24 <span class="k">do</span> allow
rule <span class="m">20110</span> ipv4 protocol icmp echo-reply from <span class="m">172</span>.16.10.0/24 to any <span class="k">do</span> allow

<span class="c1"># 开启 ssh </span>
rule <span class="m">20120</span> processing forward ipv4 protocol tcp from any to <span class="m">12</span>.12.12.120<span class="o">[</span><span class="m">22</span><span class="o">]</span> <span class="k">do</span> allow
rule <span class="m">20130</span> processing forward ipv4 protocol tcp from <span class="m">12</span>.12.12.120<span class="o">[</span><span class="m">22</span><span class="o">]</span> to any <span class="k">do</span> allow
rule <span class="m">20140</span> processing forward ipv4 protocol tcp from any to <span class="m">172</span>.16.10.100<span class="o">[</span><span class="m">22</span><span class="o">]</span> <span class="k">do</span> allow
rule <span class="m">20150</span> processing forward ipv4 protocol tcp from <span class="m">172</span>.16.10.100<span class="o">[</span><span class="m">22</span><span class="o">]</span> to any <span class="k">do</span> allow
</pre></div>


<ol>
<li>配置 filter 规则，开启子网段路由转发功能。</li>
</ol>
<div class="highlight"><pre><span></span><span class="c1"># 开放subnet1：12.12.12.0/24 子网段路由转发功能</span>
rule <span class="m">20180</span> processing forward ipv4 from any to <span class="m">12</span>.12.12.0/24 <span class="k">do</span> allow
rule <span class="m">20190</span> processing forward ipv4 from <span class="m">12</span>.12.12.0/24 to any <span class="k">do</span> allow
rule <span class="m">20200</span> processing output ipv4 from <span class="m">12</span>.12.12.0/24 to any <span class="k">do</span> allow
rule <span class="m">20210</span> processing input ipv4 from any to <span class="m">12</span>.12.12.0/24 <span class="k">do</span> allow
</pre></div>


<h3>三、配置内外网互相访问</h3>
<h4>2.3 开启 NAT 功能</h4>
<p>在云网络环境，使用 NAT 功能实现内网访问外网，使内部网络中所有主机均可共享一个合法公网 ip 地址，大大减少公网 ip 的浪费。NAT 分为静态 NAT、动态 NAT 以及网络地址端口转换 NAPT。配置静态 NAT 将私网转换为公网地址，进行一对一映射，实现外网访问内网中某一特定服务，目的地址是固定不变的。配置动态 NAT ，将私网 ip 地址转换为公网 ip 地址，但公网 IP 地址是不确定的，而是随机的，即目的 IP 地址可以配置多个，ip 地址是动态变化的。网络地址端口转换 NAPT 分为 SNAT 源地址转换以及 DNAT 目的地址转换。</p>
<h5>2.3.1 绑定 floating ip 到路由器</h5>
<ol>
<li>开启外网地址 NAT 功能，使内网能够访问外网。该功能的实现还需要 filter 开启指定子网段的路由转发功能才能起作用。</li>
</ol>
<div class="highlight"><pre><span></span># 配置filter规则
# 开放subnet1：12.12.12.0/24 子网段路由转发功能
rule 20180 processing forward ipv4 from any to 12.12.12.0/24 do allow
rule 20190 processing forward ipv4 from 12.12.12.0/24 to any do allow
rule 20200 processing output ipv4 from 12.12.12.0/24 to any do allow
rule 20210 processing input ipv4 from any to 12.12.12.0/24 do allow

# 开启nat功能
router{conf:init_turo-nat}public interface ens3
router{conf:init_turo-nat-ens3}nat enable
router{conf:init_turo-nat-ens3}save
router{}apply init_turo
</pre></div>


<p>验证内网访问外网，如下：</p>
<div class="highlight"><pre><span></span>[root@vm1 ~]# ping -c 2 baidu.com
PING baidu.com (220.181.57.216) 56(84) bytes of data.
64 bytes from 220.181.57.216: icmp_seq=1 ttl=55 time=1.94 ms
64 bytes from 220.181.57.216: icmp_seq=2 ttl=55 time=1.99 ms

--- baidu.com ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1001ms
rtt min/avg/max/mdev = 1.949/1.970/1.992/0.049 ms
</pre></div>


<ol>
<li>配置静态 NAT 规则， 将私网地址转换为公网地址，通过一对一映射，实现外网访问内网中某一特定服务。</li>
</ol>
<div class="highlight"><pre><span></span># STATIC MAPPINGS
static 100 protocol tcp public 172.32.0.5:2222 private 12.12.12.120:22
</pre></div>


<p>验证静态 NAT ssh 端口转发功能，实现外网访问内网，如下：</p>
<div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">POD23</span><span class="o">-</span><span class="n">CLU01</span><span class="o">-</span><span class="n">H028</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">ssh</span> <span class="o">-</span><span class="n">p</span> <span class="mi">2222</span> <span class="n">root</span><span class="mf">@172.32.0.5</span>
<span class="n">The</span> <span class="n">authenticity</span> <span class="n">of</span> <span class="n">host</span> <span class="err">&#39;</span><span class="p">[</span><span class="mf">172.32.0.5</span><span class="p">]</span><span class="o">:</span><span class="mi">2222</span> <span class="p">([</span><span class="mf">172.32.0.5</span><span class="p">]</span><span class="o">:</span><span class="mi">2222</span><span class="p">)</span><span class="err">&#39;</span> <span class="n">can</span><span class="err">&#39;</span><span class="n">t</span> <span class="n">be</span> <span class="n">established</span><span class="p">.</span>
<span class="n">ECDSA</span> <span class="n">key</span> <span class="n">fingerprint</span> <span class="n">is</span> <span class="nl">b0</span><span class="p">:</span><span class="mi">4</span><span class="nl">b</span><span class="p">:</span><span class="mi">6</span><span class="nl">c</span><span class="p">:</span><span class="mi">4</span><span class="nl">a</span><span class="p">:</span><span class="nl">a4</span><span class="p">:</span><span class="mi">92</span><span class="o">:</span><span class="mi">9</span><span class="nl">c</span><span class="p">:</span><span class="nl">a8</span><span class="p">:</span><span class="mi">65</span><span class="o">:</span><span class="mi">31</span><span class="o">:</span><span class="mi">76</span><span class="o">:</span><span class="mf">6f</span><span class="o">:</span><span class="nl">b5</span><span class="p">:</span><span class="mi">61</span><span class="o">:</span><span class="nl">d3</span><span class="p">:</span><span class="mi">5</span><span class="n">e</span><span class="p">.</span>
<span class="n">Are</span> <span class="n">you</span> <span class="n">sure</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="k">continue</span> <span class="n">connecting</span> <span class="p">(</span><span class="n">yes</span><span class="o">/</span><span class="n">no</span><span class="p">)</span><span class="o">?</span> <span class="n">yes</span>
<span class="nl">Warning</span><span class="p">:</span> <span class="n">Permanently</span> <span class="n">added</span> <span class="err">&#39;</span><span class="p">[</span><span class="mf">172.32.0.5</span><span class="p">]</span><span class="o">:</span><span class="mi">2222</span><span class="err">&#39;</span> <span class="p">(</span><span class="n">ECDSA</span><span class="p">)</span> <span class="n">to</span> <span class="n">the</span> <span class="n">list</span> <span class="n">of</span> <span class="n">known</span> <span class="n">hosts</span><span class="p">.</span>
<span class="n">root</span><span class="mf">@172.32.0.5</span><span class="err">&#39;</span><span class="n">s</span> <span class="nl">password</span><span class="p">:</span> 
<span class="n">Last</span> <span class="nl">login</span><span class="p">:</span> <span class="n">Sat</span> <span class="n">Aug</span>  <span class="mi">4</span> <span class="mi">21</span><span class="o">:</span><span class="mi">46</span><span class="o">:</span><span class="mo">02</span> <span class="mi">2018</span>
<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">client1</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">ip</span> <span class="n">a</span>
<span class="mi">1</span><span class="o">:</span> <span class="nl">lo</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">LOOPBACK</span><span class="p">,</span><span class="n">UP</span><span class="p">,</span><span class="n">LOWER_UP</span><span class="o">&gt;</span> <span class="n">mtu</span> <span class="mi">65536</span> <span class="n">qdisc</span> <span class="n">noqueue</span> <span class="n">state</span> <span class="n">UNKNOWN</span> 
    <span class="n">link</span><span class="o">/</span><span class="n">loopback</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span> <span class="n">brd</span> <span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span><span class="o">:</span><span class="mo">00</span>
    <span class="n">inet</span> <span class="mf">127.0.0.1</span><span class="o">/</span><span class="mi">8</span> <span class="n">scope</span> <span class="n">host</span> <span class="n">lo</span>
       <span class="n">valid_lft</span> <span class="n">forever</span> <span class="n">preferred_lft</span> <span class="n">forever</span>
    <span class="n">inet6</span> <span class="o">::</span><span class="mi">1</span><span class="o">/</span><span class="mi">128</span> <span class="n">scope</span> <span class="n">host</span> 
       <span class="n">valid_lft</span> <span class="n">forever</span> <span class="n">preferred_lft</span> <span class="n">forever</span>
<span class="mi">2</span><span class="o">:</span> <span class="nl">eth0</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">BROADCAST</span><span class="p">,</span><span class="n">MULTICAST</span><span class="p">,</span><span class="n">UP</span><span class="p">,</span><span class="n">LOWER_UP</span><span class="o">&gt;</span> <span class="n">mtu</span> <span class="mi">1500</span> <span class="n">qdisc</span> <span class="n">pfifo_fast</span> <span class="n">state</span> <span class="n">UP</span> <span class="n">qlen</span> <span class="mi">1000</span>
    <span class="n">link</span><span class="o">/</span><span class="n">ether</span> <span class="mo">00</span><span class="o">:</span><span class="mi">12</span><span class="o">:</span><span class="mi">25</span><span class="o">:</span><span class="mi">66</span><span class="o">:</span><span class="nl">d7</span><span class="p">:</span><span class="mi">77</span> <span class="n">brd</span> <span class="nl">ff</span><span class="p">:</span><span class="nl">ff</span><span class="p">:</span><span class="nl">ff</span><span class="p">:</span><span class="nl">ff</span><span class="p">:</span><span class="nl">ff</span><span class="p">:</span><span class="n">ff</span>
    <span class="n">inet</span> <span class="mf">12.12.12.120</span><span class="o">/</span><span class="mi">24</span> <span class="n">brd</span> <span class="mf">12.12.12.255</span> <span class="n">scope</span> <span class="n">global</span> <span class="n">dynamic</span> <span class="n">eth0</span>
       <span class="n">valid_lft</span> <span class="mi">3170</span><span class="n">sec</span> <span class="n">preferred_lft</span> <span class="mi">3170</span><span class="n">sec</span>
    <span class="n">inet6</span> <span class="n">fe80</span><span class="o">::</span><span class="mi">212</span><span class="o">:</span><span class="mf">25ff</span><span class="o">:</span><span class="nl">fe66</span><span class="p">:</span><span class="n">d777</span><span class="o">/</span><span class="mi">64</span> <span class="n">scope</span> <span class="n">link</span> 
       <span class="n">valid_lft</span> <span class="n">forever</span> <span class="n">preferred_lft</span> <span class="n">forever</span>
</pre></div>


<h5>2.3.2 绑定 floating ip 到虚拟机</h5>
<p>为虚拟机添加 floating ip，配置 ip 地址为 172.32.0.3，网关地址为 172.32.0.1。可从外网宿主机通过 ssh 访问该机器，该机器也能访问外网，如下：</p>
<div class="highlight"><pre><span></span><span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">POD23</span><span class="o">-</span><span class="n">CLU01</span><span class="o">-</span><span class="n">H028</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">ssh</span> <span class="n">root</span><span class="mf">@172.32.0.3</span>
<span class="n">root</span><span class="mf">@172.32.0.3</span><span class="err">&#39;</span><span class="n">s</span> <span class="nl">password</span><span class="p">:</span> 
<span class="n">Last</span> <span class="nl">login</span><span class="p">:</span> <span class="n">Mon</span> <span class="n">Aug</span>  <span class="mi">6</span> <span class="mi">10</span><span class="o">:</span><span class="mi">57</span><span class="o">:</span><span class="mi">27</span> <span class="mi">2018</span> <span class="n">from</span> <span class="mf">172.32.0.1</span>
<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">vm1</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">ip</span> <span class="n">route</span>
<span class="k">default</span> <span class="n">via</span> <span class="mf">172.32.0.1</span> <span class="n">dev</span> <span class="n">eth1</span> 
<span class="mf">12.12.12.0</span><span class="o">/</span><span class="mi">24</span> <span class="n">dev</span> <span class="n">eth0</span>  <span class="n">proto</span> <span class="n">kernel</span>  <span class="n">scope</span> <span class="n">link</span>  <span class="n">src</span> <span class="mf">12.12.12.120</span> 
<span class="mf">169.254.0.0</span><span class="o">/</span><span class="mi">16</span> <span class="n">dev</span> <span class="n">eth0</span>  <span class="n">scope</span> <span class="n">link</span>  <span class="n">metric</span> <span class="mi">1002</span> 
<span class="mf">169.254.0.0</span><span class="o">/</span><span class="mi">16</span> <span class="n">dev</span> <span class="n">eth1</span>  <span class="n">scope</span> <span class="n">link</span>  <span class="n">metric</span> <span class="mi">1003</span> 
<span class="mf">172.32.0.0</span><span class="o">/</span><span class="mi">24</span> <span class="n">dev</span> <span class="n">eth1</span>  <span class="n">proto</span> <span class="n">kernel</span>  <span class="n">scope</span> <span class="n">link</span>  <span class="n">src</span> <span class="mf">172.32.0.3</span> 
<span class="p">[</span><span class="n">root</span><span class="p">@</span><span class="n">vm1</span> <span class="o">~</span><span class="p">]</span><span class="err">#</span> <span class="n">ping</span> <span class="o">-</span><span class="n">c</span> <span class="mi">2</span> <span class="n">baidu</span><span class="p">.</span><span class="n">com</span>
<span class="n">PING</span> <span class="n">baidu</span><span class="p">.</span><span class="n">com</span> <span class="p">(</span><span class="mf">220.181.57.216</span><span class="p">)</span> <span class="mi">56</span><span class="p">(</span><span class="mi">84</span><span class="p">)</span> <span class="n">bytes</span> <span class="n">of</span> <span class="n">data</span><span class="p">.</span>
<span class="mi">64</span> <span class="n">bytes</span> <span class="n">from</span> <span class="mf">220.181.57.216</span><span class="o">:</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">1</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">56</span> <span class="n">time</span><span class="o">=</span><span class="mf">1.46</span> <span class="n">ms</span>
<span class="mi">64</span> <span class="n">bytes</span> <span class="n">from</span> <span class="mf">220.181.57.216</span><span class="o">:</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">2</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">56</span> <span class="n">time</span><span class="o">=</span><span class="mf">1.66</span> <span class="n">ms</span>

<span class="o">---</span> <span class="n">baidu</span><span class="p">.</span><span class="n">com</span> <span class="n">ping</span> <span class="n">statistics</span> <span class="o">---</span>
<span class="mi">2</span> <span class="n">packets</span> <span class="n">transmitted</span><span class="p">,</span> <span class="mi">2</span> <span class="n">received</span><span class="p">,</span> <span class="mi">0</span><span class="o">%</span> <span class="n">packet</span> <span class="n">loss</span><span class="p">,</span> <span class="n">time</span> <span class="mi">1001</span><span class="n">ms</span>
<span class="n">rtt</span> <span class="n">min</span><span class="o">/</span><span class="n">avg</span><span class="o">/</span><span class="n">max</span><span class="o">/</span><span class="n">mdev</span> <span class="o">=</span> <span class="mf">1.466</span><span class="o">/</span><span class="mf">1.566</span><span class="o">/</span><span class="mf">1.666</span><span class="o">/</span><span class="mf">0.100</span> <span class="n">ms</span>
</pre></div>


<p>这里可能会出现如下问题：</p>
<ol>
<li>公网 ip 地址的网关与通过 dhcp 功能分配的子网默认网关配置冲突，网关地址出现抢占。</li>
</ol>
<h3>四、路由器配置</h3>
<h4>4.1 配置 DHCP</h4>
<ol>
<li>创建 6wind 虚拟机，加入 public, private1 和 private2 子网，启动虚拟机，可以看到三个网卡。创建 vm1, 加入 private1 子网。创建 vm2, 加入 private2 子网。</li>
<li>配置 dhcp 功能，以配置 private2 子网段为例。其中租约时间单位为秒。</li>
</ol>
<div class="highlight"><pre><span></span>router<span class="o">{</span>conf:init_turo-dhcpv4server<span class="o">}</span>dhcpv4server <span class="nb">enable</span>                      <span class="c1"># 开启dhcp功能</span>
router<span class="o">{</span>conf:init_turo-dhcpv4server<span class="o">}</span>subnet <span class="m">172</span>.16.10.0/24                    <span class="c1"># 添加子网段</span>
router<span class="o">{</span>conf:init_turo-dhcpv4server-172.16.10.0/24<span class="o">}</span>minlease <span class="m">600</span>              <span class="c1"># 设置最小租约</span>
router<span class="o">{</span>conf:init_turo-dhcpv4server-172.16.10.0/24<span class="o">}</span>maxlease <span class="m">99000</span>            <span class="c1"># 设置最大租约</span>
router<span class="o">{</span>conf:init_turo-dhcpv4server-172.16.10.0/24<span class="o">}</span>defaultlease <span class="m">3600</span>         <span class="c1"># 设置默认租约</span>
router<span class="o">{</span>conf:init_turo-dhcpv4server-172.16.10.0/24<span class="o">}</span>domainname auto
router<span class="o">{</span>conf:init_turo-dhcpv4server-172.16.10.0/24<span class="o">}</span>default-ipv4 <span class="m">172</span>.16.10.1              <span class="c1"># 配置子网默认网关，推送给在此网段的虚拟机</span>
router<span class="o">{</span>conf:init_turo-dhcpv4server-172.16.10.0/24<span class="o">}</span>range <span class="m">172</span>.16.10.100 <span class="m">172</span>.16.10.200     <span class="c1"># 配置子网段范围</span>
router<span class="o">{</span>conf:init_turo-dhcpv4server-172.16.10.0/24<span class="o">}</span>nameserver <span class="m">114</span>.114.114.114 primary    <span class="c1"># 配置dns</span>
router<span class="o">{</span>conf:init_turo-dhcpv4server-172.16.10.0/24<span class="o">}</span>nameserver <span class="m">8</span>.8.8.8 secondary
router<span class="o">{</span>conf:init_turo-dhcpv4server-172.16.10.0/24<span class="o">}</span>display 
    <span class="c1"># SUBNET</span>
      subnet <span class="m">172</span>.16.10.0/24
          minlease <span class="m">600</span>
          maxlease <span class="m">99000</span>
          defaultlease <span class="m">3600</span>
          default-ipv4 <span class="m">172</span>.16.10.1
        <span class="c1"># RANGES</span>
          range <span class="m">172</span>.16.10.100 <span class="m">172</span>.16.10.200
        <span class="c1"># EXCLUDES</span>
        <span class="c1"># HOSTS</span>
        <span class="c1"># NAMESERVERS</span>
          nameserver <span class="m">114</span>.114.114.114 primary
          nameserver <span class="m">8</span>.8.8.8 secondary
        <span class="c1"># NTP SERVERS</span>
        <span class="c1"># NETBIOS NAME SERVERS</span>
</pre></div>


<p>再以同样的方式配置 private1，在添加完以上两个私网后，查看 dhcp 的所有配置。</p>
<div class="highlight"><pre><span></span>router<span class="o">{</span>conf:init_turo-dhcpv4server<span class="o">}</span>display
    <span class="c1"># DHCPSERVER STATEMENTS</span>
      dhcpv4server <span class="nb">enable</span>
    <span class="c1"># SUBNET</span>
      subnet <span class="m">12</span>.12.12.0/24
          minlease <span class="m">600</span>
          maxlease <span class="m">99000</span>
          defaultlease <span class="m">3600</span>
          domainname auto
          default-ipv4 <span class="m">12</span>.12.12.1
        <span class="c1"># RANGES</span>
          range <span class="m">12</span>.12.12.100 <span class="m">12</span>.12.12.200
        <span class="c1"># EXCLUDES</span>
        <span class="c1"># HOSTS</span>
          host client1 <span class="m">00</span>:12:25:66:d7:77 <span class="m">12</span>.12.12.120       <span class="c1"># 将vm1网卡mac地址与指定ip进行绑定</span>
        <span class="c1"># NAMESERVERS</span>
          nameserver <span class="m">114</span>.114.114.114 primary
          nameserver <span class="m">114</span>.114.115.115 secondary
        <span class="c1"># NTP SERVERS</span>
        <span class="c1"># NETBIOS NAME SERVERS</span>

      subnet <span class="m">172</span>.16.10.0/24
          minlease <span class="m">600</span>
          maxlease <span class="m">99000</span>
          defaultlease <span class="m">3600</span>
          default-ipv4 <span class="m">172</span>.16.10.1
        <span class="c1"># RANGES</span>
          range <span class="m">172</span>.16.10.100 <span class="m">172</span>.16.10.200
        <span class="c1"># EXCLUDES</span>
        <span class="c1"># HOSTS</span>
        <span class="c1"># NAMESERVERS</span>
          nameserver <span class="m">114</span>.114.114.114 primary
          nameserver <span class="m">8</span>.8.8.8 secondary
        <span class="c1"># NTP SERVERS</span>
        <span class="c1"># NETBIOS NAME SERVERS</span>
</pre></div>


<ol>
<li>通过 vnc 进入 vm1 虚拟机，修改网卡配置文件通过 DHCP 获取 ip 地址。重启 network 服务，查看当前网络信息。可以看到在 DHCP 子网段中配置的 DNS、默认网关以及绑定的 ip 地址都已经被分配到 ip 地址上。</li>
</ol>
<div class="highlight"><pre><span></span><span class="o">[</span>root@vm1 ~<span class="o">]</span><span class="c1"># cat /etc/resolv.conf       </span>
<span class="p">;</span> generated by /usr/sbin/dhclient-script
search centos
nameserver <span class="m">114</span>.114.114.114
nameserver <span class="m">114</span>.114.115.115
<span class="o">[</span>root@vm1 ~<span class="o">]</span><span class="c1"># ip route</span>
default via <span class="m">12</span>.12.12.1 dev eth0 
<span class="m">12</span>.12.12.0/24 dev eth0  proto kernel  scope link  src <span class="m">12</span>.12.12.120 
<span class="m">169</span>.254.0.0/16 dev eth0  scope link  metric <span class="m">1002</span> 
<span class="o">[</span>root@vm1 ~<span class="o">]</span><span class="c1"># cat /etc/resolv.conf </span>
<span class="p">;</span> generated by /usr/sbin/dhclient-script
search centos
nameserver <span class="m">114</span>.114.114.114
nameserver <span class="m">114</span>.114.115.115
<span class="o">[</span>root@client1 ~<span class="o">]</span><span class="c1"># ping -c 4 baidu.com</span>
PING baidu.com <span class="o">(</span><span class="m">220</span>.181.57.216<span class="o">)</span> <span class="m">56</span><span class="o">(</span><span class="m">84</span><span class="o">)</span> bytes of data.
<span class="m">64</span> bytes from <span class="m">220</span>.181.57.216: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">55</span> <span class="nv">time</span><span class="o">=</span><span class="m">2</span>.12 ms
<span class="m">64</span> bytes from <span class="m">220</span>.181.57.216: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">2</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">55</span> <span class="nv">time</span><span class="o">=</span><span class="m">2</span>.12 ms
<span class="m">64</span> bytes from <span class="m">220</span>.181.57.216: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">3</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">55</span> <span class="nv">time</span><span class="o">=</span><span class="m">1</span>.98 ms
<span class="m">64</span> bytes from <span class="m">220</span>.181.57.216: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">4</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">55</span> <span class="nv">time</span><span class="o">=</span><span class="m">2</span>.63 ms

--- baidu.com ping statistics ---
<span class="m">4</span> packets transmitted, <span class="m">4</span> received, <span class="m">0</span>% packet loss, <span class="nb">time</span> 3004ms
rtt min/avg/max/mdev <span class="o">=</span> <span class="m">1</span>.981/2.215/2.633/0.254 ms
</pre></div>


<p>到这里 DHCP 服务生效。</p>
<ol>
<li>DHCP 租约问题</li>
</ol>
<p>从 DHCP Client 开看，整个租约流程如下：</p>
<ol>
<li>第一次获取 DHCP 租约以及租约失效情况下，需要走 DHCP 获取租约的完整流程，即从发送 DHCPDISCOVER 开始</li>
<li>若已经获取到租约之后，每次机器开机会直接发送 DHCPREQUEST，请求使用原来的 IP 地址</li>
<li>租约期限到一半时，Client 发送 DHCPREQUEST, 若没有得到 DHCP 服务器的 ACK,仍然会继续使用</li>
<li>租约期限到87.5%，Client 继续发送 DHCPREQUEST ，能获取来自 DHCP 服务器的 ACK 则继续使用（ ACK中包含新的租约时间以及其他配置参数 ），如果得不到 ACK 响应或者联系不上，则 Client 会与其他 DHCP 服务器通信（获取新的地址）。如果网络上没有其他 DHCP 服务器，当达到租约期限时，则该 Client 必须停止使用该 IP 地址。然后走 DHCP 获取租约的完整流程，从 DHCPDISCOVER 开始，获取新的 ip 地址。</li>
</ol>
<p>综上，当租约期达到一半时，若 client 能联系上之前的 DHCP 服务器（两者均在线），则会获取 ACK 然后进行续约。在租约期内，若有一方不在线，IP 虽然不会被释放，但是没有续约，如果直到达到租约期限依然没有续约上的话，IP 会被释放。</p>
<p>如何保证在 vm 未被删除之前，ip 始终保持不变？</p>
<ol>
<li>确保网络中至少有一个 DHCP 服务器</li>
<li>当将 MAC 地址与 ip 地址进行绑定</li>
</ol>
<h4>4.2、配置 NAT</h4>
<ol>
<li>开启 6wind nat 功能，添加静态 nat 规则，将 vrouter 的公网地址 2222 端口映射 client1 的 22 端口，2223 端口映射为 client2 的 22 端口，使外网通过 ssh 访问内网。配置信息如下：</li>
</ol>
<div class="highlight"><pre><span></span>router<span class="o">{</span>conf:init_turo-nat<span class="o">}</span>public interface ens3
router<span class="o">{</span>conf:init_turo-nat-ens3<span class="o">}</span>nat <span class="nb">enable</span>
router<span class="o">{</span>conf:init_turo-nat-ens3<span class="o">}</span>static <span class="m">100</span> protocol tcp public <span class="m">172</span>.32.0.5:2222 private <span class="m">12</span>.12.12.120:22
router<span class="o">{</span>conf:init_turo-nat-ens3<span class="o">}</span>static <span class="m">200</span> protocol tcp public <span class="m">172</span>.32.0.5:2223 private <span class="m">172</span>.16.10.100:22
router<span class="o">{</span>conf:init_turo-nat-ens3<span class="o">}</span>display 
      nat <span class="nb">enable</span>

    <span class="c1"># DYNAMIC MAPPINGS</span>

    <span class="c1"># STATIC MAPPINGS</span>
      static <span class="m">100</span> protocol tcp public <span class="m">172</span>.32.0.5:2222 private <span class="m">12</span>.12.12.120:22
      static <span class="m">200</span> protocol tcp public <span class="m">172</span>.32.0.5:2223 private <span class="m">172</span>.16.10.100:22

router<span class="o">{</span>conf:init_turo-nat-ens3<span class="o">}</span>save 
router<span class="o">{}</span>apply init_turo
</pre></div>


<ol>
<li>以 100 rule 为例，验证静态 nat 功能，如下：</li>
</ol>
<div class="highlight"><pre><span></span><span class="o">[</span>root@POD23-CLU01-H028 ~<span class="o">]</span><span class="c1"># ssh -p 2222 root@172.32.0.5</span>
The authenticity of host <span class="s1">&#39;[172.32.0.5]:2222 ([172.32.0.5]:2222)&#39;</span> can<span class="s1">&#39;t be established.</span>
<span class="s1">ECDSA key fingerprint is b0:4b:6c:4a:a4:92:9c:a8:65:31:76:6f:b5:61:d3:5e.</span>
<span class="s1">Are you sure you want to continue connecting (yes/no)? yes</span>
<span class="s1">Warning: Permanently added &#39;</span><span class="o">[</span><span class="m">172</span>.32.0.5<span class="o">]</span>:2222<span class="s1">&#39; (ECDSA) to the list of known hosts.</span>
<span class="s1">root@172.32.0.5&#39;</span>s password: 
Last login: Sat Aug  <span class="m">4</span> <span class="m">21</span>:46:02 <span class="m">2018</span>
<span class="o">[</span>root@client1 ~<span class="o">]</span><span class="c1"># ip a</span>
<span class="m">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="m">65536</span> qdisc noqueue state UNKNOWN 
    link/loopback <span class="m">00</span>:00:00:00:00:00 brd <span class="m">00</span>:00:00:00:00:00
    inet <span class="m">127</span>.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
<span class="m">2</span>: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="m">1500</span> qdisc pfifo_fast state UP qlen <span class="m">1000</span>
    link/ether <span class="m">00</span>:12:25:66:d7:77 brd ff:ff:ff:ff:ff:ff
    inet <span class="m">12</span>.12.12.120/24 brd <span class="m">12</span>.12.12.255 scope global dynamic eth0
       valid_lft 3170sec preferred_lft 3170sec
    inet6 fe80::212:25ff:fe66:d777/64 scope link 
       valid_lft forever preferred_lft forever
</pre></div>


<h4>4.3、配置 Filter</h4>
<p>配置 iptables filter 规则，实现云环境中安全组功能。6wind 提供的安全组规则，是通过在在路由器上进行配置，实现对整个子网段或者单个虚拟网卡进行配置。6wind 开启 filter 功能之后，会拒绝所有进入进出流量。以下为整个测试过程中配置的 filter 规则。</p>
<div class="highlight"><pre><span></span>router<span class="o">{</span>conf:init_turo<span class="o">}</span>fil
router<span class="o">{</span>conf:init_turo-fil<span class="o">}</span>display 
    <span class="c1"># FILTER RULES</span>
      <span class="c1"># 开放路由器 22 端口</span>
      rule <span class="m">20000</span> processing input ipv4 protocol tcp from any to <span class="m">172</span>.32.0.5<span class="o">[</span><span class="m">22</span><span class="o">]</span> state new established <span class="k">do</span> allow
      rule <span class="m">20010</span> processing output ipv4 protocol tcp from <span class="m">172</span>.32.0.5<span class="o">[</span><span class="m">22</span><span class="o">]</span> to any state new established <span class="k">do</span> allow
      <span class="c1"># 允许外部 ping 路由器网关</span>
      rule <span class="m">20020</span> ipv4 protocol icmp echo-request from any to <span class="m">172</span>.32.0.5 <span class="k">do</span> allow
      rule <span class="m">20030</span> ipv4 protocol icmp echo-reply from <span class="m">172</span>.32.0.5 to any <span class="k">do</span> allow

      <span class="c1"># 允许 ping subnet1:12.12.12.0/24, subnet2: 172.16.10.0/24  (针对整个子网段配置filter规则)</span>
      rule <span class="m">20080</span> ipv4 protocol icmp echo-request from any to <span class="m">12</span>.12.12.0/24 <span class="k">do</span> allow
      rule <span class="m">20090</span> ipv4 protocol icmp echo-reply from <span class="m">12</span>.12.12.0/24 to any <span class="k">do</span> allow
      rule <span class="m">20100</span> ipv4 protocol icmp echo-request from any to <span class="m">172</span>.16.10.0/24 <span class="k">do</span> allow
      rule <span class="m">20110</span> ipv4 protocol icmp echo-reply from <span class="m">172</span>.16.10.0/24 to any <span class="k">do</span> allow

      <span class="c1"># 开放 vm1 eth0的22端口，vm2 eth0的22端口 （针对单个虚拟网卡配置filter规则）</span>
      rule <span class="m">20120</span> processing forward ipv4 protocol tcp from any to <span class="m">12</span>.12.12.120<span class="o">[</span><span class="m">22</span><span class="o">]</span> <span class="k">do</span> allow
      rule <span class="m">20130</span> processing forward ipv4 protocol tcp from <span class="m">12</span>.12.12.120<span class="o">[</span><span class="m">22</span><span class="o">]</span> to any <span class="k">do</span> allow
      rule <span class="m">20140</span> processing forward ipv4 protocol tcp from any to <span class="m">172</span>.16.10.100<span class="o">[</span><span class="m">22</span><span class="o">]</span> <span class="k">do</span> allow
      rule <span class="m">20150</span> processing forward ipv4 protocol tcp from <span class="m">172</span>.16.10.100<span class="o">[</span><span class="m">22</span><span class="o">]</span> to any <span class="k">do</span> allow

      <span class="c1"># 开放subnet1：12.12.12.0/24 子网段路由转发功能</span>
      rule <span class="m">20180</span> processing forward ipv4 from any to <span class="m">12</span>.12.12.0/24 <span class="k">do</span> allow
      rule <span class="m">20190</span> processing forward ipv4 from <span class="m">12</span>.12.12.0/24 to any <span class="k">do</span> allow
      rule <span class="m">20200</span> processing output ipv4 from <span class="m">12</span>.12.12.0/24 to any <span class="k">do</span> allow
      rule <span class="m">20210</span> processing input ipv4 from any to <span class="m">12</span>.12.12.0/24 <span class="k">do</span> allow
    <span class="c1"># RPF RULES</span>
    <span class="c1"># FILTER STATEMENT</span>
      filter <span class="nb">enable</span>
</pre></div>
  </div>
  <div class="tag-cloud">
    <p>
    </p>
  </div>





</article>

    <footer>
<p>&copy;  2019</p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Andia ",
  "url" : "https://andiaq.github.io",
  "image": "/images/head.jpg",
  "description": ""
}
</script>

</body>
</html>